<!DOCTYPE html>
<html lang="en">
<head>
    <title>xeoEngine Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <style>
        body {
            margin: 0;
            -moz-user-select: -moz-none;
            -khtml-user-select: none;
            -webkit-user-select: none;
        }
    </style>

    <script src="../build/xeoengine.js"></script>
    <script src="js/debug/debug.js"></script>
    <link href="css/styles.css" rel="stylesheet"/>

<body>

<div id="infoDark">
    <a href="http://xeoengine.org">xeoEngine</a>
    <br><br>
    <ul>
        <li>
            picking individual triangles on a <a href="../docs/classes/GameObject.html" target="_other">GameObject</a>
        </li>
        <li>
            GameObject has ~9500 triangles
        </li>
        <li>
            uses GPU-based color-indexing technique
        </li>
        <li>
            move your mouse over the heightmap!
        </li>
    </ul>
    <br><br>
    <pre id="infoTxt" style="text-align: left;"></pre>
</div>

<script>


    // ------------ Logging -------------------------------------------------

    var buf = [];

    function log(event, params) {
        var txt = event;
        if (params) {
            txt += ": " + JSON.stringify(params)
        }
        buf.push(txt);
        if (buf.length > 30) {
            buf.shift();
        }
        document.getElementById("infoTxt").innerText = buf.join("\n");
    }


    // ----------- Scene definition -----------------------------------------

    // A GameObject that we can pick - a heightmap with a diffuse map

    var terrainObject = new XEO.GameObject({

        geometry: new XEO.HeightmapGeometry({
            primitive: "triangles",
            src: "textures/height/mountain.png",
            xSize: 10,
            ySize: 10,
            zSize: 5,
            xSegments: 10,
            ySegments: 10,
            lod: 1.0, // Default
            autoNormals: true // Default
        }),

        material: new XEO.PhongMaterial({
            diffuseMap: new XEO.Texture({
                src: "textures/diffuse/uvGrid2.jpg"
            }),
            diffuse: [0.3, 0.3, 1],
            lineWidth: 3,
            pointSize: 5
        })

    });

    // Set initial camera position

    var view = terrainObject.scene.camera.view;

    view.zoom(2);
    view.rotateEyeX(-60);
    view.rotateEyeY(-20);


    // ------------ Interaction ------------------------------------------

    // Allow camera interaction

    new XEO.CameraControl();


    // Attempt to pick a triangle on the heightmap GameObject on each mouse move

    var scene = terrainObject.scene;

    var input = scene.input;


    input.on("mousemove",
            function (coords) {

                log("Mouse pos: (" + coords[0] + ", " + coords[1] + ")");

                // Attempt to pick a primitive from among whatever
                // pickable GameObjects we have

                var hit = scene.pick(coords, {
                    pickPrimitive: true
                });

                if (hit) {

                    // Picked a GameObject

                    log("Picked:");
                    log("GameObject ID = " + hit.object.id);

                    if (hit.primitiveIndex !== -1) {

                        // Picked a triangle on the GameObject's Geometry

                        log("Primitive index = " + hit.primitiveIndex);

                        // Update the positions on our triangle indicator
                        // to show the triangle we picked

                        var indices = hit.object.geometry.indices;
                        var positions = hit.object.geometry.positions;

                        // The primitiveIndex indicates the position of
                        // the triangle within the indices array

                        var i = hit.primitiveIndex;

                        var ia = indices[i];
                        var ib = indices[i + 1];
                        var ic = indices[i + 2];

                        var a = [
                            positions[(ia * 3) + 0],
                            positions[(ia * 3) + 1],
                            positions[(ia * 3) + 2]
                        ];

                        var b = [
                            positions[(ib * 3) + 0],
                            positions[(ib * 3) + 1],
                            positions[(ib * 3) + 2]
                        ];

                        var c = [
                            positions[(ic * 3) + 0],
                            positions[(ic * 3) + 1],
                            positions[(ic * 3) + 2]
                        ];

                        // Use debug helper to show triangle with vertex labels

                        XEO.debug
                                .lineWidth(4)
                                .color([0.0, 0.0, 0.0])
                                .pos(a)
                                .pos(b)
                                .pos(c)
                                .triangle();

                        XEO.debug
                                .id("vertexA")
                                .fillColor([1.0, 1.0, 0.3])
                                .color([0, 0, 0])
                                .text("A")
                                .pos(a)
                                .label();

                        XEO.debug
                                .id("vertexB")
                                .fillColor([1.0, 1.0, 0.3])
                                .color([0, 0, 0])
                                .text("B")
                                .pos(b)
                                .label();

                        XEO.debug
                                .id("vertexC")
                                .fillColor([1.0, 1.0, 0.3])
                                .color([0, 0, 0])
                                .text("C")
                                .pos(c)
                                .label();

                    } else {

                        log("No primitive picked.");
                    }

                } else {
                    log("Nothing picked.");
                }

                log(); // Newline between each logged pick
            });

    function unproject(object, canvasCoords) {

        var canvas = object.scene.canvas.canvas;
        var viewMat = object.camera.view.matrix;
        var projMat = object.camera.project.matrix;

        var w = canvas.width;
        var h = canvas.height;

        // Calculate clip space coordinates, which will be in range
        // of x=[-1..1] and y=[-1..1], with y=(+1) at top

        var x = (canvasCoords[0] - w / 2) / (w / 2);           // Calculate clip space coordinates
        var y = -(canvasCoords[1] - h / 2) / (h / 2);

        var pvMat = XEO.math.mulMat4(projMat, viewMat, []);
        var pvMatInverse = XEO.math.inverseMat4(pvMat, []);
        var world1 = XEO.math.transformVec4(pvMatInverse, [x, y, -1, 1]);
        world1 = XEO.math.mulVec4Scalar(world1, 1 / world1[3]);
        var world2 = XEO.math.transformVec4(pvMatInverse, [x, y, 1, 1]);

        XEO.debug
                .color([1, 0.3, 0.3])
                .pos(world1)
                .pos(world2)
                .line();

        world2 = XEO.math.mulVec4Scalar(world2, 1 / world2[3]);
        var dir = XEO.math.subVec3(world2, world1, []);
        var vWorld = XEO.math.addVec3(world1, XEO.math.mulVec4Scalar(dir, 0, []), []);
        return vWorld;
    }


</script>
</body>
</html>