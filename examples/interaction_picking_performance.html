<!DOCTYPE html>
<html lang="en">
<head>
    <title>xeoEngine Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <style>
        body {
            margin: 0;
            -moz-user-select: -moz-none;
            -khtml-user-select: none;
            -webkit-user-select: none;
        }
    </style>

    <script src="../build/xeoengine.js"></script>

    <script src="js/debug/debug.js"></script>

    <link href="css/styles.css" rel="stylesheet"/>

<body>

<div id="infoDark">
    <a href="http://xeoengine.org">xeoEngine</a>
    <br><br>
    <ul>
        <li>
            ray picking performance demo
        </li>
        <li>
            move your mouse over an object!
        </li>
    </ul>
    <br><br>
    <img id="diffuseTexture" src="textures/diffuse/uvGrid2.jpg" width="400px" height="400px">

    <div id="uvPos"
         style="position:absolute; width: 20px; height: 20px; border-radius: 10px; opacity: 0.7; border: 2px solid white; background: lightgreen;"></div>

</div>

<script>

    var showUVPos = (function () {
        var textureImg = document.getElementById("diffuseTexture");
        var uvPosDiv = document.getElementById("uvPos");
        var left = textureImg.offsetLeft;
        var top = textureImg.offsetTop;
        var width = textureImg.width;
        var height = textureImg.height;
        return function (uv) {
            if (!uv) {
                uvPosDiv.style.left = -100 + "px";
                return;
            }
            uvPosDiv.style.left = Math.floor(left + uv[0] * width) + "px";
            uvPosDiv.style.top = Math.floor(top + height - (uv[1] * height)) + "px"; // Correct for our texture Y-flipping
        }
    })();

    var geometry = new XEO.SphereGeometry({
        radius: 1.0
    });

    var material = new XEO.PhongMaterial({
        diffuseMap: new XEO.Texture({
            src: "textures/diffuse/uvGrid2.jpg"
        })
    });

    var width = 40;
    var halfWidth = width / 2;

    for (var i = 0; i < 1000; i++) {

        new XEO.GameObject({

            geometry: geometry,

            material: material,

            transform: new XEO.Translate({
                xyz: [
                    Math.random() * width - halfWidth,
                    Math.random() * width - halfWidth,
                    Math.random() * width - halfWidth]
            })
        });
    }

    var pencil = new XEO.GameObject({
        geometry: new XEO.CylinderGeometry({
            radiusTop: 0.0,
            radiusBottom: 0.15,
            height: 0.7,
            radialSegments: 20,
            heightSegments: 1,
            openEnded: false
        }),
        transform: new XEO.Translate({
            xyz: [0, -.35, 0],
            parent: new XEO.Transform({
                parent: new XEO.Translate({
                    xyz: [0, 2, 0]
                })
            })
        }),
        material: new XEO.PhongMaterial({
            diffuse: [1, .2, .2],
            specular: [1, 1, 1],
            shininess: 90
        }),
        modes: new XEO.Modes({
            pickable: false
        })
    });

    var scene = XEO.scene;


    scene.camera.view.zoom(2);
    scene.camera.view.rotateEyeY(45);
    scene.camera.view.rotateEyeX(45);

    // Allow camera interaction

    new XEO.CameraControl();


    // Whenever mouse moves, attempt to pick a triangle on a GameObject,
    // then show the cartesian coordinates at the picked position within
    // the triangle, along with the interpolated normal vector and UV coordinates
    // at the picked position.

    scene.input.on("mousemove",
            function (coords) {

                // Hide visual indicators


                showUVPos(null);

                // Pick a primitive on some GameObject

                var hit = scene.pick(coords, {
                    rayPick: true
                });

                if (hit) {

                    // GameObject picked

                    if (hit.worldPos) {

                        // World position picked

                        // World position picked

                        pencil.transform.parent.parent.xyz = hit.worldPos;
                    }

                    if (hit.normal) {

                        // Normal vector picked

                        pencil.transform.parent.matrix = XEO.math.quaternionToMat4(
                                XEO.math.vec3PairToQuaternion(hit.normal, [0, -1, 0]));
                    }

                    if (hit.uv) {

                        // UV coordinates picked

                        showUVPos(hit.uv);
                    }

                } else {

                    // No Triangle picked
                }

            });


</script>
</body>
</html>