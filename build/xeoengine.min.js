/*
 * XeoEngine V0.0.1
 *
 * A WebGL-Based 3D Engine from XeoLabs
 * http://xeoengine.org/
 *
 * Built on 2014-12-31
 *
 * MIT License
 * Copyright 2014, Lindsay Kay
 * http://xeolabs.com/
 *
 */

XEO.utils=XEO.utils||{},XEO.utils.Map=function(a,b){this.items=a||[],b=_baseId||0;var c=b+1;this.addItem=function(){var a;if(2==arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(;;){a=arguments[0];var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}},XEO.math={createUUID:function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;36>e;e++)8==e||13==e||18==e||23==e?c[e]="-":14==e?c[e]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19==e?3&a|8:a]);return c.join("")}}(),negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return XEO.math.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(XEO.math.sqLenVec4(a))},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return XEO.math.dotVec3(a,a)},sqLenVec2:function(a){return XEO.math.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(XEO.math.sqLenVec3(a))},lenVec2:function(a){return Math.sqrt(XEO.math.sqLenVec2(a))},rcpVec3:function(a,b){return XEO.math.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/XEO.math.lenVec4(a);return XEO.math.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/XEO.math.lenVec3(a);return XEO.math.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/XEO.math.lenVec2(a);return XEO.math.mulVec2Scalar(a,c,b)},mat4:function(){return new Array(16)},dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return XEO.math.m4s(0)},setMat4ToOnes:function(){return XEO.math.m4s(1)},diagonalMat4v:function(a){return[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]]},diagonalMat4c:function(a,b,c,d){return XEO.math.diagonalMat4v([a,b,c,d])},diagonalMat4s:function(a){return XEO.math.diagonalMat4c(a,a,a,a)},identityMat4:function(){return XEO.math.diagonalMat4v([1,1,1,1])},isIdentityMat4:function(a){return 1!==a[0]||0!==a[1]||0!==a[2]||0!==a[3]||0!==a[4]||1!==a[5]||0!==a[6]||0!==a[7]||0!==a[8]||0!==a[9]||1!==a[10]||0!==a[11]||0!==a[12]||0!==a[13]||0!==a[14]||1!==a[15]?!1:!0},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return XEO.math.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a==b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a){var b=XEO.math.identityMat4();return b[12]=a[0],b[13]=a[1],b[14]=a[2],b},translationMat4c:function(a,b,c){return XEO.math.translationMat4v([a,b,c])},translationMat4s:function(a){return XEO.math.translationMat4c(a,a,a)},rotationMat4v:function(a,b){var c,d,e,f,g,h,i=XEO.math.normalizeVec4([b[0],b[1],b[2],0],[]),j=Math.sin(a),k=Math.cos(a),l=1-k,m=i[0],n=i[1],o=i[2];c=m*n,d=n*o,e=o*m,f=m*j,g=n*j,h=o*j;var p=XEO.math.mat4();return p[0]=l*m*m+k,p[1]=l*c+h,p[2]=l*e-g,p[3]=0,p[4]=l*c-h,p[5]=l*n*n+k,p[6]=l*d+f,p[7]=0,p[8]=l*e+g,p[9]=l*d-f,p[10]=l*o*o+k,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},rotationMat4c:function(a,b,c,d){return XEO.math.rotationMat4v(a,[b,c,d])},scalingMat4v:function(a){var b=XEO.math.identityMat4();return b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat4c:function(a,b,c){return XEO.math.scalingMat4v([a,b,c])},scalingMat4s:function(a){return XEO.math.scalingMat4c(a,a,a)},lookAtMat4v:function(a,b,c,d){d||(d=XEO.math.mat4());var e=a[0],f=a[1],g=a[2],h=c[0],i=c[1],j=c[2],k=b[0],l=b[1],m=b[2];if(e==k&&f==l&&g==m)return XEO.math.identityMat4();var n,o,p,q,r,s,t,u,v,w;return n=e-k,o=f-l,p=g-m,w=1/Math.sqrt(n*n+o*o+p*p),n*=w,o*=w,p*=w,q=i*p-j*o,r=j*n-h*p,s=h*o-i*n,w=Math.sqrt(q*q+r*r+s*s),w?(w=1/w,q*=w,r*=w,s*=w):(q=0,r=0,s=0),t=o*s-p*r,u=p*q-n*s,v=n*r-o*q,w=Math.sqrt(t*t+u*u+v*v),w?(w=1/w,t*=w,u*=w,v*=w):(t=0,u=0,v=0),d[0]=q,d[1]=t,d[2]=n,d[3]=0,d[4]=r,d[5]=u,d[6]=o,d[7]=0,d[8]=s,d[9]=v,d[10]=p,d[11]=0,d[12]=-(q*e+r*f+s*g),d[13]=-(t*e+u*f+v*g),d[14]=-(n*e+o*f+p*g),d[15]=1,d},lookAtMat4c:function(a,b,c,d,e,f,g,h,i){return XEO.math.lookAtMat4v([a,b,c],[d,e,f],[g,h,i],[])},orthoMat4c:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2/i,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=-2/j,g[11]=0,g[12]=-(a+b)/h,g[13]=-(d+c)/i,g[14]=-(f+e)/j,g[15]=1,g},frustumMat4v:function(a,b){var c=[a[0],a[1],a[2],0],d=[b[0],b[1],b[2],0],e=XEO.math.mat4();XEO.math.addVec4(d,c,e);var f=XEO.math.mat4();XEO.math.subVec4(d,c,f);var g=2*c[2],h=XEO.math.mat4(),i=f[0],j=f[1],k=f[2];return h[0]=g/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=g/j,h[6]=0,h[7]=0,h[8]=e[0]/i,h[9]=e[1]/j,h[10]=-e[2]/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-g*d[2]/k,h[15]=0,h},frustumMatrix4:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2*e/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2*e/i,g[6]=0,g[7]=0,g[8]=(b+a)/h,g[9]=(d+c)/i,g[10]=-(f+e)/j,g[11]=-1,g[12]=0,g[13]=0,g[14]=-(f*e*2)/j,g[15]=0,g},perspectiveMatrix4:function(a,b,c,d){var e=[],f=[];return e[2]=c,f[2]=d,f[1]=e[2]*Math.tan(a/2),e[1]=-f[1],f[0]=f[1]*b,e[0]=-f[0],XEO.math.frustumMat4v(e,f)},transformPoint3:function(a,b){var c=b[0],d=b[1],e=b[2];return[a[0]*c+a[4]*d+a[8]*e+a[12],a[1]*c+a[5]*d+a[9]*e+a[13],a[2]*c+a[6]*d+a[10]*e+a[14],a[3]*c+a[7]*d+a[11]*e+a[15]]},transformPoints3:function(a,b){for(var c,d,e,f,g=new Array(b.length),h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15],y=0;h>y;++y)f=b[y],c=f[0],d=f[1],e=f[2],g[y]=[i*c+m*d+q*e+u,j*c+n*d+r*e+v,k*c+o*d+s*e+w,l*c+p*d+t*e+x];return g},transformVec3:function(a,b){var c=b[0],d=b[1],e=b[2];return[a[0]*c+a[4]*d+a[8]*e,a[1]*c+a[5]*d+a[9]*e,a[2]*c+a[6]*d+a[10]*e]},transformVec4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},projectVec4:function(a){var b=1/a[3];return[a[0]*b,a[1]*b,a[2]*b,1]}},XEO.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipMapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipMapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipMapLinear:"NEAREST_MIPMAP_LINEAR",linearMipMapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}},XEO.webgl.ArrayBuffer=function(a,b,c,d,e,f){this.allocated=!1,this.gl=a,this.type=b,this.numItems=d,this.itemSize=e,this.usage=f,this._allocate(c,d)},XEO.webgl.ArrayBuffer.prototype._allocate=function(a,b){if(this.allocated=!1,this.handle=this.gl.createBuffer(),!this.handle)throw"Failed to allocate WebGL ArrayBuffer";this.handle&&(this.gl.bindBuffer(this.type,this.handle),this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null),this.numItems=b,this.length=a.length,this.allocated=!0)},XEO.webgl.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):b||0===b?this.gl.bufferSubData(this.type,b,a):this.gl.bufferData(this.type,a))},XEO.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},XEO.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this.handle),this.handle=null,this.allocated=!1)},XEO.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this.handle)},XEO.webgl.Attribute=function(a,b,c,d,e,f){this.gl=a,this.location=f,this.bindFloatArrayBuffer=function(b){b&&(b.bind(),a.enableVertexAttribArray(f),a.vertexAttribPointer(f,b.itemSize,a.FLOAT,!1,0,0))}},XEO.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(a,b,c){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a,this.gl.FLOAT,!1,b,c)},XEO.webgl.Program=function(a,b,c){this.allocated=!1,this.gl=a,this._uniforms={},this._samplers={},this._attributes={},this.uniformValues=[],this.materialSettings={specular:[0,0,0],specularFactor:0,shine:0,emit:0,alpha:0},this._vertexShader=new XEO.webgl.Shader(a,a.VERTEX_SHADER,b),this._fragmentShader=new XEO.webgl.Shader(a,a.FRAGMENT_SHADER,c);var d,e,f,g,h;if(this.handle=a.createProgram(),this.handle){this._vertexShader.valid&&a.attachShader(this.handle,this._vertexShader.handle),this._fragmentShader.valid&&a.attachShader(this.handle,this._fragmentShader.handle),a.linkProgram(this.handle);var i=a.getProgramParameter(this.handle,a.ACTIVE_UNIFORMS),j=0;for(e=0;i>e;++e)f=a.getActiveUniform(this.handle,e),f&&(g=f.name,"\x00"==g[g.length-1]&&(g=g.substr(0,g.length-1)),h=a.getUniformLocation(this.handle,g),f.type==a.SAMPLER_2D||f.type==a.SAMPLER_CUBE||35682==f.type?this._samplers[g]=new XEO.webgl.Sampler(a,this.handle,g,f.type,f.size,h):(this._uniforms[g]=new XEO.webgl.Uniform(a,this.handle,g,f.type,f.size,h,j),this.uniformValues[j]=null,++j));var k=a.getProgramParameter(this.handle,a.ACTIVE_ATTRIBUTES);for(e=0;k>e;e++)d=a.getActiveAttrib(this.handle,e),d&&(h=a.getAttribLocation(this.handle,d.name),this._attributes[d.name]=new XEO.webgl.Attribute(a,this.handle,d.name,d.type,d.size,h));this.allocated=!0}},XEO.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},XEO.webgl.Program.prototype.getUniformLocation=function(a){if(this.allocated){var b=this._uniforms[a];return b?b.getLocation():void 0}},XEO.webgl.Program.prototype.getUniform=function(a){if(this.allocated){var b=this._uniforms[a];return b?b:void 0}},XEO.webgl.Program.prototype.getAttribute=function(a){if(this.allocated){var b=this._attributes[a];return b?b:void 0}},XEO.webgl.Program.prototype.bindFloatArrayBuffer=function(a,b){if(this.allocated){var c=this._attributes[a];c&&c.bindFloatArrayBuffer(b)}},XEO.webgl.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this._samplers[a];return d?d.bindTexture(b,c):!1},XEO.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this._attributes=null,this._uniforms=null,this._samplers=null,this.allocated=!1)},XEO.webgl.Program.prototype.setUniform=function(a,b){if(this.allocated){var c=this._uniforms[a];c&&(this.uniformValues[c.index]===b&&c.numberValue||(c.setValue(b),this.uniformValues[c.index]=b))}},XEO.webgl.RenderBuffer=function(a){this.allocated=!1,this.canvas=a.canvas,this.gl=a.canvas.gl,this.buf=null,this.bound=!1},XEO.webgl.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buf=null,this.allocated=!1,this.bound=!1},XEO.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.bound=!0)},XEO.webgl.RenderBuffer.prototype._touch=function(){var a=this.canvas.canvas.width,b=this.canvas.canvas.height;if(this.buf){if(this.buf.width==a&&this.buf.height==b)return;this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf)}this.buf={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:a,height:b},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buf.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(c){var d=new WebGLUnsignedByteArray(a*b*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,d)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buf.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),!this.gl.isFramebuffer(this.buf.framebuf))throw XEO_error.fatalError(XEO.errors.INVALID_FRAMEBUFFER,"Invalid framebuffer");var e=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(e){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case this.gl.FRAMEBUFFER_UNSUPPORTED:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: "+e)}this.bound=!1},XEO.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},XEO.webgl.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.canvas.height-b,e=new Uint8Array(4);return this.gl.readPixels(c,d,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),e},XEO.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},XEO.webgl.RenderBuffer.prototype.getTexture=function(){var a=this;return{bind:function(b){return a.buf&&a.buf.texture?(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buf.texture),!0):!1},unbind:function(b){a.buf&&a.buf.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},XEO.webgl.RenderBuffer.prototype.destroy=function(){this.buf&&(this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf),this.buf=null,this.bound=!1)},XEO.webgl.Sampler=function(a,b,c,d,e,f){this.bindTexture=function(b,c){return b.bind(c)?(a.uniform1i(f,c),!0):!1}},XEO.webgl.Texture2D=function(a,b){this.allocated=!1,this.target=b.target||a.TEXTURE_2D,this.minFilter=b.minFilter,this.magFilter=b.magFilter,this.wrapS=b.wrapS,this.wrapT=b.wrapT,this.update=b.update,this.texture=b.texture,this.format=a.RGBA,this.isDepth=!1,this.depthMode=0,this.depthCompareMode=0,this.depthCompareFunc=0;try{a.bindTexture(this.target,this.texture),b.minFilter&&a.texParameteri(this.target,a.TEXTURE_MIN_FILTER,b.minFilter),b.magFilter&&a.texParameteri(this.target,a.TEXTURE_MAG_FILTER,b.magFilter),b.wrapS&&a.texParameteri(this.target,a.TEXTURE_WRAP_S,b.wrapS),b.wrapT&&a.texParameteri(this.target,a.TEXTURE_WRAP_T,b.wrapT),(b.minFilter==a.NEAREST_MIPMAP_NEAREST||b.minFilter==a.LINEAR_MIPMAP_NEAREST||b.minFilter==a.NEAREST_MIPMAP_LINEAR||b.minFilter==a.LINEAR_MIPMAP_LINEAR)&&a.generateMipmap(this.target),a.bindTexture(this.target,null),this.allocated=!0}catch(c){throw XEO_error.fatalError(XEO.errors.OUT_OF_VRAM,"Failed to create texture: "+c.message||c)}this.bind=function(b){return this.allocated?this.texture?(a.activeTexture(a["TEXTURE"+b]),a.bindTexture(this.target,this.texture),this.update&&this.update(a),!0):!1:void 0},this.unbind=function(b){this.allocated&&this.texture&&(a.activeTexture(a["TEXTURE"+b]),a.bindTexture(this.target,null))},this.destroy=function(){this.allocated&&this.texture&&(a.deleteTexture(this.texture),this.texture=null)}},XEO.webgl.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=XEO.webgl.nextHighestPowerOfTwo(e),g.height=XEO.webgl.nextHighestPowerOfTwo(f);var h=g.getContext("2d");h.drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},XEO.webgl.ensureImageSizePowerOfTwo=function(a){if(!XEO.webgl.isPowerOfTwo(a.width)||!XEO.webgl.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=XEO.webgl.nextHighestPowerOfTwo(a.width),b.height=XEO.webgl.nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},XEO.webgl.isPowerOfTwo=function(a){return 0==(a&a-1)},XEO.webgl.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},XEO.webgl.Uniform=function(a,b,c,d,e,f,g){var h=null;if(this.numberValue=!1,d==a.BOOL)this.numberValue=!0,h=function(b){a.uniform1i(f,b)};else if(d==a.BOOL_VEC2)h=function(b){a.uniform2iv(f,b)};else if(d==a.BOOL_VEC3)h=function(b){a.uniform3iv(f,b)};else if(d==a.BOOL_VEC4)h=function(b){a.uniform4iv(f,b)};else if(d==a.INT)this.numberValue=!0,h=function(b){a.uniform1iv(f,b)};else if(d==a.INT_VEC2)h=function(b){a.uniform2iv(f,b)};else if(d==a.INT_VEC3)h=function(b){a.uniform3iv(f,b)};else if(d==a.INT_VEC4)h=function(b){a.uniform4iv(f,b)};else if(d==a.FLOAT)this.numberValue=!0,h=function(b){a.uniform1f(f,b)};else if(d==a.FLOAT_VEC2)h=function(b){a.uniform2fv(f,b)};else if(d==a.FLOAT_VEC3)h=function(b){a.uniform3fv(f,b)};else if(d==a.FLOAT_VEC4)h=function(b){a.uniform4fv(f,b)};else if(d==a.FLOAT_MAT2)h=function(b){a.uniformMatrix2fv(f,a.FALSE,b)};else if(d==a.FLOAT_MAT3)h=function(b){a.uniformMatrix3fv(f,a.FALSE,b)};else{if(d!=a.FLOAT_MAT4)throw"Unsupported shader uniform type: "+d;h=function(b){a.uniformMatrix4fv(f,a.FALSE,b)}}this.setValue=h,this.getValue=function(){return a.getUniform(b,f)},this.getLocation=function(){return f},this.index=g},XEO.renderer=XEO.renderer||{},XEO.renderer.Renderer=function(a){this._canvas=a.canvas,this._programFactory=new XEO.renderer.ProgramFactory({canvas:a.canvas}),this._chunkFactory=new XEO.ChunkFactory,this.transparent=a.transparent===!0,this.enable=null,this.flags=null,this.layer=null,this.stage=null,this.renderer=null,this.depthBuf=null,this.colorBuf=null,this.view=null,this.lights=null,this.material=null,this.texture=null,this.cubemap=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.renderTarget=null,this.clips=null,this.morphGeometry=null,this.name=null,this.tag=null,this.shader=null,this.shaderParams=null,this.style=null,this.geometry=null,this._objectFactory=new XEO.renderer.ObjectFactory,this._objects={},this._ambientColor=[0,0,0,1],this._objectList=[],this._objectListLen=0,this._drawList=[],this._drawListLen=0,this._pickDrawList=[],this._pickDrawListLen=0,this._targetList=[],this._targetListLen=0,this._frameCtx={pickNames:[],canvas:this._canvas,VAO:null},this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.drawListDirty=!0,this.imageDirty=!0,this.pickBufDirty=!0,this.rayPickBufDirty=!0},XEO.Renderer.prototype.webglRestored=function(){this._programFactory.webglRestored(),this._chunkFactory.webglRestored();var a=this._canvas.gl;this.pickBuf&&this.pickBuf.webglRestored(a),this.rayPickBuf&&this.rayPickBuf.webglRestored(a),this.imageDirty=!0},XEO.Renderer.prototype.buildObject=function(a){var b=this._objects[a];b||(b=this._objects[a]=this._objectFactory.getObject(a),this.objectListDirty=!0),b.stage=this.stage,b.layer=this.layer,b.renderTarget=this.renderTarget,b.texture=this.texture,b.cubemap=this.cubemap,b.geometry=this.geometry,b.enable=this.enable,b.flags=this.flags,b.tag=this.tag;var c=[this.geometry.hash,this.shader.hash,this.clips.hash,this.morphGeometry.hash,this.texture.hash,this.cubemap.hash,this.lights.hash].join(";");b.program&&c==b.hash||(b.program&&this._programFactory.putProgram(b.program),b.program=this._programFactory.getProgram(c,this),b.hash=c),this._setChunk(b,0,"program"),this._setChunk(b,1,"xform",this.modelTransform),this._setChunk(b,2,"lookAt",this.viewTransform),this._setChunk(b,3,"camera",this.projTransform),this._setChunk(b,4,"flags",this.flags),this._setChunk(b,5,"shader",this.shader),this._setChunk(b,6,"shaderParams",this.shaderParams),this._setChunk(b,7,"style",this.style),this._setChunk(b,8,"depthBuf",this.depthBuf),this._setChunk(b,9,"colorBuf",this.colorBuf),this._setChunk(b,10,"view",this.view),this._setChunk(b,11,"name",this.name),this._setChunk(b,12,"lights",this.lights),this._setChunk(b,13,"material",this.material),this._setChunk(b,14,"texture",this.texture),this._setChunk(b,15,"cubemap",this.cubemap),this._setChunk(b,16,"clips",this.clips),this._setChunk(b,17,"renderer",this.renderer),this._setChunk(b,18,"geometry",this.morphGeometry,this.geometry),this._setChunk(b,19,"draw",this.geometry)},XEO.Renderer.prototype._setChunk=function(a,b,c,d,e){var f,g=this._chunkFactory.chunkTypes[c];if(d){if(d.empty){var h=a.chunks[b];return h&&this._chunkFactory.putChunk(h),void(a.chunks[b]=null)}f=g.prototype.programGlobal?"_"+d.stateId:"p"+a.program.id+"_"+d.stateId,e&&(f+="__"+e.stateId)}else f="p"+a.program.id;f=b+"__"+f;var h=a.chunks[b];if(h){if(h.id==f)return;this._chunkFactory.putChunk(h)}a.chunks[b]=this._chunkFactory.getChunk(f,c,a.program,d,e),"lights"==c&&this._setAmbient(d)},XEO.Renderer.prototype._setAmbient=function(a){for(var b,c=a.lights,d=0,e=c.length;e>d;d++)b=c[d],"ambient"==b.mode&&(this._ambientColor[0]=b.color[0],this._ambientColor[1]=b.color[1],this._ambientColor[2]=b.color[2])},XEO.Renderer.prototype.removeObject=function(a){var b=this._objects[a];b&&(this._programFactory.putProgram(b.program),b.program=null,b.hash=null,this._objectFactory.putObject(b),delete this._objects[a],this.objectListDirty=!0)},XEO.Renderer.prototype.selectTags=function(a){this._tagSelector=a,this.drawListDirty=!0},XEO.Renderer.prototype.render=function(a){a=a||{},this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.drawListDirty=!0),this.drawListDirty&&(this._buildDrawList(),this.imageDirty=!0),(this.imageDirty||a.force)&&(this._doDrawList({clear:a.clear!==!1}),this.imageDirty=!1,this.pickBufDirty=!0)},XEO.Renderer.prototype._buildObjectList=function(){this._objectListLen=0;for(var a in this._objects)this._objects.hasOwnProperty(a)&&(this._objectList[this._objectListLen++]=this._objects[a])},XEO.Renderer.prototype._makeStateSortKeys=function(){for(var a,b=0,c=this._objectListLen;c>b;b++)a=this._objectList[b],a.sortKey=a.program?1e12*(a.stage.priority+1)+1e9*(a.flags.transparent?2:1)+1e6*(a.layer.priority+1)+1e3*(a.program.id+1)+a.texture.stateId:-1},XEO.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(this._stateSortObjects)},XEO.Renderer.prototype._stateSortObjects=function(a,b){return a.sortKey-b.sortKey},XEO.Renderer.prototype._logObjectList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._objectListLen+" objects");for(var a=0,b=this._objectListLen;b>a;a++){var c=this._objectList[a];console.log("XEO.Renderer : object["+a+"] sortKey = "+c.sortKey)}console.log("--------------------------------------------------------------------------------------------------")},XEO.Renderer.prototype._buildDrawList=function(){this._lastStateId=this._lastStateId||[],this._lastPickStateId=this._lastPickStateId||[];for(var a=0;23>a;a++)this._lastStateId[a]=null,this._lastPickStateId[a]=null;this._drawListLen=0,this._pickDrawListLen=0;var b,c,d,e,f,g={},h=[],i=[];this._tagSelector&&(c=this._tagSelector.mask,d=this._tagSelector.regex),this._objectDrawList=this._objectDrawList||[],this._objectDrawListLen=0;for(var a=0,j=this._objectListLen;j>a;a++)if(b=this._objectList[a],b.enable.enabled!==!1&&(f=b.flags,f.enabled!==!1&&b.layer.enabled&&(!c||(e=b.tag,!e.tag||(e.mask!=c&&(e.mask=c,e.matches=d.test(e.tag)),e.matches)))))if(b.renderTarget.targets)for(var k,l,m,n=b.renderTarget.targets,o=0,p=n.length;p>o;o++)k=n[o],l=k.coreId,m=g[l],m||(m=[],g[l]=m,h.push(m),i.push(this._chunkFactory.getChunk(k.stateId,"renderTarget",b.program,k))),m.push(b);else this._objectDrawList[this._objectDrawListLen++]=b;for(var m,k,b,q,a=0,j=h.length;j>a;a++){m=h[a],k=i[a],this._appendRenderTargetChunk(k);for(var o=0,p=m.length;p>o;o++)b=m[o],q=b.stage&&b.stage.pickable,this._appendObjectToDrawLists(b,q)}b&&this._appendRenderTargetChunk(this._chunkFactory.getChunk(-1,"renderTarget",b.program,{}));for(var a=0,j=this._objectDrawListLen;j>a;a++)b=this._objectDrawList[a],q=!b.stage||b.stage&&b.stage.pickable,this._appendObjectToDrawLists(b,q);
this.drawListDirty=!1},XEO.Renderer.prototype._appendRenderTargetChunk=function(a){this._drawList[this._drawListLen++]=a},XEO.Renderer.prototype._appendObjectToDrawLists=function(a,b){for(var c,d=a.chunks,e=a.flags.picking,f=0,g=d.length;g>f;f++)c=d[f],c&&(c.draw&&(c.unique||this._lastStateId[f]!=c.id)&&(this._drawList[this._drawListLen++]=c,this._lastStateId[f]=c.id),c.pick&&b!==!1&&e&&(c.unique||this._lastPickStateId[f]!=c.id)&&(this._pickDrawList[this._pickDrawListLen++]=c,this._lastPickStateId[f]=c.id))},XEO.Renderer.prototype._logDrawList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._drawListLen+" draw list chunks");for(var a=0,b=this._drawListLen;b>a;a++){var c=this._drawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+c.core.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},XEO.Renderer.prototype._logPickList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._pickDrawListLen+" pick list chunks");for(var a=0,b=this._pickDrawListLen;b>a;a++){var c=this._pickDrawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+c.core.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},XEO.Renderer.prototype.pick=function(a){var b=this._canvas.canvas,c=null,d=a.canvasX,e=a.canvasY,f=this.pickBuf;f||(f=this.pickBuf=new XEO.webgl.RenderBuffer({canvas:this._canvas}),this.pickBufDirty=!0),this.render(),f.bind(),this.pickBufDirty&&(f.clear(),this._doDrawList({pick:!0,clear:!0}),this._canvas.gl.finish(),this.pickBufDirty=!1,this.rayPickBufDirty=!0);var g=f.read(d,e),h=g[0]+256*g[1]+65536*g[2],i=h>=1?h-1:-1;f.unbind();var j=this._frameCtx.pickNames[i];if(j&&(c={name:j.name,path:j.path,nodeId:j.nodeId,canvasPos:[d,e]},a.rayPick)){var k=this.rayPickBuf;k||(k=this.rayPickBuf=new XEO.webgl.RenderBuffer({canvas:this._canvas}),this.rayPickBufDirty=!0),k.bind(),this.rayPickBufDirty&&(k.clear(),this._doDrawList({pick:!0,rayPick:!0,clear:!0}),this.rayPickBufDirty=!1),g=k.read(d,e),k.unbind();var l=this._unpackDepth(g),m=b.width,n=b.height,o=(d-m/2)/(m/2),p=-(e-n/2)/(n/2),q=this._frameCtx.cameraMat,r=this._frameCtx.viewMat,s=SceneJS_math_mulMat4(q,r,[]),t=SceneJS_math_inverseMat4(s,[]),u=SceneJS_math_transformVec4(t,[o,p,-1,1]);u=SceneJS_math_mulVec4Scalar(u,1/u[3]);var v=SceneJS_math_transformVec4(t,[o,p,1,1]);v=SceneJS_math_mulVec4Scalar(v,1/v[3]);var w=SceneJS_math_subVec3(v,u,[]),x=SceneJS_math_addVec3(u,SceneJS_math_mulVec4Scalar(w,l,[]),[]);c.worldPos=x}return c},XEO.Renderer.prototype._unpackDepth=function(a){var b=[a[0]/256,a[1]/256,a[2]/256,a[3]/256],c=[1/16777216,1/65536,1/256,1];return SceneJS_math_dotVector4(b,c)},XEO.Renderer.prototype._doDrawList=function(a){var b=this._canvas.gl,c=this._frameCtx;c.renderTarget=null,c.targetIndex=0,c.renderBuf=null,c.viewMat=null,c.modelMat=null,c.cameraMat=null,c.renderer=null,c.depthbufEnabled=null,c.clearDepth=null,c.depthFunc=b.LESS,c.scissorTestEnabled=!1,c.blendEnabled=!1,c.backfaces=!0,c.frontface="ccw",c.pick=!!a.pick,c.rayPick=!!a.rayPick,c.pickIndex=0,c.textureUnit=0,c.lineWidth=1,c.transparent=!1,c.ambientColor=this._ambientColor,c.aspect=this._canvas.canvas.width/this._canvas.canvas.height;var d=b.getExtension("OES_vertex_array_object");if(c.VAO=d?d:null,c.VAO=null,b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),this.transparent?b.clearColor(0,0,0,0):b.clearColor(this._ambientColor[0],this._ambientColor[1],this._ambientColor[2],1),a.clear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT),b.frontFace(b.CCW),b.disable(b.CULL_FACE),b.disable(b.BLEND),a.pick)for(var e=0,f=this._pickDrawListLen;f>e;e++)this._pickDrawList[e].pick(c);else for(var e=0,f=this._drawListLen;f>e;e++)this._drawList[e].draw(c);if(b.flush(),c.renderBuf&&c.renderBuf.unbind(),c.VAO){c.VAO.bindVertexArrayOES(null);for(var e=0;10>e;e++)b.disableVertexAttribArray(e)}},XEO.Renderer.prototype.destroy=function(){this._programFactory.destroy()};