/*
 * xeoEngine V0.1.0
 *
 * A WebGL-based 3D scene graph from xeoLabs
 * http://xeoengine.org/
 *
 * Built on 2015-08-17
 *
 * MIT License
 * Copyright 2015, Lindsay Kay
 * http://xeolabs.com/
 *
 */

!function(){"use strict";var a=function(){this._sceneIDMap=null,this._scene=null,this.scenes={},this._dirtyScenes={};var a=this,b={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},c=function(){var d=.001*(new Date).getTime();b.time=d;var e;for(var f in a.scenes)a.scenes.hasOwnProperty(f)&&(e=a.scenes[f],b.sceneId=f,b.startTime=e.startTime,b.deltaTime=null!=b.prevTime?d-b.prevTime:0,e.fire("tick",b,!0),e._compile(),a._dirtyScenes[f]=!1);b.prevTime=d,window.requestAnimationFrame(c)};window.requestAnimationFrame(c)};a.prototype={constructor:a,get scene(){return this._scene||(this._scene=new window.XEO.Scene({id:"default.scene"}))},_addScene:function(b){if(this._sceneIDMap=this._sceneIDMap||new window.XEO.utils.Map,b.id){if(this.scenes[b.id])return void console.error("[ERROR] Scene "+a._inQuotes(b.id)+" already exists")}else b.id=this._sceneIDMap.addItem(b);this.scenes[b.id]=b;var c=this;b.on("destroyed",function(){c._sceneIDMap.removeItem(b.id),delete c.scenes[b.id],delete c._dirtyScenes[b.id]}),b.on("dirty",function(){c._dirtyScenes[b.id]=!0})},clear:function(){var a;for(var b in this.scenes)this.scenes.hasOwnProperty(b)&&(a=this.scenes[b],"default.scene"===b?a.clear():a.destroy());this.scenes={},this._dirtyScenes={}},_isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},_isString:function(a){return"string"==typeof a||a instanceof String},_isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},_copy:function(a){return this._apply(a,{})},_apply:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_apply2:function(a,b){for(var c in a)a.hasOwnProperty(c)&&void 0!==a[c]&&null!==a[c]&&(b[c]=a[c]);return b},_applyIf:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0===b[c]||null===b[c])&&(b[c]=a[c]);return b},_isEmptyObject:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},_inQuotes:function(a){return this._isNumeric(a)?""+a:"'"+a+"'"}},window.XEO=window.XEO=new a}(),function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.__init&&this.__init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)if("_props"!==g)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];else{var h,i=c[g];for(var j in i)h=i[j],h.set||!function(){var a=j;h.set=function(){this.warn("Property '"+a+"' is read-only, ignoring assignment")}}(),h.enumerable=!0,Object.defineProperty(f,j,h)}return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),function(){"use strict";XEO.utils=XEO.utils||{},XEO.utils.Map=function(a,b){this.items=a||[],b=b||0;var c=b+1;this.addItem=function(){var a;if(2===arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(;;){a=arguments[0]||{};var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}}}(),function(){"use strict";XEO.Component=Class.extend({__init:function(){var a={},b=arguments[0],c=arguments[1];this.scene=null,"XEO.Scene"===this.type?(this.scene=this,b&&(a=b)):(b?"XEO.Scene"===b.type?(this.scene=b,c&&(a=c)):(this.scene=XEO.scene,a=b):this.scene=XEO.scene,this._renderer=this.scene._renderer),this.metadata=a.metadata||{},this.id=a.id,this.destroyed=!1,this._children={},this._childDestroySubs={},this._childDirtySubs={},this._handleMap=new XEO.utils.Map,this._eventSubs={},this._handleLocs={},this.props={},this.scene&&"XEO.Scene"!==this.type&&this.scene._addComponent(this),this._init&&this._init(a)},type:"XEO.Component",_init:function(a){},fire:function(a,b,c){c!==!0&&(this.props[a]=b);var d,e=this._eventSubs[a];if(e)for(var f in e)e.hasOwnProperty(f)&&(d=e[f],d.callback.call(d.scope,b))},on:function(a,b,c){var d=this._eventSubs[a];d||(d={},this._eventSubs[a]=d);var e=this._handleMap.addItem();d[e]={scope:c||this,callback:b},this._handleLocs[e]=a;var f=this.props[a];return f&&b.call(c||this,f),e},off:function(a){if(void 0!==a&&null!==a){var b=this._handleLocs[a];if(b){delete this._handleLocs[a];var c=this._eventSubs[b];c&&delete c[a],this._handleMap.removeItem(a)}}},once:function(a,b,c){var d=this,e=this.on(a,function(a){d.off(e),b(a)},c)},log:function(a){window.console.log("[LOG]"+this._message(a)),this.scene.fire("log",a)},_message:function(a){return" ["+this.type+" "+XEO._inQuotes(this.id)+"]: "+a},error:function(a){window.console.error("[ERROR]"+this._message(a)),this.scene.fire("error",a)},warn:function(a){window.console.warn("[WARN]"+this._message(a)),this.scene.fire("warn",a)},clone:function(a){if(this.destroyed)return void this.error("Component has been destroyed - cloning not allowed");a=a||{};var b=this.json;return delete b.id,new this.constructor(this.scene,XEO._apply(a,b))},_setChild:function(a,b){if(b){if(XEO._isNumeric(b)||XEO._isString(b)){var c=b;if(b=this.scene.components[c],!b)return void this.error("Component not found: "+XEO._inQuotes(c))}}else if(b=this.scene[a],!b)return void this.error("No default component for name '"+a+"'");if(b.scene.id!==this.scene.id)return void this.error("Not in same scene: "+b.type+" "+XEO._inQuotes(b.id));var d=this._children[a];if(d){if(d.id===b.id)return;d.off(this._childDestroySubs[a]),d.off(this._childDirtySubs[a])}this._children[a]=b;var e=this;return this._childDestroySubs[a]=b.on("destroyed",function(){delete e._children[a];var c=e.scene[a];return c&&b.id!==c.id?void e._setChild(a,c):void e.fire(a,null)}),this._childDirtySubs[a]=b.on("dirty",function(){e.fire("dirty",!0)}),this.fire("dirty",!0),this.fire(a,b),b},_compile:function(){},_props:{json:{get:function(){var a={type:this.type,id:this.id};return XEO._isEmptyObject(this.metadata)||(a.metadata=this.metadata),this._getJSON?XEO._apply(this._getJSON(),a):a}},js:{get:function(){return"new "+this.type+"("+this.string+");"}},string:{get:function(){return JSON.stringify(this.json,null,4)}}},destroy:function(){var a;for(var b in this._children)this._children.hasOwnProperty(b)&&(a=this._children[b],a.off(this._childDestroySubs[b]),a.off(this._childDirtySubs[b]));this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)},_destroy:function(){}})}(),function(){"use strict";XEO.Scene=XEO.Component.extend({type:"XEO.Scene",_init:function(a){this._componentIDMap=new XEO.utils.Map,this.startTime=(new Date).getTime(),this.components={},this.types={},this.objects={},this._dirtyObjects={},this.configs=new XEO.Configs(this,a.configs),this.canvas=new XEO.Canvas(this,{canvas:a.canvas,contextAttr:a.contextAttr||{}}),this.canvas.on("webglContextFailed",function(){alert("xeoEngine failed to find WebGL!")}),this._renderer=new XEO.renderer.Renderer({canvas:this.canvas,transparent:a.transparent}),this.input=new XEO.Input(this,{canvas:this.canvas.canvas}),this.tasks=new XEO.Tasks(this),this.stats=new XEO.Stats(this,{objects:0,geometries:0,textures:0}),XEO._addScene(this);var b=a.components;if(b)for(var c,d,e,f=0,g=b.length;g>f;f++)c=b[f],d=c.type,d&&(e=window[d],e&&new e(this,c));this._initDefaults()},_initDefaults:function(){this.view,this.project,this.camera,this.clips,this.colorTarget,this.colorBuf,this.depthTarget,this.depthBuf,this.visibility,this.modes,this.geometry,this.layer,this.lights,this.material,this.morphTargets,this.reflect,this.shader,this.shaderParams,this.stage,this.transform},_addComponent:function(a){if(a.id){if(this.components[a.id])return void this.error("Component "+XEO._inQuotes(a.id)+" already exists")}else a.id=this._componentIDMap.addItem(a);this.components[a.id]=a;var b=a.type,c=this.types[a.type];c||(c=this.types[b]={}),c[a.id]=a;var d=this;a.on("destroyed",function(){d._componentIDMap.removeItem(a.id),delete d.components[a.id];var b=d.types[a.type];b&&(delete b[a.id],XEO._isEmptyObject(b)&&delete d.types[a.type]),"XEO.GameObject"===a.type&&(d.stats.dec("objects"),delete d.objects[a.id],delete d._dirtyObjects[a.id],d.fire("dirty",!0)),d.fire("componentDestroyed",a,!0)}),"XEO.GameObject"===a.type&&(a.on("dirty",function(){d._dirtyObjects[a.id]||(d._dirtyObjects[a.id]=a),d.fire("dirty",!0)}),this.objects[a.id]=a,this.stats.inc("objects")),this.fire("componentCreated",a,!0)},_props:{project:{get:function(){return this.components["default.project"]||new XEO.Perspective(this,{id:"default.project"})}},view:{get:function(){return this.components["default.view"]||new XEO.Lookat(this,{id:"default.view"})}},camera:{get:function(){return this.components["default.camera"]||new XEO.Camera(this,{id:"default.camera",project:"default.project",view:"default.view"})}},transform:{get:function(){return this.components["default.transform"]||new XEO.Transform(this,{id:"default.transform"})}},clips:{get:function(){return this.components["default.clips"]||new XEO.Clips(this,{id:"default.clips"})}},colorBuf:{get:function(){return this.components["default.colorBuf"]||new XEO.ColorBuf(this,{id:"default.colorBuf"})}},colorTarget:{get:function(){return this.components["default.colorTarget"]||new XEO.ColorTarget(this,{id:"default.colorTarget"})}},depthBuf:{get:function(){return this.components["default.depthBuf"]||new XEO.DepthBuf(this,{id:"default.depthBuf",active:!1})}},depthTarget:{get:function(){return this.components["default.depthTarget"]||new XEO.DepthTarget(this,{id:"default.depthTarget",active:!1})}},visibility:{get:function(){return this.components["default.visibility"]||new XEO.Visibility(this,{id:"default.visibility",visible:!0})}},modes:{get:function(){return this.components["default.modes"]||new XEO.Modes(this,{id:"default.modes"})}},geometry:{get:function(){return this.components["default.geometry"]||new XEO.Torus(this,{id:"default.geometry"})}},layer:{get:function(){return this.components["default.layer"]||new XEO.Layer(this,{id:"default.layer",priority:0})}},lights:{get:function(){return this.components["default.lights"]||new XEO.Lights(this,{id:"default.lights",lights:[new XEO.AmbientLight(this,{id:"default.light0",color:[.7,.7,.7],intensity:1}),new XEO.DirLight(this,{id:"default.light1",dir:[-.5,-.5,-1],color:[1,1,1],intensity:1,space:"view"}),new XEO.DirLight(this,{id:"default.light2",dir:[1,-.9,-.7],color:[1,1,1],intensity:1,space:"view"})]})}},material:{get:function(){return this.components["default.material"]||new XEO.PhongMaterial(this,{id:"default.material"})}},morphTargets:{get:function(){return this.components["default.morphTargets"]||new XEO.MorphTargets(this,{id:"default.morphTargets"})}},reflect:{get:function(){return this.components["default.reflect"]||new XEO.Reflect(this,{id:"default.reflect"})}},shader:{get:function(){return this.components["default.shader"]||this.components["default.shader"]||new XEO.Shader(this,{id:"default.shader"})}},shaderParams:{get:function(){return this.components["default.shaderParams"]||new XEO.ShaderParams(this,{id:"default.shaderParams"})}},stage:{get:function(){return this.components["default.stage"]||new XEO.Stage(this,{id:"default.stage",priority:0})}}},pick:function(a,b){return this._renderer.pick({canvasPos:a,rayPick:b.rayPick})},clear:function(){for(var a in this.components)this.components.hasOwnProperty(a)&&this.components[a].destroy();this._initDefaults(),this._dirtyObjects={}},testPattern:function(){this.clear();var a=new XEO.Rotate(this,{xyz:[0,.5,.5],angle:0}),b=new XEO.GameObject(this,{transform:a}),c=0,d=this.on("tick",function(){b.transform.angle=c,c+=.01}),e=this;b.on("destroyed",function(){e.off(d)}),this.on("componentCreated",function(){b.destroy(),a.destroy()})},_compile:function(){var a=0;for(var b in this._dirtyObjects)this._dirtyObjects.hasOwnProperty(b)&&(this._dirtyObjects[b]._compile(),delete this._dirtyObjects[b],a++);this._renderer.render({clear:!0})},_getJSON:function(){var a,b=[];for(var c in this.components)if(this.components.hasOwnProperty(c)){if(a=this.components[c],!a._getJSON)continue;b.unshift(a)}b.sort(function(a,b){return a._componentOrder-b._componentOrder});for(var d=[],e=0,f=b.length;f>e;e++)d.push(b[e].json);return{components:d}},_destroy:function(){this.clear()}})}(),function(){"use strict";XEO.CameraFlight=XEO.Component.extend({type:"XEO.CameraFlight",_init:function(a){this._look1=XEO.math.vec3(),this._eye1=XEO.math.vec3(),this._up1=XEO.math.vec3(),this._look2=XEO.math.vec3(),this._eye2=XEO.math.vec3(),this._up2=XEO.math.vec3(),this._vec=XEO.math.vec3(),this._dist=0,this._flying=!1,this._ok=null,this._onTick=null,this._camera=a.camera,this._tempVec=XEO.math.vec3(),this._eyeVec=XEO.math.vec3(),this._lookVec=XEO.math.vec3(),this._stopFOV=55,this._time1=null,this._time2=null,this.easing=a.easing!==!1,this.duration=a.duration||.5,this.camera=a.camera},flyTo:function(a,b){this._flying&&this.stop(),this._ok=b,this._arc=void 0===a.arc?0:a.arc;var c=this.camera.view;this._look1=c.look,this._eye1=c.eye,this._up1=c.up,this._vec=XEO.math.normalizeVec3(XEO.math.subVec3(this._eye1,this._look1,[]));var d=a.backOff||.5;0>d?d=0:d>1&&(d=1),d=1-d;var e=a.component,f=a.aabb;if(e||f){if(e){if(XEO._isNumeric(e)||XEO._isString(e)){var g=e;if(e=this.scene.components[g],!e)return void this.error("Component not found: "+XEO._inQuotes(g))}var h=e.worldBoundary;if(!h)return void this.error("Can't fly to component "+XEO._inQuotes(g)+" - does not have a worldBoundary");f=h.aabb}if(f.xmax<=f.xmin||f.ymax<=f.ymin||f.zmax<=f.zmin)return;var i=a.dist||2.5,j=Math.abs(XEO.math.lenVec3(this._vec)),k=XEO.math.getAABBDiag(f),l=Math.abs(k/(1+.8*d)/Math.tan(this._stopFOV/2)),m=l/j*i;this._look2=XEO.math.getAABBCenter(f),this._look2=[this._look2[0],this._look2[1],this._look2[2]],a.offset&&(this._look2[0]+=a.offset[0],this._look2[1]+=a.offset[1],this._look2[2]+=a.offset[2]),this._eye2=XEO.math.addVec3(this._look2,XEO.math.mulVec3Scalar(this._vec,m,[])),this._up2=XEO.math.vec3(),this._up2[1]=1}else{var c=a,n=a.look||this._camera.view.look,o=a.eye||this._camera.view.eye,p=a.up||this._camera.view.up;this._look2[0]=n[0],this._look2[1]=n[1],this._look2[2]=n[2],this._eye2[0]=o[0],this._eye2[1]=o[1],this._eye2[2]=o[2],this._up2[0]=p[0],this._up2[1]=p[1],this._up2[2]=p[2]}this.fire("started",a,!0);var q=this;this._time1=(new Date).getTime(),this._time2=this._time1+this._duration,this._tick=this.scene.on("tick",function(a){q._update()}),this._flying=!0},_update:function(){if(this._flying){var a=(new Date).getTime(),b=(a-this._time1)/(this._time2-this._time1);if(b>1)return void this.stop();b=this.easing?this._ease(b,0,1,1):b;var c=this._camera.view;c.eye=XEO.math.lerpVec3(b,0,1,this._eye1,this._eye2,[]),c.look=XEO.math.lerpVec3(b,0,1,this._look1,this._look2,[]),c.up=XEO.math.lerpVec3(b,0,1,this._up1,this._up2,[])}},_ease:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},stop:function(){if(this._flying){this.scene.off(this._tick),this._flying=!1,this._time1=null,this._time2=null,this.fire("stopped",!0,!0);var a=this._ok;a&&(this._ok=!1,a())}},_props:{camera:{set:function(a){var b=a||this.scene.camera;if(b){if((XEO._isNumeric(b)||XEO._isString(b))&&(b=this.scene.components[b],!b))return void this.error("Component not found: "+XEO._inQuotes(a));if("XEO.Camera"!=b.type)return void this.error("Component "+XEO._inQuotes(b.id)+" is not a XEO.Camera");this._camera=a||this.scene.camera}this.stop()},get:function(){return this._camera}},duration:{set:function(a){this._duration=1e3*a,this.stop()},get:function(){return.001*this._duration}}},_getJSON:function(){var a={};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.stop()}})}(),function(){"use strict";XEO.MorphTargets=XEO.Component.extend({type:"XEO.MorphTargets",_init:function(a){this.scene.on("webglContextRestored",function(){}),this.targets=a.targets,this.factor=a.factor},_props:{targets:{set:function(a){},get:function(){}},factor:{set:function(a){},get:function(){return 0}},_compile:function(){this._renderer.MorphTargets=this._state}},_getJSON:function(){return{targets:this.targets,factor:this.factor}}})}(),function(){"use strict";XEO.Camera=XEO.Component.extend({type:"XEO.Camera",_init:function(a){this.project=a.project,this.view=a.view},_props:{project:{set:function(a){this._setChild("project",a)},get:function(){return this._children.project}},view:{set:function(a){this._setChild("view",a)},get:function(){return this._children.view}}},_compile:function(){this._children.project._compile(),this._children.view._compile()},_getJSON:function(){var a={};return this._children.project&&(a.project=this._children.project.id),this._children.view&&(a.view=this._children.view.id),a}})}(),function(){"use strict";XEO.Frustum=XEO.Component.extend({type:"XEO.Frustum",_init:function(a){this._state=new XEO.renderer.ProjTransform({matrix:null}),this._dirty=!1,this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=1e4,this.left=a.left,this.right=a.right,this.bottom=a.bottom,this.top=a.top,this.near=a.near,this.far=a.far},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick",function(){a._build()})}},_build:function(){this._state.matrix=XEO.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix),this._dirty=!1,this.fire("matrix",this._state.matrix)},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._dirty&&this._build(),this._state.matrix}}},_compile:function(){this._renderer.projTransform=this._state},_getJSON:function(){return{left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Lookat=XEO.Component.extend({type:"XEO.Lookat",_init:function(a){this._state=new XEO.renderer.ViewTransform({matrix:XEO.math.mat4(),normalMatrix:XEO.math.mat4(),eye:[0,0,-10],look:[0,0,0],up:[0,1,0]}),this._dirty=!0,this.eye=a.eye,this.look=a.look,this.up=a.up},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick",function(){a._build()})}},_build:function(){this._state.matrix=new Float32Array(XEO.math.lookAtMat4c(this._state.eye[0],this._state.eye[1],this._state.eye[2],this._state.look[0],this._state.look[1],this._state.look[2],this._state.up[0],this._state.up[1],this._state.up[2],this._state.matrix)),this._state.normalMatrix=new Float32Array(XEO.math.transposeMat4(new Float32Array(XEO.math.inverseMat4(this._state.matrix,this._state.normalMatrix),this._state.normalMatrix))),this._dirty=!1,this.fire("matrix",this._state.matrix)},rotateEyeY:function(a){var b=XEO.math.subVec3(this._state.eye,this._state.look,[]),c=XEO.math.rotationMat4v(.0174532925*a,this._state.up);b=XEO.math.transformPoint3(c,b,[]),this.eye=XEO.math.addVec3(b,this._state.look,[])},rotateEyeX:function(a){var b=XEO.math.subVec3(this._state.eye,this._state.look,[]),c=XEO.math.cross3Vec3(XEO.math.normalizeVec3(b,[]),XEO.math.normalizeVec3(this._state.up,[])),d=XEO.math.rotationMat4v(.0174532925*a,c);b=XEO.math.transformPoint3(d,b,[]),this.eye=XEO.math.addVec3(b,this._state.look,[]),this.up=XEO.math.transformPoint3(d,this._state.up,[])},rotateLookY:function(a){var b=XEO.math.subVec3(this._state.look,this._state.eye,[]),c=XEO.math.rotationMat4v(.0174532925*a,this._state.up);b=XEO.math.transformPoint3(c,b,[]),this.look=XEO.math.addVec3(b,this._state.eye,[])},rotateLookX:function(a){var b=XEO.math.subVec3(this._state.look,this._state.eye,[]),c=XEO.math.cross3Vec3(XEO.math.normalizeVec3(b,[]),XEO.math.normalizeVec3(this._state.up,[])),d=XEO.math.rotationMat4v(.0174532925*a,c);b=XEO.math.transformPoint3(d,b,[]),this.look=XEO.math.addVec3(b,this._state.eye,[]),this.up=XEO.math.transformPoint3(d,this._state.up,[])},pan:function(a){var b,c=XEO.math.subVec3(this._state.eye,this._state.look,[]),d=[0,0,0];if(0!==a[0]){var e=XEO.math.cross3Vec3(XEO.math.normalizeVec3(c,[]),XEO.math.normalizeVec3(this._state.up,[]));b=XEO.math.mulVec3Scalar(e,a[0]),d[0]+=b[0],d[1]+=b[1],d[2]+=b[2]}0!==a[1]&&(b=XEO.math.mulVec3Scalar(XEO.math.normalizeVec3(this._state.up,[]),a[1]),d[0]+=b[0],d[1]+=b[1],d[2]+=b[2]),0!==a[2]&&(b=XEO.math.mulVec3Scalar(XEO.math.normalizeVec3(c,[]),a[2]),d[0]+=b[0],d[1]+=b[1],d[2]+=b[2]),this.eye=XEO.math.addVec3(this._state.eye,d,[]),this.look=XEO.math.addVec3(this._state.look,d,[])},zoom:function(a){var b=XEO.math.subVec3(this._state.eye,this._state.look,[]),c=Math.abs(XEO.math.lenVec3(b,[])),d=Math.abs(c+a),e=XEO.math.normalizeVec3(b,[]);this.eye=XEO.math.addVec3(this._state.look,XEO.math.mulVec3Scalar(e,d),[])},_props:{eye:{set:function(a){a=a||[0,0,-10];var b=this._state.eye;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("eye",this._state.eye)},get:function(){return this._state.eye}},look:{set:function(a){a=a||[0,0,0];var b=this._state.look;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("look",this._state.look)},get:function(){return this._state.look}},up:{set:function(a){a=a||[0,1,0];var b=this._state.up;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("up",this._state.up)},get:function(){return this._state.up}},matrix:{get:function(){return this._dirty&&this._build(),this._state.matrix}}},_compile:function(){this._dirty&&this._build(),this._renderer.viewTransform=this._state},_getJSON:function(){return{eye:this._state.eye,look:this._state.look,up:this._state.up}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Ortho=XEO.Component.extend({type:"XEO.Ortho",_init:function(a){this._state=new XEO.renderer.ProjTransform({matrix:null}),this._dirty=!1,this._left=-1,this._right=1,this._top=1,this._bottom=-1,this._near=.1,this._far=1e4,this.left=a.left,this.right=a.right,this.top=a.top,this.bottom=a.bottom,this.near=a.near,this.far=a.far},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick",function(){a._build()})}},_build:function(){this._state.matrix=XEO.math.orthoMat4c(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix),this._dirty=!1,this.fire("matrix",this._state.matrix)},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._dirty&&this._build(),this._state.matrix}}},_compile:function(){this._dirty&&this._build(),this._renderer.projTransform=this._state},_getJSON:function(){return{left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Perspective=XEO.Component.extend({type:"XEO.Perspective",_init:function(a){this._state=new XEO.renderer.ProjTransform({matrix:null}),this._dirty=!1,this._fovy=60,this._aspect=1,this._near=.1,this._far=1e4;var b=this,c=this.scene.canvas;this._canvasResized=c.on("resized",function(){b._aspect=c.width/c.height}),this.fovy=a.fovy,this.aspect=c.width/c.height,this.near=a.near,this.far=a.far},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick",function(){a._build()})}},_build:function(){var a=this.scene.canvas.canvas,b=a.width/a.height;this._state.matrix=XEO.math.perspectiveMatrix4(this._fovy*(Math.PI/180),b,this._near,this._far),this._dirty=!1,this.fire("matrix",this._state.matrix)},_props:{fovy:{set:function(a){this._fovy=void 0!==a&&null!==a?a:60,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("fovy",this._fovy)},get:function(){return this._fovy}},aspect:{set:function(a){this._aspect=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("aspect",this._aspect)},get:function(){return this._aspect}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._dirty&&this._build(),this._state.matrix}}},_compile:function(){this._dirty&&this._build(),this._renderer.projTransform=this._state},_getJSON:function(){return{fovy:this._fovy,near:this._near,far:this._far}},_destroy:function(){this.scene.canvas.off(this._canvasResized),this._state.destroy()}})}(),function(){"use strict";XEO.Clip=XEO.Component.extend({type:"XEO.Clip",_init:function(a){this._state={mode:"disabled",dir:[1,0,0],dist:1},this.mode=a.mode,this.dir=a.dir,this.dist=a.dist},_props:{mode:{set:function(a){this._state.mode=a||"disabled",this._renderer.imageDirty=!0,this.fire("mode",this._state.mode)},get:function(){return this._state.mode}},dir:{set:function(a){this._state.dir=a||[1,0,0],this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},dist:{set:function(a){this._state.dist=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("dist",this._state.dist)},get:function(){return this._state.dist}}},_getJSON:function(){return{mode:this._state.mode,dir:this._state.dir,dist:this._state.dist}}})}(),function(){"use strict";XEO.Clips=XEO.Component.extend({type:"XEO.Clips",_init:function(a){this._state=new XEO.renderer.Clips({clips:[],hash:""}),this._dirty=!0,this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=a.clips},_props:{clips:{set:function(a){function b(){g.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=g._clips.length;c>b;b++)if(g._clips[b].id===a)return g._clips=g._clips.slice(b,b+1),g._dirtySubs=g._dirtySubs.slice(b,b+1),g._destroyedSubs=g._destroyedSubs.slice(b,b+1),g._dirty=!0,g.fire("dirty",!0),void g.fire("clips",g._clips)}a=a||[];for(var d,e=0,f=this._clips.length;f>e;e++)d=this._clips[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];for(var g=this,e=0,f=a.length;f>e;e++){if(d=a[e],XEO._isString(d)){var h=d;if(d=this.components[h],!d){this.error("Component not found: "+XEO._inQuotes(h));continue}}"XEO.Clip"===d.type?(this._clips.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+XEO._inQuotes(h)+" is not a XEO.Clip")}this._dirty=!0,this.fire("dirty",!0),this.fire("clips",this._clips)},get:function(){return this._clips.slice(0,this._clips.length)}}},_compile:function(){var a=this._state;if(this._dirty){a.clips=[];for(var b=0,c=this._clips.length;c>b;b++)a.clips.push(this._clips[b]._state);this._makeHash(),this._dirty=!1}this._renderer.clips=a},_makeHash:function(){var a=this._state.clips;if(0===a.length)return";";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b._state.mode);c.push(";"),this._state.hash=c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._clips.length;c>b;b++)a.push(this._clips[b].id);return{clips:a}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Configs=XEO.Component.extend({type:"XEO.Configs",_init:function(a){for(var b in a)a.hasOwnProperty(b)&&this.fire(b,a[b])},set:function(a,b){this.fire(a,b)},_toJSON:function(){return XEO._copy(this.props)}})}(),function(){"use strict";XEO.Visibility=XEO.Component.extend({type:"XEO.Visibility",_init:function(a){this._state=new XEO.renderer.Visibility({visible:!0}),this.visible=a.visible},_props:{visible:{set:function(a){this._state.visible=a!==!1,this._renderer.drawListDirty=!0,this.fire("visible",this._state.visible)},get:function(){return this._state.visible}}},_compile:function(){this._renderer.visibility=this._state},_getJSON:function(){return{visible:this.visible}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Geometry=XEO.Component.extend({type:"XEO.Geometry",_init:function(a){this._state=new XEO.renderer.Geometry({primitive:null,positions:null,colors:null,normals:null,uv:null,tangents:null,indices:null}),this._primitive=null,this._positions=null,this._colors=null,this._normals=null,this._uv=null,this._tangents=null,this._indices=null,this._dirty=!1,this._positionsDirty=!0,this._colorsDirty=!0,this._normalsDirty=!0,this._uvDirty=!0,this._tangentsDirty=!0,this._indicesDirty=!0,this._modelBoundary=null,this._modelBoundaryDirty=!0;var b=!(a.positions||a.normals||a.uv||a.indices);b?(this.primitive="triangles",this.positions=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],this.colors=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],this.uv=[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],this.tangents=null,this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]):(this.primitive=a.primitive,this.positions=a.positions,this.colors=a.colors,this.normals=a.normals,this.uv=a.uv,this.tangents=a.tangents,this.indices=a.indices);var c=this;this._webglContextRestored=this.scene.canvas.on("webglContextRestored",function(){c._scheduleBuild()}),this.scene.stats.inc("geometries")},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick",function(){a._build()})}},_build:function(){var a=this.scene.canvas.gl;switch(this._primitive){case"points":this._state.primitive=a.POINTS;break;case"lines":this._state.primitive=a.LINES;break;case"line-loop":this._state.primitive=a.LINE_LOOP;break;case"line-strip":this._state.primitive=a.LINE_STRIP;break;case"triangles":this._state.primitive=a.TRIANGLES;break;case"triangle-strip":this._state.primitive=a.TRIANGLE_STRIP;break;case"triangle-fan":this._state.primitive=a.TRIANGLE_FAN;break;default:this._state.primitive=a.TRIANGLES}var b=a.STATIC_DRAW;this._positionsDirty&&(this._state.positions&&(this.scene.stats.dec("vertices",this._positions.length/3),
this._state.positions.destroy()),this._state.positions=this._positions?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._positions),this._positions.length,3,b):null,this.scene.stats.inc("vertices",this._positions.length/3),this._positionsDirty=!1),this._colorsDirty&&(this._state.colors&&this._state.colors.destroy(),this._state.colors=this._colors?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._colors),this._colors.length,4,b):null,this._colorsDirty=!1),this._normalsDirty&&(this._state.normals&&this._state.normals.destroy(),this._state.normals=this._normals?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._normals),this._normals.length,3,b):null,this._normalsDirty=!1),this._uvDirty&&(this._state.uv&&this._state.uv.destroy(),this._state.uv=this._uv?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._uv),this._uv.length,2,b):null,this._uvDirty=!1),this._tangentsDirty&&(this._state.tangents&&this._state.tangents.destroy(),this._state.tangents=this._tangents?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._tangents),this._tangents.length,4,b):null,this._tangentsDirty=!1),this._indicesDirty&&(this._state.indices&&this._state.indices.destroy(),this._state.indices=this._indices?new XEO.renderer.webgl.ArrayBuffer(a,a.ELEMENT_ARRAY_BUFFER,new Uint16Array(this._indices),this._indices.length,1,b):null,this._indicesDirty=!1),this._dirty=!1},_props:{primitive:{set:function(a){a=a||"triangles","points"!==a&&"lines"!==a&&"line-loop"!==a&&"line-strip"!==a&&"triangles"!==a&&"triangle-strip"!==a&&"triangle-fan"!==a&&(this.error("Unsupported value for 'primitive': '"+a+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),a="triangles"),this._primitive=a,this.fire("dirty",!0),this.fire("primitive",this._primitive),this._scheduleBuild()},get:function(){return this._primitive}},positions:{set:function(a){this._positions=a,this._positionsDirty=!0,this._scheduleBuild(),this._setModelBoundaryDirty();var b=!this._positions!=!a;b&&this.fire("dirty",!0),this.fire("positions",this._positions),this.fire("boundary",!0),this._renderer.imageDirty=!0},get:function(){return this._positions}},normals:{set:function(a){this._normals=a,this._normalsDirty=!0,this._scheduleBuild();var b=!this._normals!=!a;b&&this.fire("dirty",!0),this.fire(" normals",this._normals),this._renderer.imageDirty=!0},get:function(){return this._normals}},uv:{set:function(a){this._uv=a,this._uvDirty=!0,this._scheduleBuild();var b=!this._uv!=!a;b&&this.fire("dirty",!0),this.fire("uv",this._uv),this._renderer.imageDirty=!0},get:function(){return this._uv}},colors:{set:function(a){this._colors=a,this._colorsDirty=!0,this._scheduleBuild();var b=!this._colors!=!a;b&&this.fire("dirty",!0),this.fire("colors",this._colors),this._renderer.imageDirty=!0},get:function(){return this._colors}},indices:{set:function(a){this._indices=a,this._indicesDirty=!0,this._scheduleBuild();var b=!this._indices&&!a;b&&this.fire("dirty",!0),this.fire("indices",this._indices),this._renderer.imageDirty=!0},get:function(){return this._indices}},modelBoundary:{get:function(){if(!this._modelBoundary){var a=this;this._modelBoundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return a._modelBoundaryDirty},getPositions:function(){return a._positions}}),this._modelBoundary.on("destroyed",function(){a._modelBoundary=null}),this._setModelBoundaryDirty()}return this._modelBoundary}}},_setModelBoundaryDirty:function(){this._modelBoundaryDirty=!0,this._modelBoundary&&this._modelBoundary.fire("updated",!0)},_compile:function(){this._dirty&&this._build(),this._renderer.geometry=this._state},_getJSON:function(){return XEO._apply2({primitive:this._primitive,positions:this._positions,normals:this._normals,uv:this._uv,colors:this._colors,indices:this._indices},{})},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.positions&&this._state.positions.destroy(),this._state.colors&&this._state.colors.destroy(),this._state.normals&&this._state.normals.destroy(),this._state.uv&&this._state.uv.destroy(),this._state.tangents&&this._state.tangents.destroy(),this._state.indices&&this._state.indices.destroy(),this._modelBoundary&&this._modelBoundary.destroy(),this._state.destroy(),this.scene.stats.dec("geometries")}})}(),function(){"use strict";XEO.Torus=XEO.Geometry.extend({type:"XEO.Torus",_init:function(a){this._super(a),this.radius=a.radius,this.tube=a.tube,this.segmentsR=a.segmentsR,this.segmentsT=a.segmentsT,this.arc=a.arc,this._build2()},_scheduleBuild2:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick",function(){a._build2()})}},_build2:function(){var a,b,c,d,e,f,g,h,i,j,k=this._radius,l=this._tube,m=this._segmentsR,n=this._segmentsT,o=this._arc,p=[],q=[],r=[],s=[],t=0;for(j=0;m>=j;j++)for(i=0;n>=i;i++)a=i/n*o,b=j/m*Math.PI*2,c=k*Math.cos(a),d=k*Math.sin(a),e=(k+l*Math.cos(b))*Math.cos(a),f=(k+l*Math.cos(b))*Math.sin(a),g=l*Math.sin(b),p.push(e),p.push(f),p.push(g),r.push(i/n),r.push(1-j/m),h=XEO.math.normalizeVec3(XEO.math.subVec3([e,f,g],[c,d,t],[]),[]),q.push(h[0]),q.push(h[1]),q.push(h[2]);var u,v,w,x;for(j=1;m>=j;j++)for(i=1;n>=i;i++)u=(n+1)*j+i-1,v=(n+1)*(j-1)+i-1,w=(n+1)*(j-1)+i,x=(n+1)*j+i,s.push(u),s.push(v),s.push(w),s.push(w),s.push(x),s.push(u);this.positions=p,this.normals=q,this.uv=r,this.indices=s,this._dirty=!1},_props:{radius:{set:function(a){a=a||1,this._radius!==a&&(0>a&&(this.warn("negative radius not allowed - will invert"),a=-1*a),this._radius=a,this.fire("radius",this._radius),this._scheduleBuild2())},get:function(){return this._radius}},tube:{set:function(a){a=a||.3,this._tube!==a&&(0>a&&(this.warn("negative tube not allowed - will invert"),a=-1*a),this._tube=a,this.fire("tube",this._tube),this._scheduleBuild2())},get:function(){return this._tube}},segmentsR:{set:function(a){a=a||32,this._segmentsR!==a&&(0>a&&(this.warn("negative segmentsR not allowed - will invert"),a=-1*a),this._segmentsR=a,this.fire("segmentsR",this._segmentsR),this._scheduleBuild2())},get:function(){return this._segmentsR}},segmentsT:{set:function(a){a=a||24,this._segmentsT!==a&&(0>a&&(this.warn("negative segmentsT not allowed - will invert"),a=-1*a),this._segmentsT=a,this.fire("segmentsT",this._segmentsT),this._scheduleBuild2())},get:function(){return this._segmentsT}},arc:{set:function(a){a=a||2*Math.PI,this._arc!==a&&(0>a&&(this.warn("negative arc not allowed - will invert"),a=-1*a),this._arc=a,this.fire("arc",this._arc),this._scheduleBuild2())},get:function(){return this._arc}}},_getJSON:function(){return XEO._apply2({radius:this._radius,tube:this._tube,segmentsR:this._segmentsR,segmentsT:this._segmentsT,arc:this._arc},{})}})}(),function(){"use strict";XEO.Group=XEO.Component.extend({type:"XEO.Group",_init:function(a){this.components={},this.numComponents=0,this.types={},this._destroyedSubs={},a.components&&this.add(a.components)},add:function(a){a=XEO._isArray(a)?a:[a];for(var b=0,c=a.length;c>b;b++)this._addComponent(a[b])},_addComponent:function(a){var b,c,d,e;if(a.type)c=a;else{if(!XEO._isNumeric(a)&&!XEO._isString(a))return;if(this.scene.types[a]){if(d=a,e=this.scene.types[d],!e)return void this.warn("Component type not found: '"+d+"'");for(b in e)e.hasOwnProperty(b)&&this._addComponent(e[b]);return}if(c=this.scene.components[a],!c)return void this.warn("Component not found: "+XEO._inQuotes(a))}if(c.scene!=this.scene)return void this.warn("Attempted to add component from different XEO.Scene: "+XEO._inQuotes(c.id));this.components[c.id]=c,e=this.types[c.type],e||(e=this.types[d]={}),e[c.id]=c,this.numComponents++;var f=this;this._destroyedSubs[c.id]=c.on("destroyed",function(a){f._removeComponent(a)}),this.fire("added",c)},clear:function(){this.iterate(function(a){this._removeComponent(a)})},destroyAll:function(){this.iterate(function(a){a.destroy()})},remove:function(a){a=XEO._isArray(a)?a:[a];for(var b=0,c=a.length;c>b;b++)this._removeComponent(a[b])},_removeComponent:function(a){var b=a.id;if(a.scene!=this.scene)return void this.warn("Attempted to remove component that's not in same XEO.Scene: '"+b+"'");delete this.components[b],a.off(this._destroyedSubs[b]),delete this._destroyedSubs[b];var c=this.types[a.type];c&&delete c[a.id],this.numComponents--,this.fire("removed",a)},iterate:function(a){for(var b in this.components)this.components.hasOwnProperty(b)&&a.call(this,this.components[b])},_getJSON:function(){var a=[];for(var b in this.components)this.components.hasOwnProperty(b)&&a.push(this.components[b].id);return{components:a}},_destroy:function(){this.clear()}})}(),function(){"use strict";XEO.GroupBoundary=XEO.Component.extend({type:"XEO.GroupBoundary",_init:function(a){this.group=a.group},_props:{group:{set:function(a){this._setChild("group",a)},get:function(){return this._children.group}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this;this._worldBoundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return a._worldBoundaryDirty},getOBB:function(){return a._children.geometry.modelBoundary.obb},getMatrix:function(){return a._children.transform.matrix}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null}),this._setWorldBoundaryDirty()}return this._worldBoundary}},viewBoundary:{get:function(){if(!this._viewBoundary){var a=this;this._viewBoundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return a._viewBoundaryDirty},getOBB:function(){return a.worldBoundary.obb},getMatrix:function(){return a._children.camera.view.matrix}}),this._viewBoundary.on("destroyed",function(){a._viewBoundary=null}),this._setViewBoundaryDirty()}return this._viewBoundary}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._viewBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0),this._viewBoundary&&this._viewBoundary.fire("updated",!0)},_setViewBoundaryDirty:function(){this._viewBoundaryDirty=!0,this._viewBoundary&&this._viewBoundary.fire("updated",!0)},_getJSON:function(){return{}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Input=XEO.Component.extend({type:"XEO.Input",serializable:!1,_init:function(a){var b=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,document.addEventListener("keydown",this._keyDownListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!0:a.altKey?b.altDown=!0:(b.keyDown[a.keyCode]=!0,b.fire("keydown",a.keyCode,!0)))},!0),document.addEventListener("keyup",this._keyUpListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!1:a.altKey?b.altDown=!1:(b.keyDown[a.keyCode]=!1,b.fire("keyup",a.keyCode,!0)))}),a.canvas.addEventListener("mousedown",this._mouseDownListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!0;break;case 2:b.mouseDownMiddle=!0;break;case 3:b.mouseDownRight=!0}var c=b._getClickCoordsWithinElement(a);b.fire("mousedown",c,!0)}}),a.canvas.addEventListener("mouseup",this._mouseUpListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("mouseup",c,!0)}}),a.canvas.addEventListener("dblclick",this._dblClickListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1,b.mouseDownRight=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownLeft=!1,b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("dblclick",c,!0)}}),a.canvas.addEventListener("mousemove",this._mouseMoveListener=function(a){if(b.enabled){var c=b._getClickCoordsWithinElement(a);b.fire("mousemove",c,!0)}}),a.canvas.addEventListener("mousewheel",this._mouseWheelListener=function(a,c){if(b.enabled){var a=window.event||a,d=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail));b.fire("mousewheel",d,!0)}}),function(){var a,c;b.on("mousedown",function(b){a=b.x,c=b.y}),b.on("mouseup",function(d){a===d.x&&c===d.y&&b.fire("mouseclicked",d,!0)})}()},_getClickCoordsWithinElement:function(a){var b=[0,0];if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b},setEnabled:function(a){this.enabled!==a&&this.fire("enabled",this.enabled=a)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}})}(),function(){"use strict";XEO.CameraControl=XEO.Component.extend({type:"XEO.CameraControl",exclusive:!0,_init:function(a){var b=this,c=this.scene;this.keyboardAxis=new XEO.KeyboardAxisCamera(c,{camera:a.camera}),this.keyboardOrbit=new XEO.KeyboardOrbitCamera(c,{sensitivity:1,camera:a.camera}),this.mouseOrbit=new XEO.MouseOrbitCamera(c,{sensitivity:1,camera:a.camera}),this.keyboardPan=new XEO.KeyboardPanCamera(c,{sensitivity:1,camera:a.camera}),this.mousePan=new XEO.MousePanCamera(c,{sensitivity:1,camera:a.camera}),this.keyboardZoom=new XEO.KeyboardZoomCamera(c,{sensitivity:1,camera:a.camera}),this.mouseZoom=new XEO.MouseZoomCamera(c,{sensitivity:1,camera:a.camera}),this.mousePickObject=new XEO.MousePickObject(c,{rayPick:!0,camera:a.camera}),this.cameraFly=new XEO.CameraFlight(c,{camera:a.camera}),this.mousePickObject.on("pick",function(a){var c=b.cameraFly.camera.view,d=XEO.math.subVec3(c.eye,c.look,[]);b.cameraFly.flyTo({look:a.worldPos,eye:[a.worldPos[0]+d[0],a.worldPos[1]+d[1],a.worldPos[2]+d[2]]})}),this.mousePickObject.on("nopick",function(a){}),this.firstPerson=a.firstPerson,this.camera=a.camera,this.active=a.active!==!1},_props:{firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.keyboardOrbit.firstPerson=a,this.mouseOrbit.firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},camera:{set:function(a){this._setChild("camera",a);var b=this._children.camera;this.keyboardAxis.camera=b,this.keyboardOrbit.camera=b,this.mouseOrbit.camera=b,this.keyboardPan.camera=b,this.mousePan.camera=b,this.keyboardZoom.camera=b,this.mouseZoom.camera=b,this.cameraFly.camera=b},get:function(){return this._camera}},active:{set:function(a){a=!!a,this._active!==a&&(this.keyboardAxis.active=a,this.keyboardOrbit.active=a,this.mouseOrbit.active=a,this.keyboardPan.active=a,this.mousePan.active=a,this.keyboardZoom.active=a,this.mouseZoom.active=a,this.mousePickObject.active=a,this.cameraFly.active=a,this.fire("active",this._active=a))},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1,this.keyboardAxis.destroy(),this.keyboardOrbit.destroy(),this.mouseOrbit.destroy(),this.keyboardPan.destroy(),this.mousePan.destroy(),this.keyboardZoom.destroy(),this.mouseZoom.destroy(),this.mousePickObject.destroy(),this.cameraFly.destroy()}})}(),function(){"use strict";XEO.KeyboardAxisCamera=XEO.Component.extend({type:"XEO.KeyboardAxisCamera",_init:function(a){this._onKeyDown=null,this._cameraFly=new XEO.CameraFlight(this.scene,{}),this.camera=a.camera,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a),this._cameraFly.camera=this._children.camera},get:function(){return this._children.camera}},active:{set:function(a){if(a=!!a,this._active!==a){this._cameraFly.active=a;var b=this,c=this.scene.input;a?this._onKeyDown=c.on("keydown",function(a){if(b._children.camera){var d=(b.scene.worldAABB,b.scene.worldCenter);switch(a){case c.KEY_NUM_1:b._cameraFly.flyTo({look:d,eye:[-10,0,0],up:[0,1,0]});break;case c.KEY_NUM_2:b._cameraFly.flyTo({look:d,eye:[10,0,0],up:[0,1,0]});break;case c.KEY_NUM_3:b._cameraFly.flyTo({look:d,eye:[0,0,-10],up:[0,1,0]});break;case c.KEY_NUM_4:b._cameraFly.flyTo({look:d,eye:[0,0,10],up:[0,1,0]});break;case c.KEY_NUM_5:b._cameraFly.flyTo({look:d,eye:[0,-10,0],up:[0,0,-1]});break;case c.KEY_NUM_6:b._cameraFly.flyTo({look:d,eye:[0,10,0],up:[0,0,1]})}}}):this.scene.off(this._onKeyDown),this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1,this._cameraFly.destroy()}})}(),function(){"use strict";XEO.KeyboardOrbitCamera=XEO.Component.extend({type:"XEO.KeyboardOrbitCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._children.camera;if(d){var e=a.deltaTime,f=50,g=50;if(!b.ctrlDown&&!b.altDown){var h=b.keyDown[b.KEY_LEFT_ARROW],i=b.keyDown[b.KEY_RIGHT_ARROW],j=b.keyDown[b.KEY_UP_ARROW],k=b.keyDown[b.KEY_DOWN_ARROW];if(h||i||j||k){var l=0,m=0;i?l=-e*f:h&&(l=e*f),k?m=e*g:j&&(m=-e*g),Math.abs(l)>Math.abs(m)?m=0:l=0,0!=l&&d.view.rotateEyeY(l),0!=m&&d.view.rotateEyeX(m)}}}})}else this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.KeyboardPanCamera=XEO.Component.extend({type:"XEO.KeyboardPanCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._children.camera;if(d){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_W],g=b.keyDown[b.KEY_S],h=b.keyDown[b.KEY_A],i=b.keyDown[b.KEY_D],j=b.keyDown[b.KEY_Z],k=b.keyDown[b.KEY_X];if(f||g||h||i||k||j){var l=0,m=0,n=0,o=c.sensitivity;g?m=e*o:f&&(m=-e*o),i?l=e*o:h&&(l=-e*o),k?n=e*o:j&&(n=-e*o),d.view.pan([l,m,n])}}}})}else this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.KeyboardZoomCamera=XEO.Component.extend({type:"XEO.KeyboardZoomCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._children.camera;if(d){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_ADD],g=b.keyDown[b.KEY_SUBTRACT];if(f||g){var h=0,i=15*c.sensitivity;g?h=e*i:f&&(h=-e*i),d.view.zoom(h)}}}})}else null!==this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MouseOrbitCamera=XEO.Component.extend({type:"XEO.MouseOrbitCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=0,f=0,g=!1,h=this;this._onTick=this.scene.on("tick",function(a){var b=h._children.camera;b&&(0!=e&&(b.view.rotateEyeY(-e*h._sensitivity),e=0),0!=f&&(b.view.rotateEyeX(f*h._sensitivity),f=0))}),this._onMouseDown=b.on("mousedown",function(a){!b.mouseDownLeft||b.mouseDownRight||b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?g=!1:(g=!0,c=a[0],d=a[1])}),this._onMouseUp=b.on("mouseup",function(a){g=!1}),this._onMouseMove=b.on("mousemove",function(a){g&&(e+=(a[0]-c)*h._sensitivity,f+=(a[1]-d)*h._sensitivity,c=a[0],d=a[1])})}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MousePanCamera=XEO.Component.extend({type:"XEO.MousePanCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a?.03*a:.03,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=0,f=0,g=!1,h=this;this._onTick=this.scene.on("tick",function(){var a=h._children.camera;a&&(0!=e||0!=f)&&(a.view.pan([e,f,0]),e=0,f=0)}),this._onMouseDown=b.on("mousedown",function(a){b.mouseDownLeft&&b.mouseDownRight||b.mouseDownLeft&&b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?(c=a[0],d=a[1],g=!0):g=!1}),this._onMouseUp=b.on("mouseup",function(){g=!1}),this._onMouseMove=b.on("mousemove",function(a){g&&(e+=(a[0]-c)*h.sensitivity,f+=(a[1]-d)*h.sensitivity,c=a[0],d=a[1])})}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MousePickObject=XEO.Component.extend({type:"XEO.MousePickObject",_init:function(a){this.rayPick=a.rayPick,this.active=a.active!==!1},_props:{active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onMouseUp=b.on("dblclick",function(a){var b=c.scene.pick(a,{rayPick:c._rayPick});b?c.fire("pick",b):c.fire("nopick",{canvasPos:a})})}else b.off(this._onMouseDown),b.off(this._onMouseUp);this.fire("active",this._active=a)}},get:function(){return this._active}},rayPick:{set:function(a){a=!!a,this._rayPick!==a&&(this._dirty=!1,this.fire("rayPick",this._rayPick=a))},get:function(){return this._rayPick}}},_getJSON:function(){var a={rayPick:this._rayPick,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MouseZoomCamera=XEO.Component.extend({type:"XEO.MouseZoomCamera",_init:function(a){this._onTick=null,this._onMouseWheel=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){if(a){var b=0,c=0,d=!1,e=!1,f=0,g=XEO.math.vec3(),h=XEO.math.vec3(),i=XEO.math.vec3(),j=this;this._onMouseWheel=this.scene.input.on("mousewheel",function(a){b=a,0===b?(e=!1,d=!1):d=!0}),this._onTick=this.scene.on("tick",function(){var a=j._children.camera;if(a){var k=a.view.eye,l=a.view.look;g[0]=k[0],g[1]=k[1],g[2]=k[2],h[0]=l[0],h[1]=l[1],h[2]=l[2],XEO.math.subVec3(g,h,i);var m=Math.abs(XEO.math.lenVec3(i)),n=1e3,o=j._sensitivity*(2+m/n);d&&(c=b*o,f=0,d=!1,e=!0),e&&(b>0?(f+=.2*o,f>c&&(e=!1)):0>b&&(f-=.2*o,c>f&&(e=!1)),e&&a.view.zoom(f))}})}else null!==this._onTick&&(this.scene.off(this._onTick),this.scene.input.off(this._onMouseWheel));this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.Lights=XEO.Component.extend({type:"XEO.Lights",_init:function(a){this._state=new XEO.renderer.Lights({lights:[],hash:""}),this._dirty=!0,this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],this.lights=a.lights},_props:{lights:{set:function(a){function b(){g.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=g._lights.length;c>b;b++)if(g._lights[b].id===a)return g._lights=g._lights.slice(b,b+1),g._dirtySubs=g._dirtySubs.slice(b,b+1),g._destroyedSubs=g._destroyedSubs.slice(b,b+1),g._dirty=!0,g.fire("dirty",!0),void g.fire("lights",g._lights)}a=a||[];for(var d,e=0,f=this._lights.length;f>e;e++)d=this._lights[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];for(var g=this,e=0,f=a.length;f>e;e++){if(d=a[e],XEO._isNumeric(d)||XEO._isString(d)){var h=d;if(d=this.scene.components[h],!d){this.error("Component not found: "+XEO._inQuotes(h));continue}}var i=d.type;"XEO.AmbientLight"===i||"XEO.DirLight"==i||"XEO.PointLight"==i?(this._lights.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+XEO._inQuotes(d.id)+" is not an XEO.AmbientLight, XEO.DirLight or XEO.PointLight ")}this._dirty=!0,this.fire("dirty",!0),this.fire("lights",this._lights)},get:function(){return this._lights.slice(0,this._lights.length)}}},_compile:function(){var a=this._state;if(this._dirty){a.lights=[];for(var b=0,c=this._lights.length;c>b;b++)a.lights.push(this._lights[b]._state);this._makeHash(),this._dirty=!1}this._renderer.lights=a},_makeHash:function(){var a=this._state.lights;if(0===a.length)return";";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b.type),c.push("world"===b.space?"w":"v");c.push(";"),this._state.hash=c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._lights.length;c>b;b++)a.push(this._lights[b].id);return{lights:a}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.AmbientLight=XEO.Component.extend({type:"XEO.AmbientLight",_init:function(a){this._state={type:"ambient",color:[.7,.7,.7],intensity:1},this.color=a.color,this.intensity=a.intensity},_props:{color:{set:function(a){this._state.color=a||[.7,.7,.8],this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){this._state.intensity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}},_getJSON:function(){return{color:this._state.color,intensity:this._state.intensity}}})}(),function(){"use strict";XEO.DirLight=XEO.Component.extend({type:"XEO.DirLight",_init:function(a){this._state={type:"dir",dir:[0,0,-1],color:[.7,.7,.8],intensity:1,space:"view"},this.dir=a.dir,this.color=a.color,this.intensity=a.intensity,this.space=a.space},_props:{dir:{set:function(a){a=a||[1,1,1];var b=this._state.dir;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._renderer.imageDirty=!0,this.fire("dir",b)},get:function(){return this._state.dir}},color:{set:function(a){a=a||[.7,.7,.8];var b=this._state.color;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._renderer.imageDirty=!0,this.fire("color",b)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,dir:this._state.dir,color:this._state.color,intensity:this._state.intensity,space:this._state.space}}})}(),function(){"use strict";XEO.PointLight=XEO.Component.extend({type:"XEO.PointLight",_init:function(a){this._state={type:"point",pos:[1,1,1],color:[.7,.7,.8],intensity:1,attenuation:[0,0,0],space:"view"},this.pos=a.pos,this.color=a.color,this.intensity=a.intensity,this.constantAttenuation=a.constantAttenuation,this.linearAttenuation=a.linearAttenuation,this.quadraticAttenuation=a.quadraticAttenuation,this.space=a.space},_props:{pos:{set:function(a){this._state.pos=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},color:{set:function(a){this._state.color=a||[.7,.7,.8],this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty=!0,this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty=!0,this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",this._state.attenuation[2]);
},get:function(){return this._state.attenuation[2]}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,pos:this._state.pos,color:this._state.color,intensity:this._state.intensity,constantAttenuation:this._state.attenuation[0],linearAttenuation:this._state.attenuation[1],quadraticAttenuation:this._state.attenuation[2],space:this._state.space}}})}(),function(){"use strict";XEO.Material=XEO.Component.extend({type:"XEO.Material",_init:function(a){}})}(),function(){"use strict";XEO.PhongMaterial=XEO.Material.extend({type:"XEO.PhongMaterial",_init:function(a){this._state=new XEO.renderer.PhongMaterial({type:"phongMaterial",ambient:[.7,.7,.8],diffuse:[1,1,1],specular:[1,1,1],emissive:[0,0,0],opacity:1,shininess:30,reflectivity:1,normalMap:null,diffuseMap:null,specularMap:null,emissiveMap:null,opacityMap:null,reflectivityMap:null,diffuseFresnel:null,specularFresnel:null,emissiveFresnel:null,opacityFresnel:null,reflectivityFresnel:null,hash:null}),this._dirty=!0,this._components=[],this._dirtyComponentSubs=[],this._destroyedComponentSubs=[],this.ambient=a.ambient,this.diffuse=a.diffuse,this.specular=a.specular,this.emissive=a.emissive,this.opacity=a.opacity,this.shininess=a.shininess,this.reflectivity=a.reflectivity,this.normalMap=a.normalMap,this.diffuseMap=a.diffuseMap,this.specularMap=a.specularMap,this.emissiveMap=a.emissiveMap,this.opacityMap=a.opacityMap,this.reflectivityMap=a.reflectivityMap,this.diffuseFresnel=a.diffuseFresnel,this.specularFresnel=a.specularFresnel,this.emissiveFresnel=a.emissiveFresnel,this.opacityFresnel=a.opacityFresnel,this.reflectivityFresnel=a.reflectivityFresnel},_props:{ambient:{set:function(a){this._state.ambient=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("ambient",this._state.ambient)},get:function(){return this._state.ambient}},diffuse:{set:function(a){this._state.diffuse=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("diffuse",this._state.diffuse)},get:function(){return this._state.diffuse}},specular:{set:function(a){this._state.specular=a||[.3,.3,.3],this._renderer.imageDirty=!0,this.fire("specular",this._state.specular)},get:function(){return this._state.specular}},emissive:{set:function(a){this._state.emissive=a||[0,0,0],this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},opacity:{set:function(a){this._state.opacity=void 0!==a||null!==a?a:1,this._renderer.imageDirty=!0,this.fire("opacity",this._state.opacity)},get:function(){return this._state.opacity}},shininess:{set:function(a){this._state.shininess=void 0!==a?a:30,this._renderer.imageDirty=!0,this.fire("shininess",this._state.shininess)},get:function(){return this._state.shininess}},reflectivity:{set:function(a){this._state.reflectivity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("reflectivity",this._state.reflectivity)},get:function(){return this._state.reflectivity}},normalMap:{set:function(a){this._attachComponent("normalMap",a)},get:function(){return this._components.normalMap}},diffuseMap:{set:function(a){this._attachComponent("diffuseMap",a)},get:function(){return this._components.diffuseMap}},specularMap:{set:function(a){this._attachComponent("specularMap",a)},get:function(){return this._components.specularMap}},emissiveMap:{set:function(a){this._attachComponent("emissiveMap",a)},get:function(){return this._components.emissiveMap}},opacityMap:{set:function(a){this._attachComponent("opacityMap",a)},get:function(){return this._components.opacityMap}},reflectivityMap:{set:function(a){this._attachComponent("reflectivityMap",a)},get:function(){return this._components.reflectivityMap}},diffuseFresnel:{set:function(a){this._attachComponent("diffuseFresnel",a)},get:function(){return this._components.diffuseFresnel}},specularFresnel:{set:function(a){this._attachComponent("specularFresnel",a)},get:function(){return this._components.specularFresnel}},emissiveFresnel:{set:function(a){this._attachComponent("emissiveFresnel",a)},get:function(){return this._components.emissiveFresnel}},opacityFresnel:{set:function(a){this._attachComponent("opacityFresnel",a)},get:function(){return this._components.opacityFresnel}},reflectivityFresnel:{set:function(a){this._attachComponent("reflectivityFresnel",a)},get:function(){return this._components.reflectivityFresnel}}},_attachComponent:function(a,b){if(XEO._isString(b)){var c=b;if(b=this.scene.components[c],!b)return void this.error("Component not found: "+XEO._inQuotes(c))}if(b&&"texture"!==b.type&&"fresnel"!==b.type)return void this.error("Component "+XEO._inQuotes(c)+" is not a XEO.Texture or XEO.Fresnel");var d=this._components[a];d&&(d.off(this._dirtyComponentSubs[a]),d.off(this._destroyedComponentSubs[a]),delete this._components[a]);var e=this;b&&(this._dirtyComponentSubs[a]=b.on("dirty",function(){e.fire("dirty",!0)}),this._destroyedComponentSubs[a]=b.on("destroyed",function(){delete e._dirtyComponentSubs[a],delete e._destroyedComponentSubs[a],e._dirty=!0,e.fire("dirty",!0),e.fire(a,null)}),this._components[a]=b),this._state[a]=b?b._state:null,this._dirty=!0,this.fire(a,b||null)},_compile:function(){this._dirty&&(this._makeHash(),this._dirty=!1),this._renderer.material=this._state},_makeHash:function(){var a=this._state,b=["/p"];a.normalMap&&(b.push("/b"),a.normalMap.matrix&&b.push("/mat")),a.diffuseMap&&(b.push("/d"),a.diffuseMap.matrix&&b.push("/mat")),a.specularMap&&(b.push("/s"),a.specularMap.matrix&&b.push("/mat")),a.emissiveMap&&(b.push("/e"),a.emissiveMap.matrix&&b.push("/mat")),a.opacityMap&&(b.push("/o"),a.opacityMap.matrix&&b.push("/mat")),a.reflectivityMap&&(b.push("/r"),a.reflectivityMap.matrix&&b.push("/mat")),a.diffuseFresnel&&b.push("/df"),a.specularFresnel&&b.push("/sf"),a.emissiveFresnel&&b.push("/ef"),a.opacityFresnel&&b.push("/of"),a.reflectivityFresnel&&b.push("/rf"),b.push(";"),a.hash=b.join("")},_getJSON:function(){var a={ambient:this._state.ambient,diffuse:this._state.diffuse,specular:this._state.specular,emissive:this._state.emissive,opacity:this._state.opacity,shininess:this._state.shininess,reflectivity:this._state.reflectivity},b=this._components;return b.normalMap&&(a.normalMap=b.normalMap.id),b.diffuseMap&&(a.diffuseMap=b.diffuseMap.id),b.specularMap&&(a.specularMap=b.specularMap.id),b.emissiveMap&&(a.emissiveMap=b.emissiveMap.id),b.opacityMap&&(a.opacityMap=b.opacityMap.id),b.reflectivityMap&&(a.reflectivityMap=b.reflectivityMap.id),b.diffuseFresnel&&(a.diffuseFresnel=b.diffuseFresnel.id),b.specularFresnel&&(a.specularFresnel=b.specularFresnel.id),b.emissiveFresnel&&(a.emissiveFresnel=b.emissiveFresnel.id),b.opacityFresnel&&(a.opacityFresnel=b.opacityFresnel.id),b.reflectivityFresnel&&(a.reflectivityFresnel=b.reflectivityFresnel.id),a},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.PBRMaterial=XEO.Material.extend({type:"XEO.PBRMaterial",_init:function(a){this._state=new XEO.renderer.PBRMaterial({type:"pbrMaterial",metallic:0,color:[1,1,1],colorMap:null,emissive:[1,1,1],emissiveMap:null,opacity:1,opacityMap:null,roughness:0,roughnessMap:null,normalMap:null,specular:[1,1,1],specularMap:null,dirty:!0,hash:null}),this._components=[],this._dirtyComponentSubs=[],this._destroyedComponentSubs=[],this.metallic=a.metallic,this.color=a.color,this.colorMap=a.colorMap,this.emissive=a.emissive,this.emissiveMap=a.emissiveMap,this.opacity=a.opacity,this.opacityMap=a.opacityMap,this.roughness=a.roughness,this.roughnessMap=a.roughnessMap,this.normalMap=a.normalMap,this.specular=a.specular,this.specularMap=a.specularMap},_props:{metallic:{set:function(a){this._state.metallic=void 0!==a?a:0,this._renderer.imageDirty=!0,this.fire("metallic",this._state.metallic)},get:function(){return this._state.metallic}},color:{set:function(a){this._state.color=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},colorMap:{set:function(a){this._attachComponent("colorMap",a)},get:function(){return this._components.colorMap}},emissive:{set:function(a){this._state.emissive=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},emissiveMap:{set:function(a){this._attachComponent("emissiveMap",a)},get:function(){return this._components.emissiveMap}},opacity:{set:function(a){this._state.opacity=void 0!==a||null!==a?a:1,this._renderer.imageDirty=!0,this.fire("opacity",this._state.opacity)},get:function(){return this._state.opacity}},opacityMap:{set:function(a){this._attachComponent("opacityMap",a)},get:function(){return this._components.opacityMap}},roughness:{set:function(a){this._state.roughness=void 0!==a?a:0,this._renderer.imageDirty=!0,this.fire("roughness",this._state.roughness)},get:function(){return this._state.roughness}},roughnessMap:{set:function(a){this._attachComponent("roughnessMap",a)},get:function(){return this._components.roughnessMap}},normalMap:{set:function(a){this._attachComponent("normalMap",a)},get:function(){return this._components.normalMap}},specular:{set:function(a){this._state.specular=a||[.3,.3,.3],this._renderer.imageDirty=!0,this.fire("specular",this._state.specular)},get:function(){return this._state.specular}},specularMap:{set:function(a){this._attachComponent("specularMap",a)},get:function(){return this._components.specularMap}}},_attachComponent:function(a,b){if(XEO._isString(b)){var c=b;if(b=this.scene.components[c],!b)return void this.error("Component not found: "+XEO._inQuotes(c))}if(b&&"XEO.Texture"!==b.type&&"XEO.Fresnel"!==b.type)return void this.error("Component "+XEO._inQuotes(c)+" is not a XEO.Texture or XEO.Fresnel");var d=this._components[a];d&&(d.off(this._dirtyComponentSubs[a]),d.off(this._destroyedComponentSubs[a]),delete this._components[a]);var e=this;b&&(this._dirtyComponentSubs[a]=b.on("dirty",function(){e.fire("dirty",!0)}),this._destroyedComponentSubs[a]=b.on("destroyed",function(){delete e._dirtyComponentSubs[a],delete e._destroyedComponentSubs[a],e._state.dirty=!0,e.fire("dirty",!0),e.fire(a,null)}),this._components[a]=b),this._state[a]=b?b._state:null,this._state.dirty=!0,this.fire(a,b||null)},_compile:function(){this._state.dirty&&(this._makeHash(),this._state.dirty=!1),this._renderer.material=this._state},_makeHash:function(){var a=this._state,b=[];a.colorMap&&(b.push("/c"),a.colorMap.matrix&&b.push("/anim")),a.emissiveMap&&(b.push("/e"),a.emissiveMap.matrix&&b.push("/anim")),a.opacityMap&&(b.push("/o"),a.opacityMap.matrix&&b.push("/anim")),a.roughnessMap&&(b.push("/r"),a.roughnessMap.matrix&&b.push("/anim")),a.normalMap&&(b.push("/b"),a.normalMap.matrix&&b.push("/anim")),b.push(";"),a.hash=b.join("")},_getJSON:function(){var a=this._components,b={};return b.color=this._state.color,a.colorMap&&(b.colorMap=a.colorMap.id),b.emissive=this._state.emissive,a.emissiveMap&&(b.emissiveMap=a.emissiveMap.id),b.opacity=this._state.opacity,a.opacityMap&&(b.opacityMap=a.opacityMap.id),b.roughness=this._state.roughness,a.roughnessMap&&(b.roughnessMap=a.roughnessMap.id),a.normalMap&&(b.normalMap=a.normalMap.id),b.metallic=this._state.metallic,b.specular=this.specular,a.specularMap&&(b.specularMap=a.specularMap.id),b},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Texture=XEO.Component.extend({type:"XEO.Texture",_init:function(a){this._state=new XEO.renderer.Texture({texture:null,matrix:null}),this._src=null,this._image=null,this._target=null,this._translate=[0,0],this._scale=[1,1],this._rotate=[0,0],this._minFilter=null,this._magFilter=null,this._wrapS=null,this._wrapT=null,this._flipY=null,this._dirty=!0,this._matrixDirty=!0,this._srcDirty=!1,this._imageDirty=!1,this._targetDirty=!1,this._propsDirty=!0;var b=this;this._webglContextRestored=this.scene.canvas.on("webglContextRestored",function(){b._state.texture=null,b._matrixDirty=!0,b._propsDirty=!0,b._image?b._imageDirty=!0:b._src?b._srcDirty=!0:b._target&&(b._targetDirty=!0),b._scheduleBuild()}),this.translate=a.translate,this.scale=a.scale,this.rotate=a.rotate,a.src?this.src=a.src:a.image?this.image=a.image:a.target&&(this.target=a.target),this.minFilter=a.minFilter,this.magFilter=a.magFilter,this.wrapS=a.wrapS,this.wrapT=a.wrapT,this.flipY=a.flipY,this.scene.stats.inc("textures")},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick",function(){a._build()})}},_build:function(){var a=this.scene.canvas.gl,b=this._state;if(b.texture||(b.texture=new XEO.renderer.webgl.Texture2D(a)),this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);if(this._imageDirty&&this._image&&(b.texture.setImage(this._image),this._imageDirty=!1),this._targetDirty&&(this._targetDirty=!1),this._matrixDirty){var c,d;(0!==this._translate[0]||0!==this._translate[2])&&(c=XEO.math.translationMat4v([this._translate[0],this._translate[0],0])),(1!==this._scale[0]||1!==this._scale[1])&&(d=XEO.math.scalingMat4v([this._scale[0],this._scale[1],1]),c=c?XEO.math.mulMat4(c,d):d),0!==this._rotate&&(d=XEO.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),c=c?XEO.math.mulMat4(c,d):d),c&&(b.matrix=c),this._matrixDirty=!1}this._propsDirty&&(b.texture.setProps(b),this._propsDirty=!1),this._renderer.imageDirty=!0,this._dirty=!1},_loadSrc:function(a){var b=this.scene.tasks.create({description:"Loading texture"}),c=this,d=new Image;d.onload=function(){c._src===a&&(c._image=XEO.renderer.webgl.ensureImageSizePowerOfTwo(d),c._target=null,c._imageDirty=!1,c._srcDirty=!1,c._targetDirty=!1,c.fire("image",c._image),c._scheduleBuild()),b.setCompleted()},d.onerror=function(){b.setFailed()},0===a.indexOf("data")?d.src=a:(d.crossOrigin="Anonymous",d.src=a)},_props:{image:{set:function(a){this._image=XEO.renderer.webgl.ensureImageSizePowerOfTwo(a),this._src=null,this._target=null,this._imageDirty=!0,this._srcDirty=!1,this._targetDirty=!1,this._scheduleBuild(),this.fire("image",this._image)},get:function(){return this._state.image}},src:{set function(a){this._image=null,this._src=a,this._target=null,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._scheduleBuild(),this.fire("src",this._src)},get function(){return this._src}},target:{set function(a){this._image=null,this._src=null,this._target=this._setChild("renderBuf",a),this._imageDirty=!1,this._srcDirty=!1,this._targetDirty=!0,this._scheduleBuild(),this.fire("target",this._target)},get function(){return this._target}},translate:{set function(a){a=a||[0,0],this._translate=a,this._matrixDirty=!0,this._scheduleBuild(),this.fire("translate",this._translate)},get:function(){return this._translate}},scale:{set:function(a){a=a||[1,1],this._scale=a,this._matrixDirty=!0,this._scheduleBuild(),this.fire("scale",this._scale)},get:function(){return this._scale}},rotate:{set:function(a){a=a||0,this._rotate=a,this._matrixDirty=!0,this._scheduleBuild(),this.fire("rotate",this._rotate)},get:function(){return this._rotate}},minFilter:{set:function(a){a=a||"linearMipMapLinear",this._minFilter=a,this._propsDirty=!0,this._scheduleBuild(),this.fire("minFilter",this._minFilter)},get:function(){return this._minFilter}},magFilter:{set:function(a){a=a||"linear",this._magFilter=a,this._propsDirty=!0,this._scheduleBuild(),this.fire("magFilter",this._magFilter)},get:function(){return this._magFilter}},wrapS:{set:function(a){a=a||"repeat",this._wrapS=a,this._propsDirty=!0,this._scheduleBuild(),this.fire("wrapS",this._wrapS)},get:function(){return this._wrapS}},wrapT:{set:function(a){a=a||"repeat",this._wrapT=a,this._propsDirty=!0,this._scheduleBuild(),this.fire("wrapT",this._wrapT)},get:function(){return this._wrapT}},flipY:{set:function(a){a=a!==!1,this._flipY=a,this._propsDirty=!0,this._scheduleBuild(),this.fire("flipY",this._flipY)},get:function(){return this._flipY}}},_getJSON:function(){var a={translate:this._translate,scale:this._scale,rotate:this._rotate};return"linearMipMapLinear"!=this._minFilter&&(a.minFilter=this._minFilter),"linear"!=this._magFilter&&(a.magFilter=this._magFilter),"repeat"!=this._wrapS&&(a.wrapS=this._wrapS),"repeat"!=this._wrapT&&(a.wrapT=this._wrapT),this._flipY!==!0&&(a.flipY=this._flipY),this._src?a.src=this._src:this._target?a.target=this._target.id:this._image,a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),this.scene.stats.dec("textures")}})}(),function(){"use strict";XEO.Reflect=XEO.Component.extend({type:"XEO.Reflect",_init:function(a){},_compile:function(){this._renderer.reflect=this._state},_getJSON:function(){return{}}})}(),function(){"use strict";XEO.math={vec2:function(){return new Float32Array(2)},vec3:function(){return new Float32Array(3)},vec4:function(){return new Float32Array(4)},mat3:function(){return new Float32Array(9)},mat4:function(){return new Float32Array(16)},createUUID:function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;36>e;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}(),fmod:function(a,b){if(b>a)return console.error("XEO.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;a>=b;)a-=b;return a},negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return XEO.math.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(XEO.math.sqLenVec4(a))},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return XEO.math.dotVec3(a,a)},sqLenVec2:function(a){return XEO.math.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(XEO.math.sqLenVec3(a))},lenVec2:function(a){return Math.sqrt(XEO.math.sqLenVec2(a))},rcpVec3:function(a,b){return XEO.math.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/XEO.math.lenVec4(a);return XEO.math.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/XEO.math.lenVec3(a);return XEO.math.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/XEO.math.lenVec2(a);return XEO.math.mulVec2Scalar(a,c,b)},dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return XEO.math.m4s(0)},setMat4ToOnes:function(){return XEO.math.m4s(1)},diagonalMat4v:function(a){return[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]]},diagonalMat4c:function(a,b,c,d){return XEO.math.diagonalMat4v([a,b,c,d])},diagonalMat4s:function(a){return XEO.math.diagonalMat4c(a,a,a,a)},identityMat4:function(){return XEO.math.diagonalMat4v([1,1,1,1])},isIdentityMat4:function(a){return 1!==a[0]||0!==a[1]||0!==a[2]||0!==a[3]||0!==a[4]||1!==a[5]||0!==a[6]||0!==a[7]||0!==a[8]||0!==a[9]||1!==a[10]||0!==a[11]||0!==a[12]||0!==a[13]||0!==a[14]||1!==a[15]?!1:!0},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return XEO.math.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a===b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a,b){var c=b||XEO.math.identityMat4();return c[12]=a[0],c[13]=a[1],c[14]=a[2],c},translationMat4c:function(a,b,c){return XEO.math.translationMat4v([a,b,c])},translationMat4s:function(a){return XEO.math.translationMat4c(a,a,a)},rotationMat4v:function(a,b){var c,d,e,f,g,h,i=XEO.math.normalizeVec4([b[0],b[1],b[2],0],[]),j=Math.sin(a),k=Math.cos(a),l=1-k,m=i[0],n=i[1],o=i[2];c=m*n,d=n*o,e=o*m,f=m*j,g=n*j,h=o*j;var p=XEO.math.mat4();return p[0]=l*m*m+k,p[1]=l*c+h,p[2]=l*e-g,p[3]=0,p[4]=l*c-h,p[5]=l*n*n+k,p[6]=l*d+f,p[7]=0,p[8]=l*e+g,p[9]=l*d-f,p[10]=l*o*o+k,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},rotationMat4c:function(a,b,c,d){return XEO.math.rotationMat4v(a,[b,c,d])},scalingMat4v:function(a){var b=XEO.math.identityMat4();return b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat4c:function(a,b,c){return XEO.math.scalingMat4v([a,b,c])},scalingMat4s:function(a){return XEO.math.scalingMat4c(a,a,a)},lookAtMat4v:function(a,b,c,d){d||(d=XEO.math.mat4());var e=a[0],f=a[1],g=a[2],h=c[0],i=c[1],j=c[2],k=b[0],l=b[1],m=b[2];if(e===k&&f===l&&g===m)return XEO.math.identityMat4();var n,o,p,q,r,s,t,u,v,w;return n=e-k,o=f-l,p=g-m,w=1/Math.sqrt(n*n+o*o+p*p),n*=w,o*=w,p*=w,q=i*p-j*o,r=j*n-h*p,s=h*o-i*n,w=Math.sqrt(q*q+r*r+s*s),w?(w=1/w,q*=w,r*=w,s*=w):(q=0,r=0,s=0),t=o*s-p*r,u=p*q-n*s,v=n*r-o*q,w=Math.sqrt(t*t+u*u+v*v),w?(w=1/w,t*=w,u*=w,v*=w):(t=0,u=0,v=0),d[0]=q,d[1]=t,d[2]=n,d[3]=0,d[4]=r,d[5]=u,d[6]=o,d[7]=0,d[8]=s,d[9]=v,d[10]=p,d[11]=0,d[12]=-(q*e+r*f+s*g),d[13]=-(t*e+u*f+v*g),d[14]=-(n*e+o*f+p*g),d[15]=1,d},lookAtMat4c:function(a,b,c,d,e,f,g,h,i){return XEO.math.lookAtMat4v([a,b,c],[d,e,f],[g,h,i],[])},orthoMat4c:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2/i,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=-2/j,g[11]=0,g[12]=-(a+b)/h,g[13]=-(d+c)/i,g[14]=-(f+e)/j,g[15]=1,g},frustumMat4v:function(a,b){var c=[a[0],a[1],a[2],0],d=[b[0],b[1],b[2],0],e=XEO.math.mat4();XEO.math.addVec4(d,c,e);var f=XEO.math.mat4();XEO.math.subVec4(d,c,f);var g=2*c[2],h=XEO.math.mat4(),i=f[0],j=f[1],k=f[2];return h[0]=g/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=g/j,h[6]=0,h[7]=0,h[8]=e[0]/i,h[9]=e[1]/j,h[10]=-e[2]/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-g*d[2]/k,h[15]=0,h},frustumMat4:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2*e/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2*e/i,g[6]=0,g[7]=0,g[8]=(b+a)/h,g[9]=(d+c)/i,g[10]=-(f+e)/j,g[11]=-1,g[12]=0,g[13]=0,g[14]=-(f*e*2)/j,g[15]=0,g},perspectiveMatrix4:function(a,b,c,d){var e=[],f=[];return e[2]=c,f[2]=d,f[1]=e[2]*Math.tan(a/2),e[1]=-f[1],f[0]=f[1]*b,e[0]=-f[0],XEO.math.frustumMat4v(e,f)},transformPoint3:function(a,b){var c=b[0],d=b[1],e=b[2];return[a[0]*c+a[4]*d+a[8]*e+a[12],a[1]*c+a[5]*d+a[9]*e+a[13],a[2]*c+a[6]*d+a[10]*e+a[14],a[3]*c+a[7]*d+a[11]*e+a[15]]},transformPoints3:function(a,b,c){for(var d,e,f,g,h=c||[],i=b.length,j=a[0],k=a[1],l=a[2],m=a[3],n=a[4],o=a[5],p=a[6],q=a[7],r=a[8],s=a[9],t=a[10],u=a[11],v=a[12],w=a[13],x=a[14],y=a[15],z=0;i>z;++z)g=b[z],d=g[0],e=g[1],f=g[2],h[z]=[j*d+n*e+r*f+v,k*d+o*e+s*f+w,l*d+p*e+t*f+x,m*d+q*e+u*f+y];return h},transformVec3:function(a,b){var c=b[0],d=b[1],e=b[2];return[a[0]*c+a[4]*d+a[8]*e,a[1]*c+a[5]*d+a[9]*e,a[2]*c+a[6]*d+a[10]*e]},transformVec4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},projectVec4:function(a){var b=1/a[3];return[a[0]*b,a[1]*b,a[2]*b,1]},lerpVec3:function(a,b,c,d,e,f){var g=f||this.vec3(),h=(a-b)/(c-b);return g[0]=d[0]+h*(e[0]-d[0]),g[1]=d[1]+h*(e[1]-d[1]),g[2]=d[2]+h*(e[2]-d[2]),g},getAABBDiag:function(a){var b=this.vec3(),c=this.vec3();b[0]=a.xmin,b[1]=a.ymin,b[2]=a.zmin,c[0]=a.xmax,c[1]=a.ymax,c[2]=a.zmax;var d=this.vec3();return this.subVec3(c,b,d),Math.abs(this.lenVec3(d))},getAABBCenter:function(a,b){var c=b||this.vec3();return c[0]=.5*(a.xmax+a.xmin),c[1]=.5*(a.ymax+a.ymin),c[2]=.5*(a.zmax+a.zmin),c},AABB3ToOBB3:function(a,b){return b=b||[],b[0]||(b[0]=[]),b[0][0]=a.xmin,b[0][1]=a.ymin,b[0][2]=a.zmin,b[1]||(b[1]=[]),b[1][0]=a.xmax,b[1][1]=a.ymin,b[1][2]=a.zmin,b[2]||(b[2]=[]),b[2][0]=a.xmax,b[2][1]=a.ymax,b[2][2]=a.zmin,b[3]||(b[3]=[]),b[3][0]=a.xmin,b[3][1]=a.ymax,b[3][2]=a.zmin,b[4]||(b[4]=[]),b[4][0]=a.xmin,b[4][1]=a.ymin,b[4][2]=a.zmax,b[5]||(b[5]=[]),b[5][0]=a.xmax,b[5][1]=a.ymin,b[5][2]=a.zmax,b[6]||(b[6]=[]),b[6][0]=a.xmax,b[6][1]=a.ymax,b[6][2]=a.zmax,b[7]||(b[7]=[]),b[7][0]=a.xmin,b[7][1]=a.ymax,b[7][2]=a.zmax,b},positions3ToAABB3:function(a,b){b=b||{xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0};for(var c,d,e,f=1e5,g=1e5,h=1e5,i=-1e5,j=-1e5,k=-1e5,l=0,m=a.length;m>l;l+=3)c=a[l+0],d=a[l+1],e=a[l+2],f>c&&(f=c),g>d&&(g=d),h>e&&(h=e),c>i&&(i=c),d>j&&(j=d),e>k&&(k=e);return b.xmin=f,b.ymin=g,b.zmin=h,b.xmax=i,b.ymax=j,b.zmax=k,b},points3ToAABB3:function(a,b){b=b||{xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0};for(var c,d,e,f=1e5,g=1e5,h=1e5,i=-1e5,j=-1e5,k=-1e5,l=0,m=a.length;m>l;l++)c=a[l][0],d=a[l][1],e=a[l][2],f>c&&(f=c),g>d&&(g=d),h>e&&(h=e),c>i&&(i=c),d>j&&(j=d),e>k&&(k=e);return b.xmin=f,b.ymin=g,b.zmin=h,b.xmax=i,b.ymax=j,b.zmax=k,b}}}(),XEO.math.buildNormals=function(a,b){for(var c,d,e,f,g,h,i=new Array(a.length/3),j=0,k=b.length-3;k>j;j+=3){c=b[j+0],d=b[j+1],e=b[j+2],f=[a[3*c+0],a[3*c+1],a[3*c+2]],g=[a[3*d+0],a[3*d+1],a[3*d+2]],h=[a[3*e+0],a[3*e+1],a[3*e+2]],g=XEO.math.subVec4(g,f,[0,0,0,0]),h=XEO.math.subVec4(h,f,[0,0,0,0]);var l=XEO.math.normalizeVec4(XEO.math.cross3Vec4(g,h,[0,0,0,0]),[0,0,0,0]);i[c]||(i[c]=[]),i[d]||(i[d]=[]),i[e]||(i[e]=[]),i[c].push(l),i[d].push(l),i[e].push(l)}for(var m=new Array(a.length),j=0,k=i.length;k>j;j++){for(var n=i[j].length,o=0,p=0,q=0,r=0;n>r;r++)o+=i[j][r][0],p+=i[j][r][1],q+=i[j][r][2];m[3*j+0]=o/n,m[3*j+1]=p/n,m[3*j+2]=q/n}return m},XEO.math.buildTangents=function(a,b,c){for(var d=[],e=0;e<b.length;e+=3){var f=b[e],g=[a[3*f],a[3*f+1],a[3*f+2]],h=[c[2*f],c[2*f+1]];f=b[e+1];var i=[a[3*f],a[3*f+1],a[3*f+2]],j=[c[2*f],c[2*f+1]];f=b[e+2];for(var k=[a[3*f],a[3*f+1],a[3*f+2]],l=[c[2*f],c[2*f+1]],m=XEO.math.subVec3(i,g,[]),n=XEO.math.subVec3(k,g,[]),o=XEO.math.subVec2(j,h,[]),p=XEO.math.subVec2(l,h,[]),q=1/(o[0]*p[1]-o[1]*p[0]),r=XEO.math.mulVec3Scalar(XEO.math.subVec3(XEO.math.mulVec3Scalar(m,p[1],[]),XEO.math.mulVec3Scalar(n,o[1],[]),[]),q,[]),s=0;3>s;s++){var t=b[e+s];"undefined"!=typeof d[t]?d[t]=XEO.math.addVec3(d[t],r,[]):d[t]=r}}for(var u=[],v=0;v<d.length;v++)u=u.concat(d[v]);return u},function(){"use strict";XEO.GameObject=XEO.Component.extend({type:"XEO.GameObject",_init:function(a){this.camera=a.camera,this.clips=a.clips,this.colorTarget=a.colorTarget,this.colorBuf=a.colorBuf,this.depthTarget=a.depthTarget,this.depthBuf=a.depthBuf,this.visibility=a.visibility,
this.modes=a.modes,this.geometry=a.geometry,this.layer=a.layer,this.lights=a.lights,this.material=a.material,this.morphTargets=a.morphTargets,this.reflect=a.reflect,this.shader=a.shader,this.shaderParams=a.shaderParams,this.stage=a.stage,this.transform=a.transform,this._worldBoundary=null,this._viewBoundary=null,this._canvasBoundary=null,this._worldBoundaryDirty=!0,this._viewBoundaryDirty=!0,this._canvasBoundaryDirty=!0},_props:{camera:{set:function(a){this._setWorldBoundaryDirty();var b=this._children.camera;!b||a&&(void 0!==a.id?a.id:a)===b.id||(b.off(this._onCameraDestroyed),b.off(this._onCameraView),b.off(this._onCameraViewMatrix)),this._setChild("camera",a);var c=this._children.camera;if(c){var d=this;this._onCameraView=c.on("view",function(){d._setWorldBoundaryDirty()}),this._onCameraDestroyed=c.on("destroyed",function(){d._setWorldBoundaryDirty()})}},get:function(){return this._children.camera}},clips:{set:function(a){this._setChild("clips",a)},get:function(){return this._children.clips}},colorTarget:{set:function(a){this._setChild("colorTarget",a)},get:function(){return this._children.colorTarget}},colorBuf:{set:function(a){this._setChild("colorBuf",a)},get:function(){return this._children.colorBuf}},depthTarget:{set:function(a){this._setChild("depthTarget",a)},get:function(){return this._children.depthTarget}},depthBuf:{set:function(a){this._setChild("depthBuf",a)},get:function(){return this._children.depthBuf}},visibility:{set:function(a){this._setChild("visibility",a)},get:function(){return this._children.visibility}},modes:{set:function(a){this._setChild("modes",a)},get:function(){return this._children.modes}},geometry:{set:function(a){this._setWorldBoundaryDirty();var b=this._children.geometry;b&&(a&&(void 0!==a.id?a.id:a)==b.id||(b.off(this._onGeometryDirty),b.off(this._onGeometryPositions),b.off(this._onGeometryDestroyed))),this._setChild("geometry",a);var c=this._children.geometry;if(c){var d=this;this._onGeometryDirty=c.on("dirty",function(){d.fire("dirty",!0)}),this._onGeometryPositions=c.on("positions",function(){d._setWorldBoundaryDirty()}),this._onGeometryDestroyed=c.on("destroyed",function(){d._setWorldBoundaryDirty()})}},get:function(){return this._children.geometry}},layer:{set:function(a){this._setChild("layer",a)},get:function(){return this._children.layer}},lights:{set:function(a){this._setChild("lights",a)},get:function(){return this._children.lights}},material:{set:function(a){this._setChild("material",a)},get:function(){return this._children.material}},morphTargets:{set:function(a){this._setChild("morphTargets",a)},get:function(){return this._children.morphTargets}},reflect:{set:function(a){this._setChild("reflect",a)},get:function(){return this._children.reflect}},shader:{set:function(a){this._setChild("shader",a)},get:function(){return this._children.shader}},shaderParams:{set:function(a){this._setChild("shaderParams",a)},get:function(){return this._children.shaderParams}},stage:{set:function(a){this._setChild("stage",a)},get:function(){return this._children.stage}},transform:{set:function(a){this._setWorldBoundaryDirty();var b=this._children.transform;!b||a&&a.id===b.id||(b.off(this._onTransformMatrix),b.off(this._onTransformDestroyed)),this._setChild("transform",a);var c=this._children.transform;if(c){var d=this;this._onTransformMatrix=c.on("matrix",function(){d._setWorldBoundaryDirty()}),this._onTransformDestroyed=c.on("destroyed",function(){d._setWorldBoundaryDirty()})}},get:function(){return this._children.transform}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this;this._worldBoundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return a._worldBoundaryDirty},getOBB:function(){return a._children.geometry.modelBoundary.obb},getMatrix:function(){return a._children.transform.matrix}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null}),this._setWorldBoundaryDirty()}return this._worldBoundary}},viewBoundary:{get:function(){if(!this._viewBoundary){var a=this;this._viewBoundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return a._viewBoundaryDirty},getOBB:function(){return a.worldBoundary.obb},getMatrix:function(){return a._children.camera.view.matrix}}),this._viewBoundary.on("destroyed",function(){a._viewBoundary=null}),this._setViewBoundaryDirty()}return this._viewBoundary}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._viewBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0),this._viewBoundary&&this._viewBoundary.fire("updated",!0)},_setViewBoundaryDirty:function(){this._viewBoundaryDirty=!0,this._viewBoundary&&this._viewBoundary.fire("updated",!0)},_compile:function(){var a=this._children;a.camera._compile(),a.clips._compile(),a.colorTarget._compile(),a.colorBuf._compile(),a.depthTarget._compile(),a.depthBuf._compile(),a.visibility._compile(),a.modes._compile(),a.geometry._compile(),a.layer._compile(),a.lights._compile(),a.material._compile(),a.reflect._compile(),a.shader._compile(),a.shaderParams._compile(),a.stage._compile(),a.transform._compile(),this._renderer.buildObject(this.id)},_getJSON:function(){return{camera:this.camera.id,clips:this.clips.id,colorTarget:this.colorTarget.id,colorBuf:this.colorBuf.id,depthTarget:this.depthTarget.id,depthBuf:this.depthBuf.id,visibility:this.visibility.id,modes:this.modes.id,geometry:this.geometry.id,layer:this.layer.id,lights:this.lights.id,material:this.material.id,reflect:this.reflect.id,shader:this.shader.id,shaderParams:this.shaderParams.id,stage:this.stage.id,transform:this.transform.id}},_destroy:function(){this._children.transform&&(this._children.transform.off(this._onTransformMatrix),this._children.transform.off(this._onTransformDestroyed)),this._children.geometry&&(this._children.geometry.off(this._onGeometryDirty),this._children.geometry.off(this._onGeometryPositions),this._children.geometry.off(this._onGeometryDestroyed)),this._worldBoundary&&this._worldBoundary.destroy(),this._viewBoundary&&this._viewBoundary.destroy(),this._renderer.removeObject(this.id)}})}(),function(){"use strict";XEO.Canvas=XEO.Component.extend({type:"XEO.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(a){if(this.canvas=null,this.gl=null,this.contextAttr=a.contextAttr||{},a.canvas?XEO._isString(a.canvas)?(this.canvas=document.getElementById(a.canvas),this.canvas||(this.error("Canvas element not found: "+XEO._inQuotes(a.canvas)+" - creating default canvas instead."),this._createCanvas())):(this.error("Config 'canvasId' should be a string - creating default canvas instead."),this._createCanvas()):this._createCanvas(),!this.canvas)return void this.error("Faied to create canvas");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this._initWebGL();var b=this;this.canvas.addEventListener("webglcontextlost",function(){b.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){b._initWebGL(),b.gl&&b.fire("webglContextRestored",b.gl)},!1);var c=this.canvas.width,d=this.canvas.height;this._tick=this.scene.on("tick",function(){var a=b.canvas;(a.width!==c||a.height!==d)&&(c=a.width,d=a.height,b.fire("resized",{width:a.width,height:a.height,aspect:a.height/a.width}))}),this.canvas.oncontextmenu=function(a){a.preventDefault()}},_createCanvas:function(){var a="XEO-canvas-"+XEO.math.createUUID(),b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height="100%",d.width="100%",d.padding="0",d.margin="0",d.background="black",d["float"]="left",c.innerHTML+='<canvas id="'+a+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',b.appendChild(c),this.canvas=document.getElementById(a)},_initWebGL:function(){for(var a=0;!this.gl&&a<this._WEBGL_CONTEXT_NAMES.length;a++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[a],this.contextAttr)}catch(b){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0))},_destroy:function(){this.scene.off(this._tick)}})}(),function(){"use strict";XEO.ColorBuf=XEO.Component.extend({type:"XEO.ColorBuf",_init:function(a){this._state=new XEO.renderer.ColorBuf({blendEnabled:!1,colorMask:[!0,!0,!0,!0]}),this.blendEnabled=a.blendEnabled,this.colorMask=a.colorMask},_props:{blendEnabled:{set:function(a){this._state.blendEnabled=a===!0,this._renderer.imageDirty=!0,this.fire("blendEnabled",this._state.blendEnabled)},get:function(){return this._state.blendEnabled}},colorMask:{set:function(a){this._state.colorMask=a||[!0,!0,!0,!0],this._renderer.imageDirty=!0,this.fire("colorMask",this._state.colorMask)},get:function(){return this._state.colorMask}}},_compile:function(){this._renderer.colorBuf=this._state},_getJSON:function(){return{blendEnabled:this._state.blendEnabled,colorMask:this._state.colorMask}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.DepthBuf=XEO.Component.extend({type:"XEO.DepthBuf",_init:function(a){this._state=new XEO.renderer.DepthBuf({clearDepth:null,depthFunc:null,active:null}),this.clearDepth=a.clearDepth,this.depthFunc=a.depthFunc,this.active=a.active},_props:{clearDepth:{set:function(a){this._state.clearDepth=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("clearDepth",this._state.clearDepth)},get:function(){return this._state.clearDepth}},depthFunc:{set:function(a){a=a||"less";var b=this._depthFuncNames[a];void 0===b&&(this.error("Unsupported value for 'clearFunc': '"+a+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal. Defaulting to 'less'."),b="less"),this._state.depthFunc=this.scene.canvas.gl[b],this._state.depthFuncName=a,this._renderer.imageDirty=!0,this.fire("depthFunc",this._state.depthFuncName)},get:function(){return this._state.depthFuncName}},active:{set:function(a){this._state.active!==a&&(this._state.active=a,this.fire("active",this._state.active))},get:function(){return this._state.active}}},_depthFuncNames:{less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},_compile:function(){this._renderer.depthBuf=this._state},_getJSON:function(){return{clearDepth:this._state.clearDepth,depthFunc:this._state.depthFuncName,active:this._state.active}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Layer=XEO.Component.extend({type:"XEO.Layer",_init:function(a){this._state=new XEO.renderer.Layer({priority:0}),this.priority=a.priority},_props:{priority:{set:function(a){this._state.priority=a||0,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority)},get:function(){return this._state.priority}}},_compile:function(){this._renderer.layer=this._state},_getJSON:function(){return{priority:this._state.priority}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.ColorTarget=XEO.Component.extend({type:"XEO.ColorTarget",_init:function(){var a=this.scene.canvas;this._state=new XEO.renderer.RenderTarget({type:XEO.renderer.RenderTarget.COLOR,renderBuf:new XEO.renderer.webgl.RenderBuffer({canvas:a.canvas,gl:a.gl})});var b=this;this._webglContextRestored=a.on("webglContextRestored",function(){b._state.renderBuf.webglRestored(a.gl)})},_compile:function(){this._renderer.colorTarget=this._state},_getJSON:function(){return{}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";XEO.DepthTarget=XEO.Component.extend({type:"XEO.DepthTarget",_init:function(){var a=this.scene.canvas;this._state=new XEO.renderer.RenderTarget({type:XEO.renderer.RenderTarget.DEPTH,renderBuf:new XEO.renderer.webgl.RenderBuffer({canvas:a.canvas,gl:a.gl})});var b=this;this._webglContextRestored=a.on("webglContextRestored",function(){b._state.renderBuf.webglRestored(a.gl)})},_compile:function(){this._renderer.depthTarget=this._state},_getJSON:function(){return{}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";XEO.Modes=XEO.Component.extend({type:"XEO.Modes",_init:function(a){this._state=new XEO.renderer.Modes({picking:!0,clipping:!0,transparent:!1,backfaces:!1,frontface:!0}),this.picking=a.picking,this.clipping=a.clipping,this.transparent=a.transparent,this.backfaces=a.backfaces,this.frontface=a.frontface},_props:{picking:{set:function(a){this._state.picking=a!==!1,this._renderer.drawListDirty=!0,this.fire("picking",this._state.picking)},get:function(){return this._state.picking}},clipping:{set:function(a){this._state.clipping=a!==!1,this._renderer.imageDirty=!0,this.fire("clipping",this._state.clipping)},get:function(){return this._state.clipping}},transparent:{set:function(a){this._state.transparent=!!a,this._renderer.stateOrderDirty=!0,this.fire("transparent",this._state.transparent)},get:function(){return this._state.transparent}},backfaces:{set:function(a){this._state.backfaces=a!==!1,this._renderer.imageDirty=!0,this.fire("backfaces",this._state.backfaces)},get:function(){return this._state.backfaces}},frontface:{set:function(a){this._state.frontface="cw"!==a,this._renderer.imageDirty=!0,this.fire("frontface",this._state.frontface?"ccw":"cw")},get:function(){return this._state.frontface?"ccw":"cw"}}},_compile:function(){this._renderer.modes=this._state},_getJSON:function(){return{picking:this._state.picking,clipping:this._state.clipping,transparent:this._state.transparent,backfaces:this._state.backfaces,frontface:this._state.frontface}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Shader=XEO.Component.extend({type:"XEO.Shader",_init:function(a){this._state=new XEO.renderer.Shader({vertex:null,fragment:null,params:{}}),this.vertex=a.vertex,this.fragment=a.fragment,this.setParams(a.params)},_props:{vertex:{set:function(a){this._state.vertex=a,this.fire("dirty",!0),this.fire("vertex",this._state.vertex)},get:function(){return this._state.vertex}},fragment:{set:function(a){this._state.fragment=a,this.fire("dirty",!0),this.fire("fragment",this._state.fragment)},get:function(){return this._state.fragment}},params:{get:function(){return this._state.params}}},setParams:function(a){for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shader=this._state},_getJSON:function(){var a={params:this._state.params};return this._state.vertex&&(a.vertex=this._state.vertex),this._state.fragment&&(a.fragment=this._state.fragment),a}})}(),function(){"use strict";XEO.ShaderParams=XEO.Component.extend({type:"XEO.ShaderParams",_init:function(a){this._state=new XEO.renderer.ShaderParams({params:{}}),this.setParams(a.params)},_props:{params:{get:function(){return this._state.params}}},setParams:function(a){for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shaderParams=this._state},_getJSON:function(){return{params:this._state.params}}})}(),function(){"use strict";XEO.Stage=XEO.Component.extend({type:"XEO.Stage",_init:function(a){this._state=new XEO.renderer.Stage({priority:0,pickable:!0}),this.priority=a.priority,this.pickable=a.pickable},_props:{priority:{set:function(a){this._state.priority=a||0,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority)},get:function(){return this._state.priority}},pickable:{set:function(a){this._state.pickable=a!==!1,this._renderer.drawListDirty=!0,this.fire("pickable",this._state.pickable)},get:function(){return this._state.pickable}}},_compile:function(){this._renderer.stage=this._state},_getJSON:function(){return{priority:this.priority,pickable:this.pickable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.Renderer=function(a){this._canvas=a.canvas,this._programFactory=new XEO.renderer.ProgramFactory({canvas:a.canvas}),this._objectFactory=new XEO.renderer.ObjectFactory,this._chunkFactory=new XEO.renderer.ChunkFactory,this.transparent=a.transparent===!0,this._objects={},this._ambientColor=[0,0,0,1],this._objectList=[],this._objectListLen=0,this._drawList=[],this._drawListLen=0,this._pickDrawList=[],this._pickDrawListLen=0,this._frameCtx={pickObjects:[],canvas:this._canvas},this.visibility=null,this.modes=null,this.layer=null,this.stage=null,this.depthBuf=null,this.colorBuf=null,this.lights=null,this.material=null,this.reflect=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.colorTarget=null,this.depthTarget=null,this.clips=null,this.morphTargets=null,this.shader=null,this.shaderParams=null,this.geometry=null,this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.drawListDirty=!0,this.imageDirty=!0,this.pickBufDirty=!0,this.rayPickBufDirty=!0},XEO.renderer.Renderer.prototype.webglRestored=function(){this._programFactory.webglRestored(),this._chunkFactory.webglRestored();var a=this._canvas.gl;this.pickBuf&&this.pickBuf.webglRestored(a),this.rayPickBuf&&this.rayPickBuf.webglRestored(a),this.imageDirty=!0},XEO.renderer.Renderer.prototype.buildObject=function(a){var b=this._objects[a];b||(b=this._objects[a]=this._objectFactory.get(a),this.objectListDirty=!0),b.stage=this.stage,b.layer=this.layer,b.colorTarget=this.colorTarget,b.depthTarget=this.depthTarget,b.material=this.material,b.reflect=this.reflect,b.geometry=this.geometry,b.visibility=this.visibility,b.modes=this.modes;var c=[this.geometry.hash,this.shader.hash,this.clips.hash,this.material.hash,this.lights.hash].join(";");b.program&&c===b.hash||(b.program&&this._programFactory.put(b.program),b.program=this._programFactory.get(c,this),b.hash=c),this._setChunk(b,0,"program"),this._setChunk(b,1,"modelTransform",this.modelTransform),this._setChunk(b,2,"viewTransform",this.viewTransform),this._setChunk(b,3,"projTransform",this.projTransform),this._setChunk(b,4,"modes",this.modes),this._setChunk(b,5,"shader",this.shader),this._setChunk(b,6,"shaderParams",this.shaderParams),this._setChunk(b,7,"depthBuf",this.depthBuf),this._setChunk(b,8,"colorBuf",this.colorBuf),this._setChunk(b,9,"lights",this.lights),this._setChunk(b,10,this.material.type,this.material),this._setChunk(b,11,"clips",this.clips),this._setChunk(b,12,"geometry",this.geometry),this._setChunk(b,13,"draw",this.geometry),this.stateOrderDirty=!0},XEO.renderer.Renderer.prototype._setChunk=function(a,b,c,d){var e=a.chunks[b];return e?void e.init(e.id,a,a.program,d):(a.chunks[b]=this._chunkFactory.getChunk(c,a,a.program,d),void("lights"===c&&this._setAmbient(d)))},XEO.renderer.Renderer.prototype._setAmbient=function(a){for(var b,c=a.lights,d=0,e=c.length;e>d;d++)b=c[d],"ambient"===b.type&&(this._ambientColor[0]=b.color[0],this._ambientColor[1]=b.color[1],this._ambientColor[2]=b.color[2])},XEO.renderer.Renderer.prototype.removeObject=function(a){var b=this._objects[a];b&&(this._programFactory.put(b.program),b.program=null,b.hash=null,this._objectFactory.put(b),delete this._objects[a],this.objectListDirty=!0)},XEO.renderer.Renderer.prototype.render=function(a){a=a||{},this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.drawListDirty=!0),this.drawListDirty&&(this._buildDrawList(),this.imageDirty=!0),(this.imageDirty||a.force)&&(this._doDrawList({clear:a.clear!==!1}),this.imageDirty=!1,this.pickBufDirty=!0)},XEO.renderer.Renderer.prototype._buildObjectList=function(){this._objectListLen=0;for(var a in this._objects)this._objects.hasOwnProperty(a)&&(this._objectList[this._objectListLen++]=this._objects[a])},XEO.renderer.Renderer.prototype._makeStateSortKeys=function(){for(var a,b=0,c=this._objectListLen;c>b;b++)a=this._objectList[b],a.program?a.sortKey=1e12*(a.stage.priority+1)+1e9*(a.modes.transparent?2:1)+1e6*(a.layer.priority+1)+1e3*(a.program.id+1)+a.material.id:a.sortKey=-1},XEO.renderer.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(function(a,b){return a.sortKey-b.sortKey})},XEO.renderer.Renderer.prototype._logObjectList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._objectListLen+" objects");for(var a=0,b=this._objectListLen;b>a;a++){var c=this._objectList[a];console.log("XEO.Renderer : object["+a+"] sortKey = "+c.sortKey)}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype._buildDrawList=function(){this._lastChunkId=this._lastChunkId||[],this._lastPickChunkId=this._lastPickChunkId||[];for(var a=0;20>a;a++)this._lastChunkId[a]=null,this._lastPickChunkId[a]=null;this._drawListLen=0,this._pickDrawListLen=0;var b,c,d,e={},f=[],g=[];this._objectDrawList=this._objectDrawList||[],this._objectDrawListLen=0;for(var a=0,h=this._objectListLen;h>a;a++)b=this._objectList[a],b.visibility.visible!==!1&&(b.colorTarget||b.depthTarget?(b.colorTarget&&(c=b.colorTarget,d=e[c.id],d||(d=[],e[c.id]=d,f.push(d),g.push(this._chunkFactory.getChunk("renderTarget",b,b.program,c))),d.push(b)),b.depthTarget&&(c=b.colorTarget,d=e[c.id],d||(d=[],e[c.id]=d,f.push(d),g.push(this._chunkFactory.getChunk("renderTarget",b,b.program,c))),d.push(b))):this._objectDrawList[this._objectDrawListLen++]=b);for(var i,a=0,h=f.length;h>a;a++){d=f[a],c=g[a],this._appendRenderTargetChunk(c);for(var j=0,k=d.length;k>j;j++)b=d[j],i=b.stage&&b.stage.pickable,this._appendObjectToDrawLists(b,i)}b&&this._appendRenderTargetChunk(this._chunkFactory.getChunk("renderTarget",b,b.program,{}));for(var a=0,h=this._objectDrawListLen;h>a;a++)b=this._objectDrawList[a],i=!b.stage||b.stage&&b.stage.pickable,this._appendObjectToDrawLists(b,i);this.drawListDirty=!1},XEO.renderer.Renderer.prototype._appendRenderTargetChunk=function(a){this._drawList[this._drawListLen++]=a},XEO.renderer.Renderer.prototype._appendObjectToDrawLists=function(a,b){for(var c,d=a.chunks,e=a.modes.picking,f=0,g=d.length;g>f;f++)c=d[f],c&&(c.draw&&(c.unique||this._lastChunkId[f]!==c.id)&&(this._drawList[this._drawListLen++]=c,this._lastChunkId[f]=c.id),c.pick&&b!==!1&&e&&(c.unique||this._lastPickChunkId[f]!==c.id)&&(this._pickDrawList[this._pickDrawListLen++]=c,this._lastPickChunkId[f]=c.id))},XEO.renderer.Renderer.prototype._logDrawList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._drawListLen+" draw list chunks");for(var a=0,b=this._drawListLen;b>a;a++){var c=this._drawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" type = renderTarget")}}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype._logPickList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._pickDrawListLen+" pick list chunks");for(var a=0,b=this._pickDrawListLen;b>a;a++){var c=this._pickDrawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" type = renderTarget")}}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype.pick=function(a){var b=this._canvas.canvas,c=null,d=a.canvasPos[0],e=a.canvasPos[1],f=this.pickBuf;f||(f=new XEO.renderer.webgl.RenderBuffer({gl:this._canvas.gl,canvas:this._canvas}),this.pickBuf=f,this.pickBufDirty=!0),this.render(),f.bind(),this.pickBufDirty&&(f.clear(),this._doDrawList({pick:!0,clear:!0}),this._canvas.gl.finish(),this.pickBufDirty=!1,this.rayPickBufDirty=!0);var g=f.read(d,e),h=g[0]+256*g[1]+65536*g[2],i=h>=1?h-1:-1;f.unbind();var j=this._frameCtx.pickObjects[i];if(j&&(c={object:j,canvasPos:[d,e]},a.rayPick)){var k=this.rayPickBuf;k||(k=new XEO.renderer.webgl.RenderBuffer({gl:this._canvas.gl,canvas:this._canvas}),this.rayPickBuf=k,this.rayPickBufDirty=!0),k.bind(),this.rayPickBufDirty&&(k.clear(),this._doDrawList({object:j,pick:!0,rayPick:!0,clear:!0}),this.rayPickBufDirty=!1),g=k.read(d,e),k.unbind();var l=this._unpackDepth(g),m=b.width,n=b.height,o=(d-m/2)/(m/2),p=-(e-n/2)/(n/2),q=this._frameCtx.projMatrix,r=this._frameCtx.viewMatrix,s=XEO.math.mulMat4(q,r,[]),t=XEO.math.inverseMat4(s,[]),u=XEO.math.transformVec4(t,[o,p,-1,1]);u=XEO.math.mulVec4Scalar(u,1/u[3]);var v=XEO.math.transformVec4(t,[o,p,1,1]);v=XEO.math.mulVec4Scalar(v,1/v[3]);var w=XEO.math.subVec3(v,u,[]),x=XEO.math.addVec3(u,XEO.math.mulVec4Scalar(w,l,[]),[]);c.worldPos=x}return c},XEO.renderer.Renderer.prototype._unpackDepth=function(a){var b=[a[0]/256,a[1]/256,a[2]/256,a[3]/256],c=[1/16777216,1/65536,1/256,1];return XEO.math.dotVec4(b,c)},XEO.renderer.Renderer.prototype._doDrawList=function(a){var b=this._canvas.gl,c=this._frameCtx;if(c.pick=!!a.pick,c.rayPick=!!a.rayPick,c.renderTarget=null,c.renderBuf=null,c.viewMatrix=null,c.projMatrix=null,c.depthbufEnabled=null,c.clearDepth=null,c.depthFunc=b.LESS,c.blendEnabled=!1,c.backfaces=!0,c.frontface=!0,c.pickIndex=0,c.textureUnit=0,c.lineWidth=1,c.transparent=!1,c.ambientColor=this._ambientColor,b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),b.enable(b.DEPTH_TEST),this.transparent?b.clearColor(0,0,0,0):b.clearColor(this._ambientColor[0],this._ambientColor[1],this._ambientColor[2],1),a.clear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT),b.frontFace(b.CCW),b.disable(b.CULL_FACE),b.disable(b.BLEND),a.pick)if(a.object);else for(var d=0,e=this._pickDrawListLen;e>d;d++)this._pickDrawList[d].pick(c);else for(var d=0,e=this._drawListLen;e>d;d++)this._drawList[d].draw(c);b.flush(),c.renderBuf},XEO.renderer.Renderer.prototype.destroy=function(){this._programFactory.destroy()}}(),function(){"use strict";XEO.renderer=XEO.renderer||{};var a=new XEO.utils.Map({});XEO.renderer.State=Class.extend({__init:function(b){this.id=a.addItem({}),this.hash=b.hash||""+this.id;for(var c in b)b.hasOwnProperty(c)&&(this[c]=b[c])},destroy:function(){a.removeItem(this.id)}}),XEO.renderer.Visibility=XEO.renderer.State.extend({}),XEO.renderer.Modes=XEO.renderer.State.extend({}),XEO.renderer.Layer=XEO.renderer.State.extend({}),XEO.renderer.Stage=XEO.renderer.State.extend({}),XEO.renderer.DepthBuf=XEO.renderer.State.extend({}),XEO.renderer.ColorBuf=XEO.renderer.State.extend({}),XEO.renderer.Lights=XEO.renderer.State.extend({}),XEO.renderer.PhongMaterial=XEO.renderer.State.extend({}),XEO.renderer.Reflect=XEO.renderer.State.extend({}),XEO.renderer.ModelTransform=XEO.renderer.State.extend({}),XEO.renderer.ViewTransform=XEO.renderer.State.extend({}),XEO.renderer.ProjTransform=XEO.renderer.State.extend({}),XEO.renderer.RenderTarget=XEO.renderer.State.extend({}),XEO.renderer.RenderTarget.DEPTH=0,XEO.renderer.RenderTarget.COLOR=1,XEO.renderer.Clips=XEO.renderer.State.extend({}),XEO.renderer.MorphTargets=XEO.renderer.State.extend({}),XEO.renderer.Shader=XEO.renderer.State.extend({}),XEO.renderer.ShaderParams=XEO.renderer.State.extend({}),XEO.renderer.Geometry=XEO.renderer.State.extend({})}(),function(){"use strict";XEO.renderer.Object=function(a){this.id=a,this.hash=null,this.sortKey=null,this.chunks=[],this.chunksLen=0,this.program=null,this.stage=null,this.modes=null,this.layer=null,this.material=null}}(),function(){"use strict";XEO.renderer.ObjectFactory=function(){var a=[],b=0;this.get=function(c){var d;return b>0?(d=a[--b],d.id=c,d):new XEO.renderer.Object(c)},this.put=function(c){a[b++]=c}}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.Program=function(a,b,c,d){this.id=a,this.hash=c.hash,this.source=c,this.gl=d,this.draw=null,this.pick=null,this.useCount=0,this.build(d)},XEO.renderer.Program.prototype.build=function(a){this.gl=a,this.draw=new XEO.renderer.webgl.Program(a,this.source.drawVertex,this.source.drawFragment),this.pick=new XEO.renderer.webgl.Program(a,this.source.pickVertex,this.source.pickFragment)}}(),function(){"use strict";XEO.renderer.ProgramFactory=function(a){this._canvas=a.canvas,this._programs={},this._nextProgramId=0},XEO.renderer.ProgramFactory.prototype.get=function(a,b){var c=this._programs[a];if(!c){var d=XEO.renderer.ProgramSourceFactory.getSource(a,b);c=new XEO.renderer.Program(this._nextProgramId++,a,d,this._canvas.gl),this._programs[a]=c}return c.useCount++,c},XEO.renderer.ProgramFactory.prototype.put=function(a){--a.useCount<=0&&(a.draw.destroy(),a.pick.destroy(),XEO.renderer.ProgramSourceFactory.putSource(a.hash),this._programs[a.hash]=null)},XEO.renderer.ProgramFactory.prototype.webglRestored=function(){var a=this._canvas.gl;for(var b in this._programs)this._programs.hasOwnProperty(b)&&this._programs[b].build(a)},XEO.renderer.ProgramFactory.prototype.destroy=function(){}}(),function(){"use strict";XEO.renderer.ProgramSource=function(a,b,c,d,e){this.hash=a,this.pickVertex=b,this.pickFragment=c,this.drawVertex=d,this.drawFragment=e,this.useCount=0}}(),function(){"use strict";XEO.renderer.ProgramSourceFactory=new function(){function a(){if(!n.geometry.uv)return!1;var a=n.material;return"phongMaterial"===a.type&&(a.diffuseMap||a.specularMap||a.emissiveMap||a.opacityMap||a.reflectivityMap)?!0:!1}function b(a){return!1}function c(){return n.geometry.normals?!0:!1}function d(){return!1}function e(){return!!n.depthTarget}function f(){return j(),k("attribute vec3 xeo_aPosition;"),k("uniform mat4 xeo_uModelMatrix;"),k("uniform mat4 xeo_uViewMatrix;"),k("uniform mat4 xeo_uViewNormalMatrix;"),k("uniform mat4 xeo_uProjMatrix;"),k("varying vec4 xeo_vWorldPosition;"),k("varying vec4 xeo_vViewPosition;"),k("void main(void) {"),k("vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),k("xeo_vWorldPosition = xeo_uModelMatrix * tmpVertex; "),k("xeo_vViewPosition = xeo_uViewMatrix * xeo_vWorldPosition;"),k("gl_Position = xeo_uProjMatrix * xeo_vViewPosition;"),k("}"),l()}function g(){if(j(),k("precision "+m(n._canvas.gl)+" float;"),k("varying vec4 xeo_vWorldPosition;"),k("varying vec4 xeo_vViewPosition;"),k("uniform bool  xeo_uRayPickMode;"),k("uniform vec3  xeo_uPickColor;"),r)for(var a=0;a<n.clips.clips.length;a++)k("uniform float xeo_uClipMode"+a+";"),k("uniform vec4  xeo_uClipPlane"+a+";");if(k("vec4 packDepth(const in float depth) {"),k("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),k("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),k("  vec4 res = fract(depth * bitShift);"),k("  res -= res.xxyz * bitMask;"),k("  return res;"),k("}"),k("void main(void) {"),r){k("if (SCENEJS_uModesClipping) {"),k("float dist = 0.0;");for(var a=0;a<n.clips.clips.length;a++)k("if (xeo_uClipMode"+a+" != 0.0) {"),k("   dist += clamp(dot(xeo_vWorldPosition.xyz, xeo_uClipPlane"+a+".xyz) - xeo_uClipPlane"+a+".w, 0.0, 1000.0);"),k("}");k("if (dist > 0.0) { discard; }"),k("}")}return k("if (xeo_uRayPickMode) {"),k("   gl_FragColor = packDepth(gl_Position.z); "),k("} else {"),k("   gl_FragColor = vec4(xeo_uPickColor.rgb, 1.0);  "),k("}"),k("}"),l()}function h(){var a=n.shader.vertex;if(a)return a;if(j(),k("uniform mat4 xeo_uModelMatrix;"),k("uniform mat4 xeo_uViewMatrix;"),k("uniform mat4 xeo_uProjMatrix;"),k("uniform vec3 xeo_uEye;"),k("attribute vec3 xeo_aPosition;"),k("varying vec4 xeo_vViewPosition;"),k("varying vec3 xeo_vViewEyeVec;"),p){k("attribute vec3 xeo_aNormal;"),k("uniform mat4 xeo_uModelNormalMatrix;"),k("uniform mat4 xeo_uViewNormalMatrix;"),k("varying vec3 xeo_vViewNormal;"),q&&k("attribute vec4 xeo_aTangent;");for(var b=0;b<n.lights.lights.length;b++){var c=n.lights.lights[b];"ambient"!==c.type&&("dir"===c.type&&k("uniform vec3 xeo_uLightDir"+b+";"),
"point"===c.type&&k("uniform vec3 xeo_uLightPos"+b+";"),"spot"===c.type&&k("uniform vec3 xeo_uLightPos"+b+";"),k("varying vec4 xeo_vViewLightVecAndDist"+b+";"))}}if(r&&k("varying vec4 xeo_vWorldPosition;"),o&&(k("attribute vec2 xeo_aUV;"),k("varying vec2 xeo_vUV;")),n.geometry.colorBuf&&(k("attribute vec4 xeo_aColor;"),k("varying vec4 xeo_vColor;")),k("void main(void) {"),k("vec4 modelPosition = vec4(xeo_aPosition, 1.0); "),p&&k("vec4 modelNormal = vec4(xeo_aNormal, 0.0); "),k("vec4 worldPosition = xeo_uModelMatrix * modelPosition;"),k("vec4 viewPosition  = xeo_uViewMatrix * worldPosition; "),p&&(k("vec3 worldNormal = (xeo_uModelNormalMatrix * modelNormal).xyz; "),k("xeo_vViewNormal = (xeo_uViewNormalMatrix * vec4(worldNormal, 1.0)).xyz;")),r&&k("  xeo_vWorldPosition = worldPosition;"),k("xeo_vViewPosition = viewPosition;"),q&&(k("vec3 tangent = normalize((xeo_uViewNormalMatrix * xeo_uModelNormalMatrix * xeo_aTangent).xyz);"),k("vec3 bitangent = cross(xeo_vViewNormal, tangent);"),k("mat3 TBM = mat3(tangent, bitangent, xeo_vViewNormal);")),k("  vec3 tmpVec3;"),p)for(var b=0;b<n.lights.lights.length;b++)c=n.lights.lights[b],"ambient"!==c.type&&("dir"===c.type&&("world"===c.space?(k("tmpVec3 = normalize(xeo_uLightDir"+b+");"),k("tmpVec3 = vec3(xeo_uViewMatrix * vec4(tmpVec3, 0.0)).xyz;"),q&&k("tmpVec3 *= TBM;")):(k("tmpVec3 = normalize(xeo_uLightDir"+b+");"),q&&k("tmpVec3 *= TBM;")),k("xeo_vViewLightVecAndDist"+b+" = vec4(-tmpVec3, 0.0);")),"point"===c.type&&("world"===c.space?(k("tmpVec3 = xeo_uLightPos"+b+" - worldPosition.xyz;"),k("tmpVec3 = vec3(xeo_uViewMatrix * vec4(tmpVec3, 0.0)).xyz;"),q&&k("tmpVec3 *= TBM;")):(k("tmpVec3 = xeo_uLightPos"+b+".xyz - viewPosition.xyz;"),q&&k("tmpVec3 *= TBM;")),k("xeo_vViewLightVecAndDist"+b+" = vec4(tmpVec3, length(xeo_uLightPos"+b+".xyz - worldPosition.xyz));")));return k("xeo_vViewEyeVec = ((xeo_uViewMatrix * vec4(xeo_uEye, 0.0)).xyz  - viewPosition.xyz);"),q&&k("xeo_vViewEyeVec *= TBM;"),o&&n.geometry.uv&&k("xeo_vUV = xeo_aUV;"),n.geometry.colorBuf&&k("xeo_vColor = xeo_aColor;"),k("gl_Position = xeo_uProjMatrix * xeo_vViewPosition;"),k("}"),l()}function i(){var a=n.shader.fragment;if(a)return a;if(j(),k("precision "+m(n._canvas.gl)+" float;"),k("varying vec4 xeo_vViewPosition;"),k("uniform float xeo_uZNear;"),k("uniform float xeo_uZFar;"),r){k("varying vec4 xeo_vWorldPosition;");for(var b=0;b<n.clips.clips.length;b++)k("uniform float xeo_uClipMode"+b+";"),k("uniform vec4  xeo_uClipPlane"+b+";")}var c="flatMaterial"===n.material.type,d=!c&&"phongMaterial"===n.material.type;!c&&!d&&"pbrMaterial"===n.material.type;if(d&&(k("uniform vec3 xeo_uMaterialDiffuse;"),k("uniform vec3 xeo_uMaterialSpecular;"),k("uniform vec3 xeo_uMaterialEmissive;"),k("uniform float xeo_uMaterialOpacity;"),k("uniform float xeo_uMaterialShininess;"),k("uniform float xeo_uMaterialReflectivity;"),o&&(n.geometry.uv&&k("varying vec2 xeo_vUV;"),n.material.diffuseMap&&(k("uniform sampler2D xeo_uTextureDiffuse;"),n.material.diffuseMap.matrix&&k("uniform mat4 xeo_uTextureDiffuseMatrix;")),n.material.specularMap&&(k("uniform sampler2D xeo_uTextureSpecular;"),n.material.specularMap.matrix&&k("uniform mat4 xeo_uTextureSpecularMatrix;")),n.material.emissiveMap&&(k("uniform sampler2D xeo_uTextureEmissive;"),n.material.emissiveMap.matrix&&k("uniform mat4 xeo_uTextureEmissiveMatrix;")),n.material.emissiveMap&&(k("uniform sampler2D xeo_uTextureEmissive;"),n.material.emissiveMap.matrix&&k("uniform mat4 xeo_uTextureEmissiveMatrix;")),n.material.opacityMap&&(k("uniform sampler2D xeo_uTextureOpacity;"),n.material.opacityMap.matrix&&k("uniform mat4 xeo_uTextureOpacityMatrix;")),n.material.reflectivityMap&&(k("uniform sampler2D xeo_uTextureReflectivity;"),n.material.reflectivityMap.matrix&&k("uniform mat4 xeo_uTextureReflectivityMatrix;")))),k("uniform bool xeo_uDepthMode;"),n.geometry.colorBuf&&k("varying vec4 xeo_vColor;"),k("uniform vec3 xeo_uLightAmbientColor;"),k("varying vec3 xeo_vViewEyeVec;"),p){k("varying vec3 xeo_vViewNormal;");for(var e,b=0;b<n.lights.lights.length;b++)e=n.lights.lights[b],"ambient"!==e.type&&(k("uniform vec3 xeo_uLightColor"+b+";"),k("uniform float xeo_uLightIntensity"+b+";"),"point"===e.type&&k("uniform vec3 xeo_uLightAttenuation"+b+";"),k("varying vec4 xeo_vViewLightVecAndDist"+b+";"))}if(k("void main(void) {"),r){k("if (SCENEJS_uModesClipping) {"),k("float dist = 0.0;");for(var b=0;b<n.clips.clips.length;b++)k("if (xeo_uClipMode"+b+" != 0.0) {"),k("dist += clamp(dot(xeo_vWorldPosition.xyz, xeo_uClipPlane"+b+".xyz) - xeo_uClipPlane"+b+".w, 0.0, 1000.0);"),k("}");k("if (dist > 0.0) { discard; }"),k("}")}if(k("vec3 ambient = xeo_uLightAmbientColor;"),d){if(k(n.geometry.colorBuf?"vec3 diffuse = xeo_vColor.rgb;":"vec3 diffuse = xeo_uMaterialDiffuse;"),k("vec3 specular = xeo_uMaterialSpecular;"),k("vec3 emissive = xeo_uMaterialEmissive;"),k("float opacity = xeo_uMaterialOpacity;"),k("float shininess  = xeo_uMaterialShininess;"),k("float reflectivity  = xeo_uMaterialReflectivity;"),p&&k(q?"vec3 viewNormalVec = vec3(0.0, 1.0, 0.0);":"vec3 viewNormalVec = normalize(xeo_vViewNormal);"),o){k("vec4 texturePos = vec4(xeo_vUV.s, xeo_vUV.t, 1.0, 1.0);"),k("vec2 textureCoord = texturePos.xy;"),k("textureCoord.y = -textureCoord.y;");var f=n.material;f.diffuseMap&&(k(f.diffuseMap.matrix?"textureCoord = (xeo_uMaterialDiffuseTextureMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),k("diffuse = texture2D(xeo_uMaterialDiffuseTexture, textureCoord).rgb);")),f.specularMap&&(k(f.specularMap.matrix?"textureCoord = (xeo_uSpecularTextureMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),k("specular = texture2D(xeo_uSpecularTexture, textureCoord).rgb;")),f.emissiveMap&&(k(f.emissiveMap.matrix?"textureCoord = (xeo_uEmissiveTextureMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),k("emissive = texture2D(xeo_uEmissiveTexture, textureCoord).rgb;")),f.opacityMap&&(k(f.opacityMap.matrix?"textureCoord = (xeo_uOpacityTextureMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),k("opacity = texture2D(xeo_uOpacityTexture, textureCoord).b;")),f.reflectivityMap&&(k(f.reflectivityMap.matrix?"textureCoord = (xeo_uReflectivityTextureMatrix * texturePos).xy;":"textureCoord = texturePos.xy;"),k("reflectivity = texture2D(xeo_uReflectivityTexture, textureCoord).b;"))}if(p&&t&&(k("vec3 envLookup = reflect(xeo_vViewEyeVec, viewNormalVec);"),k("envLookup.y = envLookup.y * -1.0;"),k("vec4 envColor;")),k("vec4 fragColor;"),p){k("vec3  diffuseLight = vec3(0.0, 0.0, 0.0);"),k("vec3  specularLight = vec3(0.0, 0.0, 0.0);"),k("vec3  viewLightVec;"),k("float dotN;"),k("float lightDist;"),k("float attenuation;");for(var e,b=0,g=n.lights.lights.length;g>b;b++)e=n.lights.lights[b],"ambient"!==e.type&&(k("viewLightVec = xeo_vViewLightVecAndDist"+b+".xyz;"),"point"===e.type&&(k("dotN = max(dot(normalize(viewNormalVec), normalize(viewLightVec)), 0.0);"),k("lightDist = xeo_vViewLightVecAndDist"+b+".w;"),k("attenuation = 1.0 - (  xeo_uLightAttenuation"+b+"[0] +   xeo_uLightAttenuation"+b+"[1] * lightDist +   xeo_uLightAttenuation"+b+"[2] * lightDist * lightDist);"),k("diffuseLight += dotN * xeo_uLightColor"+b+" * attenuation;"),k("specularLight += specular * xeo_uLightIntensity"+b+" * specular * pow(max(dot(reflect(normalize(-viewLightVec), normalize(-viewNormalVec)), normalize(-xeo_vViewPosition.xyz)), 0.0), shininess) * attenuation;")),"dir"===e.type&&(k("dotN = max(dot(normalize(viewNormalVec), normalize(viewLightVec)), 0.0);"),k("diffuseLight += dotN * xeo_uLightColor"+b+";"),k("specularLight += specular * xeo_uLightIntensity"+b+" * pow(max(dot(reflect(normalize(-viewLightVec), normalize(-viewNormalVec)), normalize(-xeo_vViewPosition.xyz)), 0.0), shininess);")));k("fragColor = vec4(diffuse * diffuseLight, opacity);")}else k("fragColor = vec4((diffuse.rgb + (emissive * color.rgb)) * (vec3(1.0, 1.0, 1.0) + ambient.rgb), opacity);")}return u&&(k("if (xeo_uDepthMode) {"),k("  float depth = length(xeo_vViewPosition) / (xeo_uZFar - xeo_uZNear);"),k("  const vec4 bias = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);"),k("  float r = depth;"),k("  float g = fract(r * 255.0);"),k("  float b = fract(g * 255.0);"),k("  float a = fract(b * 255.0);"),k("  vec4 colour = vec4(r, g, b, a);"),k("  gl_FragColor = colour - (colour.yzww * bias);"),k("} else {"),k("  gl_FragColor = fragColor;"),k("};")),k("}"),l()}function j(){w=[""]}function k(a){w.push(a)}function l(){var a=w.join("\n");return a}function m(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}var n,o,p,q,r,s,t,u,v={},w="";this.getSource=function(j,k){var l=v[j];return l?(l.useCount++,l):(n=k,o=a(),p=c(),q=d(),r=n.clips.clips.length>0,s=!1,t=b(),u=e(),l=new XEO.renderer.ProgramSource(j,f(),g(),h(),i()),v[j]=l,l)},this.putSource=function(a){var b=v[a];b&&0===--b.useCount&&(v[b.hash]=null)}}}(),function(){"use strict";XEO.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipMapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipMapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipMapLinear:"NEAREST_MIPMAP_LINEAR",linearMipMapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}}}(),function(){"use strict";XEO.renderer.webgl.ArrayBuffer=function(a,b,c,d,e,f){this.allocated=!1,this.gl=a,this.type=b,this.itemType=c.constructor==Uint8Array?a.UNSIGNED_BYTE:c.constructor==Uint16Array?a.UNSIGNED_SHORT:c.constructor==Uint32Array?a.UNSIGNED_INT:a.FLOAT,this.numItems=d,this.itemSize=e,this.usage=f,this._allocate(c,d)},XEO.renderer.webgl.ArrayBuffer.prototype._allocate=function(a,b){if(this.allocated=!1,this._handle=this.gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this.gl.bindBuffer(this.type,this._handle),this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null),this.numItems=b,this.length=a.length,this.allocated=!0)},XEO.renderer.webgl.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):b||0===b?this.gl.bufferSubData(this.type,b,a):this.gl.bufferData(this.type,a))},XEO.renderer.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this._handle)},XEO.renderer.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},XEO.renderer.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}(),function(){"use strict";XEO.renderer.webgl.Attribute=function(a,b){this.gl=a,this.location=b},XEO.renderer.webgl.Attribute.prototype.bindFloatArrayBuffer=function(a){a&&(a.bind(),this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a.itemSize,this.gl.FLOAT,!1,0,0))},XEO.renderer.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(a,b,c){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a,this.gl.FLOAT,!1,b,c)}}(),function(){"use strict";XEO.renderer.webgl.Program=function(a,b,c){this.allocated=!1,this.gl=a,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new XEO.renderer.webgl.Shader(a,a.VERTEX_SHADER,b),this._fragmentShader=new XEO.renderer.webgl.Shader(a,a.FRAGMENT_SHADER,c);var d,e,f,g,h;if(this.handle=a.createProgram(),this.handle){this._vertexShader.valid&&a.attachShader(this.handle,this._vertexShader.handle),this._fragmentShader.valid&&a.attachShader(this.handle,this._fragmentShader.handle),a.linkProgram(this.handle),console.error("vertex"),console.error(a.getShaderInfoLog(this._vertexShader.handle)),console.error("fragment"),console.error(a.getShaderInfoLog(this._fragmentShader.handle));var i=a.getProgramParameter(this.handle,a.ACTIVE_UNIFORMS);for(e=0;i>e;++e)f=a.getActiveUniform(this.handle,e),f&&(g=f.name,"\x00"===g[g.length-1]&&(g=g.substr(0,g.length-1)),h=a.getUniformLocation(this.handle,g),f.type===a.SAMPLER_2D||f.type===a.SAMPLER_CUBE||35682===f.type?this.samplers[g]=new XEO.renderer.webgl.Sampler(a,h):this.uniforms[g]=new XEO.renderer.webgl.Uniform(a,f.type,h));var j=a.getProgramParameter(this.handle,a.ACTIVE_ATTRIBUTES);for(e=0;j>e;e++)d=a.getActiveAttrib(this.handle,e),d&&(h=a.getAttribLocation(this.handle,d.name),this.attributes[d.name]=new XEO.renderer.webgl.Attribute(a,h));this.allocated=!0}},XEO.renderer.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},XEO.renderer.webgl.Program.prototype.setUniform=function(a,b){if(this.allocated){var c=this.uniforms[a];c&&c.setValue(b)}},XEO.renderer.webgl.Program.prototype.getUniform=function(a){return this.allocated?this.uniforms[a]:void 0},XEO.renderer.webgl.Program.prototype.getAttribute=function(a){return this.allocated?this.attributes[a]:void 0},XEO.renderer.webgl.Program.prototype.bindFloatArrayBuffer=function(a,b){return this.allocated?this.attributes[a]:void 0},XEO.renderer.webgl.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this.samplers[a];return d?d.bindTexture(b,c):!1},XEO.renderer.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),function(){"use strict";XEO.renderer.webgl.RenderBuffer=function(a){this.allocated=!1,this.canvas=a.canvas,this.gl=a.gl,this.buffer=null,this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buffer=null,this.allocated=!1,this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0)},XEO.renderer.webgl.RenderBuffer.prototype._touch=function(){var a=this.canvas.width,b=this.canvas.height;if(this.buffer){if(this.buffer.width===a&&this.buffer.height===b)return;this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf)}this.buffer={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:a,height:b},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buffer.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(c){var d=new WebGLUnsignedByteArray(a*b*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,d)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buffer.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),!this.gl.isFramebuffer(this.buffer.framebuf))throw"Invalid framebuffer";var e=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(e){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case this.gl.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+e}this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},XEO.renderer.webgl.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.height-b,e=new Uint8Array(4);return this.gl.readPixels(c,d,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),e},XEO.renderer.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.getTexture=function(){var a=this;return{bind:function(b){return a.buffer&&a.buffer.texture?(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buffer.texture),!0):!1},unbind:function(b){a.buffer&&a.buffer.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},XEO.renderer.webgl.RenderBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1)}}(),function(){"use strict";XEO.renderer.webgl.Sampler=function(a,b){this.bindTexture=function(c,d){return c.bind(d)?(a.uniform1i(b,d),!0):!1}}}(),function(){"use strict";XEO.renderer.webgl.Shader=function(a,b,c){if(this.allocated=!1,this.handle=a.createShader(b),!this.handle)return void console.error("Failed to create WebGL shader");if(a.shaderSource(this.handle,c),a.compileShader(this.handle),this.valid=0!==a.getShaderParameter(this.handle,a.COMPILE_STATUS),this.valid||a.isContextLost())this.allocated=!0;else{console.error("Shader program failed to compile: "+a.getShaderInfoLog(this.handle)),console.error("Shader source:");for(var d=c.split("\n"),e=0;e<d.length;e++)console.error(e+1+": "+d[e])}}}(),function(){"use strict";XEO.renderer.webgl.Texture2D=function(a,b){this.gl=a,b=b||{},this.target=b.target||a.TEXTURE_2D,this.texture=a.createTexture(),this.allocated=!0},XEO.renderer.webgl.Texture2D.prototype.setImage=function(a){var b=this.gl;b.bindTexture(this.target,this.texture),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,XEO.renderer.webgl.ensureImageSizePowerOfTwo(cfg.image)),b.bindTexture(this.target,null)},XEO.renderer.webgl.Texture2D.prototype.setProps=function(a){var b=this.gl;if(b.bindTexture(this.target,this.texture),(a.flipY===!0||a.flipY===!1)&&b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,a.flipY),a.minFilter){var c=this._getGLEnum(a.minFilter);c&&(b.texParameteri(this.target,b.TEXTURE_MIN_FILTER,c),(c===b.NEAREST_MIPMAP_NEAREST||c===b.LINEAR_MIPMAP_NEAREST||c===b.NEAREST_MIPMAP_LINEAR||c===b.LINEAR_MIPMAP_LINEAR)&&b.generateMipmap(this.target))}if(a.magFilter){var d=this._getGLEnum(a.minFilter);d&&b.texParameteri(this.target,b.TEXTURE_MAG_FILTER,d)}a.wrapS&&b.texParameteri(this.target,b.TEXTURE_WRAP_S,a.wrapS),a.wrapT&&b.texParameteri(this.target,b.TEXTURE_WRAP_T,a.wrapT),b.bindTexture(this.target,null)},XEO.renderer.webgl.Texture2D.prototype._getGLEnum=function(a,b){if(void 0===a)return b;var c=XEO.renderer.webgl.enums[a];return void 0===c?b:this.gl[c]},XEO.renderer.webgl.Texture2D.prototype.bind=function(a){if(this.allocated){if(this.texture){var b=this.gl;return b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,this.texture),!0}return!1}},XEO.renderer.webgl.Texture2D.prototype.unbind=function(a){if(this.allocated&&this.texture){var b=this.gl;b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,null)}},XEO.renderer.webgl.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},XEO.renderer.webgl.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=XEO.renderer.webgl.nextHighestPowerOfTwo(e),g.height=XEO.renderer.webgl.nextHighestPowerOfTwo(f);var h=g.getContext("2d");h.drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},XEO.renderer.webgl.ensureImageSizePowerOfTwo=function(a){if(!XEO.renderer.webgl.isPowerOfTwo(a.width)||!XEO.renderer.webgl.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=XEO.renderer.webgl.nextHighestPowerOfTwo(a.width),b.height=XEO.renderer.webgl.nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},XEO.renderer.webgl.isPowerOfTwo=function(a){return 0===(a&a-1)},XEO.renderer.webgl.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1}}(),function(){"use strict";XEO.renderer.webgl.Uniform=function(a,b,c){var d=null,e=null;if(b===a.BOOL)d=function(b){e!==b&&(e=b,a.uniform1i(c,b))};else if(b===a.BOOL_VEC2)d=function(b){(null===e||e[0]!==b[0]||e[1]!==b[1])&&(e=b,a.uniform2iv(c,b))};else if(b===a.BOOL_VEC3)d=function(b){(null===e||e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2])&&(e=b,a.uniform3iv(c,b))};else if(b===a.BOOL_VEC4)d=function(b){(null===e||e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2]||e[3]!==b[3])&&(e=b,a.uniform4iv(c,b))};else if(b===a.INT)d=function(b){e!==b&&(e=b,a.uniform1iv(c,b))};else if(b===a.INT_VEC2)d=function(b){(null===e||e[0]!==b[0]||e[1]!==b[1])&&(e=b,a.uniform2iv(c,b))};else if(b===a.INT_VEC3)d=function(b){(null===e||e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2])&&(e=b,a.uniform3iv(c,b))};else if(b===a.INT_VEC4)d=function(b){(null===e||e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2]||e[3]!==b[3])&&(e=b,a.uniform4iv(c,b))};else if(b===a.FLOAT)d=function(b){e!==b&&(e=b,a.uniform1f(c,b))};else if(b===a.FLOAT_VEC2)d=function(b){(null===e||e[0]!==b[0]||e[1]!==b[1])&&(e=b,a.uniform2fv(c,b))};else if(b===a.FLOAT_VEC3)d=function(b){(null===e||e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2])&&(e=b,a.uniform3fv(c,b))};else if(b===a.FLOAT_VEC4)d=function(b){(null===e||e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2]||e[3]!==b[3])&&(e=b,a.uniform4fv(c,b))};else if(b===a.FLOAT_MAT2)d=function(b){a.uniformMatrix2fv(c,a.FALSE,b)};else if(b===a.FLOAT_MAT3)d=function(b){a.uniformMatrix3fv(c,a.FALSE,b)};else{if(b!==a.FLOAT_MAT4)throw"Unsupported shader uniform type: "+b;d=function(b){a.uniformMatrix4fv(c,a.FALSE,b)}}this.setValue=d,this.getLocation=function(){return c}}}(),function(){"use strict";XEO.renderer.Chunk=function(){},XEO.renderer.Chunk.prototype.init=function(a,b,c,d){this.id=a,this.object=b,this.program=c,this.state=d,this.useCount=0,this.build&&this.build()}}(),function(){"use strict";XEO.renderer.ChunkFactory=function(){this._chunks={},this._chunkIDs=new XEO.utils.Map,this.chunkTypes=XEO.renderer.ChunkFactory.chunkTypes},XEO.renderer.ChunkFactory.chunkTypes={},XEO.renderer.ChunkFactory._freeChunks={},XEO.renderer.ChunkFactory.createChunkType=function(a){if(!a.type)throw"'type' expected in params";var b=XEO.renderer.Chunk,c=function(){this.useCount=0,this.init.apply(this,arguments)};return c.prototype=new b,c.prototype.constructor=c,a.drawAndPick&&(a.draw=a.pick=a.drawAndPick),XEO._apply(a,c.prototype),XEO.renderer.ChunkFactory.chunkTypes[a.type]=c,XEO.renderer.ChunkFactory._freeChunks[a.type]={chunks:[],chunksLen:0},c},XEO.renderer.ChunkFactory.prototype.getChunk=function(a,b,c,d){var e=XEO.renderer.ChunkFactory.chunkTypes[a];if(!e)throw"chunk type not supported: '"+a+"'";var f,g=this._chunkIDs.addItem(),h=XEO.renderer.ChunkFactory._freeChunks[a];return h.chunksLen>0&&(f=h.chunks[--h.chunksLen]),f?f.init(g,b,c,d):f=new e(g,b,c,d),f.useCount=1,this._chunks[g]=f,f},XEO.renderer.ChunkFactory.prototype.putChunk=function(a){if(0!==a.useCount&&--a.useCount<=0){this._chunkIDs.removeItem(a.id),delete this._chunks[a.id];var b=XEO.renderer.ChunkFactory._freeChunks[a.type];b.chunks[b.chunksLen++]=a}},XEO.renderer.ChunkFactory.prototype.webglRestored=function(){var a;for(var b in this._chunks)this._chunks.hasOwnProperty(b)&&(a=this._chunks[b],a.build&&a.build())}}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"clips",build:function(){this._uClipModeDraw=this._uClipModeDraw||[],this._uClipPlaneDraw=this._uClipPlaneDraw||[];for(var a=this.program.draw,b=0,c=this.state.clips.length;c>b;b++)this._uClipModeDraw[b]=a.getUniform("xeo_uClipMode"+b),this._uClipPlaneDraw[b]=a.getUniform("xeo_uClipPlane"+b);this._uClipModePick=this._uClipModePick||[],this._uClipPlanePick=this._uClipPlanePick||[];for(var d=this.program.pick,b=0,c=this.state.clips.length;c>b;b++)this._uClipModePick[b]=d.getUniform("xeo_uClipMode"+b),this._uClipPlanePick[b]=d.getUniform("xeo_uClipPlane"+b)},drawAndPick:function(a){for(var b,c,d,e=a.pick?this._uClipModePick:this._uClipModeDraw,f=a.pick?this._uClipPlanePick:this._uClipPlaneDraw,g=this.state.clips,h=0,i=g.length;i>h;h++)b=e[h],c=f[h],b&&c&&(d=g[h],"inside"===d.mode?(b.setValue(2),c.setValue(d.plane)):"outside"===d.mode?(b.setValue(1),c.setValue(d.plane)):b.setValue(0))}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"colorBuf",programGlobal:!0,build:function(){},drawAndPick:function(a){if(!a.transparent){var b=this.state,c=b.blendEnabled,d=this.program.gl;a.blendEnabled!==c&&(c?d.enable(d.BLEND):d.disable(d.BLEND),a.blendEnabled=c);var e=b.colorMask;d.colorMask(e[0],e[1],e[2],e[3])}}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"cubemap",build:function(){},draw:function(a){}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"depthBuf",programGlobal:!0,drawAndPick:function(a){var b=this.program.gl,c=this.state,d=c.active;a.depthbufEnabled!==d&&(d?b.disable(b.DEPTH_TEST):b.enable(b.DEPTH_TEST),a.depthbufEnabled=d);var e=c.clearDepth;a.clearDepth!==e&&(b.clearDepth(e),a.clearDepth=e);var f=c.depthFunc;a.depthFunc!==f&&(b.depthFunc(f),a.depthFunc=f),c.clear&&b.clear(b.DEPTH_BUFFER_BIT)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"draw",unique:!0,build:function(){this._depthModeDraw=this.program.draw.getUniform("xeo_uDepthMode"),this._depthModePick=this.program.pick.getUniform("xeo_uDepthMode"),this._uPickColor=this.program.pick.getUniform("xeo_uPickColor")},drawAndPick:function(a){var b=this.state,c=this.program.gl;if(a.pick){if(this._uPickColor){a.pickObjects[a.pickIndex++]=this.object;var d=a.pickIndex>>16&255,e=a.pickIndex>>8&255,f=255&a.pickIndex;this._uPickColor.setValue([f/255,e/255,d/255])}this._depthModeDraw&&this._depthModePick.setValue(a.depthMode)}else this._depthModePick&&this._depthModeDraw.setValue(a.depthMode);b.indices&&c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"geometry",build:function(){var a=this.program.draw;this._aPositionDraw=a.getAttribute("xeo_aPosition"),this._aNormalDraw=a.getAttribute("xeo_aNormal"),this._aUVDraw=a.getAttribute("xeo_aUV"),this._aTangentDraw=a.getAttribute("xeo_aTangent"),this._aColorDraw=a.getAttribute("xeo_aColor");var b=this.program.pick;this._aPositionPick=b.getAttribute("xeo_aPosition")},draw:function(a){var b=this.state;this._aPositionDraw&&this._aPositionDraw.bindFloatArrayBuffer(b.positions),this._aNormalDraw&&this._aNormalDraw.bindFloatArrayBuffer(b.normals),this._aUVDraw&&this._aUVDraw.bindFloatArrayBuffer(b.uv),this._aColorDraw&&this._aColorDraw.bindFloatArrayBuffer(b.colors),this._aTangentDraw,b.indices&&b.indices.bind()},pick:function(){var a=this.state;this._aPositionPick&&this._aPositionPick.bindFloatArrayBuffer(a.positions),a.indices&&a.indices.bind()}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"lights",build:function(){this._uLightAmbientColor=this._uLightAmbientColor||[],this._uLightAmbientIntensity=this._uLightAmbientIntensity||[],this._uLightColor=this._uLightColor||[],this._uLightIntensity=this._uLightIntensity||[],this._uLightDir=this._uLightDir||[],this._uLightPos=this._uLightPos||[],this._uLightAttenuation=this._uLightAttenuation||[];for(var a=this.state.lights,b=this.program,c=0,d=a.length;d>c;c++)switch(a[c].type){case"ambient":this._uLightAmbientColor[c]=b.draw.getUniform("xeo_uLightAmbientColor"),this._uLightAmbientIntensity[c]=b.draw.getUniform("xeo_uLightAmbientIntensity"+c);break;case"dir":this._uLightColor[c]=b.draw.getUniform("xeo_uLightColor"+c),this._uLightIntensity[c]=b.draw.getUniform("xeo_uLightIntensity"+c),this._uLightPos[c]=null,this._uLightDir[c]=b.draw.getUniform("xeo_uLightDir"+c);break;case"point":this._uLightColor[c]=b.draw.getUniform("xeo_uLightColor"+c),this._uLightIntensity[c]=b.draw.getUniform("xeo_uLightIntensity"+c),this._uLightPos[c]=b.draw.getUniform("xeo_uLightPos"+c),this._uLightDir[c]=null,this._uLightAttenuation[c]=b.draw.getUniform("xeo_uLightAttenuation"+c)}},draw:function(){for(var a,b=this.state.lights,c=(this.program.gl,0),d=b.length;d>c;c++)a=b[c],this._uLightAmbientColor[c]?(this._uLightAmbientColor[c].setValue(a.color),this._uLightAmbientIntensity[c]&&this._uLightAmbientIntensity[c].setValue(a.intensity)):(this._uLightColor[c]&&this._uLightColor[c].setValue(a.color),this._uLightIntensity[c]&&this._uLightIntensity[c].setValue(a.intensity),this._uLightPos[c]&&(this._uLightPos[c].setValue(a.pos),this._uLightAttenuation[c]&&this._uLightAttenuation[c].setValue(a.attenuation)),this._uLightDir[c]&&this._uLightDir[c].setValue(a.dir))}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"modelTransform",build:function(){var a=this.program.draw;this._uModelMatrixDraw=a.getUniform("xeo_uModelMatrix"),this._uModelNormalMatrixDraw=a.getUniform("xeo_uModelNormalMatrix");var b=this.program.pick;this._uModelMatrixPick=b.getUniform("xeo_uModelMatrix")},draw:function(){this.program.gl;this._uModelMatrixDraw&&this._uModelMatrixDraw.setValue(this.state.matrix),this._uModelNormalMatrixDraw&&this._uModelNormalMatrixDraw.setValue(this.state.normalMatrix)},pick:function(){this.program.gl;this._uModelMatrixPick&&this._uModelMatrixPick.setValue(this.state.matrix)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"modes",build:function(){var a=this.program.draw;this._uModesClippingDraw=a.getUniform("xeo_uModesClipping");var b=this.program.pick;this._uModesClippingPick=b.getUniform("xeo_uModesClipping")},drawAndPick:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e);var f=b.transparent;a.transparent!==f&&(a.pick||(f?(c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),a.blendEnabled=!0):(c.disable(c.BLEND),a.blendEnabled=!1)),a.transparent=f),a.pick?this._uModesClippingPick&&this._uModesClippingPick.setValue(b.clipping):this._uModesClippingDraw&&this._uModesClippingDraw.setValue(b.clipping);
}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"pbrMaterial",build:function(){var a=this.state,b=this.program.draw;this._uMetallic=b.getUniform("xeo_uMetallic"),this._uMaterialColor=b.getUniform("xeo_uMaterialColor"),a.colorMap&&(this._uMaterialColorMap=b.getUniform("xeo_uMaterialColorMap"),this._uMaterialColorMapMatrix=b.getUniform("xeo_uMaterialColorMapMatrix")),this._uMaterialEmissive=b.getUniform("xeo_uMaterialEmissive"),a.emissiveMap&&(this._uMaterialEmissiveMap=b.getUniform("xeo_uMaterialEmissiveMap"),this._uMaterialEmissiveMapMatrix=b.getUniform("xeo_uMaterialEmissiveMapMatrix")),this._uMaterialOpacity=b.getUniform("xeo_uMaterialOpacity"),a.opacityMap&&(this._uMaterialOpacityMap=b.getUniform("xeo_uMaterialOpacityMap"),this._uMaterialOpacityMapMatrix=b.getUniform("xeo_uMaterialOpacityMapMatrix")),this._uMaterialRoughness=b.getUniform("xeo_uMaterialRoughness"),a.roughnessMap&&(this._uMaterialRoughnessMap=b.getUniform("xeo_uMaterialRoughnessMap"),this._uMaterialRoughnessMapMatrix=b.getUniform("xeo_uMaterialRoughnessMapMatrix")),a.normalMap&&(this._uMaterialNormalMap=b.getUniform("xeo_uMaterialNormalMap"),this._uMaterialNormalMapMatrix=b.getUniform("xeo_uMaterialNormalMapMatrix")),this._uMaterialSpecular=b.getUniform("xeo_uMaterialSpecular"),a.specularMap&&(this._uMaterialSpecularMap=b.getUniform("xeo_uMaterialSpecularMap"),this._uMaterialSpecularMapMatrix=b.getUniform("xeo_uMaterialSpecularMapMatrix"))},draw:function(a){a.textureUnit=0;var b=this.program.draw,c=this.state;this._uMetallic&&this._uMetallic.setValue(c.metallic),this._uMaterialColor&&this._uMaterialColor.setValue(c.color),this._uMaterialColorMap&&(b.bindTexture(this._uMaterialColorMap,c.colorMap.texture,a.textureUnit++),this._uMaterialColorMapMatrix&&this._uMaterialColorMapMatrix.setValue(c.colorMap.matrix)),this._uMaterialEmissive&&this._uMaterialEmissive.setValue(c.emissive),this._uMaterialEmissiveMap&&(b.bindTexture(this._uMaterialEmissiveMap,c.emissiveMap.texture,a.textureUnit++),this._uMaterialEmissiveMapMatrix&&this._uMaterialEmissiveMapMatrix.setValue(c.emissiveMap.matrix)),this._uMaterialOpacity&&this._uMaterialOpacity.setValue(c.opacity),this._uMaterialOpacityMap&&(b.bindTexture(this._uMaterialOpacityMap,c.opacityMap.texture,a.textureUnit++),this._uMaterialOpacityMapMatrix&&this._uMaterialOpacityMapMatrix.setValue(c.opacityMap.matrix)),this._uMaterialRoughness&&this._uMaterialRoughness.setValue(c.roughness),this._uMaterialRoughnessMap&&(b.bindTexture(this._uMaterialRoughnessMap,c.roughnessMap.texture,a.textureUnit++),this._uMaterialRoughnessMapMatrix&&this._uMaterialRoughnessMapMatrix.setValue(c.roughnessMap.matrix)),this._uMaterialNormalMap&&(b.bindTexture(this._uMaterialNormalMap,c.normalMap.texture,a.textureUnit++),this._uMaterialNormalMapMatrix&&this._uMaterialNormalMapMatrix.setValue(c.normalMap.matrix)),this._uMaterialSpecular&&this._uMaterialSpecular.setValue(c.specular),this._uMaterialSpecularMap&&(b.bindTexture(this._uMaterialSpecularMap,c.specularMap.texture,a.textureUnit++),this._uMaterialSpecularMapMatrix&&this._uMaterialSpecularMapMatrix.setValue(c.specularMap.matrix)),a.textureUnit>10&&(a.textureUnit=0)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"phongMaterial",build:function(){var a=this.state,b=this.program.draw;this._uMaterialDiffuse=b.getUniform("xeo_uMaterialDiffuse"),this._uMaterialSpecular=b.getUniform("xeo_uMaterialSpecular"),this._uMaterialEmissive=b.getUniform("xeo_uMaterialEmissive"),this._uMaterialOpacity=b.getUniform("xeo_uMaterialOpacity"),this._uMaterialShininess=b.getUniform("xeo_uMaterialShininess"),a.diffuseMap&&(this._uMaterialDiffuseMap=b.getUniform("xeo_uMaterialDiffuseMap"),this._uMaterialDiffuseMapMatrix=b.getUniform("xeo_uMaterialDiffuseMapMatrix")),a.specularMap&&(this._uSpecularMap=b.getUniform("xeo_uSpecularMap"),this._uSpecularMapMatrix=b.getUniform("xeo_uSpecularMapMatrix")),a.emissiveMap&&(this._uEmissiveMap=b.getUniform("xeo_uEmissiveMap"),this._uEmissiveMapMatrix=b.getUniform("xeo_uEmissiveMapMatrix")),a.opacityMap&&(this._uOpacityMap=b.getUniform("xeo_uOpacityMap"),this._uOpacityMapMatrix=b.getUniform("xeo_uOpacityMapMatrix")),a.reflectivityMap&&(this._uReflectivityMap=b.getUniform("xeo_uReflectivityMap"),this._uReflectivityMapMatrix=b.getUniform("xeo_uReflectivityMapMatrix")),a.normalMap&&(this._uBumpMap=b.getUniform("xeo_uBumpMap"),this._uBumpMapMatrix=b.getUniform("xeo_uBumpMapMatrix")),a.diffuseFresnel&&(this._uMaterialDiffuseFresnelBias=b.getUniform("xeo_uMaterialDiffuseFresnelBias"),this._uMaterialDiffuseFresnelPower=b.getUniform("xeo_uMaterialDiffuseFresnelPower"),this._uMaterialDiffuseFresnelLeftColor=b.getUniform("xeo_uMaterialDiffuseFresnelLeftColor"),this._uMaterialDiffuseFresnelRightColor=b.getUniform("xeo_uMaterialDiffuseFresnelRightColor")),a.specularFresnel&&(this._uSpecularFresnelBias=b.getUniform("xeo_uSpecularFresnelBias"),this._uSpecularFresnelPower=b.getUniform("xeo_uSpecularFresnelPower"),this._uSpecularFresnelLeftColor=b.getUniform("xeo_uSpecularFresnelLeftColor"),this._uSpecularFresnelRightColor=b.getUniform("xeo_uSpecularFresnelRightColor")),a.opacityFresnel&&(this._uOpacityFresnelBias=b.getUniform("xeo_uOpacityFresnelBias"),this._uOpacityFresnelPower=b.getUniform("xeo_uOpacityFresnelPower"),this._uOpacityFresnelLeftColor=b.getUniform("xeo_uOpacityFresnelLeftColor"),this._uOpacityFresnelRightColor=b.getUniform("xeo_uOpacityFresnelRightColor")),a.reflectivityFresnel&&(this._uReflectivityFresnelBias=b.getUniform("xeo_uReflectivityFresnelBias"),this._uReflectivityFresnelPower=b.getUniform("xeo_uReflectivityFresnelPower"),this._uReflectivityFresnelLeftColor=b.getUniform("xeo_uReflectivityFresnelLeftColor"),this._uReflectivityFresnelRightColor=b.getUniform("xeo_uReflectivityFresnelRightColor")),a.emissiveFresnel&&(this._uEmissiveFresnelBias=b.getUniform("xeo_uEmissiveFresnelBias"),this._uEmissiveFresnelPower=b.getUniform("xeo_uEmissiveFresnelPower"),this._uEmissiveFresnelLeftColor=b.getUniform("xeo_uEmissiveFresnelLeftColor"),this._uEmissiveFresnelRightColor=b.getUniform("xeo_uEmissiveFresnelRightColor"))},draw:function(a){var b=this.program.draw,c=this.state;this._uMaterialDiffuse&&this._uMaterialDiffuse.setValue(c.diffuse),this._uMaterialSpecular&&this._uMaterialSpecular.setValue(c.specular),this._uMaterialEmissive&&this._uMaterialEmissive.setValue(c.emissive),this._uMaterialOpacity&&this._uMaterialOpacity.setValue(c.opacity),this._uMaterialShininess&&this._uMaterialShininess.setValue(c.shininess),a.textureUnit=0,this._uMaterialDiffuseMap&&(b.bindTexture(this._uMaterialDiffuseMap,c.diffuseMap.texture,a.textureUnit++),this._uMaterialDiffuseMapMatrix&&this._uMaterialDiffuseMapMatrix.setValue(c.diffuseMap.matrix)),this._uSpecularMap&&(b.bindTexture(this._uSpecularMap,c.specularMap.texture,a.textureUnit++),this._uSpecularMapMatrix&&this._uSpecularMapMatrix.setValue(c.specularMap.matrix)),this._uEmissiveMap&&(b.bindTexture(this._uEmissiveMap,c.emissiveMap.texture,a.textureUnit++),this._uEmissiveMapMatrix&&this._uEmissiveMapMatrix.setValue(c.emissiveMap.matrix)),this._uOpacityMap&&(b.bindTexture(this._uOpacityMap,c.opacityMap.texture,a.textureUnit++),this._uOpacityMapMatrix&&this._uOpacityMapMatrix.setValue(c.opacityMap.matrix)),this._uReflectivityMap&&(b.bindTexture(this._uReflectivityMap,c.reflectivityMap.texture,a.textureUnit++),this._uReflectivityMapMatrix&&this._uReflectivityMapMatrix.setValue(c.reflectivityMap.matrix)),this._uBumpMap&&(b.bindTexture(this._uBumpMap,c.normalMap.texture,a.textureUnit++),this._uBumpMapMatrix&&this._uBumpMapMatrix.setValue(c.normalMap.matrix)),a.textureUnit>10&&(a.textureUnit=0),c.diffuseFresnel&&(this._uMaterialDiffuseFresnelBias&&this._uMaterialDiffuseFresnelBias.setValue(c.diffuseFresnel.bias),this._uMaterialDiffuseFresnelPower&&this._uMaterialDiffuseFresnelPower.setValue(c.diffuseFresnel.power),this._uMaterialDiffuseFresnelLeftColor&&this._uMaterialDiffuseFresnelLeftColor.setValue(c.diffuseFresnel.leftColor),this._uMaterialDiffuseFresnelRightColor&&this._uMaterialDiffuseFresnelRightColor.setValue(c.diffuseFresnel.rightColor)),c.specularFresnel&&(this._uSpecularFresnelBias&&this._uSpecularFresnelBias.setValue(c.specularFresnel.bias),this._uSpecularFresnelPower&&this._uSpecularFresnelPower.setValue(c.specularFresnel.power),this._uSpecularFresnelLeftColor&&this._uSpecularFresnelLeftColor.setValue(c.specularFresnel.leftColor),this._uSpecularFresnelRightColor&&this._uSpecularFresnelRightColor.setValue(c.specularFresnel.rightColor)),c.opacityFresnel&&(this._uOpacityFresnelBias&&this._uOpacityFresnelBias.setValue(c.opacityFresnel.bias),this._uOpacityFresnelPower&&this._uOpacityFresnelPower.setValue(c.opacityFresnel.power),this._uOpacityFresnelLeftColor&&this._uOpacityFresnelLeftColor.setValue(c.opacityFresnel.leftColor),this._uOpacityFresnelRightColor&&this._uOpacityFresnelRightColor.setValue(c.opacityFresnel.rightColor)),c.reflectivityFresnel&&(this._uReflectivityFresnelBias&&this._uReflectivityFresnelBias.setValue(c.reflectivityFresnel.bias),this._uReflectivityFresnelPower&&this._uReflectivityFresnelPower.setValue(c.reflectivityFresnel.power),this._uReflectivityFresnelLeftColor&&this._uReflectivityFresnelLeftColor.setValue(c.reflectivityFresnel.leftColor),this._uReflectivityFresnelRightColor&&this._uReflectivityFresnelRightColor.setValue(c.reflectivityFresnel.rightColor)),c.emissiveFresnel&&(this._uEmissiveFresnelBias&&this._uEmissiveFresnelBias.setValue(c.emissiveFresnel.bias),this._uEmissiveFresnelPower&&this._uEmissiveFresnelPower.setValue(c.emissiveFresnel.power),this._uEmissiveFresnelLeftColor&&this._uEmissiveFresnelLeftColor.setValue(c.emissiveFresnel.leftColor),this._uEmissiveFresnelRightColor&&this._uEmissiveFresnelRightColor.setValue(c.emissiveFresnel.rightColor))}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"program",build:function(){this._depthModeDraw=this.program.draw.getUniform("xeo_uDepthMode"),this._depthModePick=this.program.pick.getUniform("xeo_uDepthMode"),this._rayPickMode=this.program.pick.getUniform("xeo_uRayPickMode")},draw:function(a){var b=this.program.draw;b.bind(),a.textureUnit=0,this._depthModeDraw&&this._depthModeDraw.setValue(a.depthMode),a.drawProgram=b},pick:function(a){var b=this.program.pick;b.bind(),this._rayPickMode.setValue(a.rayPick),this._depthModePick&&this._depthModePick.setValue(a.depthMode),a.textureUnit=0}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"projTransform",build:function(){this._uProjMatrixDraw=this.program.draw.getUniform("xeo_uProjMatrix"),this._uZNearDraw=this.program.draw.getUniform("xeo_uZNear"),this._uZFarDraw=this.program.draw.getUniform("xeo_uZFar"),this._uProjMatrixPick=this.program.pick.getUniform("xeo_uProjMatrix"),this._uZNearPick=this.program.pick.getUniform("xeo_uZNear"),this._uZFarPick=this.program.pick.getUniform("xeo_uZFar")},draw:function(a){var b=this.state;this._uProjMatrixDraw&&this._uProjMatrixDraw.setValue(b.matrix),this._uZNearDraw&&this._uZNearDraw.setValue(b.near),this._uZFarDraw&&this._uZFarDraw.setValue(b.far),a.projMatrix=b.matrix},pick:function(a){var b=this.state;this._uProjMatrixPick&&this._uProjMatrixPick.setValue(b.matrix),a.rayPick&&(this._uZNearPick&&this._uZNearPick.setValue(b.near),this._uZFarPick&&this._uZFarPick.setValue(b.far)),a.projMatrix=b.matrix}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"renderTarget",programGlobal:!0,draw:function(a){return}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"shader",build:function(){},drawAndPick:function(a){var b=this.state.params;if(b){var c,d=a.pick?this.program.pick:this.program.draw;for(c in b)b.hasOwnProperty(c)&&d.setUniform(c,b[c])}}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"shaderParams",build:function(){},drawAndPick:function(a){var b=this.state.params;if(b){var c,d=a.pick?this.program.pick:this.program.draw;for(c in b)b.hasOwnProperty(c)&&d.setUniform(c,b[c])}}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"viewTransform",build:function(){this._uViewMatrixDraw=this.program.draw.getUniform("xeo_uViewMatrix"),this._uViewNormalMatrixDraw=this.program.draw.getUniform("xeo_uViewNormalMatrix"),this._uEyeDraw=this.program.draw.getUniform("xeo_uEye"),this._uViewMatrixPick=this.program.pick.getUniform("xeo_uViewMatrix")},draw:function(a){var b=this.state;this._uViewMatrixDraw&&this._uViewMatrixDraw.setValue(b.matrix),this._uViewNormalMatrixDraw&&this._uViewNormalMatrixDraw.setValue(b.normalMatrix),this._uEyeDraw&&this._uEyeDraw.setValue(b.eye),a.viewMatrix=b.matrix},pick:function(a){var b=this.state;this._uViewMatrixPick&&this._uViewMatrixPick.setValue(b.matrix),a.viewMatrix=b.matrix}})}(),function(){"use strict";XEO.Stats=XEO.Component.extend({type:"XEO.Stats",_init:function(a){this.stats={};for(var b in a)a.hasOwnProperty(b)&&(this.stats[b]=a[b],this.fire(b,this.stats[b]))},clear:function(){},inc:function(a,b){b=void 0!==b&&null!=b?b:1,(void 0===this.stats[a]||null===this.stats[a])&&(this.stats[a]=b),this.stats[a]+=b,this.fire(a,this.stats[a])},dec:function(a,b){b=void 0!==b&&null!=b?b:1,(void 0===this.stats[a]||null===this.stats[a])&&(this.stats[a]=b),this.stats[a]-=b,this.fire(a,this.stats[a])},zero:function(a){(void 0===this.stats[a]||null===this.stats[a])&&(this.stats[a]=0),this.stats[a]=0,this.fire(a,this.stats[a])},_toJSON:function(){return XEO._copy(this.stats)}})}(),function(){"use strict";XEO.Task=XEO.Component.extend({type:"XEO.Task",serializable:!1,_init:function(a){this.description=a.description||"",this.failed=!1,this.completed=!1},setCompleted:function(){this.fire("completed",this.completed=!0)},setFailed:function(){this.fire("failed",this.failed=!0)},_destroy:function(){!this.completed&&this.destroyed&&this.setCompleted()}})}(),function(){"use strict";XEO.Tasks=XEO.Component.extend({type:"XEO.Tasks",serializable:!1,_init:function(a){this._idMap=new XEO.utils.Map,this.tasks={}},create:function(a){if(a=a||{},a.id){if(this.tasks[a.id])return this.error("Task "+XEO._inQuotes(a.id)+"already exists"),null}else a.id=this._idMap.addItem({});var b=new XEO.Tasks.Task(this,a);this.tasks[a.id]=b;var c=this;return b.on("completed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("completed",b,!0)}),b.on("failed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("failed",b,!0)}),c.fire("started",b,!0),b},setCompleted:function(a){var b=this.tasks[a];return b?void b.fire("completed",b,!0):void this.error("Task not found:"+XEO._inQuotes(a))},setFailed:function(a){var b=this.tasks[a];return b?void b.fire("failed",b,!0):void this.error("Task not found:"+XEO._inQuotes(a))},clear:function(){for(var a in this.tasks)this.tasks.hasOwnProperty(a)&&this.tasks[a].setCompleted()}})}(),function(){"use strict";XEO.Boundary3D=XEO.Component.extend({type:"XEO.Boundary3D",_init:function(a){this._getDirty=a.getDirty,this._getOBB=a.getOBB,this._getMatrix=a.getMatrix,this._obb=null,this._aabb=null,this._center=null},_props:{obb:{get:function(){return this._getDirty()&&this._build(),this._obb}},aabb:{get:function(){return this._getDirty()&&this._build(),this._aabb}},center:{get:function(){return this._getDirty()&&this._build(),this._center}}},_build:function(){this._obb||(this._obb=[],this._aabb={xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0},this._center=[0,0,0]);var a=this._getAABB?this._getAABB():null;if(a)return this._aabb.xmin=a.xmin,this._aabb.ymin=a.ymin,this._aabb.zmin=a.zmin,this._aabb.xmax=a.xmax,this._aabb.ymax=a.ymax,this._aabb.zmax=a.zmax,XEO.math.AABB3ToOBB3(this._aabb,this._obb),void XEO.math.getAABBCenter(this._aabb,this._center);var b,c=this._getPositions?this._getPositions():null;if(c)return b=this._getMatrix?this._getMatrix():null,void(b?(XEO.math.positions3ToAABB3(c,this._aabb),XEO.math.AABB3ToOBB3(this._aabb,this._obb),XEO.math.transformPoints3(b,this._obb),XEO.math.points3ToAABB3(this._obb,this._aabb),XEO.math.getAABBCenter(this._aabb,this._center)):(XEO.math.positions3ToAABB3(c,this._aabb),XEO.math.AABB3ToOBB3(this._aabb,this._obb),XEO.math.getAABBCenter(this._aabb,this._center)));var d=this._getOBB?this._getOBB():null;if(d)if(b=this._getMatrix?this._getMatrix():null)XEO.math.transformPoints3(b,d,this._obb),XEO.math.points3ToAABB3(this._obb,this._aabb),XEO.math.getAABBCenter(this._aabb,this._center);else{var e=0;for(d.length;e<lenl;e++)this._obb[e]=d[e];XEO.math.points3ToAABB3(this._obb,this._aabb),XEO.math.getAABBCenter(this._aabb,this._center)}}})}(),function(){"use strict";XEO.Transform=XEO.Component.extend({type:"XEO.Transform",_init:function(a){this._state=new XEO.renderer.ModelTransform({matrix:null,normalMatrix:null}),this.parent=a.parent,this.matrix=a.matrix},_props:{parent:{set:function(a){this._parent=a,this.fire("parent",this._parent)},get:function(){return this._parent}},matrix:{set:function(a){a=a||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this._state.matrix=new Float32Array(a),this._state.normalMatrix=new Float32Array(XEO.math.transposeMat4(new Float32Array(XEO.math.inverseMat4(this._state.matrix,this._state.normalMatrix),this._state.normalMatrix))),this._renderer.imageDirty=!0,this.fire("matrix",this._state.matrix)},get:function(){return this._state.matrix}}},_compile:function(){this._renderer.modelTransform=this._state},_getJSON:function(){return{matrix:Array.prototype.slice.call(this._state.matrix)}}})}(),function(){"use strict";XEO.Rotate=XEO.Transform.extend({type:"XEO.Rotate",_init:function(a){this._super(a),this._xyz=null,this._angle=null,this.xyz=a.xyz,this.angle=a.angle},_props:{xyz:{set:function(a){a=a||[0,1,0],this._xyz=this._xyz||[0,0,0],this._xyz[0]=a[0],this._xyz[1]=a[1],this._xyz[2]=a[2],this.fire("xyz",this._xyz),this._update()},get:function(){return this._xyz}},angle:{set:function(a){this._angle=a||0,this.fire("angle",this._angle),this._update()},get:function(){return this._angle}}},_update:function(){null!==this._xyz&&null!==this._angle&&(this.matrix=XEO.math.rotationMat4v(this._angle,this._xyz))},_getJSON:function(){return{xyz:this._xyz,angle:this._angle}}})}(),function(){"use strict";XEO.Translate=XEO.Transform.extend({type:"XEO.Translate",_init:function(a){this._super(a),this.xyz=a.xyz},_props:{xyz:{set:function(a){this._xyz=a||[1,1,1],this.matrix=XEO.math.translationMat4v(this._xyz),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){return{xyz:this.xyz}}})}(),function(){"use strict";XEO.Scale=XEO.Transform.extend({type:"XEO.Scale",_init:function(a){this._super(a),this.xyz=a.xyz},_props:{xyz:{set:function(a){this._xyz=a||[1,1,1],this.matrix=XEO.math.scalingMat4v(this._xyz),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){return{xyz:this.xyz}}})}();