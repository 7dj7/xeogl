/*
 * xeoEngine V0.1.0
 *
 * A WebGL-based 3D scene graph from xeoLabs
 * http://xeoengine.org/
 *
 * Built on 2015-11-03
 *
 * MIT License
 * Copyright 2015, Lindsay Kay
 * http://xeolabs.com/
 *
 */

!function(){"use strict";var a=function(){this.version=null,this._sceneIDMap=null,this._scene=null,this.scenes={};var a=this,b={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},c=function(){var d=(new Date).getTime();b.time=d;var e;for(var f in a.scenes)a.scenes.hasOwnProperty(f)&&(e=a.scenes[f],b.sceneId=f,b.startTime=e.startTime,b.deltaTime=null!=b.prevTime?d-b.prevTime:0,e.fire("tick",b,!0),e.fire("tick2",b,!0),e.fire("tick3",b,!0),e._compile());b.prevTime=d,window.requestAnimationFrame(c)};window.requestAnimationFrame(c)};a.prototype={constructor:a,get scene(){return this._scene||(this._scene=new window.XEO.Scene({id:"default.scene"}))},_addScene:function(b){if(this._sceneIDMap=this._sceneIDMap||new window.XEO.utils.Map,b.id){if(this.scenes[b.id])return void console.error("[ERROR] Scene "+a._inQuotes(b.id)+" already exists")}else b.id=this._sceneIDMap.addItem(b);this.scenes[b.id]=b;var c=this;b.on("destroyed",function(){c._sceneIDMap.removeItem(b.id),delete c.scenes[b.id]})},clear:function(){var a;for(var b in this.scenes)this.scenes.hasOwnProperty(b)&&(a=this.scenes[b],"default.scene"===b?a.clear():a.destroy());this.scenes={}},_isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},_isString:function(a){return"string"==typeof a||a instanceof String},_isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},_copy:function(a){return this._apply(a,{})},_apply:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_apply2:function(a,b){for(var c in a)a.hasOwnProperty(c)&&void 0!==a[c]&&null!==a[c]&&(b[c]=a[c]);return b},_applyIf:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0===b[c]||null===b[c])&&(b[c]=a[c]);return b},_isEmptyObject:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},_inQuotes:function(a){return this._isNumeric(a)?""+a:"'"+a+"'"}},window.XEO=window.XEO=new a}(),function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.__init&&this.__init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)if("_props"!==g)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];else{var h,i=c[g];for(var j in i)h=i[j],h.set||!function(){var a=j;h.set=function(){this.warn("Property '"+a+"' is read-only, ignoring assignment")}}(),h.enumerable=!0,Object.defineProperty(f,j,h)}return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),function(){"use strict";XEO.utils=XEO.utils||{},XEO.utils.Map=function(a,b){this.items=a||[],b=b||0;var c=b+1;this.addItem=function(){var a;if(2===arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(;;){a=arguments[0]||{};var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}}}(),function(){"use strict";var a=new Float32Array(16),b=new Float32Array(16),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3),g=new Float32Array(3),h=new Float32Array(3),i=new Float32Array(4);XEO.math={DEGTORAD:.0174532925,vec2:function(){return new Float32Array(2)},vec3:function(){return new Float32Array(3)},vec4:function(){return new Float32Array(4)},mat3:function(){return new Float32Array(9)},mat4:function(){return new Float32Array(16)},createUUID:function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;36>e;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}(),fmod:function(a,b){if(b>a)return console.error("XEO.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;a>=b;)a-=b;return a},negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return XEO.math.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(XEO.math.sqLenVec4(a))},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return XEO.math.dotVec3(a,a)},sqLenVec2:function(a){return XEO.math.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(XEO.math.sqLenVec3(a))},lenVec2:function(a){return Math.sqrt(XEO.math.sqLenVec2(a))},rcpVec3:function(a,b){return XEO.math.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/XEO.math.lenVec4(a);return XEO.math.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/XEO.math.lenVec3(a);return XEO.math.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/XEO.math.lenVec2(a);return XEO.math.mulVec2Scalar(a,c,b)},dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return XEO.math.m4s(0)},setMat4ToOnes:function(){return XEO.math.m4s(1)},diagonalMat4v:function(a){return new Float32Array([a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]])},diagonalMat4c:function(a,b,c,d){return XEO.math.diagonalMat4v([a,b,c,d])},diagonalMat4s:function(a){return XEO.math.diagonalMat4c(a,a,a,a)},identityMat4:function(a){return a=a||new Float32Array(16),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},isIdentityMat4:function(a){return 1!==a[0]||0!==a[1]||0!==a[2]||0!==a[3]||0!==a[4]||1!==a[5]||0!==a[6]||0!==a[7]||0!==a[8]||0!==a[9]||1!==a[10]||0!==a[11]||0!==a[12]||0!==a[13]||0!==a[14]||1!==a[15]?!1:!0},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return XEO.math.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a===b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a,b){var c=b||XEO.math.identityMat4();return c[12]=a[0],c[13]=a[1],c[14]=a[2],c},translationMat4c:function(a,b,c){return XEO.math.translationMat4v([a,b,c])},translationMat4s:function(a){return XEO.math.translationMat4c(a,a,a)},rotationMat4v:function(a,b,c){var d,e,f,g,h,i,j=XEO.math.normalizeVec4([b[0],b[1],b[2],0],[]),k=Math.sin(a),l=Math.cos(a),m=1-l,n=j[0],o=j[1],p=j[2];return d=n*o,e=o*p,f=p*n,g=n*k,h=o*k,i=p*k,c=c||XEO.math.mat4(),c[0]=m*n*n+l,c[1]=m*d+i,c[2]=m*f-h,c[3]=0,c[4]=m*d-i,c[5]=m*o*o+l,c[6]=m*e+g,c[7]=0,c[8]=m*f+h,c[9]=m*e-g,c[10]=m*p*p+l,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c},rotationMat4c:function(a,b,c,d){return XEO.math.rotationMat4v(a,[b,c,d])},scalingMat4v:function(a,b){return b=b||XEO.math.identityMat4(),b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat4c:function(a,b,c){return XEO.math.scalingMat4v([a,b,c])},scalingMat4s:function(a){return XEO.math.scalingMat4c(a,a,a)},lookAtMat4v:function(a,b,c,d){d||(d=XEO.math.mat4());var e=a[0],f=a[1],g=a[2],h=c[0],i=c[1],j=c[2],k=b[0],l=b[1],m=b[2];if(e===k&&f===l&&g===m)return XEO.math.identityMat4();var n,o,p,q,r,s,t,u,v,w;return n=e-k,o=f-l,p=g-m,w=1/Math.sqrt(n*n+o*o+p*p),n*=w,o*=w,p*=w,q=i*p-j*o,r=j*n-h*p,s=h*o-i*n,w=Math.sqrt(q*q+r*r+s*s),w?(w=1/w,q*=w,r*=w,s*=w):(q=0,r=0,s=0),t=o*s-p*r,u=p*q-n*s,v=n*r-o*q,w=Math.sqrt(t*t+u*u+v*v),w?(w=1/w,t*=w,u*=w,v*=w):(t=0,u=0,v=0),d[0]=q,d[1]=t,d[2]=n,d[3]=0,d[4]=r,d[5]=u,d[6]=o,d[7]=0,d[8]=s,d[9]=v,d[10]=p,d[11]=0,d[12]=-(q*e+r*f+s*g),d[13]=-(t*e+u*f+v*g),d[14]=-(n*e+o*f+p*g),d[15]=1,d},lookAtMat4c:function(a,b,c,d,e,f,g,h,i){return XEO.math.lookAtMat4v([a,b,c],[d,e,f],[g,h,i],[])},orthoMat4c:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2/i,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=-2/j,g[11]=0,g[12]=-(a+b)/h,g[13]=-(d+c)/i,g[14]=-(f+e)/j,g[15]=1,g},frustumMat4v:function(c,d,e){e||(e=XEO.math.mat4());var f=[c[0],c[1],c[2],0],g=[d[0],d[1],d[2],0];XEO.math.addVec4(g,f,a),XEO.math.subVec4(g,f,b);var h=2*f[2],i=b[0],j=b[1],k=b[2];return e[0]=h/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=h/j,e[6]=0,e[7]=0,e[8]=a[0]/i,e[9]=a[1]/j,e[10]=-a[2]/k,e[11]=-1,e[12]=0,e[13]=0,e[14]=-h*g[2]/k,e[15]=0,e},frustumMat4:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2*e/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2*e/i,g[6]=0,g[7]=0,g[8]=(b+a)/h,g[9]=(d+c)/i,g[10]=-(f+e)/j,g[11]=-1,g[12]=0,g[13]=0,g[14]=-(f*e*2)/j,g[15]=0,g},perspectiveMatrix4:function(a,b,c,d,e){var f=[],g=[];return f[2]=c,g[2]=d,g[1]=f[2]*Math.tan(a/2),f[1]=-g[1],g[0]=g[1]*b,f[0]=-g[0],XEO.math.frustumMat4v(f,g,e)},transformPoint3:function(a,b,c){var d=c||XEO.math.vec4();return i[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12],i[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13],i[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14],d[0]=i[0],d[1]=i[1],d[2]=i[2],d[3]=1,d},transformPoint4:function(a,b,c){var d=c||XEO.math.vec4();return i[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3],i[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3],i[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3],i[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3],d[0]=i[0],d[1]=i[1],d[2]=i[2],d[3]=i[3],d},transformPoints3:function(a,b,c){for(var d,e,f,g,h,i=c||[],j=b.length,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=a[12],x=a[13],y=a[14],z=a[15],A=0;j>A;++A)g=b[A],d=g[0],e=g[1],f=g[2],h=i[A]||(i[A]=[0,0,0,1]),h[0]=k*d+o*e+s*f+w,h[1]=l*d+p*e+t*f+x,h[2]=m*d+q*e+u*f+y,h[3]=n*d+r*e+v*f+z;return i.length=j,i},transformVec3:function(a,b,c){var d=b[0],e=b[1],f=b[2];return c=c||this.vec3(),c[0]=a[0]*d+a[4]*e+a[8]*f,c[1]=a[1]*d+a[5]*e+a[9]*f,c[2]=a[2]*d+a[6]*e+a[10]*f,c},transformVec4:function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3];return c=c||this.vec4(),c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*g,c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*g,c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*g,c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*g,c},projectVec4:function(a){var b=1/a[3];return[a[0]*b,a[1]*b,a[2]*b,1]},lerpVec3:function(a,b,c,d,e,f){var g=f||this.vec3(),h=(a-b)/(c-b);return g[0]=d[0]+h*(e[0]-d[0]),g[1]=d[1]+h*(e[1]-d[1]),g[2]=d[2]+h*(e[2]-d[2]),g},getAABBDiag:function(a){var b=c,f=d;return b[0]=a.xmin,b[1]=a.ymin,b[2]=a.zmin,f[0]=a.xmax,f[1]=a.ymax,f[2]=a.zmax,this.subVec3(f,b,e),Math.abs(this.lenVec3(e))},getAABBCenter:function(a,b){var c=b||this.vec3();return c[0]=.5*(a.xmax+a.xmin),c[1]=.5*(a.ymax+a.ymin),c[2]=.5*(a.zmax+a.zmin),c},getAABB2Center:function(a,b){var c=b||this.vec2();return c[0]=(a.xmax+a.xmin)/2,c[1]=(a.ymax+a.ymin)/2,c},AABB3ToOBB3:function(a,b){return b=b||[],b[0]||(b[0]=[]),b[0][0]=a.xmin,b[0][1]=a.ymin,b[0][2]=a.zmin,b[0][3]=1,b[1]||(b[1]=[]),b[1][0]=a.xmax,b[1][1]=a.ymin,b[1][2]=a.zmin,b[1][3]=1,b[2]||(b[2]=[]),b[2][0]=a.xmax,b[2][1]=a.ymax,b[2][2]=a.zmin,b[2][3]=1,b[3]||(b[3]=[]),b[3][0]=a.xmin,b[3][1]=a.ymax,b[3][2]=a.zmin,b[3][3]=1,b[4]||(b[4]=[]),b[4][0]=a.xmin,b[4][1]=a.ymin,b[4][2]=a.zmax,b[4][3]=1,b[5]||(b[5]=[]),b[5][0]=a.xmax,b[5][1]=a.ymin,b[5][2]=a.zmax,b[5][3]=1,b[6]||(b[6]=[]),b[6][0]=a.xmax,b[6][1]=a.ymax,b[6][2]=a.zmax,b[6][3]=1,b[7]||(b[7]=[]),b[7][0]=a.xmin,b[7][1]=a.ymax,b[7][2]=a.zmax,b[7][3]=1,b},positions3ToAABB3:function(a,b){b=b||{xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0};for(var c,d,e,f=1e5,g=1e5,h=1e5,i=-1e5,j=-1e5,k=-1e5,l=0,m=a.length-2;m>l;l+=3)c=a[l+0],d=a[l+1],e=a[l+2],f>c&&(f=c),g>d&&(g=d),h>e&&(h=e),c>i&&(i=c),d>j&&(j=d),e>k&&(k=e);return b.xmin=f,b.ymin=g,b.zmin=h,b.xmax=i,b.ymax=j,b.zmax=k,b},points3ToAABB3:function(a,b){b=b||{xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0};for(var c,d,e,f=1e5,g=1e5,h=1e5,i=-1e5,j=-1e5,k=-1e5,l=0,m=a.length;m>l;l++)c=a[l][0],d=a[l][1],e=a[l][2],f>c&&(f=c),g>d&&(g=d),h>e&&(h=e),c>i&&(i=c),d>j&&(j=d),e>k&&(k=e);return b.xmin=f,b.ymin=g,b.zmin=h,b.xmax=i,b.ymax=j,b.zmax=k,b},expandAABB3:function(a,b){return a.xmin<b.xmin&&(b.xmin=a.xmin),a.ymin<b.ymin&&(b.ymin=a.ymin),a.zmin<b.zmin&&(b.zmin=a.zmin),a.xmax>b.xmax&&(b.xmax=a.xmax),a.ymax>b.ymax&&(b.ymax=a.ymax),a.zmax>b.zmax&&(b.zmax=a.zmax),b},points3ToAABB2:function(a,b){b=b||{xmin:0,xmax:0,ymin:0,ymax:0};for(var c,d,e,f,g,h=1e7,i=1e7,j=-1e7,k=-1e7,l=0,m=a.length;m>l;l++)c=a[l][0],d=a[l][1],e=a[l][2],f=a[l][3]||1,g=1/f,c*=g,d*=g,h>c&&(h=c),i>d&&(i=d),c>j&&(j=c),d>k&&(k=d);return b.xmin=h,b.ymin=i,b.xmax=j,b.ymax=k,b},AABB2ToCanvas:function(a,b,c,d){d=d||a;var e=.5*b,f=.5*c,g=a.xmin,h=-a.ymin,i=a.xmax,j=-a.ymax;return d.xmin=Math.floor(g*e+e),d.ymin=c-Math.floor(h*-f+f),d.xmax=Math.floor(i*e+e),d.ymax=c-Math.floor(j*-f+f),a},buildNormals:function(a,b){for(var c,d,e,f,g,h,i=new Array(a.length/3),j=0,k=b.length;k>j;j+=3){c=b[j+0],d=b[j+1],e=b[j+2],f=[a[3*c+0],a[3*c+1],a[3*c+2]],g=[a[3*d+0],a[3*d+1],a[3*d+2]],h=[a[3*e+0],a[3*e+1],a[3*e+2]],g=XEO.math.subVec3(g,f,[0,0,0]),h=XEO.math.subVec3(h,f,[0,0,0]);var l=XEO.math.normalizeVec3(XEO.math.cross3Vec3(g,h,[0,0,0]),[0,0,0]);i[c]||(i[c]=[]),i[d]||(i[d]=[]),i[e]||(i[e]=[]),i[c].push(l),i[d].push(l),i[e].push(l)}for(var m=new Array(a.length),j=0,k=i.length;k>j;j++){for(var n=i[j].length,o=0,p=0,q=0,r=0;n>r;r++)o+=i[j][r][0],p+=i[j][r][1],q+=i[j][r][2];m[3*j+0]=o/n,m[3*j+1]=p/n,m[3*j+2]=q/n}return m},buildTangents:function(a,b,c){for(var d=[],e=0;e<b.length;e+=3){var f=b[e],g=[a[3*f],a[3*f+1],a[3*f+2]],h=[c[2*f],c[2*f+1]];f=b[e+1];var i=[a[3*f],a[3*f+1],a[3*f+2]],j=[c[2*f],c[2*f+1]];f=b[e+2];for(var k=[a[3*f],a[3*f+1],a[3*f+2]],l=[c[2*f],c[2*f+1]],m=XEO.math.subVec3(i,g,[]),n=XEO.math.subVec3(k,g,[]),o=XEO.math.subVec2(j,h,[]),p=XEO.math.subVec2(l,h,[]),q=1/(o[0]*p[1]-o[1]*p[0]),r=XEO.math.mulVec3Scalar(XEO.math.subVec3(XEO.math.mulVec3Scalar(m,p[1],[]),XEO.math.mulVec3Scalar(n,o[1],[]),[]),q,[]),s=0;3>s;s++){var t=b[e+s];"undefined"!=typeof d[t]?d[t]=XEO.math.addVec3(d[t],r,[]):d[t]=r}}for(var u=[],v=0;v<d.length;v++)u=u.concat(d[v]);return u},flatten:function(a){var b,c,d,e,f,g=[];for(b=0,c=a.length;c>b;b++)for(f=a[b],d=0,e=f.length;e>d;d++)g.push(f[d]);return g},getPickPrimitives:function(a,b,c,d){c=c||{};for(var e,f,g,h,i,j=[],k=[],l=[],m=0,n=0,o=0;o<b.length;o+=3)n++,n=o+1,d?(f=Math.random(),g=Math.random(),h=Math.random(),i=1):(h=(n>>16&255)/255,g=(n>>8&255)/255,f=(255&n)/255,i=1),e=b[o+0],j.push(a[3*e+0]),j.push(a[3*e+1]),j.push(a[3*e+2]),k.push(f),k.push(g),k.push(h),k.push(i),l.push(m++),e=b[o+1],j.push(a[3*e+0]),j.push(a[3*e+1]),j.push(a[3*e+2]),k.push(f),k.push(g),k.push(h),k.push(i),l.push(m++),e=b[o+2],j.push(a[3*e+0]),j.push(a[3*e+1]),j.push(a[3*e+2]),k.push(f),k.push(g),k.push(h),k.push(i),l.push(m++);return c.pickPositions=j,c.pickColors=k,c.pickIndices=l,c},rayTriangleIntersect:function(a,b,h,i,j,k){k=k||XEO.math.vec3();var l=1e-6,m=XEO.math.subVec3(i,h,c),n=XEO.math.subVec3(j,h,d),o=XEO.math.cross3Vec3(b,n,e),p=XEO.math.dotVec3(m,o);if(l>p)return null;var q=XEO.math.subVec3(a,h,f),r=XEO.math.dotVec3(q,o);if(0>r||r>p)return null;var s=XEO.math.cross3Vec3(q,m,g),t=XEO.math.dotVec3(b,s);if(0>t||r+t>p)return null;var u=XEO.math.dotVec3(n,s)/p;return k[0]=a[0]+u*b[0],k[1]=a[1]+u*b[1],k[2]=a[2]+u*b[2],k},rayPlaneIntersect:function(a,b,g,h,i,j){var k=XEO.math;j=j||k.vec3(),b=k.normalizeVec3(b,c);var l=k.subVec3(h,g,d),m=k.subVec3(i,g,e),n=k.cross3Vec3(l,m,f);k.normalizeVec3(n,n);var o=-k.dotVec3(g,n),p=-(k.dotVec3(a,n)+o)/k.dotVec3(b,n);return j[0]=a[0]+p*b[0],j[1]=a[1]+p*b[1],j[2]=a[2]+p*b[2],j},cartesianToBarycentric:function(a,b,i,j,k){var l=XEO.math.subVec3(b,a,c),m=XEO.math.subVec3(i,a,d),n=XEO.math.subVec3(j,a,e),o=XEO.math.subVec3(b,i,f),p=XEO.math.subVec3(b,j,g),q=XEO.math.lenVec3(XEO.math.cross3Vec3(o,p,h));return k[0]=XEO.math.lenVec3(XEO.math.cross3Vec3(m,n,h))/q,k[1]=XEO.math.lenVec3(XEO.math.cross3Vec3(n,l,h))/q,k[2]=XEO.math.lenVec3(XEO.math.cross3Vec3(l,m,h))/q,k},cartesianToBarycentric2:function(a,b,f,g,h){var i=XEO.math,j=i.subVec3(g,b,c),k=i.subVec3(f,b,d),l=i.subVec3(a,b,e),m=i.dotVec3(j,j),n=i.dotVec3(j,k),o=i.dotVec3(j,l),p=i.dotVec3(k,k),q=i.dotVec3(k,l),r=m*p-n*n;if(0===r)return null;var s=1/r,t=(p*o-n*q)*s,u=(m*q-n*o)*s;return h[0]=1-t-u,h[1]=u,h[2]=t,h},barycentricInsideTriangle:function(a){var b=a[1],c=a[2];return c>=0&&b>=0&&1>c+b},barycentricToCartesian2:function(a,b,c,d,e){e=e||XEO.math.vec3();var f=a[0],g=a[1],h=a[2];return e[0]=b[0]*f+c[0]*g+d[0]*h,e[1]=b[1]*f+c[1]*g+d[1]*h,e[2]=b[2]*f+c[2]*g+d[2]*h,e},identityQuaternion:function(a){return a=a||XEO.math.vec4(),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},vec3PairToQuaternion:function(a,b,c){c=c||XEO.math.vec4();var d,e=XEO.math,f=Math.sqrt(e.dotVec3(a,a)*e.dotVec3(b,b)),g=f+e.dotVec3(a,b);return 1e-8*f>g?(g=0,Math.abs(a[0])>Math.abs(a[2])?(d[0]=-a[1],d[1]=a[0],d[2]=0):(d[0]=0,d[1]=-a[2],d[2]=a[1])):d=e.cross3Vec3(a,b),c[0]=d[0],c[1]=d[1],c[2]=d[2],c[3]=g,e.normalizeQuaternion(c)},angleAxisToQuaternion:function(a,b,c,d,e){e=e||XEO.math.vec4();var f=d/180*Math.PI,g=f/2,h=Math.sin(g);return e[0]=h*a,e[1]=h*b,e[2]=h*c,e[4]=Math.cos(g),e},mulQuaternions:function(a,b,c){c=c||XEO.math.vec4();var d=a[0],e=a[1],f=a[2],g=a[3],h=b[0],i=b[1],j=b[2],k=b[3];return c[0]=g*h+d*k+e*j-f*i,c[1]=g*i+e*k+f*h-d*j,c[2]=g*j+f*k+d*i-e*h,c[3]=g*k-d*h-e*i-f*j,c},quaternionToMat4:function(a,b){b=XEO.math.identityMat4(b);var c=a[0],d=a[1],e=a[2],f=a[3],g=2*c,h=2*d,i=2*e,j=g*f,k=h*f,l=i*f,m=g*c,n=h*c,o=i*c,p=h*d,q=i*d,r=i*e;return b[0]=1-(p+r),b[1]=n-l,b[2]=o+k,b[4]=n+l,b[5]=1-(m+r),b[6]=q-j,b[8]=o-k,b[9]=q+j,b[10]=1-(m+p),b},normalizeQuaternion:function(a,b){b=b||a;var c=XEO.math.lenVec4([a[0],a[1],a[2],a[3]]);return b[0]=a[0]/c,b[1]=a[1]/c,b[2]=a[2]/c,b[3]=a[3]/c,b},conjugateQuaternion:function(a,b){return b=b||a,b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=a[3],b},quaternionToAngleAxis:function(a,b){b=b||XEO.math.vec4(),a=XEO.math.normalizeQuaternion(a,i);var c=a[3],d=2*Math.acos(c),e=Math.sqrt(1-c*c);return.001>e?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=a[0]/e,b[0]=a[1]/e,b[0]=a[2]/e),b[3]=57.295779579*d,b}}}(),XEO.math.tangentQuadraticBezier=function(a,b,c,d){return 2*(1-a)*(c-b)+2*a*(d-c)},XEO.math.tangentQuadraticBezier=function(a,b,c,d,e){return-3*b*(1-a)*(1-a)+3*c*(1-a)*(1-a)-6*a*c*(1-a)+6*a*d*(1-a)-3*a*a*d+3*a*a*e},XEO.math.tangentSpline=function(a,b,c,d,e){var f=6*a*a-6*a,g=3*a*a-4*a+1,h=-6*a*a+6*a,i=3*a*a-2*a;return f+g+h+i},XEO.math.catmullRomInterpolate=function(a,b,c,d,e){var f=.5*(c-a),g=.5*(d-b),h=e*e,i=e*h;return(2*b-2*c+f+g)*i+(-3*b+3*c-2*f-g)*h+f*e+b},XEO.math.b2p0=function(a,b){var c=1-a;return c*c*b},XEO.math.b2p1=function(a,b){return 2*(1-a)*a*b},XEO.math.b2p2=function(a,b){return a*a*b},XEO.math.b2=function(a,b,c,d){return this.b2p0(a,b)+this.b2p1(a,c)+this.b2p2(a,d)},XEO.math.b3p0=function(a,b){var c=1-a;return c*c*c*b},XEO.math.b3p1=function(a,b){var c=1-a;return 3*c*c*a*b},XEO.math.b3p2=function(a,b){var c=1-a;return 3*c*a*a*b},XEO.math.b3p3=function(a,b){return a*a*a*b},XEO.math.b3=function(a,b,c,d,e){return this.b3p0(a,b)+this.b3p1(a,c)+this.b3p2(a,d)+this.b3p3(a,e)},function(){"use strict";XEO.Component=Class.extend({__init:function(){var a={},b=arguments[0],c=arguments[1];this.scene=null,"XEO.Scene"===this.type?(this.scene=this,b&&(a=b)):(b?"XEO.Scene"===b.type?(this.scene=b,c&&(a=c)):(this.scene=XEO.scene,a=b):this.scene=XEO.scene,this._renderer=this.scene._renderer),this.meta=a.meta||{},this.id=a.id,this.destroyed=!1,this._children={},this._childDestroySubs={},this._childDirtySubs={},this._handleMap=new XEO.utils.Map,this._eventSubs={},this._handleLocs={},this.props={},this.scene&&"XEO.Scene"!==this.type&&this.scene._addComponent(this),this._init&&this._init(a)},type:"XEO.Component",_init:function(a){},_nextTick:function(a){this.__needBuild||(this.__needBuild=!0,this.scene.once("tick2",a))},fire:function(a,b,c){c!==!0&&(this.props[a]=b);var d,e=this._eventSubs[a];if(e)for(var f in e)e.hasOwnProperty(f)&&(d=e[f],d.callback.call(d.scope,b))},on:function(a,b,c){var d=this._eventSubs[a];d||(d={},this._eventSubs[a]=d);var e=this._handleMap.addItem();d[e]={scope:c||this,callback:b},this._handleLocs[e]=a;var f=this.props[a];return f&&b.call(c||this,f),e},off:function(a){if(void 0!==a&&null!==a){var b=this._handleLocs[a];if(b){delete this._handleLocs[a];var c=this._eventSubs[b];c&&delete c[a],this._handleMap.removeItem(a)}}},once:function(a,b,c){var d=this,e=this.on(a,function(a){d.off(e),b(a)},c)},log:function(a){a="[LOG]"+this._message(a),window.console.log(a),this.scene.fire("log",a)},_message:function(a){return" ["+this.type+" "+XEO._inQuotes(this.id)+"]: "+a},warn:function(a){a="[WARN]"+this._message(a),window.console.warn(a),this.scene.fire("warn",a)},error:function(a){a="[ERROR]"+this._message(a),window.console.error(a),this.scene.fire("error",a)},clone:function(a){if(this.destroyed)return void this.error("Clone failed - component has been destroyed");a=a||{};var b=this.json;return delete b.id,new this.constructor(this.scene,XEO._apply(a,b))},_setChild:function(a,b,c){if(b||c===!1){if(b&&XEO._isNumeric(b)||XEO._isString(b)){var d=b;if(b=this.scene.components[d],!b)return void this.error("Component not found: "+XEO._inQuotes(d))}}else b=this.scene[a];if(b&&b.scene.id!==this.scene.id)return void this.error("Not in same scene: "+b.type+" "+XEO._inQuotes(b.id));var e=this._children[a];if(e){if(b&&e.id===b.id)return;e.off(this._childDestroySubs[a]),e.off(this._childDirtySubs[a])}if(b){this._children[a]=b;var f=this;this._childDestroySubs[a]=b.on("destroyed",function(){delete f._children[a];var c=f.scene[a];return c&&b.id!==c.id?void f._setChild(a,c):void f.fire(a,null)}),this._childDirtySubs[a]=b.on("dirty",function(){f.fire("dirty",!0)})}else delete this._children[a];return this.fire("dirty",!0),this.fire(a,b),b},_compile:function(){},_props:{json:{get:function(){var a={type:this.type,id:this.id};return XEO._isEmptyObject(this.meta)||(a.meta=this.meta),this._getJSON?XEO._apply(this._getJSON(),a):a}},string:{get:function(){return JSON.stringify(this.json,"\n",4)}},js:{get:function(){var a=this.json;delete a.id;var b=JSON.stringify(a,"\n",4);return"new "+this.type+"("+b+");"}}},destroy:function(){var a;for(var b in this._children)this._children.hasOwnProperty(b)&&(a=this._children[b],a.off(this._childDestroySubs[b]),a.off(this._childDirtySubs[b]));this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)},_destroy:function(){}})}(),function(){"use strict";XEO.Scene=XEO.Component.extend({type:"XEO.Scene",_init:function(a){var b=this;this.stats={build:{version:XEO.version},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},canvas:{width:0,height:0},scene:{objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,programs:0},frame:{frameCount:0,renderTime:0,useProgram:0,setUniform:0,setUniformCacheHits:0,bindTexture:0,bindArray:0,drawElements:0,drawChunks:0},_cache:{tangents:0,pickPositions:0,pickColors:0,pickIndices:0}},this._componentIDMap=new XEO.utils.Map,this.startTime=(new Date).getTime(),this.components={},this.types={},this.objects={},this._dirtyObjects={},this.configs=new XEO.Configs(this,a.configs),this.canvas=new XEO.Canvas(this,{canvas:a.canvas,contextAttr:a.contextAttr||{}}),this.canvas.on("size",function(){b._renderer.render({force:!0,clear:!0})}),this.canvas.on("webglContextFailed",function(){alert("xeoEngine failed to find WebGL!")}),this._renderer=new XEO.renderer.Renderer(this.stats,{canvas:this.canvas,transparent:a.transparent}),this.input=new XEO.Input(this,{element:this.canvas.overlay}),this.tasks=new XEO.Tasks(this),XEO._addScene(this);var c=a.components;if(c)for(var d,e,f,g=0,h=c.length;h>g;g++)d=c[g],e=d.type,e&&(f=window[e],f&&new f(this,d));this._initDefaults()},_initDefaults:function(){this.view,this.project,this.camera,this.clips,this.colorTarget,this.colorBuf,this.depthTarget,this.depthBuf,this.visibility,this.modes,this.geometry,this.layer,this.lights,this.material,this.morphTargets,this.reflect,this.shader,this.shaderParams,this.stage,this.transform},_addComponent:function(a){if(a.id){if(this.components[a.id])return void this.error("Component "+XEO._inQuotes(a.id)+" already exists")}else a.id=this._componentIDMap.addItem(a);this.components[a.id]=a;var b=a.type,c=this.types[a.type];c||(c=this.types[b]={}),c[a.id]=a;var d=this;a.on("destroyed",function(){d._componentIDMap.removeItem(a.id),delete d.components[a.id];var b=d.types[a.type];b&&(delete b[a.id],XEO._isEmptyObject(b)&&delete d.types[a.type]),"XEO.GameObject"===a.type&&(d.stats.scene.objects--,delete d.objects[a.id],delete d._dirtyObjects[a.id]),d.fire("componentDestroyed",a,!0)}),"XEO.GameObject"===a.type&&(a.on("dirty",function(){d._dirtyObjects[a.id]||(d._dirtyObjects[a.id]=a)}),this.objects[a.id]=a,this.stats.scene.objects++),this.fire("componentCreated",a,!0)},_props:{project:{get:function(){return this.components["default.project"]||new XEO.Perspective(this,{id:"default.project"})}},view:{get:function(){return this.components["default.view"]||new XEO.Lookat(this,{id:"default.view"})}},camera:{get:function(){return this.components["default.camera"]||new XEO.Camera(this,{id:"default.camera",project:"default.project",view:"default.view"})}},transform:{get:function(){return this.components["default.transform"]||new XEO.Transform(this,{id:"default.transform"})}},billboard:{get:function(){return this.components["default.billboard"]||new XEO.Billboard(this,{id:"default.billboard",active:!1})}},clips:{get:function(){return this.components["default.clips"]||new XEO.Clips(this,{id:"default.clips"})}},colorBuf:{get:function(){return this.components["default.colorBuf"]||new XEO.ColorBuf(this,{id:"default.colorBuf"})}},colorTarget:{get:function(){return this.components["default.colorTarget"]||new XEO.ColorTarget(this,{id:"default.colorTarget",active:!1})}},depthBuf:{get:function(){return this.components["default.depthBuf"]||new XEO.DepthBuf(this,{id:"default.depthBuf",active:!1})}},depthTarget:{get:function(){return this.components["default.depthTarget"]||new XEO.DepthTarget(this,{id:"default.depthTarget",active:!1})}},visibility:{get:function(){return this.components["default.visibility"]||new XEO.Visibility(this,{id:"default.visibility",visible:!0})}},modes:{get:function(){
return this.components["default.modes"]||new XEO.Modes(this,{id:"default.modes"})}},geometry:{get:function(){return this.components["default.geometry"]||new XEO.Geometry(this,{id:"default.geometry"})}},layer:{get:function(){return this.components["default.layer"]||new XEO.Layer(this,{id:"default.layer",priority:0})}},lights:{get:function(){return this.components["default.lights"]||new XEO.Lights(this,{id:"default.lights",lights:[new XEO.AmbientLight(this,{id:"default.light0",color:[.8,.8,.9],intensity:.5}),new XEO.DirLight(this,{id:"default.light1",dir:[-.5,-.5,-1],color:[1,1,.9],intensity:.5,space:"world"}),new XEO.DirLight(this,{id:"default.light2",dir:[1,-.9,.7],color:[1,1,1],intensity:.5,space:"world"})]})}},material:{get:function(){return this.components["default.material"]||new XEO.PhongMaterial(this,{id:"default.material"})}},morphTargets:{get:function(){return this.components["default.morphTargets"]||new XEO.MorphTargets(this,{id:"default.morphTargets"})}},reflect:{get:function(){return this.components["default.reflect"]||new XEO.Reflect(this,{id:"default.reflect"})}},shader:{get:function(){return this.components["default.shader"]||this.components["default.shader"]||new XEO.Shader(this,{id:"default.shader"})}},shaderParams:{get:function(){return this.components["default.shaderParams"]||new XEO.ShaderParams(this,{id:"default.shaderParams"})}},stage:{get:function(){return this.components["default.stage"]||new XEO.Stage(this,{id:"default.stage",priority:0})}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this,b={};this._worldBoundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return!0},getAABB:function(){b.xmin=1e5,b.ymin=1e5,b.zmin=1e5,b.xmax=-1e5,b.ymax=-1e5,b.zmax=-1e5;var c,d=a.objects;for(var e in d)d.hasOwnProperty(e)&&(c=d[e],XEO.math.expandAABB3(c.worldBoundary.aabb,b));return b}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null}),this._setWorldBoundaryDirty()}return this._worldBoundary}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0)},pick:function(){function a(a,b,c,d){var e=XEO.math,f=a.scene.canvas.canvas,g=a.transform.matrix,h=a.camera.view.matrix,i=a.camera.project.matrix,j=e.mulMat4(h,g,q),k=e.mulMat4(i,j,r),l=e.inverseMat4(k,r),m=f.width,n=f.height,o=(b[0]-m/2)/(m/2),p=-(b[1]-n/2)/(n/2),u=e.transformVec4(l,[o,p,-1,1],s);u=e.mulVec4Scalar(u,1/u[3]);var v=e.transformVec4(l,[o,p,1,1],t);v=e.mulVec4Scalar(v,1/v[3]),c[0]=u[0],c[1]=u[1],c[2]=u[2],e.subVec3(v,u,d),e.normalizeVec3(d)}var b=XEO.math.vec3(),c=XEO.math.vec3(),d=XEO.math.vec3(),e=XEO.math.vec3(),f=XEO.math.vec3(),g=XEO.math.vec3(),h=XEO.math.vec4(),i=XEO.math.vec4(),j=XEO.math.vec3(),k=XEO.math.vec3(),l=XEO.math.vec3(),m=XEO.math.vec3(),n=XEO.math.vec3(),o=XEO.math.vec3(),p=XEO.math.vec3(),q=XEO.math.mat4(),r=XEO.math.mat4(),s=XEO.math.vec4(),t=XEO.math.vec4(),u=(XEO.math.vec4(),XEO.math.vec3()),v=XEO.math.vec3(),w=XEO.math.vec3(),x=XEO.math.vec3(),y=XEO.math.vec3(),z=XEO.math.vec3(),A=XEO.math.vec3(),B=XEO.math.vec3(),C=XEO.math.vec3(),D=XEO.math.vec3();return function(q,r){var E=XEO.math;r=r||{};var F=this._renderer.pick({canvasPos:q,rayPick:r.rayPick});if(F){var G=this.objects[F.object];if(F.object=G,-1!==F.primitiveIndex){var H=G.geometry;if("triangles"===H.primitive){F.primitive="triangle";var I=F.primitiveIndex,J=H.indices,K=H.positions,L=J[I],M=J[I+1],N=J[I+2];g[0]=L,g[1]=M,g[2]=N,F.indices=g,d[0]=K[3*L],d[1]=K[3*L+1],d[2]=K[3*L+2],e[0]=K[3*M],e[1]=K[3*M+1],e[2]=K[3*M+2],f[0]=K[3*N],f[1]=K[3*N+1],f[2]=K[3*N+2],a(G,q,b,c),E.rayPlaneIntersect(b,c,d,e,f,h),F.position=h,s[0]=h[0],s[1]=h[1],s[2]=h[2],s[3]=1,E.transformVec4(G.transform.matrix,s,t),i[0]=t[0],i[1]=t[1],i[2]=t[2],F.worldPos=i,E.cartesianToBarycentric2(h,d,e,f,j),F.barycentric=j;var O=H.normals;O&&(k[0]=O[3*L],k[1]=O[3*L+1],k[2]=O[3*L+2],l[0]=O[3*M],l[1]=O[3*M+1],l[2]=O[3*M+2],m[0]=O[3*N],m[1]=O[3*N+1],m[2]=O[3*N+2],F.normal=E.addVec3(E.addVec3(E.mulVec3Scalar(k,j[0],u),E.mulVec3Scalar(l,j[1],v),w),E.mulVec3Scalar(m,j[2],x),y));var P=H.uv;P&&(n[0]=P[2*L],n[1]=P[2*L+1],o[0]=P[2*M],o[1]=P[2*M+1],p[0]=P[2*N],p[1]=P[2*N+1],F.uv=E.addVec3(E.addVec3(E.mulVec2Scalar(n,j[0],z),E.mulVec2Scalar(o,j[1],A),B),E.mulVec2Scalar(p,j[2],C),D))}}return F}}}(),clear:function(){for(var a in this.components)this.components.hasOwnProperty(a)&&this.components[a].destroy();this._initDefaults(),this._dirtyObjects={}},testPattern:function(){this.clear();var a=new XEO.Rotate(this,{xyz:[0,.5,.5],angle:0}),b=new XEO.GameObject(this,{transform:a}),c=0,d=this.on("tick",function(){b.transform.angle=c,c+=.5}),e=this;b.on("destroyed",function(){e.off(d)}),this.on("componentCreated",function(){b.destroy(),a.destroy()})},_compile:function(){var a=0;for(var b in this._dirtyObjects)this._dirtyObjects.hasOwnProperty(b)&&(this._dirtyObjects[b]._compile(),delete this._dirtyObjects[b],a++);this._renderer.render({clear:!0})},_getJSON:function(){var a,b=[];for(var c in this.components)if(this.components.hasOwnProperty(c)){if(a=this.components[c],!a._getJSON)continue;b.unshift(a)}b.sort(function(a,b){return a._componentOrder-b._componentOrder});for(var d=[],e=0,f=b.length;f>e;e++)d.push(b[e].json);return{components:d}},_destroy:function(){this.clear()}})}(),function(){"use strict";XEO.MorphTargets=XEO.Component.extend({type:"XEO.MorphTargets",_init:function(a){this.scene.on("webglContextRestored",function(){}),this.targets=a.targets,this.factor=a.factor},_props:{targets:{set:function(a){},get:function(){}},factor:{set:function(a){},get:function(){return 0}},_compile:function(){this._renderer.MorphTargets=this._state}},_getJSON:function(){return{targets:this.targets,factor:this.factor}}})}(),function(){"use strict";XEO.Camera=XEO.Component.extend({type:"XEO.Camera",_init:function(a){this.project=a.project,this.view=a.view},_props:{project:{set:function(a){var b=this._children.project;b&&b.off(this._onProjectMatrix),this._setChild("project",a);var c=this._children.project;if(c){var d=this;this._onProjectMatrix=c.on("matrix",function(){d.fire("projectMatrix")})}},get:function(){return this._children.project}},view:{set:function(a){var b=this._children.project;b&&b.off(this._onViewMatrix),this._setChild("view",a);var c=this._children.view;if(c){var d=this;this._onViewMatrix=c.on("matrix",function(){d.fire("viewMatrix")})}},get:function(){return this._children.view}}},_compile:function(){this._children.project._compile(),this._children.view._compile()},_getJSON:function(){var a={};return this._children.project&&(a.project=this._children.project.id),this._children.view&&(a.view=this._children.view.id),a}})}(),function(){"use strict";XEO.Frustum=XEO.Component.extend({type:"XEO.Frustum",_init:function(a){this._state=new XEO.renderer.ProjTransform({matrix:XEO.math.mat4()}),this._dirty=!1,this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=1e4,this.left=a.left,this.right=a.right,this.bottom=a.bottom,this.top=a.top,this.near=a.near,this.far=a.far},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick2",function(){a._build()})}},_build:function(){XEO.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix),this._dirty=!1,this.fire("matrix",this._state.matrix)},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._dirty&&this._build(),this._state.matrix}}},_compile:function(){this._renderer.projTransform=this._state},_getJSON:function(){return{left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Lookat=XEO.Component.extend({type:"XEO.Lookat",_init:function(a){this._state=new XEO.renderer.ViewTransform({matrix:XEO.math.mat4(),normalMatrix:XEO.math.mat4(),eye:[0,0,-10],look:[0,0,0],up:[0,1,0]}),this._dirty=!0,this.eye=a.eye,this.look=a.look,this.up=a.up},_lookatDirty:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick2",function(){a._buildLookat()})}},_buildLookat:function(){this._state.matrix=new Float32Array(XEO.math.lookAtMat4c(this._state.eye[0],this._state.eye[1],this._state.eye[2],this._state.look[0],this._state.look[1],this._state.look[2],this._state.up[0],this._state.up[1],this._state.up[2],this._state.matrix)),this._state.normalMatrix=new Float32Array(XEO.math.transposeMat4(new Float32Array(XEO.math.inverseMat4(this._state.matrix,this._state.normalMatrix),this._state.normalMatrix))),this._dirty=!1,this._renderer.imageDirty=!0,this.fire("matrix",this._state.matrix)},rotateEyeY:function(a){var b=XEO.math.subVec3(this._state.eye,this._state.look,[]),c=XEO.math.rotationMat4v(.0174532925*a,this._state.up);b=XEO.math.transformPoint3(c,b,[]),this.eye=XEO.math.addVec3(b,this._state.look,[])},rotateEyeX:function(a){var b=XEO.math.subVec3(this._state.eye,this._state.look,[]),c=XEO.math.cross3Vec3(XEO.math.normalizeVec3(b,[]),XEO.math.normalizeVec3(this._state.up,[])),d=XEO.math.rotationMat4v(.0174532925*a,c);b=XEO.math.transformPoint3(d,b,[]),this.eye=XEO.math.addVec3(b,this._state.look,[]),this.up=XEO.math.transformPoint3(d,this._state.up,[])},rotateLookY:function(a){var b=XEO.math.subVec3(this._state.look,this._state.eye,[]),c=XEO.math.rotationMat4v(.0174532925*a,this._state.up);b=XEO.math.transformPoint3(c,b,[]),this.look=XEO.math.addVec3(b,this._state.eye,[])},rotateLookX:function(a){var b=XEO.math.subVec3(this._state.look,this._state.eye,[]),c=XEO.math.cross3Vec3(XEO.math.normalizeVec3(b,[]),XEO.math.normalizeVec3(this._state.up,[])),d=XEO.math.rotationMat4v(.0174532925*a,c);b=XEO.math.transformPoint3(d,b,[]),this.look=XEO.math.addVec3(b,this._state.eye,[]),this.up=XEO.math.transformPoint3(d,this._state.up,[])},pan:function(a){var b,c=XEO.math.subVec3(this._state.eye,this._state.look,[]),d=[0,0,0];if(0!==a[0]){var e=XEO.math.cross3Vec3(XEO.math.normalizeVec3(c,[]),XEO.math.normalizeVec3(this._state.up,[]));b=XEO.math.mulVec3Scalar(e,a[0]),d[0]+=b[0],d[1]+=b[1],d[2]+=b[2]}0!==a[1]&&(b=XEO.math.mulVec3Scalar(XEO.math.normalizeVec3(this._state.up,[]),a[1]),d[0]+=b[0],d[1]+=b[1],d[2]+=b[2]),0!==a[2]&&(b=XEO.math.mulVec3Scalar(XEO.math.normalizeVec3(c,[]),a[2]),d[0]+=b[0],d[1]+=b[1],d[2]+=b[2]),this.eye=XEO.math.addVec3(this._state.eye,d,[]),this.look=XEO.math.addVec3(this._state.look,d,[])},zoom:function(a){var b=XEO.math.subVec3(this._state.eye,this._state.look,[]),c=Math.abs(XEO.math.lenVec3(b,[])),d=Math.abs(c+a),e=XEO.math.normalizeVec3(b,[]);this.eye=XEO.math.addVec3(this._state.look,XEO.math.mulVec3Scalar(e,d),[])},_props:{eye:{set:function(a){a=a||[0,0,-10];var b=this._state.eye;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._lookatDirty(),this.fire("eye",this._state.eye)},get:function(){return this._state.eye}},look:{set:function(a){a=a||[0,0,0];var b=this._state.look;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._lookatDirty(),this.fire("look",this._state.look)},get:function(){return this._state.look}},up:{set:function(a){a=a||[0,1,0];var b=this._state.up;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._lookatDirty(),this.fire("up",this._state.up)},get:function(){return this._state.up}},matrix:{get:function(){return this._dirty&&this._buildLookat(),this._state.matrix}}},_compile:function(){this._dirty&&this._buildLookat(),this._renderer.viewTransform=this._state},_getJSON:function(){return{eye:this._state.eye,look:this._state.look,up:this._state.up}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Ortho=XEO.Component.extend({type:"XEO.Ortho",_init:function(a){this._state=new XEO.renderer.ProjTransform({matrix:XEO.math.mat4()}),this._dirty=!1,this._left=-1,this._right=1,this._top=1,this._bottom=-1,this._near=.1,this._far=1e4,this.left=a.left,this.right=a.right,this.top=a.top,this.bottom=a.bottom,this.near=a.near,this.far=a.far},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick2",function(){a._build()})}},_build:function(){XEO.math.orthoMat4c(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix),this._dirty=!1,this.fire("matrix",this._state.matrix)},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._dirty&&this._build(),this._state.matrix}}},_compile:function(){this._dirty&&this._build(),this._renderer.projTransform=this._state},_getJSON:function(){return{left:this._left,right:this._right,top:this._top,bottom:this._bottom,near:this._near,far:this._far}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Perspective=XEO.Component.extend({type:"XEO.Perspective",_init:function(a){this._state=new XEO.renderer.ProjTransform({matrix:XEO.math.mat4()}),this._dirty=!1,this._fovy=60,this._near=.1,this._far=1e4;var b=this,c=this.scene.canvas;this._canvasResized=c.on("size",function(){b._scheduleBuild()}),this.fovy=a.fovy,this.near=a.near,this.far=a.far},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick2",function(){a._build()})}},_build:function(){var a=this.scene.canvas.canvas,b=a.clientWidth/a.clientHeight;XEO.math.perspectiveMatrix4(this._fovy*(Math.PI/180),b,this._near,this._far,this._state.matrix),this._dirty=!1,this.fire("matrix",this._state.matrix)},_props:{fovy:{set:function(a){this._fovy=void 0!==a&&null!==a?a:60,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("fovy",this._fovy)},get:function(){return this._fovy}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._renderer.imageDirty=!0,this._scheduleBuild(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._dirty&&this._build(),this._state.matrix}}},_compile:function(){this._dirty&&this._build(),this._renderer.projTransform=this._state},_getJSON:function(){return{fovy:this._fovy,near:this._near,far:this._far}},_destroy:function(){this.scene.canvas.off(this._canvasResized),this._state.destroy()}})}(),function(){"use strict";XEO.Canvas=XEO.Component.extend({type:"XEO.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(a){if(this.canvas=null,this.overlay=null,this.gl=null,this.contextAttr=a.contextAttr||{},a.canvas?XEO._isString(a.canvas)?(this.canvas=document.getElementById(a.canvas),this.canvas||(this.error("Canvas element not found: "+XEO._inQuotes(a.canvas)+" - creating default canvas instead."),this._createCanvas())):(this.error("Config 'canvasId' should be a string - creating default canvas instead."),this._createCanvas()):this._createCanvas(),!this.canvas)return void this.error("Faied to create canvas");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this._createOverlay(),this._initWebGL();var b=this;this.canvas.addEventListener("webglcontextlost",function(){b.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){b._initWebGL(),b.gl&&b.fire("webglContextRestored",b.gl)},!1);var c=null,d=null;this._tick=this.scene.on("tick",function(){var a=b.canvas;if(a.clientWidth!==c||a.clientHeight!==d){var e=a.clientWidth,f=a.clientHeight;b.fire("size",{width:e,height:f,aspect:f/e});var g=b.scene.stats.canvas;g.width=e,g.height=f,c=e,d=f}}),this.canvas.oncontextmenu=function(a){a.preventDefault()}},_createCanvas:function(){var a="XEO-canvas-"+XEO.math.createUUID(),b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height="100%",d.width="100%",d.padding="0",d.margin="0",d.background="black",d["float"]="left",d.left="0",d.top="0",d.position="absolute",d["z-index"]="-10000",c.innerHTML+='<canvas id="'+a+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',b.appendChild(c),this.canvas=document.getElementById(a)},_createOverlay:function(){var a="XEO-overlay-"+XEO.math.createUUID(),b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height=this.canvas.height+"px",d.width="100%",d.padding="0",d.margin="0",d.background="black",d["float"]="left",d.left="0",d.top="0",d.position="absolute",d.opacity=0,d["z-index"]="100000",c.innerHTML+='<div id="'+a+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0; opacity: 0;"></overlay>',b.appendChild(c),this.overlay=document.getElementById(a)},_initWebGL:function(){for(var a=XEO._applyIf({preserveDrawingBuffer:!1},this.contextAttr),b=0;!this.gl&&b<this._WEBGL_CONTEXT_NAMES.length;b++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[b],a)}catch(c){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0))},_destroy:function(){this.scene.off(this._tick)}})}(),function(){"use strict";XEO.Clip=XEO.Component.extend({type:"XEO.Clip",_init:function(a){this._state={mode:"disabled",dir:[1,0,0],dist:1},this.mode=a.mode,this.dir=a.dir,this.dist=a.dist},_props:{mode:{set:function(a){this._state.mode=a||"disabled",this._renderer.imageDirty=!0,this.fire("mode",this._state.mode)},get:function(){return this._state.mode}},dir:{set:function(a){this._state.dir=a||[1,0,0],this._renderer.imageDirty=!0,this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},dist:{set:function(a){this._state.dist=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("dist",this._state.dist)},get:function(){return this._state.dist}}},_getJSON:function(){return{mode:this._state.mode,dir:this._state.dir,dist:this._state.dist}}})}(),function(){"use strict";XEO.Clips=XEO.Component.extend({type:"XEO.Clips",_init:function(a){this._state=new XEO.renderer.Clips({clips:[],hash:""}),this._dirty=!0,this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=a.clips},_props:{clips:{set:function(a){function b(){g.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=g._clips.length;c>b;b++)if(g._clips[b].id===a)return g._clips=g._clips.slice(b,b+1),g._dirtySubs=g._dirtySubs.slice(b,b+1),g._destroyedSubs=g._destroyedSubs.slice(b,b+1),g._dirty=!0,g.fire("dirty",!0),void g.fire("clips",g._clips)}a=a||[];for(var d,e=0,f=this._clips.length;f>e;e++)d=this._clips[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];for(var g=this,e=0,f=a.length;f>e;e++){if(d=a[e],XEO._isString(d)){var h=d;if(d=this.components[h],!d){this.error("Component not found: "+XEO._inQuotes(h));continue}}"XEO.Clip"===d.type?(this._clips.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+XEO._inQuotes(h)+" is not a XEO.Clip")}this._dirty=!0,this.fire("dirty",!0),this.fire("clips",this._clips)},get:function(){return this._clips.slice(0,this._clips.length)}}},_compile:function(){var a=this._state;if(this._dirty){a.clips=[];for(var b=0,c=this._clips.length;c>b;b++)a.clips.push(this._clips[b]._state);this._makeHash(),this._dirty=!1}this._renderer.clips=a},_makeHash:function(){var a=this._state.clips;if(0===a.length)return";";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b._state.mode);c.push(";"),this._state.hash=c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._clips.length;c>b;b++)a.push(this._clips[b].id);return{clips:a}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Configs=XEO.Component.extend({type:"XEO.Configs",_init:function(a){for(var b in a)a.hasOwnProperty(b)&&this.fire(b,a[b])},set:function(a,b){this.fire(a,b)},_toJSON:function(){return XEO._copy(this.props)}})}(),function(){"use strict";XEO.Visibility=XEO.Component.extend({type:"XEO.Visibility",_init:function(a){this._state=new XEO.renderer.Visibility({visible:!0}),this.visible=a.visible},_props:{visible:{set:function(a){this._state.visible=a!==!1,this._renderer.drawListDirty=!0,this.fire("visible",this._state.visible)},get:function(){return this._state.visible}}},_compile:function(){this._renderer.visibility=this._state},_getJSON:function(){return{visible:this.visible}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Geometry=XEO.Component.extend({type:"XEO.Geometry",_init:function(a){var b=this;this._state=new XEO.renderer.Geometry({primitive:null,primitiveName:null,positions:null,colors:null,normals:null,uv:null,tangents:null,indices:null,getTangents:function(){return b._tangentsDirty&&b._buildTangents(),b._tangents},getPickPositions:function(){return b._pickVBOsDirty&&b._buildPickVBOs(),b._pickPositions},getPickColors:function(){return b._pickVBOsDirty&&b._buildPickVBOs(),b._pickColors},getPickIndices:function(){return b._pickVBOsDirty&&b._buildPickVBOs(),b._pickIndices}}),this._positionsData=null,this._colorsData=null,this._normalsData=null,this._uvData=null,this._tangentsData=null,this._indicesData=null,this._tangents=null,this._pickPositions=null,this._pickColors=null,this._pickIndices=null,this._dirty=!1,this._positionsDirty=!0,this._colorsDirty=!0,this._normalsDirty=!0,this._uvDirty=!0,this._tangentsDirty=!0,this._indicesDirty=!0,this._pickVBOsDirty=!0,this._boundary=null,this._boundaryDirty=!0;var c=!(a.positions||a.normals||a.uv||a.indices);if(c)this.primitive=a.primitive,this.positions=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],this.uv=[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],this.tangents=null,this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];else{var d=(!a.primitive||"line-strip"===a.primitive)&&a.positions&&!a.indices;if(d){for(var e=[],f=0,g=a.positions.length/3;g>f;f++)e.push(f);this.primitive="line-strip",this.positions=a.positions,this.indices=e}else this.primitive=a.primitive,this.positions=a.positions,this.colors=a.colors,this.normals=a.normals,this.uv=a.uv,this.tangents=a.tangents,this.indices=a.indices}this.autoNormals=a.autoNormals,this.usage=a.usage;var b=this;this._webglContextRestored=this.scene.canvas.on("webglContextRestored",function(){b._scheduleBuild()}),this.scene.stats.memory.meshes++},_scheduleBuild:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick3",function(){a._build()})}},_build:function(){var a=this.scene.canvas.gl;switch(this._state.primitiveName){case"points":this._state.primitive=a.POINTS;break;case"lines":this._state.primitive=a.LINES;break;case"line-loop":this._state.primitive=a.LINE_LOOP;break;case"line-strip":this._state.primitive=a.LINE_STRIP;break;case"triangles":this._state.primitive=a.TRIANGLES;break;case"triangle-strip":this._state.primitive=a.TRIANGLE_STRIP;break;case"triangle-fan":this._state.primitive=a.TRIANGLE_FAN;break;default:this._state.primitive=a.TRIANGLES}var b=a.STATIC_DRAW,c=this.scene.stats.memory;this._positionsDirty&&(this._state.positions&&(c.positions-=this._state.positions.numItems,this._state.positions.destroy()),this._state.positions=this._positionsData?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._positionsData),this._positionsData.length,3,b):null,c.positions+=this._state.positions.numItems,this._positionsDirty=!1,this._pickVBOsDirty=!0),this._colorsDirty&&(this._state.colors&&(c.colors-=this._state.colors.numItems,this._state.colors.destroy()),this._state.colors=this._colorsData?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._colorsData),this._colorsData.length,4,b):null,this._state.colors&&(c.colors+=this._state.colors.numItems),this._colorsDirty=!1),this._normalsDirty&&(this._state.normals&&(c.normals-=this._state.normals.numItems,this._state.normals.destroy()),this._autoNormals&&this._positionsData&&this._indicesData&&(this._normalsData=XEO.math.buildNormals(this._positionsData,this._indicesData)),this._state.normals=this._normalsData?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._normalsData),this._normalsData.length,3,b):null,this._state.normals&&(c.normals+=this._state.normals.numItems),this._normalsDirty=!1,this._tangentsDirty=!0),this._uvDirty&&(this._state.uv&&(c.uvs-=this._state.uv.numItems,this._state.uv.destroy()),this._state.uv=this._uvData?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._uvData),this._uvData.length,2,b):null,this._state.uv&&(c.uvs+=this._state.uv.numItems),this._uvDirty=!1,this._tangentsDirty=!0),this._indicesDirty&&(this._state.indices&&(c.indices-=this._state.indices.numItems,this._state.indices.destroy()),this._state.indices=this._indicesData?new XEO.renderer.webgl.ArrayBuffer(a,a.ELEMENT_ARRAY_BUFFER,new Uint16Array(this._indicesData),this._indicesData.length,1,b):null,this._state.indices&&(c.indices+=this._state.indices.numItems),this._indicesDirty=!1,this._pickVBOsDirty=!0),this._dirty=!1},_buildTangents:function(){if(this._tangentsDirty){this._tangents&&this._tangents.destroy();var a=this.scene.canvas.gl,b=a.STATIC_DRAW;this._tangents=this._tangentsData?new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(this._tangentsData),this._tangentsData.length,4,b):null,this._tangentsDirty=!1}},_buildPickVBOs:function(){if(this._pickVBOsDirty){if(this._destroyPickVBOs(),this._positionsData&&this._indicesData){var a=this.scene.canvas.gl,b=a.STATIC_DRAW,c=XEO.math.getPickPrimitives(this._positionsData,this._indicesData),d=c.pickPositions,e=c.pickColors,f=c.pickIndices;this._pickPositions=new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(d),d.length,3,b),this._pickColors=new XEO.renderer.webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(e),e.length,4,b),this._pickIndices=new XEO.renderer.webgl.ArrayBuffer(a,a.ELEMENT_ARRAY_BUFFER,new Uint16Array(f),f.length,1,b);var g=this.scene.stats._cache;g.pickPositions+=this._pickPositions.numItems,g.pickColors+=this._pickColors.numItems,g.pickIndices+=this._pickIndices.numItems}this._pickVBOsDirty=!1}},_destroyPickVBOs:function(){var a=this.scene.stats._cache;this._pickPositions&&(this._pickPositions.destroy(),a.pickPositions-=this._pickPositions.numItems,this._pickPositions=null),this._pickColors&&(this._pickColors.destroy(),a.pickColors-=this._pickColors.numItems,this._pickColors=null),this._pickIndices&&(this._pickIndices.destroy(),cacheStats_cache.pickIndices-=this._pickIndices.numItems,this._pickIndices=null),this._pickVBOsDirty=!0},_props:{usage:{set:function(a){a=a||"static","static"!==a&&"dynamic"!==a&&"stream"!==a&&(this.error("Unsupported value for 'usage': '"+a+"' - supported values are 'static', 'dynamic' and 'stream'."),a="static"),this._state.usageName=a,this._scheduleBuild(),this.fire("dirty",!0),this.fire("usage",this._state.usageName)},get:function(){return this._state.usageName}},primitive:{set:function(a){a=a||"triangles","points"!==a&&"lines"!==a&&"line-loop"!==a&&"line-strip"!==a&&"triangles"!==a&&"triangle-strip"!==a&&"triangle-fan"!==a&&(this.error("Unsupported value for 'primitive': '"+a+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),a="triangles"),this._state.primitiveName=a,this._scheduleBuild(),this.fire("dirty",!0),this.fire("primitive",this._state.primitiveName)},get:function(){return this._state.primitiveName}},positions:{set:function(a){var b=!this._positionsData!=!a;this._positionsData=a,this._positionsDirty=!0,this._scheduleBuild(),this._setBoundaryDirty(),b&&this.fire("dirty",!0),this.fire("positions",this._positionsData),this.fire("boundary",!0),this._renderer.imageDirty=!0},get:function(){return this._positionsData}},normals:{set:function(a){var b=!this._normalsData!=!a;this._normalsData=a,this._normalsDirty=!0,this._scheduleBuild(),b&&this.fire("dirty",!0),this.fire(" normals",this._normalsData),this._renderer.imageDirty=!0},get:function(){return this._normalsData}},uv:{set:function(a){var b=!this._uvData!=!a;this._uvData=a,this._uvDirty=!0,this._scheduleBuild(),b&&this.fire("dirty",!0),this.fire("uv",this._uvData),this._renderer.imageDirty=!0},get:function(){return this._uvData}},colors:{set:function(a){var b=!this._colorsData!=!a;this._colorsData=a,this._colorsDirty=!0,this._scheduleBuild(),b&&this.fire("dirty",!0),this.fire("colors",this._colorsData),this._renderer.imageDirty=!0},get:function(){return this._colorsData}},indices:{set:function(a){var b=!this._indicesData&&!a;this._indicesData=a,this._indicesDirty=!0,this._scheduleBuild(),b&&this.fire("dirty",!0),this.fire("indices",this._indicesData),this._renderer.imageDirty=!0},get:function(){return this._indicesData}},boundary:{get:function(){if(!this._boundary){var a=this;this._boundary=new XEO.Boundary3D(this.scene,{getDirty:function(){return a._boundaryDirty},getPositions:function(){return a._positionsData}}),this._boundary.on("destroyed",function(){a._boundary=null}),this._setBoundaryDirty()}return this._boundary}},autoNormals:{set:function(a){a=!!a,this._autoNormals!==a&&(this._autoNormals=a,this._normalsDirty=!0,this.fire("autoNormals",this._autoNormals),this._scheduleBuild())},get:function(){return this._autoNormals}}},_setBoundaryDirty:function(){this._boundaryDirty=!0,this._boundary&&this._boundary.fire("updated",!0)},_compile:function(){this._dirty&&this._build(),this._renderer.geometry=this._state},_getJSON:function(){return{primitive:this._state.primitiveName,positions:this._positionsData,normals:this._normalsData,uv:this._uvData,colors:this._colorsData,indices:this._indicesData}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.positions&&this._state.positions.destroy(),this._state.colors&&this._state.colors.destroy(),this._state.normals&&this._state.normals.destroy(),
this._state.uv&&this._state.uv.destroy(),this._state.indices&&this._state.indices.destroy(),this._tangentsData&&this._tangentsData.destroy(),this._pickPositions&&this._pickPositions.destroy(),this._pickColors&&this._pickColors.destroy(),this._pickIndices&&this._pickIndices.destroy(),this._boundary&&this._boundary.destroy(),this._state.destroy(),this.scene.stats.memory.meshes--}})}(),function(){"use strict";XEO.Input=XEO.Component.extend({type:"XEO.Input",serializable:!1,_init:function(a){var b=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,document.addEventListener("keydown",this._keyDownListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!0:a.altKey?b.altDown=!0:(b.keyDown[a.keyCode]=!0,b.fire("keydown",a.keyCode,!0)))},!0),document.addEventListener("keyup",this._keyUpListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!1:a.altKey?b.altDown=!1:(b.keyDown[a.keyCode]=!1,b.fire("keyup",a.keyCode,!0)))}),a.element.addEventListener("mousedown",this._mouseDownListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!0;break;case 2:b.mouseDownMiddle=!0;break;case 3:b.mouseDownRight=!0}var c=b._getClickCoordsWithinElement(a);b.fire("mousedown",c,!0)}}),a.element.addEventListener("mouseup",this._mouseUpListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("mouseup",c,!0)}}),a.element.addEventListener("dblclick",this._dblClickListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1,b.mouseDownRight=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownLeft=!1,b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("dblclick",c,!0)}}),a.element.addEventListener("mousemove",this._mouseMoveListener=function(a){if(b.enabled){var c=b._getClickCoordsWithinElement(a);b.fire("mousemove",c,!0)}}),a.element.addEventListener("mousewheel",this._mouseWheelListener=function(a,c){if(b.enabled){var a=window.event||a,d=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail));b.fire("mousewheel",d,!0)}}),function(){var a,c,d=2;b.on("mousedown",function(b){a=b[0],c=b[1]}),b.on("mouseup",function(e){a>=e[0]-d&&a<=e[0]+d&&c>=e[1]-d&&c<=e[1]+d&&b.fire("mouseclicked",e,!0)})}()},_getClickCoordsWithinElement:function(a){var b=[0,0];if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b},setEnabled:function(a){this.enabled!==a&&this.fire("enabled",this.enabled=a)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}})}(),function(){"use strict";XEO.Lights=XEO.Component.extend({type:"XEO.Lights",_init:function(a){this._state=new XEO.renderer.Lights({lights:[],hash:""}),this._dirty=!0,this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],this.lights=a.lights},_props:{lights:{set:function(a){function b(){g.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=g._lights.length;c>b;b++)if(g._lights[b].id===a)return g._lights=g._lights.slice(b,b+1),g._dirtySubs=g._dirtySubs.slice(b,b+1),g._destroyedSubs=g._destroyedSubs.slice(b,b+1),g._dirty=!0,g.fire("dirty",!0),void g.fire("lights",g._lights)}a=a||[];var d,e,f;for(e=0,f=this._lights.length;f>e;e++)d=this._lights[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];var g=this;for(e=0,f=a.length;f>e;e++){if(d=a[e],XEO._isNumeric(d)||XEO._isString(d)){var h=d;if(d=this.scene.components[h],!d){this.error("Component not found: "+XEO._inQuotes(h));continue}}var i=d.type;"XEO.AmbientLight"===i||"XEO.DirLight"==i||"XEO.PointLight"==i?(this._lights.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+XEO._inQuotes(d.id)+" is not an XEO.AmbientLight, XEO.DirLight or XEO.PointLight ")}this._dirty=!0,this.fire("dirty",!0),this.fire("lights",this._lights)},get:function(){return this._lights}}},_compile:function(){var a=this._state;if(this._dirty){a.lights=[];for(var b=0,c=this._lights.length;c>b;b++)a.lights.push(this._lights[b]._state);this._makeHash(),this._dirty=!1}this._renderer.lights=a},_makeHash:function(){var a=this._state.lights;if(0===a.length)return";";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b.type),c.push("world"===b.space?"w":"v");c.push(";"),this._state.hash=c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._lights.length;c>b;b++)a.push(this._lights[b].id);return{lights:a}},_destroy:function(){var a,b,c;for(a=0,b=this._lights.length;b>a;a++)c=this._lights[a],c.off(this._dirtySubs[a]),c.off(this._destroyedSubs[a]);this._state.destroy()}})}(),function(){"use strict";XEO.AmbientLight=XEO.Component.extend({type:"XEO.AmbientLight",_init:function(a){this._state={type:"ambient",color:[.7,.7,.7],intensity:1},this.color=a.color,this.intensity=a.intensity},_props:{color:{set:function(a){this._state.color=a||[.7,.7,.8],this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){this._state.intensity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}},_getJSON:function(){return{color:this._state.color,intensity:this._state.intensity}}})}(),function(){"use strict";XEO.DirLight=XEO.Component.extend({type:"XEO.DirLight",_init:function(a){this._state={type:"dir",dir:[0,0,-1],color:[.7,.7,.8],intensity:1,space:"view"},this.dir=a.dir,this.color=a.color,this.intensity=a.intensity,this.space=a.space},_props:{dir:{set:function(a){a=a||[1,1,1];var b=this._state.dir;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._renderer.imageDirty=!0,this.fire("dir",b)},get:function(){return this._state.dir}},color:{set:function(a){a=a||[.7,.7,.8];var b=this._state.color;b[0]=a[0],b[1]=a[1],b[2]=a[2],this._renderer.imageDirty=!0,this.fire("color",b)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,dir:this._state.dir,color:this._state.color,intensity:this._state.intensity,space:this._state.space}}})}(),function(){"use strict";XEO.PointLight=XEO.Component.extend({type:"XEO.PointLight",_init:function(a){this._state={type:"point",pos:[1,1,1],color:[.7,.7,.8],intensity:1,attenuation:[0,0,0],space:"view"},this.pos=a.pos,this.color=a.color,this.intensity=a.intensity,this.constantAttenuation=a.constantAttenuation,this.linearAttenuation=a.linearAttenuation,this.quadraticAttenuation=a.quadraticAttenuation,this.space=a.space},_props:{pos:{set:function(a){this._state.pos=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},color:{set:function(a){this._state.color=a||[.7,.7,.8],this._renderer.imageDirty=!0,this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty=!0,this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty=!0,this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty=!0,this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",this._state.attenuation[2])},get:function(){return this._state.attenuation[2]}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}}},_getJSON:function(){return{type:this._state.type,pos:this._state.pos,color:this._state.color,intensity:this._state.intensity,constantAttenuation:this._state.attenuation[0],linearAttenuation:this._state.attenuation[1],quadraticAttenuation:this._state.attenuation[2],space:this._state.space}}})}(),function(){"use strict";XEO.Material=XEO.Component.extend({type:"XEO.Material",_init:function(a){}})}(),function(){"use strict";XEO.PhongMaterial=XEO.Material.extend({type:"XEO.PhongMaterial",_init:function(a){this._state=new XEO.renderer.PhongMaterial({type:"phongMaterial",ambient:[.7,.7,.8],diffuse:[1,1,1],specular:[1,1,1],emissive:[0,0,0],opacity:1,shininess:20,reflectivity:1,lineWidth:1,pointSize:1,ambientMap:null,normalMap:null,diffuseMap:null,specularMap:null,emissiveMap:null,opacityMap:null,reflectivityMap:null,diffuseFresnel:null,specularFresnel:null,emissiveFresnel:null,opacityFresnel:null,reflectivityFresnel:null,hash:null}),this._hashDirty=!0,this.ambient=a.ambient,this.diffuse=a.diffuse,this.specular=a.specular,this.emissive=a.emissive,this.opacity=a.opacity,this.shininess=a.shininess,this.reflectivity=a.reflectivity,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,this.ambientMap=a.ambientMap,this.diffuseMap=a.diffuseMap,this.specularMap=a.specularMap,this.emissiveMap=a.emissiveMap,this.opacityMap=a.opacityMap,this.reflectivityMap=a.reflectivityMap,this.normalMap=a.normalMap,this.diffuseFresnel=a.diffuseFresnel,this.specularFresnel=a.specularFresnel,this.emissiveFresnel=a.emissiveFresnel,this.opacityFresnel=a.opacityFresnel,this.reflectivityFresnel=a.reflectivityFresnel},_props:{ambient:{set:function(a){this._state.ambient=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("ambient",this._state.ambient)},get:function(){return this._state.ambient}},diffuse:{set:function(a){this._state.diffuse=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("diffuse",this._state.diffuse)},get:function(){return this._state.diffuse}},specular:{set:function(a){this._state.specular=a||[1,1,1],this._renderer.imageDirty=!0,this.fire("specular",this._state.specular)},get:function(){return this._state.specular}},emissive:{set:function(a){this._state.emissive=a||[0,0,0],this._renderer.imageDirty=!0,this.fire("emissive",this._state.emissive)},get:function(){return this._state.emissive}},opacity:{set:function(a){this._state.opacity=void 0!==a||null!==a?a:1,this._renderer.imageDirty=!0,this.fire("opacity",this._state.opacity)},get:function(){return this._state.opacity}},shininess:{set:function(a){this._state.shininess=void 0!==a?a:80,this._renderer.imageDirty=!0,this.fire("shininess",this._state.shininess)},get:function(){return this._state.shininess}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty=!0,this.fire("lineWidth",this._state.lineWidth)},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty=!0,this.fire("pointSize",this._state.pointSize)},get:function(){return this._state.pointSize}},reflectivity:{set:function(a){this._state.reflectivity=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("reflectivity",this._state.reflectivity)},get:function(){return this._state.reflectivity}},normalMap:{set:function(a){this._setComponent("normalMap",a)},get:function(){return this._children.normalMap}},ambientMap:{set:function(a){this._setComponent("ambientMap",a)},get:function(){return this._children.ambientMap}},diffuseMap:{set:function(a){this._setComponent("diffuseMap",a)},get:function(){return this._children.diffuseMap}},specularMap:{set:function(a){this._setComponent("specularMap",a)},get:function(){return this._children.specularMap}},emissiveMap:{set:function(a){this._setComponent("emissiveMap",a)},get:function(){return this._children.emissiveMap}},opacityMap:{set:function(a){this._setComponent("opacityMap",a)},get:function(){return this._children.opacityMap}},reflectivityMap:{set:function(a){this._setComponent("reflectivityMap",a)},get:function(){return this._children.reflectivityMap}},reflection:{set:function(a){this._setComponent("reflection",a)},get:function(){return this._children.reflection}},diffuseFresnel:{set:function(a){this._setComponent("diffuseFresnel",a)},get:function(){return this._children.diffuseFresnel}},specularFresnel:{set:function(a){this._setComponent("specularFresnel",a)},get:function(){return this._children.specularFresnel}},emissiveFresnel:{set:function(a){this._setComponent("emissiveFresnel",a)},get:function(){return this._children.emissiveFresnel}},opacityFresnel:{set:function(a){this._setComponent("opacityFresnel",a)},get:function(){return this._children.opacityFresnel}},reflectivityFresnel:{set:function(a){this._setComponent("reflectivityFresnel",a)},get:function(){return this._children.reflectivityFresnel}}},_setComponent:function(a,b){b=this._setChild(a,b,!1),this._state[a]=b?b._state:null,this._hashDirty=!0},_compile:function(){this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._renderer.material=this._state},_makeHash:function(){var a=this._state,b=["/p"];a.normalMap&&(b.push("/b"),a.normalMap.matrix&&b.push("/mat")),a.ambientMap&&(b.push("/a"),a.ambientMap.matrix&&b.push("/mat")),a.diffuseMap&&(b.push("/d"),a.diffuseMap.matrix&&b.push("/mat")),a.specularMap&&(b.push("/s"),a.specularMap.matrix&&b.push("/mat")),a.emissiveMap&&(b.push("/e"),a.emissiveMap.matrix&&b.push("/mat")),a.opacityMap&&(b.push("/o"),a.opacityMap.matrix&&b.push("/mat")),a.reflectivityMap&&(b.push("/r"),a.reflectivityMap.matrix&&b.push("/mat")),a.diffuseFresnel&&b.push("/df"),a.specularFresnel&&b.push("/sf"),a.emissiveFresnel&&b.push("/ef"),a.opacityFresnel&&b.push("/of"),a.reflectivityFresnel&&b.push("/rf"),b.push(";"),a.hash=b.join("")},_getJSON:function(){var a={ambient:this._state.ambient,diffuse:this._state.diffuse,specular:this._state.specular,emissive:this._state.emissive};1!=this._state.opacity&&(a.opacity=this._state.opacity),80!=this._state.shininess&&(a.shininess=this._state.shininess),1!=this._state.reflectivity&&(a.reflectivity=this._state.reflectivity),1!=this._state.lineWidth&&(a.lineWidth=this._state.lineWidth),1!=this._state.pointSize&&(a.pointSize=this._state.pointSize);var b=this._children;return b.normalMap&&(a.normalMap=b.normalMap.id),b.ambientMap&&(a.ambientMap=b.ambientMap.id),b.diffuseMap&&(a.diffuseMap=b.diffuseMap.id),b.specularMap&&(a.specularMap=b.specularMap.id),b.emissiveMap&&(a.emissiveMap=b.emissiveMap.id),b.opacityMap&&(a.opacityMap=b.opacityMap.id),b.reflectivityMap&&(a.reflectivityMap=b.reflectivityMap.id),b.diffuseFresnel&&(a.diffuseFresnel=b.diffuseFresnel.id),b.specularFresnel&&(a.specularFresnel=b.specularFresnel.id),b.emissiveFresnel&&(a.emissiveFresnel=b.emissiveFresnel.id),b.opacityFresnel&&(a.opacityFresnel=b.opacityFresnel.id),b.reflectivityFresnel&&(a.reflectivityFresnel=b.reflectivityFresnel.id),a},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Texture=XEO.Component.extend({type:"XEO.Texture",_init:function(a){this._state=new XEO.renderer.Texture({texture:null,matrix:null,minFilter:null,magFilter:null,wrapS:null,wrapT:null,flipY:null}),this._src=null,this._image=null,this._target=null,this._translate=[0,0],this._scale=[1,1],this._rotate=[0,0],this._dirty=!1,this._matrixDirty=!1,this._srcDirty=!1,this._imageDirty=!1,this._targetDirty=!1,this._propsDirty=!1;var b=this;this._webglContextRestored=this.scene.canvas.on("webglContextRestored",function(){b._state.texture=null,b._matrixDirty=!0,b._propsDirty=!0,b._image?b._imageDirty=!0:b._src?b._srcDirty=!0:b._target&&(b._targetDirty=!0),b._textureDirty()}),this.translate=a.translate,this.scale=a.scale,this.rotate=a.rotate,this.minFilter=a.minFilter,this.magFilter=a.magFilter,this.wrapS=a.wrapS,this.wrapT=a.wrapT,this.flipY=a.flipY,a.src?this.src=a.src:a.image?this.image=a.image:a.target&&(this.target=a.target),this.scene.stats.memory.textures++},_textureDirty:function(){if(!this._dirty){this._dirty=!0;var a=this;this.scene.once("tick2",function(){a._buildTexture(),a._dirty=!1})}},_buildTexture:function(){var a=this.scene.canvas.gl,b=this._state;if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);if(this._imageDirty&&this._image&&(this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),b.texture&&b.texture.renderBuffer&&(b.texture=null),b.texture||(b.texture=new XEO.renderer.webgl.Texture2D(a)),b.texture.setImage(this._image),this._imageDirty=!1,this._propsDirty=!0),this._targetDirty&&(b.texture&&!b.texture.renderBuffer&&(b.texture.destroy(),b.texture=null),this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),this._target&&(this._onTargetActive=this._target.on("active",function(a){b.texture=a?this._state.renderBuf.getTexture():null})),this._targetDirty=!1,this._propsDirty=!0),this._matrixDirty){var c,d;(0!==this._translate[0]||0!==this._translate[2])&&(c=XEO.math.translationMat4v([this._translate[0],this._translate[0],0])),(1!==this._scale[0]||1!==this._scale[1])&&(d=XEO.math.scalingMat4v([this._scale[0],this._scale[1],1]),c=c?XEO.math.mulMat4(c,d):d),0!==this._rotate&&(d=XEO.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),c=c?XEO.math.mulMat4(c,d):d),c&&(b.matrix=c),this._matrixDirty=!1}this._propsDirty&&(b.texture&&b.texture.setProps&&b.texture.setProps(b),this._propsDirty=!1),this._renderer.imageDirty=!0},_loadSrc:function(a){var b=this,c=new Image;c.onload=function(){b._src===a&&(b._image=XEO.renderer.webgl.ensureImageSizePowerOfTwo(c),b._imageDirty=!0,b._srcDirty=!1,b._targetDirty=!1,b.fire("image",b._image),b.fire("loaded",b._src),b._textureDirty())},c.onerror=function(){},0===a.indexOf("data")?c.src=a:(c.crossOrigin="Anonymous",c.src=a)},_props:{image:{set:function(a){this._image=XEO.renderer.webgl.ensureImageSizePowerOfTwo(a),this._src=null,this._imageDirty=!0,this._srcDirty=!1,this._targetDirty=!1,this._textureDirty(),this.fire("image",this._image)},get:function(){return this._state.image}},src:{set:function(a){this._image=null,this._src=a,this._imageDirty=!1,this._srcDirty=!0,this._targetDirty=!1,this._textureDirty(),this.fire("src",this._src)},get:function(){return this._src}},target:{set:function(a){this._image=null,this._src=null,this._onTargetActive&&(this._target.off(this._onTargetActive),this._onTargetActive=null),this._target=this._setChild("renderBuf",a),this._imageDirty=!1,this._srcDirty=!1,this._targetDirty=!0,this._textureDirty(),this.fire("target",this._target)},get:function(){return this._children.target}},translate:{set:function(a){a=a||[0,0],this._translate=a,this._matrixDirty=!0,this._textureDirty(),this.fire("translate",this._translate)},get:function(){return this._translate}},scale:{set:function(a){a=a||[1,1],this._scale=a,this._matrixDirty=!0,this._textureDirty(),this.fire("scale",this._scale)},get:function(){return this._scale}},rotate:{set:function(a){a=a||0,this._rotate=a,this._matrixDirty=!0,this._textureDirty(),this.fire("rotate",this._rotate)},get:function(){return this._rotate}},minFilter:{set:function(a){a=a||"linearMipmapLinear","linear"!==a&&"linearMipmapNearest"!==a&&"linearMipmapLinear"!==a&&"nearestMipmapLinear"!==a&&"linearMipmapLinear"!==a&&(this.error("Unsupported value for 'minFilter': '"+a+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),a="linearMipmapLinear"),this._state.minFilter=a,this._propsDirty=!0,this._textureDirty(),this.fire("minFilter",this._state.minFilter)},get:function(){return this._state.minFilter}},magFilter:{set:function(a){a=a||"linear","linear"!==a&&"nearest"!==a&&(this.error("Unsupported value for 'magFilter': '"+a+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),a="linear"),this._state.magFilter=a,this._propsDirty=!0,this._textureDirty(),this.fire("magFilter",this._state.magFilter)},get:function(){return this._state.magFilter}},wrapS:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapS': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapS=a,this._propsDirty=!0,this._textureDirty(),this.fire("wrapS",this._state.wrapS)},get:function(){return this._state.wrapS}},wrapT:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapT': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapT=a,this._propsDirty=!0,this._textureDirty(),this.fire("wrapT",this._state.wrapT)},get:function(){return this._state.wrapT}},flipY:{set:function(a){a=a!==!1,this._state.flipY=a,this._propsDirty=!0,this._textureDirty(),this.fire("flipY",this._state.flipY)},get:function(){return this._state.flipY}}},_getJSON:function(){var a={};return!this._translate||0===this._translate[0]&&0===this._translate[1]||(a.translate=this._translate),!this._scale||1===this._scale[0]&&1===this._scale[1]||(a.scale=this._scale),0!==this._rotate&&(a.rotate=this._rotate),"linearMipmapLinear"!=this._state.minFilter&&(a.minFilter=this._state.minFilter),"linear"!=this._state.magFilter&&(a.magFilter=this._state.magFilter),"repeat"!=this._state.wrapS&&(a.wrapS=this._state.wrapS),"repeat"!=this._state.wrapT&&(a.wrapT=this._state.wrapT),this._state.flipY!==!0&&(a.flipY=this._state.flipY),this._src?a.src=this._src:this._target?a.target=this._target.id:this._image,a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),this.scene.stats.memory.textures--}})}(),function(){"use strict";XEO.Reflect=XEO.Component.extend({type:"XEO.Reflect",_init:function(a){},_compile:function(){this._renderer.reflect=this._state},_getJSON:function(){return{}}})}(),function(){"use strict";XEO.GameObject=XEO.Component.extend({type:"XEO.GameObject",_init:function(a){this.camera=a.camera,this.clips=a.clips,this.colorTarget=a.colorTarget,this.colorBuf=a.colorBuf,this.depthTarget=a.depthTarget,this.depthBuf=a.depthBuf,this.visibility=a.visibility,this.modes=a.modes,this.geometry=a.geometry,this.layer=a.layer,this.lights=a.lights,this.material=a.material,this.morphTargets=a.morphTargets,this.reflect=a.reflect,this.shader=a.shader,this.shaderParams=a.shaderParams,this.stage=a.stage,this.transform=a.transform,this.billboard=a.billboard,this._worldBoundary=null,this._viewBoundary=null,this._canvasBoundary=null,this._worldBoundaryDirty=!0,this._viewBoundaryDirty=!0,this._canvasBoundaryDirty=!0},_props:{camera:{set:function(a){this._setViewBoundaryDirty();var b=this._children.camera;b&&(b.off(this._onCameraViewMatrix),b.off(this._onCameraProjMatrix)),this._setChild("camera",a);var c=this._children.camera;if(c){var d=this;this._onCameraViewMatrix=c.on("viewMatrix",function(){d._setViewBoundaryDirty()}),this._onCameraProjMatrix=c.on("projMatrix",function(){d._setCanvasBoundaryDirty()})}},get:function(){return this._children.camera}},clips:{set:function(a){this._setChild("clips",a)},get:function(){return this._children.clips}},colorTarget:{set:function(a){this._setChild("colorTarget",a)},get:function(){return this._children.colorTarget}},colorBuf:{set:function(a){this._setChild("colorBuf",a)},get:function(){return this._children.colorBuf}},depthTarget:{set:function(a){this._setChild("depthTarget",a)},get:function(){return this._children.depthTarget}},depthBuf:{set:function(a){this._setChild("depthBuf",a)},get:function(){return this._children.depthBuf}},visibility:{set:function(a){this._setChild("visibility",a)},get:function(){return this._children.visibility}},modes:{set:function(a){this._setChild("modes",a)},get:function(){return this._children.modes}},geometry:{set:function(a){this._setWorldBoundaryDirty();var b=this._children.geometry;b&&(a&&(void 0!==a.id?a.id:a)==b.id||(b.off(this._onGeometryPositions),b.off(this._onGeometryDestroyed))),this._setChild("geometry",a);var c=this._children.geometry;if(c){var d=this;this._onGeometryPositions=c.on("positions",function(){d._setWorldBoundaryDirty()}),this._onGeometryDestroyed=c.on("destroyed",function(){d._setWorldBoundaryDirty()})}},get:function(){return this._children.geometry}},layer:{set:function(a){this._setChild("layer",a)},get:function(){return this._children.layer}},lights:{set:function(a){this._setChild("lights",a)},get:function(){return this._children.lights}},material:{set:function(a){this._setChild("material",a)},get:function(){return this._children.material}},morphTargets:{set:function(a){this._setChild("morphTargets",a)},get:function(){return this._children.morphTargets}},reflect:{set:function(a){this._setChild("reflect",a)},get:function(){return this._children.reflect}},shader:{set:function(a){this._setChild("shader",a)},get:function(){return this._children.shader}},shaderParams:{set:function(a){this._setChild("shaderParams",a)},get:function(){return this._children.shaderParams}},stage:{set:function(a){this._setChild("stage",a)},get:function(){return this._children.stage}},transform:{set:function(a){this._setWorldBoundaryDirty();var b=this._children.transform;!b||a&&a.id===b.id||(b.off(this._onTransformUpdated),b.off(this._onTransformDestroyed)),this._setChild("transform",a);var c=this._children.transform;if(c){var d=this;this._onTransformUpdated=c.on("updated",function(){d._XXX||(d._XXX=!0,d.scene.once("tick2",function(){c._buildLeafMatrix(),d._setWorldBoundaryDirty(),d._XXX=!1}))}),this._onTransformDestroyed=c.on("destroyed",function(){d._setWorldBoundaryDirty()})}},get:function(){return this._children.transform}},billboard:{set:function(a){this._setChild("billboard",a)},get:function(){return this._children.billboard}},localBoundary:{get:function(){return this._children.geometry.boundary}},worldBoundary:{get:function(){if(!this._worldBoundary){var a=this;this._worldBoundary=new XEO.Boundary3D(this.scene,{meta:{desc:"GameObject "+a.id+" World Boundary"},getDirty:function(){return a._worldBoundaryDirty},getPositions:function(){return a._children.geometry.positions},getMatrix:function(){return a._children.transform.leafMatrix}}),this._worldBoundary.on("destroyed",function(){a._worldBoundary=null}),this._setWorldBoundaryDirty()}return this._worldBoundary}},viewBoundary:{get:function(){if(!this._viewBoundary){var a=this;this._viewBoundary=new XEO.Boundary3D(this.scene,{meta:{desc:"GameObject "+a.id+" View Boundary"},getDirty:function(){return a._viewBoundaryDirty},getOBB:function(){return a.worldBoundary.obb},getMatrix:function(){return a._children.camera.view.matrix}}),this._viewBoundary.on("destroyed",function(){a._viewBoundary=null}),this._setViewBoundaryDirty()}return this._viewBoundary}},canvasBoundary:{get:function(){if(!this._canvasBoundary){var a=this;this._canvasBoundary=new XEO.Boundary2D(this.scene,{meta:{desc:"GameObject "+a.id+" Canvas Boundary"},getDirty:function(){return a._canvasBoundaryDirty},getOBB:function(){return a.viewBoundary.obb},getMatrix:function(){return a._children.camera.project.matrix}}),this._canvasBoundary.on("destroyed",function(){a._canvasBoundary=null}),this._setCanvasBoundaryDirty()}return this._canvasBoundary}},glsl:{get:function(){var a=this._renderer.objects[this.id];if(!a)return null;var b=a.program.source;return{draw:{vertex:b.vertexDraw,fragment:b.fragmentDraw},pickObject:{vertex:b.vertexPickObject,fragment:b.fragmentPickObject},pickPrimitive:{vertex:b.vertexPickPrimitive,fragment:b.fragmentPickPrimitive}}}},glslString:{get:function(){var a=this.glsl;return a?JSON.stringify(a,"\n",4):void 0}}},_setWorldBoundaryDirty:function(){this._worldBoundaryDirty=!0,this._worldBoundary&&this._worldBoundary.fire("updated",!0),this._setViewBoundaryDirty()},_setViewBoundaryDirty:function(){this._viewBoundaryDirty=!0,this._viewBoundary&&this._viewBoundary.fire("updated",!0),this._setCanvasBoundaryDirty()},_setCanvasBoundaryDirty:function(){this._canvasBoundaryDirty=!0,this._canvasBoundary&&this._canvasBoundary.fire("updated",!0)},_compile:function(){var a=this._children;a.camera._compile(),a.clips._compile(),a.colorTarget._compile(),a.colorBuf._compile(),a.depthTarget._compile(),a.depthBuf._compile(),a.visibility._compile(),a.modes._compile(),a.geometry._compile(),a.layer._compile(),a.lights._compile(),a.material._compile(),a.reflect._compile(),a.shader._compile(),a.shaderParams._compile(),a.stage._compile(),a.transform._compile(),a.billboard._compile();var b=this._renderer.buildObject(this.id);b&&b.error&&this.error(b.errorLog.join("\n"))},_getJSON:function(){var a=this._children;return{camera:a.camera.id,clips:a.clips.id,colorTarget:a.colorTarget.id,colorBuf:a.colorBuf.id,depthTarget:a.depthTarget.id,depthBuf:a.depthBuf.id,visibility:a.visibility.id,modes:a.modes.id,geometry:a.geometry.id,layer:a.layer.id,lights:a.lights.id,material:a.material.id,reflect:a.reflect.id,shader:a.shader.id,shaderParams:a.shaderParams.id,stage:a.stage.id,transform:a.transform.id,billboard:a.billboard.id}},_destroy:function(){this._children.transform&&(this._children.transform.off(this._onTransformUpdated),this._children.transform.off(this._onTransformDestroyed)),this._children.geometry&&(this._children.geometry.off(this._onGeometryDirty),this._children.geometry.off(this._onGeometryPositions),this._children.geometry.off(this._onGeometryDestroyed)),this._worldBoundary&&this._worldBoundary.destroy(),this._viewBoundary&&this._viewBoundary.destroy(),this._canvasBoundary&&this._canvasBoundary.destroy(),this._renderer.removeObject(this.id)}})}(),function(){"use strict";XEO.ColorBuf=XEO.Component.extend({type:"XEO.ColorBuf",_init:function(a){this._state=new XEO.renderer.ColorBuf({blendEnabled:!1,colorMask:[!0,!0,!0,!0]}),this.blendEnabled=a.blendEnabled,this.colorMask=a.colorMask},_props:{blendEnabled:{set:function(a){this._state.blendEnabled=a===!0,this._renderer.imageDirty=!0,this.fire("blendEnabled",this._state.blendEnabled)},get:function(){return this._state.blendEnabled}},colorMask:{set:function(a){this._state.colorMask=a||[!0,!0,!0,!0],this._renderer.imageDirty=!0,this.fire("colorMask",this._state.colorMask)},get:function(){
return this._state.colorMask}}},_compile:function(){this._renderer.colorBuf=this._state},_getJSON:function(){return{blendEnabled:this._state.blendEnabled,colorMask:this._state.colorMask}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.DepthBuf=XEO.Component.extend({type:"XEO.DepthBuf",_init:function(a){this._state=new XEO.renderer.DepthBuf({clearDepth:null,depthFunc:null,active:null}),this.clearDepth=a.clearDepth,this.depthFunc=a.depthFunc,this.active=a.active},_props:{clearDepth:{set:function(a){this._state.clearDepth=void 0!==a?a:1,this._renderer.imageDirty=!0,this.fire("clearDepth",this._state.clearDepth)},get:function(){return this._state.clearDepth}},depthFunc:{set:function(a){a=a||"less";var b=this._depthFuncNames[a];void 0===b&&(this.error("Unsupported value for 'clearFunc': '"+a+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal. Defaulting to 'less'."),b="less"),this._state.depthFunc=this.scene.canvas.gl[b],this._state.depthFuncName=a,this._renderer.imageDirty=!0,this.fire("depthFunc",this._state.depthFuncName)},get:function(){return this._state.depthFuncName}},active:{set:function(a){this._state.active!==a&&(this._state.active=a,this.fire("active",this._state.active))},get:function(){return this._state.active}}},_depthFuncNames:{less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},_compile:function(){this._renderer.depthBuf=this._state},_getJSON:function(){return{clearDepth:this._state.clearDepth,depthFunc:this._state.depthFuncName,active:this._state.active}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Layer=XEO.Component.extend({type:"XEO.Layer",_init:function(a){this._state=new XEO.renderer.Layer({priority:null}),this.priority=a.priority},_props:{priority:{set:function(a){a=a||0,a!==this._state.priority&&(this._state.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}}},_compile:function(){this._renderer.layer=this._state},_getJSON:function(){return{priority:this._state.priority}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.ColorTarget=XEO.Component.extend({type:"XEO.ColorTarget",_init:function(a){this._state=new XEO.renderer.RenderTarget({type:XEO.renderer.RenderTarget.COLOR,renderBuf:null});var b=this.scene.canvas,c=this;this._webglContextRestored=b.on("webglContextRestored",function(){c._state.renderBuf&&c._state.renderBuf.webglRestored(b.gl)}),this.size=a.size,this.active=a.active},_props:{size:{set:function(a){a=a||null,this._size=a,this._active&&this._state.renderBuf.setSize(this._size),this.fire("size",this._size)},get:function(){return this._size}},active:{set:function(a){if(a=a!==!1,this._active!==a){var b=this._state;if(this._active=a,this._active){var c=this.scene.canvas;b.renderBuf=new XEO.renderer.webgl.RenderBuffer({canvas:c.canvas,gl:c.gl,size:this._size}),this._renderer.imageDirty=!0}else b.renderBuf&&(b.renderBuf.destroy(),b.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.colorTarget=this._state},_getJSON:function(){var a={active:this._active};return this._size&&(a.size=this._size),a},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";XEO.DepthTarget=XEO.Component.extend({type:"XEO.DepthTarget",_init:function(a){this._state=new XEO.renderer.RenderTarget({type:XEO.renderer.RenderTarget.DEPTH,renderBuf:null});var b=this.scene.canvas,c=this;this._webglContextRestored=b.on("webglContextRestored",function(){c._state.renderBuf&&c._state.renderBuf.webglRestored(b.gl)}),this.active=a.active},_props:{active:{set:function(a){if(a=a!==!1,this._active!==a){this._active=a;var b=this._state;if(this._active){var c=this.scene.canvas;b.renderBuf=new XEO.renderer.webgl.RenderBuffer({canvas:c.canvas,gl:c.gl}),this._renderer.imageDirty=!0}else b.renderBuf&&(b.renderBuf.destroy(),b.renderBuf=null);this.fire("active",this._active)}},get:function(){return this._active}}},_compile:function(){this._renderer.depthTarget=this._state},_getJSON:function(){return{active:this._active}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.renderBuf.destroy(),this._state.destroy()}})}(),function(){"use strict";XEO.Modes=XEO.Component.extend({type:"XEO.Modes",_init:function(a){this._state=new XEO.renderer.Modes({pickable:!0,clipping:!0,transparent:!1,backfaces:!1,frontface:!0}),this.pickable=a.pickable,this.clipping=a.clipping,this.transparent=a.transparent,this.backfaces=a.backfaces,this.frontface=a.frontface},_props:{pickable:{set:function(a){this._state.pickable=a!==!1,this._renderer.drawListDirty=!0,this.fire("pickable",this._state.pickable)},get:function(){return this._state.pickable}},clipping:{set:function(a){this._state.clipping=a!==!1,this._renderer.imageDirty=!0,this.fire("clipping",this._state.clipping)},get:function(){return this._state.clipping}},transparent:{set:function(a){this._state.transparent=!!a,this._renderer.stateOrderDirty=!0,this.fire("transparent",this._state.transparent)},get:function(){return this._state.transparent}},backfaces:{set:function(a){a=!!a,this._state.backfaces=a,this._renderer.imageDirty=!0,this.fire("backfaces",this._state.backfaces)},get:function(){return this._state.backfaces}},frontface:{set:function(a){this._state.frontface="cw"!==a,this._renderer.imageDirty=!0,this.fire("frontface",this._state.frontface?"ccw":"cw")},get:function(){return this._state.frontface?"ccw":"cw"}}},_compile:function(){this._renderer.modes=this._state},_getJSON:function(){return{pickable:this._state.pickable,clipping:this._state.clipping,transparent:this._state.transparent,backfaces:this._state.backfaces,frontface:this._state.frontface}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.Shader=XEO.Component.extend({type:"XEO.Shader",_init:function(a){this._state=new XEO.renderer.Shader({vertex:null,fragment:null,params:{}}),this.vertex=a.vertex,this.fragment=a.fragment,this.setParams(a.params)},_props:{vertex:{set:function(a){this._state.vertex=a,this.fire("dirty",!0),this.fire("vertex",this._state.vertex)},get:function(){return this._state.vertex}},fragment:{set:function(a){this._state.fragment=a,this.fire("dirty",!0),this.fire("fragment",this._state.fragment)},get:function(){return this._state.fragment}},params:{get:function(){return this._state.params}}},setParams:function(a){for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shader=this._state},_getJSON:function(){var a={params:this._state.params};return this._state.vertex&&(a.vertex=this._state.vertex),this._state.fragment&&(a.fragment=this._state.fragment),a}})}(),function(){"use strict";XEO.ShaderParams=XEO.Component.extend({type:"XEO.ShaderParams",_init:function(a){this._state=new XEO.renderer.ShaderParams({params:{}}),this.setParams(a.params)},_props:{params:{get:function(){return this._state.params}}},setParams:function(a){for(var b in a)a.hasOwnProperty(b)&&(this._state.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._state.params)},_compile:function(){this._renderer.shaderParams=this._state},_getJSON:function(){return{params:this._state.params}}})}(),function(){"use strict";XEO.Stage=XEO.Component.extend({type:"XEO.Stage",_init:function(a){this._state=new XEO.renderer.Stage({priority:null,pickable:!0}),this.priority=a.priority,this.pickable=a.pickable},_props:{priority:{set:function(a){a=a||0,a!==this._state.priority&&(this._state.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",this._state.priority))},get:function(){return this._state.priority}},pickable:{set:function(a){this._state.pickable=a!==!1,this._renderer.drawListDirty=!0,this.fire("pickable",this._state.pickable)},get:function(){return this._state.pickable}}},_compile:function(){this._renderer.stage=this._state},_getJSON:function(){return{priority:this.priority,pickable:this.pickable}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.Renderer=function(a,b){this.stats=a||{},this._canvas=b.canvas,this._programFactory=new XEO.renderer.ProgramFactory(this.stats,{canvas:b.canvas}),this._objectFactory=new XEO.renderer.ObjectFactory,this._chunkFactory=new XEO.renderer.ChunkFactory,this._extraChunks=[],this._numExtraChunks=0,this.transparent=b.transparent===!0,this.objects={},this._ambient=null,this._objectList=[],this._objectListLen=0,this._objectPickList=[],this._objectPickListLen=0,this._drawChunkList=[],this._drawChunkListLen=0,this._pickObjectChunkList=[],this._pickObjectChunkListLen=0,this._frameCtx={pickObjects:[],canvas:this._canvas},this.visibility=null,this.modes=null,this.layer=null,this.stage=null,this.depthBuf=null,this.colorBuf=null,this.lights=null,this.material=null,this.reflect=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.billboard=null,this.colorTarget=null,this.depthTarget=null,this.clips=null,this.morphTargets=null,this.shader=null,this.shaderParams=null,this.geometry=null,this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.drawListDirty=!0,this.imageDirty=!0},XEO.renderer.Renderer.prototype.webglRestored=function(){this._programFactory.webglRestored(),this._chunkFactory.webglRestored();var a=this._canvas.gl;this.pickBuf&&this.pickBuf.webglRestored(a),this.imageDirty=!0},XEO.renderer.Renderer.prototype.buildObject=function(a){var b=this.objects[a];b||(b=this._objectFactory.get(a)),b.stage=this.stage,b.layer=this.layer,b.colorTarget=this.colorTarget,b.depthTarget=this.depthTarget,b.material=this.material,b.reflect=this.reflect,b.geometry=this.geometry,b.visibility=this.visibility,b.modes=this.modes,b.billboard=this.billboard;var c=[this.geometry.hash,this.shader.hash,this.clips.hash,this.material.hash,this.lights.hash,this.billboard.hash].join(";");b.program&&c===b.hash||(b.program&&this._programFactory.put(b.program),b.program=this._programFactory.get(c,this),b.hash=c);var d=b.program;if(d){var e=d.program;if(!(e.allocated&&e.compiled&&e.validated&&e.linked))return this.objects[a]&&this.removeObject(a),{error:!0,errorLog:e.errorLog}}return this._setChunk(b,0,"program",b.program),this._setChunk(b,1,"modelTransform",this.modelTransform),this._setChunk(b,2,"viewTransform",this.viewTransform),this._setChunk(b,3,"projTransform",this.projTransform),this._setChunk(b,4,"modes",this.modes),this._setChunk(b,5,"shader",this.shader),this._setChunk(b,6,"shaderParams",this.shaderParams),this._setChunk(b,7,"depthBuf",this.depthBuf),this._setChunk(b,8,"colorBuf",this.colorBuf),this._setChunk(b,9,"lights",this.lights),this._setChunk(b,10,this.material.type,this.material),this._setChunk(b,11,"clips",this.clips),this._setChunk(b,12,"geometry",this.geometry),this._setChunk(b,13,"draw",this.geometry,!0),this.objects[a]?this.stateOrderDirty=!0:(this.objects[a]=b,this.objectListDirty=!0),b},XEO.renderer.Renderer.prototype._setChunk=function(a,b,c,d,e){var f,g=this._chunkFactory.types[c];f="program"===c?1e8*(a.program.id+1):g.constructor.prototype.programGlobal?d.id:1e8*(a.program.id+1)+(d.id+1),e&&(f*=1e5);var h=a.chunks[b];h&&this._chunkFactory.putChunk(h),a.chunks[b]=this._chunkFactory.getChunk(f,c,a.program.program,d),"lights"===c&&this._setAmbient(d)},XEO.renderer.Renderer.prototype._setAmbient=function(a){for(var b,c=a.lights,d=0,e=c.length;e>d;d++)b=c[d],"ambient"===b.type&&(this._ambient=b)},XEO.renderer.Renderer.prototype.removeObject=function(a){var b=this.objects[a];if(b){for(var c=b.chunks,d=0,e=c.length;e>d;d++)this._chunkFactory.putChunk(c[d]);this._programFactory.put(b.program),b.program=null,b.hash=null,this._objectFactory.put(b),delete this.objects[a],this.objectListDirty=!0}},XEO.renderer.Renderer.prototype.render=function(a){a=a||{},this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.drawListDirty=!0),this.drawListDirty&&(this._buildDrawList(),this.imageDirty=!0),(this.imageDirty||a.force)&&(this._doDrawList({clear:a.clear!==!1}),this.stats.frame.frameCount++,this.imageDirty=!1)},XEO.renderer.Renderer.prototype._buildObjectList=function(){this._objectListLen=0;for(var a in this.objects)this.objects.hasOwnProperty(a)&&(this._objectList[this._objectListLen++]=this.objects[a])},XEO.renderer.Renderer.prototype._makeStateSortKeys=function(){for(var a,b=0,c=this._objectListLen;c>b;b++)a=this._objectList[b],a.program?a.sortKey=1e16*(a.stage.priority+1)+1e14*(a.modes.transparent?2:1)+1e13*(a.layer.priority+1)+1e8*(a.program.id+1)+1e4*(a.material.id+1)+a.geometry.id:a.sortKey=-1},XEO.renderer.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(function(a,b){return a.sortKey-b.sortKey})},XEO.renderer.Renderer.prototype._logObjectList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._objectListLen+" objects");for(var a=0,b=this._objectListLen;b>a;a++){var c=this._objectList[a];console.log("XEO.Renderer : object["+a+"] sortKey = "+c.sortKey)}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype._buildDrawList=function(){this._clearExtraChunks(),this._lastDrawChunkId=this._lastDrawChunkId||[],this._lastPickObjectChunkId=this._lastPickObjectChunkId||[];for(var a=0;20>a;a++)this._lastDrawChunkId[a]=null,this._lastPickObjectChunkId[a]=null;this._drawChunkListLen=0,this._pickObjectChunkListLen=0;var b,c,d,e,f,g,h,i={},j=[],k=[];this._objectDrawList=this._objectDrawList||[],this._objectDrawListLen=0,this._objectPickListLen=0;for(var a=0,l=this._objectListLen;l>a;a++)b=this._objectList[a],b.visibility.visible!==!1&&(c=b.colorTarget?b.colorTarget.renderBuf:null,d=b.depthTarget?b.depthTarget.renderBuf:null,c?(e=b.colorTarget,g=i[e.id],g||(g=[],i[e.id]=g,j.push(g),h=-this._numExtraChunks,f=this._chunkFactory.getChunk(h,"renderTarget",b.program.program,e),this._extraChunks[this._numExtraChunks++]=f,k.push(f)),g.push(b)):d?(e=b.depthTarget,g=i[e.id],g||(g=[],i[e.id]=g,j.push(g),h=-this._numExtraChunks,f=this._chunkFactory.getChunk(h,"renderTarget",b.program.program,e),this._extraChunks[this._numExtraChunks++]=f,k.push(f)),g.push(b)):this._objectDrawList[this._objectDrawListLen++]=b);for(var m,n=!1,a=0,l=j.length;l>a;a++){f=k[a],g=j[a],this._appendRenderTargetChunk(f);for(var o=0,p=g.length;p>o;o++)b=g[o],m=b.stage&&b.stage.pickable,this._appendObjectToDrawChunkLists(b,m),n=!0}n&&(h=-this._numExtraChunks,this._appendRenderTargetChunk(this._chunkFactory.getChunk(h,"renderTarget",b.program.program,{})),this._extraChunks[this._numExtraChunks++]=f);for(var a=0,l=this._objectDrawListLen;l>a;a++)b=this._objectDrawList[a],m=!b.stage||b.stage&&b.stage.pickable,this._appendObjectToDrawChunkLists(b,m);this.drawListDirty=!1},XEO.renderer.Renderer.prototype._clearExtraChunks=function(){for(var a=0,b=this._numExtraChunks;b>a;a++)this._chunkFactory.putChunk(this._extraChunks[a]);this._numExtraChunks=0},XEO.renderer.Renderer.prototype._appendRenderTargetChunk=function(a){this._drawChunkList[this._drawChunkListLen++]=a},XEO.renderer.Renderer.prototype._appendObjectToDrawChunkLists=function(a,b){for(var c,d=a.chunks,b=b&&a.modes.pickable,e=0,f=d.length;f>e;e++)c=d[e],c&&(c.draw&&(c.unique||this._lastDrawChunkId[e]!==c.id)&&(this._drawChunkList[this._drawChunkListLen++]=c,this._lastDrawChunkId[e]=c.id),c.pickObject&&b&&(c.unique||this._lastPickObjectChunkId[e]!==c.id)&&(this._pickObjectChunkList[this._pickObjectChunkListLen++]=c,this._lastPickObjectChunkId[e]=c.id));b&&(this._objectPickList[this._objectPickListLen++]=a)},XEO.renderer.Renderer.prototype._logDrawList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._drawChunkListLen+" draw list chunks");for(var a=0,b=this._drawChunkListLen;b>a;a++){var c=this._drawChunkList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" type = renderTarget")}}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype._logPickList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._pickObjectChunkListLen+" pick list chunks");for(var a=0,b=this._pickObjectChunkListLen;b>a;a++){var c=this._pickObjectChunkList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" type = renderTarget")}}console.log("--------------------------------------------------------------------------------------------------")},XEO.renderer.Renderer.prototype.pick=function(a){var b=this._canvas.gl,c=null,d=a.canvasPos[0],e=a.canvasPos[1],f=this.pickBuf;f||(f=new XEO.renderer.webgl.RenderBuffer({gl:this._canvas.gl,canvas:this._canvas.canvas}),this.pickBuf=f),this.render(),f.bind(),f.clear(),this._doDrawList({pickObject:!0,clear:!0});var g=f.read(d,e),h=g[0]+256*g[1]+65536*g[2];h=h>=1?h-1:-1;var i=this._objectPickList[h];if(i&&(c={object:i.id,canvasPos:[d,e]},a.rayPick)){f.clear(),this._doDrawList({rayPick:!0,object:i,clear:!0}),b.finish(),g=f.read(d,e);var j=g[0]+256*g[1]+65536*g[2];j=j>=1?j-1:-1,c.primitiveIndex=j}return f.unbind(),c},XEO.renderer.Renderer.prototype._doDrawList=function(a){var b,c=this._canvas.gl,d=this._ambient;if(d){var e=d.color,f=d.intensity;b=[e[0]*f,e[1]*f,e[2]*f,1]}else b=[0,0,0];var g=this._frameCtx;if(g.renderTarget=null,g.renderBuf=null,g.depthbufEnabled=null,g.clearDepth=null,g.depthFunc=c.LESS,g.blendEnabled=!1,g.backfaces=!0,g.frontface=!0,g.pickIndex=0,g.textureUnit=0,g.transparent=!1,g.ambientColor=b,g.drawElements=0,g.useProgram=0,g.bindTexture=0,g.bindArray=0,this.stats.frame.setUniform=0,this.stats.frame.setUniformCacheHits=0,c.viewport(0,0,c.drawingBufferWidth,c.drawingBufferHeight),c.enable(c.DEPTH_TEST),this.transparent?c.clearColor(0,0,0,0):c.clearColor(b[0],b[1],b[2],1),a.clear&&c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT|c.STENCIL_BUFFER_BIT),c.frontFace(c.CCW),c.disable(c.CULL_FACE),c.disable(c.BLEND),a.pickObject)for(var h=0,i=this._pickObjectChunkListLen;i>h;h++)this._pickObjectChunkList[h].pickObject(g);else if(a.rayPick){if(a.object)for(var j,k=a.object.chunks,h=0,i=k.length;i>h;h++)j=k[h],j.pickPrimitive&&j.pickPrimitive(g)}else{for(var l=(new Date).getTime(),h=0,i=this._drawChunkListLen;i>h;h++)this._drawChunkList[h].draw(g);var m=(new Date).getTime();this.stats.frame.renderTime=(m-l)/1e3,this.stats.frame.drawElements=g.drawElements,this.stats.frame.useProgram=g.useProgram,this.stats.frame.bindTexture=g.bindTexture,this.stats.frame.bindArray=g.bindArray}c.flush(),g.renderBuf&&g.renderBuf.unbind();for(var n=c.getParameter(c.MAX_TEXTURE_IMAGE_UNITS),o=0;n>o;++o)c.activeTexture(c.TEXTURE0+o),c.bindTexture(c.TEXTURE_CUBE_MAP,null),c.bindTexture(c.TEXTURE_2D,null);this.stats.frame.drawChunks=this._drawChunkListLen},XEO.renderer.Renderer.prototype.destroy=function(){this._programFactory.destroy()}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.State=Class.extend({__init:function(a){this.id=this._ids.addItem({}),this.hash=a.hash||""+this.id;for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])},destroy:function(){this._ids.removeItem(this.id)}}),XEO.renderer.Visibility=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Modes=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Layer=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Stage=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.DepthBuf=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ColorBuf=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Lights=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.PhongMaterial=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Reflect=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ModelTransform=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ViewTransform=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ProjTransform=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Billboard=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.RenderTarget=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.RenderTarget.DEPTH=0,XEO.renderer.RenderTarget.COLOR=1,XEO.renderer.Clips=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.MorphTargets=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Shader=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ShaderParams=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Texture=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.Geometry=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})}),XEO.renderer.ProgramState=XEO.renderer.State.extend({_ids:new XEO.utils.Map({})})}(),function(){"use strict";XEO.renderer.Object=function(a){this.id=a,this.hash=null,this.sortKey=null,this.chunks=[],this.program=null,this.stage=null,this.modes=null,this.layer=null,this.material=null}}(),function(){"use strict";XEO.renderer.ObjectFactory=function(){var a=[],b=0;this.get=function(c){var d;return b>0?(d=a[--b],d.id=c,d):new XEO.renderer.Object(c)},this.put=function(c){a[b++]=c}}}(),function(){"use strict";XEO.renderer=XEO.renderer||{},XEO.renderer.Program=function(a,b,c,d){this.stats=a,this.hash=c.hash,this.source=c,this.gl=d,this.draw=null,this.pickObject=null,this.pickPrimitive=null,this.useCount=0,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.build(d)},XEO.renderer.Program.prototype.build=function(a){return this.gl=a,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.draw=new XEO.renderer.webgl.Program(this.stats,a,this.source.vertexDraw,this.source.fragmentDraw),this.pickObject=new XEO.renderer.webgl.Program(this.stats,a,this.source.vertexPickObject,this.source.fragmentPickObject),this.pickPrimitive=new XEO.renderer.webgl.Program(this.stats,a,this.source.vertexPickPrimitive,this.source.fragmentPickPrimitive),this.draw.allocated?this.pickObject.allocated?this.pickPrimitive.allocated?(this.allocated=!0,this.draw.compiled?this.pickObject.compiled?this.pickPrimitive.compiled?(this.compiled=!0,this.draw.linked?this.pickObject.linked?this.pickPrimitive.linked?(this.linked=!0,this.draw.validated?this.pickObject.validated?this.pickPrimitive.validated?void(this.validated=!0):void(this.errorLog=["Primitive-picking program failed to validate"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to validate"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to validate"].concat(this.draw.errorLog))):void(this.errorLog=["Primitive-picking program failed to link"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to link"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to link"].concat(this.draw.errorLog))):void(this.errorLog=["Primitive-picking program failed to compile"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to compile"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to compile"].concat(this.draw.errorLog))):void(this.errorLog=["Primitive-picking program failed to allocate"].concat(this.pickPrimitive.errorLog)):void(this.errorLog=["Object-picking program failed to allocate"].concat(this.pickObject.errorLog)):void(this.errorLog=["Draw program failed to allocate"].concat(this.draw.errorLog))}}(),function(){"use strict";XEO.renderer.ProgramFactory=function(a,b){this.stats=a,this._canvas=b.canvas,this._programStates={}},XEO.renderer.ProgramFactory.prototype.get=function(a,b){var c=this._programStates[a];if(!c){var d=XEO.renderer.ProgramSourceFactory.getSource(a,b),e=new XEO.renderer.Program(this.stats,a,d,this._canvas.gl);c=new XEO.renderer.ProgramState({program:e}),this._programStates[a]=c,this.stats.memory.programs++}return c.useCount++,c},XEO.renderer.ProgramFactory.prototype.put=function(a){var b=a.program;--b.useCount<=0&&(b.draw.destroy(),b.pickObject.destroy(),b.pickPrimitive.destroy(),XEO.renderer.ProgramSourceFactory.putSource(b.hash),delete this._programStates[b.hash],this.stats.memory.programs--)},XEO.renderer.ProgramFactory.prototype.webglRestored=function(){var a=this._canvas.gl;for(var b in this._programStates)this._programStates.hasOwnProperty(b)&&this._programStates[b].build(a)},XEO.renderer.ProgramFactory.prototype.destroy=function(){}}(),function(){"use strict";XEO.renderer.ProgramSource=function(a,b,c,d,e,f,g){this.hash=a,this.vertexPickObject=b,this.fragmentPickObject=c,this.vertexPickPrimitive=d,this.fragmentPickPrimitive=e,this.vertexDraw=f,this.fragmentDraw=g,this.useCount=0}}(),function(){"use strict";XEO.renderer.ProgramSourceFactory=new function(){function a(){if(!o.geometry.uv)return!1;var a=o.material;return a.ambientMap||a.diffuseMap||a.specularMap||a.emissiveMap||a.opacityMap||a.reflectivityMap}function b(){return!1}function c(){var a=o.geometry.primitiveName;return!o.geometry.normals||"triangles"!==a&&"triangle-strip"!==a&&"triangle-fan"!==a?!1:!0}function d(){return o.geometry.normals&&o.material.normalMap}function e(){return k(),l("attribute vec3 xeo_aPosition;"),l("uniform mat4 xeo_uModelMatrix;"),l("uniform mat4 xeo_uViewMatrix;"),l("uniform mat4 xeo_uViewNormalMatrix;"),l("uniform mat4 xeo_uProjMatrix;"),l("varying vec4 xeo_vWorldPosition;"),l("varying vec4 xeo_vViewPosition;"),l("void main(void) {"),l("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),l("   xeo_vWorldPosition = xeo_uModelMatrix * tmpVertex; "),l("   xeo_vViewPosition = xeo_uViewMatrix * xeo_vWorldPosition;"),l("   gl_Position = xeo_uProjMatrix * xeo_vViewPosition;"),l("}"),m()}function f(){return k(),l("precision "+n(o._canvas.gl)+" float;"),l("uniform vec4 xeo_uPickColor;"),l("void main(void) {"),l("   gl_FragColor = xeo_uPickColor; "),l("}"),m()}function g(){return k(),l("attribute vec3 xeo_aPosition;"),l("attribute vec4 xeo_aColor;"),l("uniform vec3 xeo_uPickColor;"),l("uniform mat4 xeo_uModelMatrix;"),l("uniform mat4 xeo_uViewMatrix;"),l("uniform mat4 xeo_uProjMatrix;"),l("varying vec4 xeo_vWorldPosition;"),l("varying vec4 xeo_vViewPosition;"),l("varying vec4 xeo_vColor;"),l("void main(void) {"),l("   vec4 tmpVertex = vec4(xeo_aPosition, 1.0); "),l("   vec4 worldPosition = xeo_uModelMatrix * tmpVertex; "),l("   vec4 viewPosition = xeo_uViewMatrix * worldPosition;"),l("   xeo_vColor = xeo_aColor;"),l("   gl_Position = xeo_uProjMatrix * viewPosition;"),l("}"),m()}function h(){return k(),l("precision "+n(o._canvas.gl)+" float;"),l("varying vec4 xeo_vColor;"),l("void main(void) {"),l("   gl_FragColor = xeo_vColor;"),l("}"),m()}function i(){var a=o.shader.vertex;if(a)return a;if(k(),l("uniform mat4 xeo_uModelMatrix;"),l("uniform mat4 xeo_uViewMatrix;"),l("uniform mat4 xeo_uProjMatrix;"),l("uniform vec3 xeo_uEye;"),l(),l("attribute vec3 xeo_aPosition;"),l(),l("varying vec4 xeo_vViewPosition;"),q){l("varying vec3 xeo_vViewEyeVec;"),l(),l("attribute vec3 xeo_aNormal;"),l("uniform mat4 xeo_uModelNormalMatrix;"),l("uniform mat4 xeo_uViewNormalMatrix;"),l("varying vec3 xeo_vViewNormal;"),r&&l("attribute vec4 xeo_aTangent;");for(var b=0;b<o.lights.lights.length;b++){var c=o.lights.lights[b];"ambient"!==c.type&&("dir"===c.type&&l("uniform vec3 xeo_uLightDir"+b+";"),"point"===c.type&&l("uniform vec3 xeo_uLightPos"+b+";"),"spot"===c.type&&l("uniform vec3 xeo_uLightPos"+b+";"),l("varying vec4 xeo_vViewLightVecAndDist"+b+";"))}}if(p&&(l(),l("attribute vec2 xeo_aUV;"),l("varying vec2 xeo_vUV;")),o.geometry.colors&&(l("attribute vec4 xeo_aColor;"),l("varying vec4 xeo_vColor;")),"points"===o.geometry.primitiveName&&l("uniform float xeo_uPointSize;"),o.billboard.active&&(l("void billboard(inout mat4 mat) {"),l("   mat[0][0] = 1.0;"),l("   mat[0][1] = 0.0;"),l("   mat[0][2] = 0.0;"),o.billboard.spherical&&(l("   mat[1][0] = 0.0;"),l("   mat[1][1] = 1.0;"),l("   mat[1][2] = 0.0;")),l("   mat[2][0] = 0.0;"),l("   mat[2][1] = 0.0;"),l("   mat[2][2] = 1.0;"),l("}")),l(),l("void main(void) {"),l(),l("   vec4 localPosition = vec4(xeo_aPosition, 1.0); "),q&&l("   vec4 localNormal = vec4(xeo_aNormal, 0.0); "),l("   mat4 modelMatrix = xeo_uModelMatrix;"),l("   mat4 viewMatrix = xeo_uViewMatrix;"),q&&(l("   mat4 modelNormalMatrix = xeo_uModelNormalMatrix;"),l("   mat4 viewNormalMatrix = xeo_uViewNormalMatrix;")),l("   vec4 worldPosition;"),o.billboard.active?(l("   mat4 modelView =  xeo_uViewMatrix * xeo_uModelMatrix ;"),q&&l("   mat4 modelViewNormal =  xeo_uViewNormalMatrix * xeo_uModelNormalMatrix ;"),l("   billboard(modelMatrix);"),l("   billboard(viewMatrix);"),l("   billboard(modelView);"),q&&(l("   billboard(modelNormalMatrix);"),l("   billboard(viewNormalMatrix);"),l("   billboard(modelViewNormal);")),l("   worldPosition = modelMatrix * localPosition;"),l("   vec4 viewPosition = modelView * localPosition;")):(l("   worldPosition = modelMatrix * localPosition;"),l("   vec4 viewPosition  = viewMatrix * worldPosition; ")),q&&(l("   vec3 worldNormal = (modelNormalMatrix * localNormal).xyz; "),l("   xeo_vViewNormal = (viewNormalMatrix * vec4(worldNormal, 1.0)).xyz;")),l("   xeo_vViewPosition = viewPosition;"),r&&(l("   vec3 tangent = normalize((viewNormalMatrix * modelNormalMatrix * xeo_aTangent).xyz);"),l("   vec3 bitangent = cross(xeo_vViewNormal, tangent);"),l("   mat3 TBM = mat3(tangent, bitangent, xeo_vViewNormal);")),l("  vec3 tmpVec3;"),q){for(var b=0;b<o.lights.lights.length;b++)c=o.lights.lights[b],"ambient"!==c.type&&("dir"===c.type&&("world"===c.space?(l("   tmpVec3 = xeo_uLightDir"+b+";"),l("   tmpVec3 = vec3(viewMatrix * vec4(tmpVec3, 0.0)).xyz;"),r&&l("   tmpVec3 *= TBM;")):(l("   tmpVec3 = xeo_uLightDir"+b+";"),r&&l("   tmpVec3 *= TBM;")),l("xeo_vViewLightVecAndDist"+b+" = vec4(-tmpVec3, 0.0);")),"point"===c.type&&("world"===c.space?(l("   tmpVec3 = (viewMatrix * vec4(xeo_uLightPos"+b+", 0.0)).xyz - viewPosition.xyz;"),r&&l("   tmpVec3 *= TBM;")):(l("   tmpVec3 = xeo_uLightPos"+b+".xyz - viewPosition.xyz;"),r&&l("   tmpVec3 *= TBM;")),l("   xeo_vViewLightVecAndDist"+b+" = vec4(tmpVec3, length(xeo_uLightPos"+b+".xyz - worldPosition.xyz));")));l("   xeo_vViewEyeVec = ((viewMatrix * vec4(xeo_uEye, 0.0)).xyz  - viewPosition.xyz);")}return r&&l("   xeo_vViewEyeVec *= TBM;"),p&&l("   xeo_vUV = xeo_aUV;"),o.geometry.colors&&l("   xeo_vColor = xeo_aColor;"),"points"===o.geometry.primitiveName&&l("   gl_PointSize = xeo_uPointSize;"),l("   gl_Position = xeo_uProjMatrix * viewPosition;"),l("}"),m()}function j(){var a=o.shader.fragment;if(a)return a;if(k(),l("precision "+n(o._canvas.gl)+" float;"),l(),q&&l("varying vec4 xeo_vViewPosition;"),l(),l("uniform vec3 xeo_uDiffuse;"),l("uniform vec3 xeo_uSpecular;"),l("uniform vec3 xeo_uEmissive;"),l("uniform float xeo_uOpacity;"),l("uniform float xeo_uShininess;"),l("uniform float xeo_uReflectivity;"),l(),p&&(o.geometry.uv&&l("varying vec2 xeo_vUV;"),o.material.ambientMap&&(l("uniform sampler2D xeo_uAmbientMap;"),o.material.ambientMap.matrix&&l("uniform mat4 xeo_uAmbientMapMatrix;")),o.material.diffuseMap&&(l("uniform sampler2D xeo_uDiffuseMap;"),o.material.diffuseMap.matrix&&l("uniform mat4 xeo_uDiffuseMapMatrix;")),
o.material.specularMap&&(l("uniform sampler2D xeo_uSpecularMap;"),o.material.specularMap.matrix&&l("uniform mat4 xeo_uSpecularMapMatrix;")),o.material.emissiveMap&&(l("uniform sampler2D xeo_uEmissiveMap;"),o.material.emissiveMap.matrix&&l("uniform mat4 xeo_uEmissiveMapMatrix;")),o.material.opacityMap&&(l("uniform sampler2D xeo_uOpacityMap;"),o.material.opacityMap.matrix&&l("uniform mat4 xeo_uOpacityMapMatrix;")),o.material.reflectivityMap&&(l("uniform sampler2D xeo_uTextureReflectivity;"),o.material.reflectivityMap.matrix&&l("uniform mat4 xeo_uTextureReflectivityMatrix;"))),o.geometry.colors&&l("varying vec4 xeo_vColor;"),q){l("uniform vec3 xeo_uLightAmbientColor;"),l("uniform float xeo_uLightAmbientIntensity;"),l("varying vec3 xeo_vViewEyeVec;"),l("varying vec3 xeo_vViewNormal;");for(var b,c=0;c<o.lights.lights.length;c++)b=o.lights.lights[c],"ambient"!==b.type&&(l("uniform vec3 xeo_uLightColor"+c+";"),l("uniform float xeo_uLightIntensity"+c+";"),"point"===b.type&&l("uniform vec3 xeo_uLightAttenuation"+c+";"),l("varying vec4 xeo_vViewLightVecAndDist"+c+";"))}if(l(),l("void main(void) {"),l(),q&&(l("   vec3 ambient = xeo_uLightAmbientColor;"),l("   vec3 diffuse = xeo_uDiffuse;"),l("   vec3 specular = xeo_uSpecular;"),l("   float shininess = xeo_uShininess;"),l("   float reflectivity = xeo_uReflectivity;")),l("   vec3 emissive = xeo_uEmissive;"),l("   float opacity = xeo_uOpacity;"),o.geometry.colors&&l("   diffuse = xeo_vColor.rgb;"),q&&l(r?"   vec3 viewNormalVec = vec3(0.0, 1.0, 0.0);":"   vec3 viewNormalVec = normalize(xeo_vViewNormal);"),p){l(),l("   vec4 texturePos = vec4(xeo_vUV.s, xeo_vUV.t, 1.0, 1.0);"),l("   vec2 textureCoord;");var d=o.material;d.ambientMap&&(l(),l(d.ambientMap.matrix?"   textureCoord = (xeo_uAmbientMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   ambient = texture2D(xeo_uAmbientMap, textureCoord).rgb;")),d.diffuseMap&&(l(),l(d.diffuseMap.matrix?"   textureCoord = (xeo_uDiffuseMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   diffuse = texture2D(xeo_uDiffuseMap, textureCoord).rgb;")),d.specularMap&&(l(),l(d.specularMap.matrix?"   textureCoord = (xeo_uSpecularMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   specular = texture2D(xeo_uSpecularMap, textureCoord).rgb;")),d.emissiveMap&&(l(),l(d.emissiveMap.matrix?"   textureCoord = (xeo_uEmissiveMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   emissive = texture2D(xeo_uEmissiveMap, textureCoord).rgb;")),d.opacityMap&&(l(),l(d.opacityMap.matrix?"   textureCoord = (xeo_uOpacityMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   opacity = texture2D(xeo_uOpacityMap, textureCoord).b;")),d.reflectivityMap&&(l(),l(d.reflectivityMap.matrix?"   textureCoord = (xeo_uReflectivityMapMatrix * texturePos).xy;":"   textureCoord = texturePos.xy;"),l("   textureCoord.y = -textureCoord.y;"),l("   reflectivity = texture2D(xeo_uReflectivityMap, textureCoord).b;"))}if(q){l(),l("   vec3  diffuseLight = vec3(0.0, 0.0, 0.0);"),l("   vec3  specularLight = vec3(0.0, 0.0, 0.0);"),l(),l("   vec3  viewLightVec;"),l("   float dotN;"),l("   float lightDist;"),l("   float attenuation;");for(var b,c=0,e=o.lights.lights.length;e>c;c++)b=o.lights.lights[c],"ambient"!==b.type&&(l("   viewLightVec = normalize(xeo_vViewLightVecAndDist"+c+".xyz);"),"point"===b.type&&(l(),l("   dotN = max(dot(viewNormalVec, viewLightVec), 0.0);"),l("   lightDist = xeo_vViewLightVecAndDist"+c+".w;"),l("   attenuation = 1.0 - (  xeo_uLightAttenuation"+c+"[0] +   xeo_uLightAttenuation"+c+"[1] * lightDist +   xeo_uLightAttenuation"+c+"[2] * lightDist * lightDist);"),l("   diffuseLight += dotN * xeo_uLightColor"+c+" * attenuation;"),l("   specularLight += xeo_uLightIntensity"+c+" *  pow(max(dot(reflect(-viewLightVec, -viewNormalVec), normalize(-xeo_vViewPosition.xyz)), 0.0), shininess) * attenuation;")),"dir"===b.type&&(l(),l("   dotN = max(dot(viewNormalVec, viewLightVec), 0.0);"),l("   diffuseLight += dotN * xeo_uLightColor"+c+";"),l("   specularLight += xeo_uLightIntensity"+c+" * pow(max(dot(reflect(-viewLightVec, -viewNormalVec), normalize(-xeo_vViewPosition.xyz)), 0.0), shininess);")));l(),l("   gl_FragColor = vec4((specular * specularLight) + ((diffuseLight + (ambient * xeo_uLightAmbientIntensity) ) * diffuse) + emissive, opacity);")}else l(),l("   gl_FragColor = vec4(emissive, opacity);");return l("}"),m()}function k(){u=[]}function l(a){u.push(a||"")}function m(){return u}function n(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}var o,p,q,r,s,t={},u="";this.getSource=function(k,l){var m=t[k];return m?(m.useCount++,m):(o=l,p=a(),q=c(),r=d(),s=b(),m=new XEO.renderer.ProgramSource(k,e(),f(),g(),h(),i(),j()),t[k]=m,m)},this.putSource=function(a){var b=t[a];b&&0===--b.useCount&&(t[b.hash]=null)}}}(),function(){"use strict";XEO.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}}}(),function(){"use strict";XEO.renderer.webgl.ArrayBuffer=function(a,b,c,d,e,f){this.allocated=!1,this.gl=a,this.type=b,this.itemType=c.constructor==Uint8Array?a.UNSIGNED_BYTE:c.constructor==Uint16Array?a.UNSIGNED_SHORT:c.constructor==Uint32Array?a.UNSIGNED_INT:a.FLOAT,this.usage=f,this.length=0,this.numItems=0,this.itemSize=e,this._allocate(c)},XEO.renderer.webgl.ArrayBuffer.prototype._allocate=function(a){if(this.allocated=!1,this._handle=this.gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this.gl.bindBuffer(this.type,this._handle),this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null),this.length=a.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},XEO.renderer.webgl.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):b||0===b?this.gl.bufferSubData(this.type,b,a):this.gl.bufferData(this.type,a))},XEO.renderer.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this._handle)},XEO.renderer.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},XEO.renderer.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}(),function(){"use strict";XEO.renderer.webgl.Attribute=function(a,b){this.gl=a,this.location=b},XEO.renderer.webgl.Attribute.prototype.bindFloatArrayBuffer=function(a){a&&(a.bind(),this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a.itemSize,this.gl.FLOAT,!1,0,0))},XEO.renderer.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(a,b,c){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a,this.gl.FLOAT,!1,b,c)}}(),function(){"use strict";XEO.renderer.webgl.Program=function(a,b,c,d){if(this.stats=a,this.gl=b,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errorLog=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new XEO.renderer.webgl.Shader(b,b.VERTEX_SHADER,c.join("\n")),this._fragmentShader=new XEO.renderer.webgl.Shader(b,b.FRAGMENT_SHADER,d.join("\n")),!this._vertexShader.allocated)return void(this.errorLog=["Vertex shader failed to allocate"].concat(this._vertexShader.errorLog));if(!this._fragmentShader.allocated)return void(this.errorLog=["Fragment shader failed to allocate"].concat(this._fragmentShader.errorLog));if(this.allocated=!0,!this._vertexShader.compiled)return void(this.errorLog=["Vertex shader failed to compile"].concat(this._vertexShader.errorLog));if(!this._fragmentShader.compiled)return void(this.errorLog=["Fragment shader failed to compile"].concat(this._fragmentShader.errorLog));this.compiled=!0;var e,f,g,h,i;if(this.handle=b.createProgram(),!this.handle)return void(this.errorLog=["Failed to allocate program"]);if(b.attachShader(this.handle,this._vertexShader.handle),b.attachShader(this.handle,this._fragmentShader.handle),b.linkProgram(this.handle),this.linked=b.getProgramParameter(this.handle,b.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errorLog=[],this.errorLog.push(""),this.errorLog.push(b.getProgramInfoLog(this.handle)),this.errorLog.push("\nVertex shader:\n"),this.errorLog=this.errorLog.concat(c),this.errorLog.push("\nFragment shader:\n"),void(this.errorLog=this.errorLog.concat(d));var j=b.getProgramParameter(this.handle,b.ACTIVE_UNIFORMS);for(f=0;j>f;++f)g=b.getActiveUniform(this.handle,f),g&&(h=g.name,"\x00"===h[h.length-1]&&(h=h.substr(0,h.length-1)),i=b.getUniformLocation(this.handle,h),g.type===b.SAMPLER_2D||g.type===b.SAMPLER_CUBE||35682===g.type?this.samplers[h]=new XEO.renderer.webgl.Sampler(b,i):this.uniforms[h]=new XEO.renderer.webgl.Uniform(a.frame,b,g.type,i));var k=b.getProgramParameter(this.handle,b.ACTIVE_ATTRIBUTES);for(f=0;k>f;f++)e=b.getActiveAttrib(this.handle,f),e&&(i=b.getAttribLocation(this.handle,e.name),this.attributes[e.name]=new XEO.renderer.webgl.Attribute(b,i));this.allocated=!0},XEO.renderer.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},XEO.renderer.webgl.Program.prototype.setUniform=function(a,b){if(this.allocated){var c=this.uniforms[a];c&&c.setValue(b)}},XEO.renderer.webgl.Program.prototype.getUniform=function(a){return this.allocated?this.uniforms[a]:void 0},XEO.renderer.webgl.Program.prototype.getAttribute=function(a){return this.allocated?this.attributes[a]:void 0},XEO.renderer.webgl.Program.prototype.bindFloatArrayBuffer=function(a,b){return this.allocated?this.attributes[a]:void 0},XEO.renderer.webgl.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this.samplers[a];return d?d.bindTexture(b,c):!1},XEO.renderer.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),function(){"use strict";XEO.renderer.webgl.RenderBuffer=function(a){this.allocated=!1,this.canvas=a.canvas,this.gl=a.gl,this.buffer=null,this.bound=!1,this.size=a.size},XEO.renderer.webgl.RenderBuffer.prototype.setSize=function(a){this.size=a},XEO.renderer.webgl.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buffer=null,this.allocated=!1,this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0)},XEO.renderer.webgl.RenderBuffer.prototype._touch=function(){var a,b;if(this.size?(a=this.size[0],b=this.size[1]):(a=this.canvas.clientWidth,b=this.canvas.clientHeight),this.buffer){if(this.buffer.width===a&&this.buffer.height===b)return;this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf)}if(this.buffer={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:a,height:b},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buffer.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buffer.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buffer.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buffer.framebuf),!this.gl.isFramebuffer(this.buffer.framebuf))throw"Invalid framebuffer";this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);var c=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(c){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case this.gl.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+c}this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},XEO.renderer.webgl.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.height-b,e=new Uint8Array(4);return this.gl.readPixels(c,d,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),e},XEO.renderer.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},XEO.renderer.webgl.RenderBuffer.prototype.getTexture=function(){var a=this;return{renderBuffer:this,bind:function(b){return a.buffer&&a.buffer.texture?(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buffer.texture),!0):!1},unbind:function(b){a.buffer&&a.buffer.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},XEO.renderer.webgl.RenderBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteTexture(this.buffer.texture),this.gl.deleteFramebuffer(this.buffer.framebuf),this.gl.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1)}}(),function(){"use strict";XEO.renderer.webgl.Sampler=function(a,b){this.bindTexture=function(c,d){return c.bind(d)?(a.uniform1i(b,d),!0):!1}}}(),function(){"use strict";XEO.renderer.webgl.Shader=function(a,b,c){return this.allocated=!1,this.compiled=!1,this.errorLog=null,this.source=c,this.handle=a.createShader(b),this.handle?(this.allocated=!0,a.shaderSource(this.handle,c),a.compileShader(this.handle),this.compiled=a.getShaderParameter(this.handle,a.COMPILE_STATUS),void(this.compiled||a.isContextLost()||(this.errorLog=[],this.errorLog.push(""),this.errorLog.push(a.getShaderInfoLog(this.handle)),this.errorLog=this.errorLog.concat(this.source)))):void(this.errorLog=["Failed to allocate"])}}(),function(){"use strict";XEO.renderer.webgl.Texture2D=function(a,b){this.gl=a,b=b||{},this.target=b.target||a.TEXTURE_2D,this.texture=a.createTexture(),this.allocated=!0},XEO.renderer.webgl.Texture2D.prototype.setImage=function(a){var b=this.gl;b.bindTexture(this.target,this.texture),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a),b.bindTexture(this.target,null)},XEO.renderer.webgl.Texture2D.prototype.setProps=function(a){var b=this.gl;if(b.bindTexture(this.target,this.texture),(a.flipY===!0||a.flipY===!1)&&b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,a.flipY),a.minFilter){var c=this._getGLEnum(a.minFilter);c&&(b.texParameteri(this.target,b.TEXTURE_MIN_FILTER,c),(c===b.NEAREST_MIPMAP_NEAREST||c===b.LINEAR_MIPMAP_NEAREST||c===b.NEAREST_MIPMAP_LINEAR||c===b.LINEAR_MIPMAP_LINEAR)&&b.generateMipmap(this.target))}if(a.magFilter){var d=this._getGLEnum(a.magFilter);d&&b.texParameteri(this.target,b.TEXTURE_MAG_FILTER,d)}if(a.wrapS){var e=this._getGLEnum(a.wrapS);e&&b.texParameteri(this.target,b.TEXTURE_WRAP_S,e)}if(a.wrapT){var f=this._getGLEnum(a.wrapT);f&&b.texParameteri(this.target,b.TEXTURE_WRAP_T,f)}b.bindTexture(this.target,null)},XEO.renderer.webgl.Texture2D.prototype._getGLEnum=function(a,b){if(void 0===a)return b;var c=XEO.renderer.webgl.enums[a];return void 0===c?b:this.gl[c]},XEO.renderer.webgl.Texture2D.prototype.bind=function(a){if(this.allocated){if(this.texture){var b=this.gl;return b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,this.texture),!0}return!1}},XEO.renderer.webgl.Texture2D.prototype.unbind=function(a){if(this.allocated&&this.texture){var b=this.gl;b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,null)}},XEO.renderer.webgl.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},XEO.renderer.webgl.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=XEO.renderer.webgl.nextHighestPowerOfTwo(e),g.height=XEO.renderer.webgl.nextHighestPowerOfTwo(f);var h=g.getContext("2d");h.drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},XEO.renderer.webgl.ensureImageSizePowerOfTwo=function(a){if(!XEO.renderer.webgl.isPowerOfTwo(a.width)||!XEO.renderer.webgl.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=XEO.renderer.webgl.nextHighestPowerOfTwo(a.width),b.height=XEO.renderer.webgl.nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},XEO.renderer.webgl.isPowerOfTwo=function(a){return 0===(a&a-1)},XEO.renderer.webgl.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1}}(),function(){"use strict";XEO.renderer.webgl.Uniform=function(a,b,c,d){var e=null,f=null;if(c===b.BOOL)e=function(c){return f===c?void a.setUniformCacheHits++:(f=c,b.uniform1i(d,c),void a.setUniform++)};else if(c===b.BOOL_VEC2)e=function(c){return null!==f&&f[0]===c[0]&&f[1]===c[1]?void a.setUniformCacheHits++:(f=c,b.uniform2iv(d,c),void a.setUniform++)};else if(c===b.BOOL_VEC3)e=function(c){return null!==f&&f[0]===c[0]&&f[1]===c[1]&&f[2]===c[2]?void a.setUniformCacheHits++:(f=c,b.uniform3iv(d,c),void a.setUniform++)};else if(c===b.BOOL_VEC4)e=function(c){return null!==f&&f[0]===c[0]&&f[1]===c[1]&&f[2]===c[2]&&f[3]===c[3]?void a.setUniformCacheHits++:(f=c,b.uniform4iv(d,c),void a.setUniform++)};else if(c===b.INT)e=function(c){return f===c?void a.setUniformCacheHits++:(f=c,b.uniform1iv(d,c),void a.setUniform++)};else if(c===b.INT_VEC2)e=function(c){return null!==f&&f[0]===c[0]&&f[1]===c[1]?void a.setUniformCacheHits++:(f=c,b.uniform2iv(d,c),void a.setUniform++)};else if(c===b.INT_VEC3)e=function(c){return null!==f&&f[0]===c[0]&&f[1]===c[1]&&f[2]===c[2]?void a.setUniformCacheHits++:(f=c,b.uniform3iv(d,c),void a.setUniform++)};else if(c===b.INT_VEC4)e=function(c){return null!==f&&f[0]===c[0]&&f[1]===c[1]&&f[2]===c[2]&&f[3]===c[3]?void a.setUniformCacheHits++:(f=c,b.uniform4iv(d,c),void a.setUniform++)};else if(c===b.FLOAT)e=function(c){return f===c?void a.setUniformCacheHits++:(f=c,b.uniform1f(d,c),void a.setUniform++)};else if(c===b.FLOAT_VEC2)e=function(c){return null!==f&&f[0]===c[0]&&f[1]===c[1]?void a.setUniformCacheHits++:(f=c,b.uniform2fv(d,c),void a.setUniform++)};else if(c===b.FLOAT_VEC3)e=function(c){return null!==f&&f[0]===c[0]&&f[1]===c[1]&&f[2]===c[2]?void a.setUniformCacheHits++:(f=c,b.uniform3fv(d,c),void a.setUniform++)};else if(c===b.FLOAT_VEC4)e=function(c){return null!==f&&f[0]===c[0]&&f[1]===c[1]&&f[2]===c[2]&&f[3]===c[3]?void a.setUniformCacheHits++:(f=c,b.uniform4fv(d,c),void a.setUniform++)};else if(c===b.FLOAT_MAT2)e=function(c){b.uniformMatrix2fv(d,b.FALSE,c),a.setUniform++};else if(c===b.FLOAT_MAT3)e=function(c){b.uniformMatrix3fv(d,b.FALSE,c),a.setUniform++};else{if(c!==b.FLOAT_MAT4)throw"Unsupported shader uniform type: "+c;e=function(c){b.uniformMatrix4fv(d,b.FALSE,c),a.setUniform++}}this.setValue=e,this.getLocation=function(){return d}}}(),function(){"use strict";XEO.renderer.Chunk=function(){},XEO.renderer.Chunk.prototype.init=function(a,b,c){this.id=a,this.program=b,this.state=c,this.useCount=0,this.build&&this.build()}}(),function(){"use strict";XEO.renderer.ChunkFactory=function(){this.types=XEO.renderer.ChunkFactory.types},XEO.renderer.ChunkFactory.types={},XEO.renderer.ChunkFactory.createChunkType=function(a){if(!a.type)throw"'type' expected in params";var b=XEO.renderer.Chunk,c=function(){this.useCount=0,this.init.apply(this,arguments)};return c.prototype=new b,c.prototype.constructor=c,XEO._apply(a,c.prototype),XEO.renderer.ChunkFactory.types[a.type]={constructor:c,chunks:{},freeChunks:[],freeChunksLen:0},c},XEO.renderer.ChunkFactory.prototype.getChunk=function(a,b,c,d){var e=this.types[b];if(!e)throw"chunk type not supported: '"+b+"'";var f=e.chunks[a];return f?(f.useCount++,f):(e.freeChunksLen>0&&(f=e.freeChunks[--e.freeChunksLen]),f?f.init(a,c,d):f=new e.constructor(a,c,d),f.useCount=1,e.chunks[a]=f,f)},XEO.renderer.ChunkFactory.prototype.putChunk=function(a){if(0!==a.useCount&&--a.useCount<=0){var b=this.types[a.type];delete b.chunks[a.id],b.freeChunks[b.freeChunksLen++]=a}},XEO.renderer.ChunkFactory.prototype.webglRestored=function(){var a,b,c,d=this.types;for(var e in d)if(d.hasOwnProperty(e)){a=d[e],b=a.chunks;for(var f in b)b.hasOwnProperty(f)&&(c=b[f],c.build&&c.build())}}}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"clips",build:function(){this._uClipModeDraw=this._uClipModeDraw||[],this._uClipPlaneDraw=this._uClipPlaneDraw||[];for(var a=this.program.draw,b=0,c=this.state.clips.length;c>b;b++)this._uClipModeDraw[b]=a.getUniform("xeo_uClipMode"+b),this._uClipPlaneDraw[b]=a.getUniform("xeo_uClipPlane"+b);this._uClipModePick=this._uClipModePick||[],this._uClipPlanePick=this._uClipPlanePick||[];for(var d=this.program.pick,b=0,c=this.state.clips.length;c>b;b++)this._uClipModePick[b]=d.getUniform("xeo_uClipMode"+b),this._uClipPlanePick[b]=d.getUniform("xeo_uClipPlane"+b)},drawPick:function(a){return}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"colorBuf",programGlobal:!0,draw:function(a){if(!a.transparent){var b=this.state,c=b.blendEnabled,d=this.program.gl;a.blendEnabled!==c&&(c?d.enable(d.BLEND):d.disable(d.BLEND),a.blendEnabled=c);var e=b.colorMask;d.colorMask(e[0],e[1],e[2],e[3])}}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"cubemap",build:function(){},draw:function(a){}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"depthBuf",programGlobal:!0,draw:function(a){var b=this.program.gl,c=this.state,d=c.active;a.depthbufEnabled!==d&&(d?b.disable(b.DEPTH_TEST):b.enable(b.DEPTH_TEST),a.depthbufEnabled=d);var e=c.clearDepth;a.clearDepth!==e&&(b.clearDepth(e),a.clearDepth=e);var f=c.depthFunc;a.depthFunc!==f&&(b.depthFunc(f),a.depthFunc=f),c.clear&&b.clear(b.DEPTH_BUFFER_BIT)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"draw",unique:!0,build:function(){this._uPickColorObject=this.program.pickObject.getUniform("xeo_uPickColor")},draw:function(a){var b=this.state,c=this.program.gl;b.indices&&(c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0),a.drawElements++)},pickObject:function(a){var b=this.state,c=this.program.gl;if(this._uPickColorObject){a.pickObjects[a.pickIndex++]=this.object;var d=a.pickIndex>>16&255,e=a.pickIndex>>8&255,f=255&a.pickIndex;this._uPickColorObject.setValue([f/255,e/255,d/255,0])}b.indices&&(c.drawElements(b.primitive,b.indices.numItems,b.indices.itemType,0),a.drawElements++)},pickPrimitive:function(){var a=this.state,b=this.program.gl,c=a.getPickIndices();c&&b.drawElements(a.primitive,c.numItems,c.itemType,0)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"geometry",build:function(){var a=this.program.draw;this._aPositionDraw=a.getAttribute("xeo_aPosition"),this._aNormalDraw=a.getAttribute("xeo_aNormal"),this._aUVDraw=a.getAttribute("xeo_aUV"),this._aTangentDraw=a.getAttribute("xeo_aTangent"),this._aColorDraw=a.getAttribute("xeo_aColor");var b=this.program.pickObject;this._aPositionPickObject=b.getAttribute("xeo_aPosition");var c=this.program.pickPrimitive;this._aPositionPickPrimitive=c.getAttribute("xeo_aPosition"),this._aColorPickPrimitive=c.getAttribute("xeo_aColor")},draw:function(a){var b=this.state;this._aPositionDraw&&(this._aPositionDraw.bindFloatArrayBuffer(b.positions),a.bindArray++),this._aNormalDraw&&(this._aNormalDraw.bindFloatArrayBuffer(b.normals),a.bindArray++),this._aUVDraw&&(this._aUVDraw.bindFloatArrayBuffer(b.uv),a.bindArray++),this._aColorDraw&&(this._aColorDraw.bindFloatArrayBuffer(b.colors),a.bindArray++),this._aTangentDraw&&(this._aTangentDraw.bindFloatArrayBuffer(b.getTangents()),a.bindArray++),b.indices&&(b.indices.bind(),a.bindArray++)},pickObject:function(){var a=this.state;this._aPositionPickObject&&this._aPositionPickObject.bindFloatArrayBuffer(a.positions),a.indices&&a.indices.bind()},pickPrimitive:function(){var a=this.state;this._aPositionPickPrimitive&&this._aPositionPickPrimitive.bindFloatArrayBuffer(a.getPickPositions()),this._aColorPickPrimitive&&this._aColorPickPrimitive.bindFloatArrayBuffer(a.getPickColors());var b=a.getPickIndices();b&&b.bind()}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"lights",build:function(){this._uLightAmbientColor=this._uLightAmbientColor||[],this._uLightAmbientIntensity=this._uLightAmbientIntensity||[],this._uLightColor=this._uLightColor||[],this._uLightIntensity=this._uLightIntensity||[],this._uLightDir=this._uLightDir||[],this._uLightPos=this._uLightPos||[],this._uLightAttenuation=this._uLightAttenuation||[];for(var a=this.state.lights,b=this.program,c=0,d=a.length;d>c;c++)switch(a[c].type){case"ambient":this._uLightAmbientColor[c]=b.draw.getUniform("xeo_uLightAmbientColor"),this._uLightAmbientIntensity[c]=b.draw.getUniform("xeo_uLightAmbientIntensity");break;case"dir":this._uLightColor[c]=b.draw.getUniform("xeo_uLightColor"+c),this._uLightIntensity[c]=b.draw.getUniform("xeo_uLightIntensity"+c),this._uLightPos[c]=null,this._uLightDir[c]=b.draw.getUniform("xeo_uLightDir"+c);break;case"point":this._uLightColor[c]=b.draw.getUniform("xeo_uLightColor"+c),this._uLightIntensity[c]=b.draw.getUniform("xeo_uLightIntensity"+c),this._uLightPos[c]=b.draw.getUniform("xeo_uLightPos"+c),this._uLightDir[c]=null,this._uLightAttenuation[c]=b.draw.getUniform("xeo_uLightAttenuation"+c)}},draw:function(){for(var a,b=this.state.lights,c=(this.program.gl,0),d=b.length;d>c;c++)a=b[c],this._uLightAmbientColor[c]?(this._uLightAmbientColor[c].setValue(a.color),this._uLightAmbientIntensity[c]&&this._uLightAmbientIntensity[c].setValue(a.intensity)):(this._uLightColor[c]&&this._uLightColor[c].setValue(a.color),this._uLightIntensity[c]&&this._uLightIntensity[c].setValue(a.intensity),this._uLightPos[c]&&(this._uLightPos[c].setValue(a.pos),this._uLightAttenuation[c]&&this._uLightAttenuation[c].setValue(a.attenuation)),this._uLightDir[c]&&this._uLightDir[c].setValue(a.dir))}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"modelTransform",build:function(){this._uModelMatrixDraw=this.program.draw.getUniform("xeo_uModelMatrix"),this._uModelNormalMatrixDraw=this.program.draw.getUniform("xeo_uModelNormalMatrix"),this._uModelMatrixPickObject=this.program.pickObject.getUniform("xeo_uModelMatrix"),this._uModelMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uModelMatrix")},draw:function(){this._uModelMatrixDraw&&this._uModelMatrixDraw.setValue(this.state.matrix),this._uModelNormalMatrixDraw&&this._uModelNormalMatrixDraw.setValue(this.state.normalMatrix)},pickObject:function(){this._uModelMatrixPickObject&&this._uModelMatrixPickObject.setValue(this.state.matrix)},pickPrimitive:function(){this._uModelMatrixPickPrimitive&&this._uModelMatrixPickPrimitive.setValue(this.state.matrix)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"modes",build:function(){},draw:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e);var f=b.transparent;a.transparent!==f&&(a.pick||(f?(c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),a.blendEnabled=!0):(c.disable(c.BLEND),a.blendEnabled=!1)),a.transparent=f)},pickObject:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)},pickPrimitive:function(a){var b=this.state,c=this.program.gl,d=b.backfaces;a.backfaces!==d&&(d?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=d);var e=b.frontface;a.frontface!==e&&(e?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=e)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"pbrMaterial",build:function(){var a=this.state,b=this.program.draw;this._uMetallic=b.getUniform("xeo_uMetallic"),this._uMaterialColor=b.getUniform("xeo_uMaterialColor"),a.colorMap&&(this._uMaterialColorMap=b.getUniform("xeo_uMaterialColorMap"),this._uMaterialColorMapMatrix=b.getUniform("xeo_uMaterialColorMapMatrix")),this._uMaterialEmissive=b.getUniform("xeo_uEmissive"),a.emissiveMap&&(this._uEmissiveMap=b.getUniform("xeo_uMaterialEmissiveMap"),this._uMaterialEmissiveMapMatrix=b.getUniform("xeo_uMaterialEmissiveMapMatrix")),this._uOpacity=b.getUniform("xeo_uOpacity"),a.opacityMap&&(this._uMaterialOpacityMap=b.getUniform("xeo_uMaterialOpacityMap"),this._uMaterialOpacityMapMatrix=b.getUniform("xeo_uMaterialOpacityMapMatrix")),this._uMaterialRoughness=b.getUniform("xeo_uMaterialRoughness"),a.roughnessMap&&(this._uMaterialRoughnessMap=b.getUniform("xeo_uMaterialRoughnessMap"),this._uMaterialRoughnessMapMatrix=b.getUniform("xeo_uMaterialRoughnessMapMatrix")),a.normalMap&&(this._uMaterialNormalMap=b.getUniform("xeo_uMaterialNormalMap"),this._uMaterialNormalMapMatrix=b.getUniform("xeo_uMaterialNormalMapMatrix")),this._uMaterialSpecular=b.getUniform("xeo_uSpecular"),a.specularMap&&(this._uMaterialSpecularMap=b.getUniform("xeo_uMaterialSpecularMap"),this._uMaterialSpecularMapMatrix=b.getUniform("xeo_uMaterialSpecularMapMatrix"))},draw:function(a){var b=this.program.draw,c=this.state;this._uMetallic&&this._uMetallic.setValue(c.metallic),this._uMaterialColor&&this._uMaterialColor.setValue(c.color),
this._uMaterialColorMap&&(b.bindTexture(this._uMaterialColorMap,c.colorMap.texture,a.textureUnit++),this._uMaterialColorMapMatrix&&this._uMaterialColorMapMatrix.setValue(c.colorMap.matrix)),this._uMaterialEmissive&&this._uMaterialEmissive.setValue(c.emissive),this._uEmissiveMap&&(b.bindTexture(this._uEmissiveMap,c.emissiveMap.texture,a.textureUnit++),this._uMaterialEmissiveMapMatrix&&this._uMaterialEmissiveMapMatrix.setValue(c.emissiveMap.matrix)),this._uOpacity&&this._uOpacity.setValue(c.opacity),this._uMaterialOpacityMap&&(b.bindTexture(this._uMaterialOpacityMap,c.opacityMap.texture,a.textureUnit++),this._uMaterialOpacityMapMatrix&&this._uMaterialOpacityMapMatrix.setValue(c.opacityMap.matrix)),this._uMaterialRoughness&&this._uMaterialRoughness.setValue(c.roughness),this._uMaterialRoughnessMap&&(b.bindTexture(this._uMaterialRoughnessMap,c.roughnessMap.texture,a.textureUnit++),this._uMaterialRoughnessMapMatrix&&this._uMaterialRoughnessMapMatrix.setValue(c.roughnessMap.matrix)),this._uMaterialNormalMap&&(b.bindTexture(this._uMaterialNormalMap,c.normalMap.texture,a.textureUnit++),this._uMaterialNormalMapMatrix&&this._uMaterialNormalMapMatrix.setValue(c.normalMap.matrix)),this._uMaterialSpecular&&this._uMaterialSpecular.setValue(c.specular),this._uMaterialSpecularMap&&(b.bindTexture(this._uMaterialSpecularMap,c.specularMap.texture,a.textureUnit++),this._uMaterialSpecularMapMatrix&&this._uMaterialSpecularMapMatrix.setValue(c.specularMap.matrix))}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"phongMaterial",build:function(){var a=this.state,b=this.program.draw;this._uDiffuse=b.getUniform("xeo_uDiffuse"),this._uSpecular=b.getUniform("xeo_uSpecular"),this._uEmissive=b.getUniform("xeo_uEmissive"),this._uOpacity=b.getUniform("xeo_uOpacity"),this._uShininess=b.getUniform("xeo_uShininess"),this._uPointSize=b.getUniform("xeo_uPointSize"),a.ambientMap&&(this._uAmbientMap="xeo_uAmbientMap",this._uAmbientMapMatrix=b.getUniform("xeo_uAmbientMapMatrix")),a.diffuseMap&&(this._uDiffuseMap="xeo_uDiffuseMap",this._uDiffuseMapMatrix=b.getUniform("xeo_uDiffuseMapMatrix")),a.specularMap&&(this._uSpecularMap="xeo_uSpecularMap",this._uSpecularMapMatrix=b.getUniform("xeo_uSpecularMapMatrix")),a.emissiveMap&&(this._uEmissiveMap="xeo_uEmissiveMap",this._uEmissiveMapMatrix=b.getUniform("xeo_uEmissiveMapMatrix")),a.opacityMap&&(this._uOpacityMap="xeo_uOpacityMap",this._uOpacityMapMatrix=b.getUniform("xeo_uOpacityMapMatrix")),a.reflectivityMap&&(this._uReflectivityMap="xeo_uReflectivityMap",this._uReflectivityMapMatrix=b.getUniform("xeo_uReflectivityMapMatrix")),a.normalMap&&(this._uBumpMap="xeo_uNormalMap",this._uBumpMapMatrix=b.getUniform("xeo_uNormalMapMatrix")),a.diffuseFresnel&&(this._uDiffuseFresnelBias=b.getUniform("xeo_uDiffuseFresnelBias"),this._uDiffuseFresnelPower=b.getUniform("xeo_uDiffuseFresnelPower"),this._uDiffuseFresnelLeftColor=b.getUniform("xeo_uDiffuseFresnelLeftColor"),this._uDiffuseFresnelRightColor=b.getUniform("xeo_uDiffuseFresnelRightColor")),a.specularFresnel&&(this._uSpecularFresnelBias=b.getUniform("xeo_uSpecularFresnelBias"),this._uSpecularFresnelPower=b.getUniform("xeo_uSpecularFresnelPower"),this._uSpecularFresnelLeftColor=b.getUniform("xeo_uSpecularFresnelLeftColor"),this._uSpecularFresnelRightColor=b.getUniform("xeo_uSpecularFresnelRightColor")),a.opacityFresnel&&(this._uOpacityFresnelBias=b.getUniform("xeo_uOpacityFresnelBias"),this._uOpacityFresnelPower=b.getUniform("xeo_uOpacityFresnelPower"),this._uOpacityFresnelLeftColor=b.getUniform("xeo_uOpacityFresnelLeftColor"),this._uOpacityFresnelRightColor=b.getUniform("xeo_uOpacityFresnelRightColor")),a.reflectivityFresnel&&(this._uReflectivityFresnelBias=b.getUniform("xeo_uReflectivityFresnelBias"),this._uReflectivityFresnelPower=b.getUniform("xeo_uReflectivityFresnelPower"),this._uReflectivityFresnelLeftColor=b.getUniform("xeo_uReflectivityFresnelLeftColor"),this._uReflectivityFresnelRightColor=b.getUniform("xeo_uReflectivityFresnelRightColor")),a.emissiveFresnel&&(this._uEmissiveFresnelBias=b.getUniform("xeo_uEmissiveFresnelBias"),this._uEmissiveFresnelPower=b.getUniform("xeo_uEmissiveFresnelPower"),this._uEmissiveFresnelLeftColor=b.getUniform("xeo_uEmissiveFresnelLeftColor"),this._uEmissiveFresnelRightColor=b.getUniform("xeo_uEmissiveFresnelRightColor"))},draw:function(a){var b=this.program.draw,c=this.state,d=this.program.gl;this._uDiffuse&&this._uDiffuse.setValue(c.diffuse),this._uSpecular&&this._uSpecular.setValue(c.specular),this._uEmissive&&this._uEmissive.setValue(c.emissive),this._uOpacity&&this._uOpacity.setValue(c.opacity),this._uShininess&&this._uShininess.setValue(c.shininess),a.lineWidth!=c.lineWidth&&(d.lineWidth(c.lineWidth),a.lineWidth=c.lineWidth),this._uPointSize&&this._uPointSize.setValue(c.pointSize),c.ambientMap&&c.ambientMap.texture&&(b.bindTexture(this._uAmbientMap,c.ambientMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uAmbientMapMatrix&&this._uAmbientMapMatrix.setValue(c.ambientMap.matrix)),c.diffuseMap&&c.diffuseMap.texture&&(b.bindTexture(this._uDiffuseMap,c.diffuseMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uDiffuseMapMatrix&&this._uDiffuseMapMatrix.setValue(c.diffuseMap.matrix)),c.specularMap&&c.specularMap.texture&&(b.bindTexture(this._uSpecularMap,c.specularMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uSpecularMapMatrix&&this._uSpecularMapMatrix.setValue(c.specularMap.matrix)),c.emissiveMap&&c.emissiveMap.texture&&(b.bindTexture(this._uEmissiveMap,c.emissiveMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uEmissiveMapMatrix&&this._uEmissiveMapMatrix.setValue(c.emissiveMap.matrix)),c.opacityMap&&c.opacityMap.texture&&(b.bindTexture(this._uOpacityMap,c.opacityMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uOpacityMapMatrix&&this._uOpacityMapMatrix.setValue(c.opacityMap.matrix)),c.reflectivityMap&&c.reflectivityMap.texture&&(b.bindTexture(this._uReflectivityMap,c.reflectivityMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),this._uReflectivityMapMatrix&&this._uReflectivityMapMatrix.setValue(c.reflectivityMap.matrix)),c.bumpMap&&c.bumpMap.texture&&(b.bindTexture(this._uBumpMap,c.normalMap.texture,a.textureUnit<8?a.textureUnit++:a.textureUnit=0),a.bindTexture++,this._uBumpMapMatrix&&this._uBumpMapMatrix.setValue(c.normalMap.matrix)),c.diffuseFresnel&&(this._uDiffuseFresnelBias&&this._uDiffuseFresnelBias.setValue(c.diffuseFresnel.bias),this._uDiffuseFresnelPower&&this._uDiffuseFresnelPower.setValue(c.diffuseFresnel.power),this._uDiffuseFresnelLeftColor&&this._uDiffuseFresnelLeftColor.setValue(c.diffuseFresnel.leftColor),this._uDiffuseFresnelRightColor&&this._uDiffuseFresnelRightColor.setValue(c.diffuseFresnel.rightColor)),c.specularFresnel&&(this._uSpecularFresnelBias&&this._uSpecularFresnelBias.setValue(c.specularFresnel.bias),this._uSpecularFresnelPower&&this._uSpecularFresnelPower.setValue(c.specularFresnel.power),this._uSpecularFresnelLeftColor&&this._uSpecularFresnelLeftColor.setValue(c.specularFresnel.leftColor),this._uSpecularFresnelRightColor&&this._uSpecularFresnelRightColor.setValue(c.specularFresnel.rightColor)),c.opacityFresnel&&(this._uOpacityFresnelBias&&this._uOpacityFresnelBias.setValue(c.opacityFresnel.bias),this._uOpacityFresnelPower&&this._uOpacityFresnelPower.setValue(c.opacityFresnel.power),this._uOpacityFresnelLeftColor&&this._uOpacityFresnelLeftColor.setValue(c.opacityFresnel.leftColor),this._uOpacityFresnelRightColor&&this._uOpacityFresnelRightColor.setValue(c.opacityFresnel.rightColor)),c.reflectivityFresnel&&(this._uReflectivityFresnelBias&&this._uReflectivityFresnelBias.setValue(c.reflectivityFresnel.bias),this._uReflectivityFresnelPower&&this._uReflectivityFresnelPower.setValue(c.reflectivityFresnel.power),this._uReflectivityFresnelLeftColor&&this._uReflectivityFresnelLeftColor.setValue(c.reflectivityFresnel.leftColor),this._uReflectivityFresnelRightColor&&this._uReflectivityFresnelRightColor.setValue(c.reflectivityFresnel.rightColor)),c.emissiveFresnel&&(this._uEmissiveFresnelBias&&this._uEmissiveFresnelBias.setValue(c.emissiveFresnel.bias),this._uEmissiveFresnelPower&&this._uEmissiveFresnelPower.setValue(c.emissiveFresnel.power),this._uEmissiveFresnelLeftColor&&this._uEmissiveFresnelLeftColor.setValue(c.emissiveFresnel.leftColor),this._uEmissiveFresnelRightColor&&this._uEmissiveFresnelRightColor.setValue(c.emissiveFresnel.rightColor))}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"program",build:function(){},draw:function(a){this.program.draw.bind(),a.useProgram++},pickObject:function(){this.program.pickObject.bind()},pickPrimitive:function(){this.program.pickPrimitive.bind()}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"projTransform",build:function(){this._uProjMatrixDraw=this.program.draw.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickObject=this.program.pickObject.getUniform("xeo_uProjMatrix"),this._uProjMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uProjMatrix")},draw:function(){this._uProjMatrixDraw&&this._uProjMatrixDraw.setValue(this.state.matrix)},pickObject:function(){this._uProjMatrixPickObject&&this._uProjMatrixPickObject.setValue(this.state.matrix)},pickPrimitive:function(){this._uProjMatrixPickPrimitive&&this._uProjMatrixPickPrimitive.setValue(this.state.matrix)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"renderTarget",programGlobal:!0,draw:function(a){var b=this.program.gl,c=this.state;a.renderBuf&&(b.flush(),a.renderBuf.unbind(),a.renderBuf=null);var d=c.renderBuf;return d?(d.bind(),a.depthMode=c.type===c.DEPTH,a.blendEnabled&&!a.depthMode&&(b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA)),b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),b.clearColor(a.ambientColor[0],a.ambientColor[1],a.ambientColor[2],1),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT),void(a.renderBuf=d)):void(a.depthMode=!1)}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"shader",draw:function(){var a=this.state.params;if(a){var b,c=this.program.draw;for(b in a)a.hasOwnProperty(b)&&c.setUniform(b,a[b])}}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"shaderParams",draw:function(a){var b=this.state.params;if(b){var c,d=this.program.draw;for(c in b)b.hasOwnProperty(c)&&d.setUniform(c,b[c])}}})}(),function(){"use strict";XEO.renderer.ChunkFactory.createChunkType({type:"viewTransform",build:function(){this._uViewMatrixDraw=this.program.draw.getUniform("xeo_uViewMatrix"),this._uViewNormalMatrixDraw=this.program.draw.getUniform("xeo_uViewNormalMatrix"),this._uViewMatrixPickObject=this.program.pickObject.getUniform("xeo_uViewMatrix"),this._uViewMatrixPickPrimitive=this.program.pickPrimitive.getUniform("xeo_uViewMatrix")},draw:function(){this._uViewMatrixDraw&&this._uViewMatrixDraw.setValue(this.state.matrix),this._uViewNormalMatrixDraw&&this._uViewNormalMatrixDraw.setValue(this.state.normalMatrix)},pickObject:function(){this._uViewMatrixPickObject&&this._uViewMatrixPickObject.setValue(this.state.matrix)},pickPrimitive:function(){this._uViewMatrixPickPrimitive&&this._uViewMatrixPickPrimitive.setValue(this.state.matrix)}})}(),function(){"use strict";XEO.Task=XEO.Component.extend({type:"XEO.Task",serializable:!1,_init:function(a){this.description=a.description||"",this.failed=!1,this.completed=!1},setCompleted:function(){this.fire("completed",this.completed=!0)},setFailed:function(){this.fire("failed",this.failed=!0)},_destroy:function(){!this.completed&&this.destroyed&&this.setCompleted()}})}(),function(){"use strict";XEO.Tasks=XEO.Component.extend({type:"XEO.Tasks",serializable:!1,_init:function(a){this._idMap=new XEO.utils.Map,this.tasks={}},create:function(a){if(a=a||{},a.id){if(this.tasks[a.id])return this.error("Task "+XEO._inQuotes(a.id)+"already exists"),null}else a.id=this._idMap.addItem({});var b=new XEO.Task(this,a);this.tasks[a.id]=b;var c=this;return b.on("completed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("completed",b,!0)}),b.on("failed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("failed",b,!0)}),c.fire("started",b,!0),b},setCompleted:function(a){var b=this.tasks[a];return b?void b.fire("completed",b,!0):void this.error("Task not found:"+XEO._inQuotes(a))},setFailed:function(a){var b=this.tasks[a];return b?void b.fire("failed",b,!0):void this.error("Task not found:"+XEO._inQuotes(a))},clear:function(){for(var a in this.tasks)this.tasks.hasOwnProperty(a)&&this.tasks[a].setCompleted()}})}(),function(){"use strict";XEO.Boundary2D=XEO.Component.extend({type:"XEO.Boundary2D",_init:function(a){this._div=null,this._shown=!1,this._obb=null,this._aabb=a.aabb||null,this._center=a.center||null,this._getDirty=a.getDirty,this._getOBB=a.getOBB,this._getMatrix=a.getMatrix,this.shown=a.shown},_props:{aabb:{get:function(){return this._getDirty()&&this._build(),this._aabb}},center:{get:function(){return this._getDirty()&&this._build(),this._center}},shown:{set:function(a){if(a!==this._shown){if(a){if(!this._div){var b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.position="absolute",d.padding="10px",d.margin="0",d.background="green",d.opacity=.4,d.border="1px black solid",d["z-index"]="1000",b.appendChild(c);var e=this;this.on("updated",function(){var a=e.aabb;c.style.left=a.xmin+"px",c.style.top=a.ymin+"px",c.style.width=a.xmax-a.xmin+"px",c.style.height=a.ymax-a.ymin+"px"}),this._div=c}}else this._div&&(this._div.parentNode.removeChild(this._div),this._div=null);this._shown=a,this.fire("shown",this._shown)}},get:function(){return this._shown}}},_build:function(){var a=XEO.math,b=this.scene.canvas.canvas,c=b.width,d=b.height;this._obb||(this._obb=[],this._aabb={xmin:0,ymin:0,xmax:0,ymax:0},this._center=[0,0]);var e=this._getOBB(),f=this._getMatrix();e&&f&&(a.transformPoints3(f,e,this._obb),a.points3ToAABB2(this._obb,this._aabb),a.AABB2ToCanvas(this._aabb,c,d),a.getAABB2Center(this._aabb,this._center))},_getJSON:function(){return{aabb:this.aabb,center:this.center}}})}(),function(){"use strict";XEO.Boundary3D=XEO.Component.extend({type:"XEO.Boundary3D",_init:function(a){this._obb=a.obb||null,this._aabb=a.aabb||null,this._center=a.center||null,this._getDirty=a.getDirty,this._getOBB=a.getOBB,this._getAABB=a.getAABB,this._getMatrix=a.getMatrix,this._getPositions=a.getPositions},_props:{obb:{get:function(){return this._getDirty()&&this._build(),this._obb}},aabb:{get:function(){return this._getDirty()&&this._build(),this._aabb}},center:{get:function(){return this._getDirty()&&this._build(),this._center}}},_build:function(){var a=XEO.math;this._obb||(this._obb=[]),this._aabb||(this._aabb={xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0}),this._center||(this._center=[0,0,0]);var b=this._getAABB?this._getAABB():null;if(b)return this._aabb.xmin=b.xmin,this._aabb.ymin=b.ymin,this._aabb.zmin=b.zmin,this._aabb.xmax=b.xmax,this._aabb.ymax=b.ymax,this._aabb.zmax=b.zmax,a.AABB3ToOBB3(this._aabb,this._obb),void a.getAABBCenter(this._aabb,this._center);var c,d=this._getPositions?this._getPositions():null;if(d)return(c=this._getMatrix?this._getMatrix():null)?(a.positions3ToAABB3(d,this._aabb),a.AABB3ToOBB3(this._aabb,this._obb),this._obb=a.transformPoints3(c,this._obb),a.points3ToAABB3(this._obb,this._aabb),void a.getAABBCenter(this._aabb,this._center)):(a.positions3ToAABB3(d,this._aabb),a.AABB3ToOBB3(this._aabb,this._obb),void a.getAABBCenter(this._aabb,this._center));var e=this._getOBB?this._getOBB():null;if(e){if(c=this._getMatrix?this._getMatrix():null)return a.transformPoints3(c,e,this._obb),a.points3ToAABB3(this._obb,this._aabb),void a.getAABBCenter(this._aabb,this._center);for(var f=0,g=e.length;g>f;f++)this._obb[f]=e[f];a.points3ToAABB3(this._obb,this._aabb),a.getAABBCenter(this._aabb,this._center)}},_getJSON:function(){return{obb:this.obb,aabb:this.aabb,center:this.center}}})}(),function(){"use strict";XEO.Transform=XEO.Component.extend({type:"XEO.Transform",_init:function(a){this._leafMatrixDirty=!1,this._onParentUpdated=null,this._onParentDestroyed=null,this._state=new XEO.renderer.ModelTransform({matrix:null,normalMatrix:null}),this.parent=a.parent,this.matrix=a.matrix},_props:{parent:{set:function(a){!this._parent||a&&a.id===this._parent.id||(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed)),this._parent=a,this.fire("parent",this._parent);var b=this,c=function(){b._leafMatrixDirty=!0,b.fire("updated",!0)};this._parent&&(this._onParentUpdated=this._parent.on("updated",c),this._onParentDestroyed=this._parent.on("destroyed",c)),c()},get:function(){return this._parent}},matrix:{set:function(a){a=a||XEO.math.identityMat4(),this._matrix?this._matrix.set(a):this._matrix=XEO.math.identityMat4(),this._leafMatrixDirty=!0,this.fire("matrix",this._matrix),this.fire("updated",!0)},get:function(){return this._matrix}},leafMatrix:{get:function(){return this._leafMatrixDirty&&this._buildLeafMatrix(),this._state.matrix}}},_compile:function(){this._renderer.modelTransform=this._state},_buildLeafMatrix:function(){if(this._leafMatrixDirty){if(this._state.matrix=this._state.matrix||XEO.math.identityMat4(),this._parent)XEO.math.mulMat4(this._parent.leafMatrix,this._matrix,this._state.matrix);else for(var a=this._matrix,b=this._state.matrix,c=0,d=a.length;d>c;c++)b[c]=a[c];this._state.normalMatrix||(this._state.normalMatrix=XEO.math.identityMat4()),XEO.math.inverseMat4(this._state.matrix,this._state.normalMatrix),XEO.math.transposeMat4(this._state.normalMatrix),this._renderer.imageDirty=!0,this._leafMatrixDirty=!1}},_getJSON:function(){return{matrix:Array.prototype.slice.call(this._matrix)}},_destroy:function(){this._parent&&(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed))}})}(),function(){"use strict";XEO.Rotate=XEO.Transform.extend({type:"XEO.Rotate",_init:function(a){this._super(a),this.xyz=a.xyz,this.angle=a.angle},_props:{xyz:{set:function(a){if(a=a||[0,1,0],this._xyz){if(this._xyz[0]===a[0]&&this._xyz[1]===a[1]&&this._xyz[2]===a[2])return;this._xyz[0]=a[0],this._xyz[1]=a[1],this._xyz[2]=a[2]}else this._xyz=a;this.fire("xyz",this._xyz),this._update()},get:function(){return this._xyz}},angle:{set:function(a){this._angle=a||0,this.fire("angle",this._angle),this._update()},get:function(){return this._angle}}},_update:function(){null!==this._xyz&&null!==this._angle&&(this.matrix=XEO.math.rotationMat4v(this._angle*XEO.math.DEGTORAD,this._xyz,this._matrix||(this._matrix=XEO.math.identityMat4())))},_getJSON:function(){return{xyz:this._xyz,angle:this._angle}}})}(),function(){"use strict";XEO.Quaternion=XEO.Transform.extend({type:"XEO.Quaternion",_init:function(a){this._super(a),this.xyzw=a.xyzw},_props:{xyzw:{set:function(a){this._xyzw=a||[0,0,0,1],this.fire("xyzw",this._xyzw)},get:function(){return this._xyz}}},rotate:function(a){},_getJSON:function(){return{xyzw:this.xyzw}}})}(),function(){"use strict";XEO.Scale=XEO.Transform.extend({type:"XEO.Scale",_init:function(a){this._super(a),this.xyz=a.xyz},_props:{xyz:{set:function(a){if(a=a||[1,1,1],this._xyz){if(this._xyz[0]===a[0]&&this._xyz[1]===a[1]&&this._xyz[2]===a[2])return;this._xyz[0]=a[0],this._xyz[1]=a[1],this._xyz[2]=a[2]}else this._xyz=a;this.matrix=XEO.math.scalingMat4v(this._xyz,this._matrix||(this._matrix=XEO.math.identityMat4())),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){return{xyz:this.xyz}}})}(),function(){"use strict";XEO.Translate=XEO.Transform.extend({type:"XEO.Translate",_init:function(a){this._super(a),this.xyz=a.xyz},_props:{xyz:{set:function(a){if(a=a||[0,0,0],this._xyz){if(this._xyz[0]===a[0]&&this._xyz[1]===a[1]&&this._xyz[2]===a[2])return;this._xyz[0]=a[0],this._xyz[1]=a[1],this._xyz[2]=a[2]}else this._xyz=a;this.matrix=XEO.math.translationMat4v(this._xyz,this._matrix||(this._matrix=XEO.math.identityMat4())),this.fire("xyz",this._xyz)},get:function(){return this._xyz}}},_getJSON:function(){return{xyz:this.xyz}}})}(),function(){"use strict";XEO.Billboard=XEO.Transform.extend({type:"XEO.Billboard",_init:function(a){this._super(a),this._state=new XEO.renderer.Billboard({active:!0,spherical:!0,hash:"a;s;"}),this.active=a.active!==!1,this.spherical=a.spherical!==!1},_props:{active:{set:function(a){a=!!a,this._state.active!==a&&(this._state.active=a,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("active",this._state.active))},get:function(){return this._state.active}},spherical:{set:function(a){a=!!a,this._state.spherical!==a&&(this._state.spherical=a,this._state.hash=(this._state.active?"a;":";")+(this._state.spherical?"s;":";"),this.fire("dirty",!0),this.fire("spherical",this._state.spherical))},get:function(){return this._state.spherical}}},_compile:function(){this._renderer.billboard=this._state},_getJSON:function(){return{active:this._state.active}}})}(),function(){"use strict";var a=XEO.math.vec3(),b=XEO.math.vec3(),c=XEO.math.vec3();XEO.CameraFlight=XEO.Component.extend({type:"XEO.CameraFlight",_init:function(a){this._look1=XEO.math.vec3(),this._eye1=XEO.math.vec3(),this._up1=XEO.math.vec3(),this._look2=XEO.math.vec3(),this._eye2=XEO.math.vec3(),this._up2=XEO.math.vec3(),this._flying=!1,this._ok=null,this._onTick=null,this._stopFOV=55,this._time1=null,this._time2=null,this.easing=a.easing!==!1,this.duration=a.duration||.5,this.camera=a.camera},flyTo:function(b,c){this._flying&&this.stop();var d=this._children.camera;if(!d)return void(c&&c());this._flying=!1,this._ok=c;var e=d.view;this._eye1[0]=e.eye[0],this._eye1[1]=e.eye[1],this._eye1[2]=e.eye[2],this._look1[0]=e.look[0],this._look1[1]=e.look[1],this._look1[2]=e.look[2],this._up1[0]=e.up[0],this._up1[1]=e.up[1],this._up1[2]=e.up[2];var f,g,h,i;if(l=b.worldBoundary)f=l.aabb;else if(f=b.aabb);else if(void 0!=b.xmin&&void 0!=b.ymin&&void 0!=b.zmin&&void 0!=b.xmax&&void 0!=b.ymax&&void 0!=b.zmax)f=b;else if(b.eye||b.look||b.up)g=b.eye,h=b.look,i=b.up;else{var j=b;if(XEO._isNumeric(j)||XEO._isString(j)){var k=j;if(j=this.scene.components[k],!j)return this.error("Component not found: "+XEO._inQuotes(k)),void(c&&c())}var l=j.worldBoundary;if(!l)return this.error("Can't fly to component "+XEO._inQuotes(k)+" - does not have a worldBoundary"),void(c&&c());f=l.aabb}var m=b.offset;if(f){if(f.xmax<=f.xmin||f.ymax<=f.ymin||f.zmax<=f.zmin)return;this._look2=XEO.math.getAABBCenter(f),m&&(this._look2[0]+=m[0],this._look2[1]+=m[1],this._look2[2]+=m[2]);var n=XEO.math.normalizeVec3(XEO.math.subVec3(this._eye1,this._look1,a)),o=XEO.math.getAABBDiag(f),p=Math.abs(o/Math.tan(this._stopFOV/2));this._eye2[0]=this._look2[0]+n[0]*p,this._eye2[1]=this._look2[1]+n[1]*p,this._eye2[2]=this._look2[2]+n[2]*p,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2]}else(g||h||i)&&(h=h||this._look1,g=g||this._eye1,i=i||this._up1,this._look2[0]=h[0],this._look2[1]=h[1],this._look2[2]=h[2],this._eye2[0]=g[0],this._eye2[1]=g[1],this._eye2[2]=g[2],this._up2[0]=i[0],this._up2[1]=i[1],this._up2[2]=i[2]);this.fire("started",b,!0);var q=this;this._time1=(new Date).getTime(),this._time2=this._time1+this._duration,this._flying=!0,this._tick=this.scene.on("tick",function(a){q._update(a)})},_update:function(d){if(this._flying){var e=d.time,f=(e-this._time1)/(this._time2-this._time1),g=f>=1;f>1&&(f=1),f=this.easing?this._ease(f,0,1,1):f;var h=this._children.camera.view;h.eye=XEO.math.lerpVec3(f,0,1,this._eye1,this._eye2,a),h.look=XEO.math.lerpVec3(f,0,1,this._look1,this._look2,b),h.up=XEO.math.lerpVec3(f,0,1,this._up1,this._up2,c),g&&this.stop()}},_ease:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},stop:function(){if(this._flying){this.scene.off(this._tick),this._flying=!1,this._time1=null,this._time2=null;var a=this._ok;a&&(this._ok=null,a()),this.fire("stopped",!0,!0)}},_props:{camera:{set:function(a){this._setChild("camera",a),this.stop()},get:function(){return this._children.camera}},duration:{set:function(a){this._duration=1e3*a,this.stop()},get:function(){return this._duration/1e3}}},_getJSON:function(){var a={};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.stop()}})}(),function(){"use strict";XEO.CameraPath=XEO.Component.extend({type:"XEO.CameraPath",_init:function(a){this.camera=a.camera,this.path=a.path},_props:{camera:{set:function(a){this._setChild("camera",a),this._update()},get:function(){return this._children.camera}},path:{set:function(a){var b=this._children.path;!b||a&&(void 0!==a.id?a.id:a)===b.id||b.off(this._onPathT),this._setChild("path",a);var c=this._children.path;if(c){var d=this;this._onPathT=c.on("t",function(){d._update()})}},get:function(){return this._children.path}}},_update:function(){var a=this._children.camera,b=this._children.path;if(a&&b){var c=b.point,d=b.tangent,e=a.view;e.eye=c,e.look=[c[0]+d[0],c[1]+d[1],c[2]+d[2]]}},_getJSON:function(){var a={};return this._children.camera&&(a.camera=this._children.camera.id),this._children.path&&(a.path=this._children.path.id),a},_destroy:function(){this._children.path&&this._children.path.off(this._onPathT)}})}(),function(){"use strict";XEO.Curve=XEO.Component.extend({type:"XEO.Curve",_init:function(a){this.t=a.t},_props:{t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},tangent:{get:function(){return this.getTangent(this._t)}},length:{get:function(){var a=this._getLengths();return a[a.length-1]}}},getTangent:function(a){var b=1e-4,c=this._t-b,d=this._t+b;0>c&&(c=0),d>1&&(d=1);var e=this.getPoint(c),f=this.getPoint(d),g=XEO.math.subVec3(f,e,[]);return XEO.math.normalizeVec3(g,[])},_getPointAt:function(a){var b=this._getUToTMapping(a);return this.getPoint(b)},getPoints:function(a){a||(a=5);var b,c=[];for(b=0;a>=b;b++)c.push(this.getPoint(b/a));return c},getSpacedPoints:function(a){a||(a=5);var b,c=[];for(b=0;a>=b;b++)c.push(this._getPointAt(b/a));return c},_getLengths:function(a){if(a||(a=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length==a+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var b,c,d=[],e=this.getPoint(0),f=0;for(d.push(0),c=1;a>=c;c++)b=this.getPoint(c/a),f+=XEO.math.lenVec3(XEO.math.subVec3(b,e,[])),d.push(f),e=b;return this.cacheArcLengths=d,d},_updateArcLengths:function(){this.needsUpdate=!0,this._getLengths()},_getUToTMapping:function(a,b){var c,d=this._getLengths(),e=0,f=d.length;c=b?b:a*d[f-1];for(var g,h=0,i=f-1;i>=h;)if(e=Math.floor(h+(i-h)/2),g=d[e]-c,0>g)h=e+1;else{if(!(g>0)){i=e;break}i=e-1}if(e=i,d[e]==c){var j=e/(f-1);return j}var k=d[e],l=d[e+1],m=l-k,n=(c-k)/m,j=(e+n)/(f-1);return j}})}(),function(){"use strict";XEO.CubicBezierCurve=XEO.Curve.extend({type:"XEO.CubicBezierCurve",_init:function(a){this._super(a),this.v0=a.v0,this.v1=a.v1,this.v2=a.v2,this.v3=a.v3,this.t=a.t},_props:{v0:{set:function(a){this.fire("v0",this._v0=a||[0,0,0])},get:function(){return this._v0}},v1:{set:function(a){this.fire("v1",this._v1=a||[0,0,0])},get:function(){return this._v1}},v2:{set:function(a){this.fire("v2",this._v2=a||[0,0,0])},get:function(){return this._v2}},v3:{set:function(a){this.fire("v3",this._v3=a||[0,0,0])},get:function(){return this._v3}},t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},point:{get:function(){return this.getPoint(this._t)}}},getPoint:function(a){var b=XEO.math,c=b.vec3();return c[0]=b.b3(a,this._v0[0],this._v1[0],this._v2[0],this._v3[0]),c[1]=b.b3(a,this._v0[1],this._v1[1],this._v2[1],this._v3[1]),c[2]=b.b3(a,this._v0[2],this._v1[2],this._v2[2],this._v3[2]),c},_getJSON:function(){return{v0:this._v0,v1:this._v1,v2:this._v2,v3:this._v3,t:this._t}}})}(),function(){"use strict";XEO.SplineCurve=XEO.Curve.extend({type:"XEO.SplineCurve",_init:function(a){this._super(a),this.points=a.points,this.t=a.t},_props:{points:{set:function(a){this._points=a||[],this.fire("points",this._points)},get:function(){return this._points}},t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},point:{get:function(){return this.getPoint(this._t)}}},getPoint:function(a){var b=XEO.math,c=this.points,d=(c.length-1)*a,e=Math.floor(d),f=d-e,g=c[0==e?e:e-1],h=c[e],i=c[e>c.length-2?c.length-1:e+1],j=c[e>c.length-3?c.length-1:e+2],k=b.vec3();return k[0]=b.catmullRomInterpolate(g[0],h[0],i[0],j[0],f),k[1]=b.catmullRomInterpolate(g[1],h[1],i[1],j[1],f),k[2]=b.catmullRomInterpolate(g[2],h[2],i[2],j[2],f),k},_getJSON:function(){return{v0:this._v0,v1:this._v1,v2:this._v2,v3:this._v3,t:this._t}}})}(),function(){"use strict";XEO.QuadraticBezierCurve=XEO.Curve.extend({type:"XEO.QuadraticBezierCurve",_init:function(a){this._super(a),this.v0=a.v0,this.v1=a.v1,this.v2=a.v2,this.t=a.t},_props:{v0:{set:function(a){this.fire("v0",this._v0=a||[0,0,0])},get:function(){return this._v0}},v1:{set:function(a){this.fire("v1",this._v1=a||[0,0,0])},get:function(){return this._v1}},v2:{set:function(a){this.fire("v2",this._v2=a||[0,0,0])},get:function(){return this._v2}},t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},point:{get:function(){return this.getPoint(this._t)}}},getPoint:function(a){var b=XEO.math,c=b.vec3();return c[0]=b.b2(a,this._v0[0],this._v1[0],this._v2[0]),c[1]=b.b2(a,this._v0[1],this._v1[1],this._v2[1]),c[2]=b.b2(a,this._v0[2],this._v1[2],this._v2[2]),c},_getJSON:function(){return{v0:this._v0,v1:this._v1,v2:this._v2,t:this._t}}})}(),function(){"use strict";XEO.Path=XEO.Curve.extend({type:"XEO.Path",_init:function(a){this._super(a),this._cachedLengths=[],this._dirty=!0,this._curves=[],this._t=0,this._dirtySubs=[],this._destroyedSubs=[],this.curves=a.curves||[],this.t=a.t},addCurve:function(a){this._curves.push(a),this._dirty=!0,this.fire("curves",this._curves)},_props:{curves:{set:function(a){function b(){g._dirty=!0}function c(){var a=this.id;for(e=0,f=g._curves.length;f>e;e++)if(g._curves[e].id===a)return g._curves=g._curves.slice(e,e+1),g._dirtySubs=g._dirtySubs.slice(e,e+1),g._destroyedSubs=g._destroyedSubs.slice(e,e+1),g._dirty=!0,void g.fire("curves",g._curves)}a=a||[];var d,e,f;for(e=0,f=this._curves.length;f>e;e++)d=this._curves[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._curves=[],this._dirtySubs=[],this._destroyedSubs=[];var g=this;for(e=0,f=a.length;f>e;e++){if(d=a[e],XEO._isNumeric(d)||XEO._isString(d)){var h=d;if(d=this.scene.components[h],!d){this.error("Component not found: "+XEO._inQuotes(h));continue}}var i=d.type;"XEO.SplineCurve"===i||"XEO.Path"==i||"XEO.CubicBezierCurve"==i||"XEO.QuadraticBezierCurve"==i?(this._curves.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+XEO._inQuotes(d.id)+" is not a XEO.SplineCurve, XEO.Path or XEO.QuadraticBezierCurve")}this._dirty=!0,this.fire("curves",this._curves)},get:function(){return this._curves}},t:{set:function(a){a=a||0,this._t=0>a?0:a>1?1:a,this.fire("t",this._t)},get:function(){return this._t}},point:{get:function(){return this.getPoint(this._t)}},length:{get:function(){var a=this._getCurveLengths();return a[a.length-1]}}},getPoint:function(a){for(var b,c,d=a*this.length,e=this._getCurveLengths(),f=0;f<e.length;){if(e[f]>=d){b=e[f]-d,c=this._curves[f];var g=1-b/c.length;return c._getPointAt(g)}f++}return null},_getCurveLengths:function(){if(!this._dirty)return this._cachedLengths;var a,b=[],c=0,d=this._curves.length;for(a=0;d>a;a++)c+=this._curves[a].length,b.push(c);return this._cachedLengths=b,this._dirty=!1,b},_getJSON:function(){for(var a=[],b=0,c=this._curves.length;c>b;b++)a.push(this._curves[b].id);return{curves:a,t:this._t}},_destroy:function(){var a,b,c;for(a=0,b=this._curves.length;b>a;a++)c=this._curves[a],c.off(this._dirtySubs[a]),c.off(this._destroyedSubs[a]);this._super();
}})}(),function(){"use strict";XEO.BoundaryGeometry=XEO.Geometry.extend({type:"XEO.BoundaryGeometry",_init:function(a){this._super(a),this.primitive=a.primitive||"lines",this.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],a.boundary?this.boundary=a.boundary:a.obb?this.obb=a.obb:a.aabb?this.aabb=a.aabb:a.positions?this.positions=a.positions:this.positions=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]},_props:{boundary:{set:function(a){var b=this._children.boundary;b&&(a&&(void 0!==a.id?a.id:a)===b.id||(b.off(this._onBoundaryUpdated),b.off(this._onBoundaryDestroyed))),this._setChild("boundary",a);var c=this._children.boundary;if(c){var d=this;this._onBoundaryUpdated=c.on("updated",function(){d._setPositionsFromOBB(c.obb)}),this._onBoundaryDestroyed=c.on("destroyed",function(){d.boundary=null})}},get:function(){return this._children.boundary}},obb:{set:function(a){a&&(this._children.boundary&&(this.boundary=null),this._setPositionsFromOBB(a))}},aabb:{set:function(a){a&&(this._children.boundary&&(this.boundary=null),this._setPositionsFromAABB(a))}}},_setPositionsFromOBB:function(a){this.positions=[a[2][0],a[2][1],a[4][2],a[2][0],a[4][1],a[4][2],a[0][0],a[4][1],a[4][2],a[0][0],a[2][1],a[4][2],a[2][0],a[2][1],a[3][2],a[2][0],a[4][1],a[3][2],a[0][0],a[4][1],a[3][2],a[0][0],a[2][1],a[3][2]]},_setPositionsFromAABB:function(a){this.positions=[a.xmax,a.ymax,a.zmax,a.xmax,a.ymin,a.zmax,a.xmin,a.ymin,a.zmax,a.xmin,a.ymax,a.zmax,a.xmax,a.ymax,a.zmin,a.xmax,a.ymin,a.zmin,a.xmin,a.ymin,a.zmin,a.xmin,a.ymax,a.zmin]},_getJSON:function(){var a={};return this._children.boundary?a.boundary=this._children.boundary.id:a.positions&&(a.positions=this.positions),a},_destroy:function(){this._children.boundary&&(this._children.boundary.off(this._onBoundaryUpdated),this._children.boundary.off(this._onBoundaryDestroyed)),this._super()}})}(),function(){"use strict";XEO.TorusGeometry=XEO.Geometry.extend({type:"XEO.TorusGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.radius=a.radius,this.tube=a.tube,this.segmentsR=a.segmentsR,this.segmentsT=a.segmentsT,this.arc=a.arc},_torusDirty:function(){if(!this.__dirty){this.__dirty=!0;var a=this;this.scene.once("tick2",function(){a._buildTorus(),a.__dirty=!1})}},_buildTorus:function(){var a=this._radius,b=this._tube,c=Math.floor(this._segmentsR*this._lod),d=Math.floor(this._segmentsT*this._lod),e=this._arc;4>c&&(c=4),4>d&&(d=4);var f,g,h,i,j,k,l,m,n,o,p=[],q=[],r=[],s=[],t=0;for(o=0;c>=o;o++)for(n=0;d>=n;n++)f=n/d*e,g=o/c*Math.PI*2,h=a*Math.cos(f),i=a*Math.sin(f),j=(a+b*Math.cos(g))*Math.cos(f),k=(a+b*Math.cos(g))*Math.sin(f),l=b*Math.sin(g),p.push(j),p.push(k),p.push(l),r.push(n/d),r.push(1-o/c),m=XEO.math.normalizeVec3(XEO.math.subVec3([j,k,l],[h,i,t],[]),[]),q.push(m[0]),q.push(m[1]),q.push(m[2]);var u,v,w,x;for(o=1;c>=o;o++)for(n=1;d>=n;n++)u=(d+1)*o+n-1,v=(d+1)*(o-1)+n-1,w=(d+1)*(o-1)+n,x=(d+1)*o+n,s.push(u),s.push(v),s.push(w),s.push(w),s.push(x),s.push(u);this.positions=p,this.normals=q,this.uv=r,this.indices=s},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this.fire("lod",this._lod),this._torusDirty())},get:function(){return this._lod}},radius:{set:function(a){a=a||1,this._radius!==a&&(0>a&&(this.warn("negative radius not allowed - will invert"),a=-1*a),this._radius=a,this.fire("radius",this._radius),this._torusDirty())},get:function(){return this._radius}},tube:{set:function(a){a=a||.3,this._tube!==a&&(0>a&&(this.warn("negative tube not allowed - will invert"),a=-1*a),this._tube=a,this.fire("tube",this._tube),this._torusDirty())},get:function(){return this._tube}},segmentsR:{set:function(a){a=a||32,this._segmentsR!==a&&(0>a&&(this.warn("negative segmentsR not allowed - will invert"),a=-1*a),this._segmentsR=a,this.fire("segmentsR",this._segmentsR),this._torusDirty())},get:function(){return this._segmentsR}},segmentsT:{set:function(a){a=a||24,this._segmentsT!==a&&(0>a&&(this.warn("negative segmentsT not allowed - will invert"),a=-1*a),this._segmentsT=a,this.fire("segmentsT",this._segmentsT),this._torusDirty())},get:function(){return this._segmentsT}},arc:{set:function(a){a=a||2*Math.PI,this._arc!==a&&(0>a&&(this.warn("negative arc not allowed - will invert"),a=-1*a),this._arc=a,this.fire("arc",this._arc),this._torusDirty())},get:function(){return this._arc}}},_getJSON:function(){return{radius:this._radius,tube:this._tube,segmentsR:this._segmentsR,segmentsT:this._segmentsT,arc:this._arc}}})}(),function(){"use strict";XEO.SphereGeometry=XEO.Geometry.extend({type:"XEO.SphereGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.radius=a.radius,this.heightSegments=a.heightSegments,this.widthSegments=a.widthSegments},_sphereDirty:function(){if(!this.__dirty){this.__dirty=!0;var a=this;this.scene.once("tick2",function(){a._buildSphere(),a.__dirty=!1})}},_buildSphere:function(){var a=this._radius,b=Math.floor(this._lod*this._heightSegments),c=Math.floor(this._lod*this._widthSegments);18>b&&(b=18),18>c&&(c=18);var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=[],t=[],u=[],v=[];for(d=0;b>=d;d++)for(f=d*Math.PI/b,g=Math.sin(f),h=Math.cos(f),e=0;c>=e;e++)i=2*e*Math.PI/c,j=Math.sin(i),k=Math.cos(i),l=k*g,m=h,n=j*g,o=e/c,p=d/b,t.push(l),t.push(m),t.push(n),u.push(o),u.push(p),s.push(a*l),s.push(a*m),s.push(a*n);for(d=0;b>d;d++)for(e=0;c>e;e++)q=d*(c+1)+e,r=q+c+1,v.push(q+1),v.push(r+1),v.push(r),v.push(q+1),v.push(r),v.push(q);this.positions=s,this.normals=t,this.uv=u,this.indices=v},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this.fire("lod",this._lod),this._sphereDirty())},get:function(){return this._lod}},radius:{set:function(a){a=a||1,this._radius!==a&&(0>a&&(this.warn("negative radius not allowed - will invert"),a=-1*a),this._radius=a,this.fire("radius",this._radius),this._sphereDirty())},get:function(){return this._radius}},heightSegments:{set:function(a){a=a||18,this._heightSegments!==a&&(0>a&&(this.warn("negative heightSegments not allowed - will invert"),a=-1*a),this._heightSegments=a,this.fire("heightSegments",this._heightSegments),this._sphereDirty())},get:function(){return this._heightSegments}},widthSegments:{set:function(a){a=a||24,this._widthSegments!==a&&(0>a&&(this.warn("negative widthSegments not allowed - will invert"),a=-1*a),this._widthSegments=a,this.fire("widthSegments",this._widthSegments),this._sphereDirty())},get:function(){return this._widthSegments}}},_getJSON:function(){return{radius:this._radius,heightSegments:this._heightSegments,widthSegments:this._widthSegments}}})}(),XEO.PathGeometry=XEO.Geometry.extend({type:"XEO.PathGeometry",_init:function(a){this._super(a),this.path=a.path,this.divisions=a.divisions},__scheduleBuild:function(){if(!this.__dirty){this.__dirty=!0;var a=this;this.scene.once("tick2",function(){a.__build(),a.__dirty=!1})}},_props:{path:{set:function(a){var b=this._children.path;!b||a&&(void 0!==a.id?a.id:a)===b.id||b.off(this._onPathCurves),this._setChild("path",a);var c=this._children.path;if(c){var d=this;this._onPathCurves=c.on("curves",function(){d.__scheduleBuild()})}},get:function(){return this._children.path}},divisions:{set:function(a){a=a||6,this._divisions=a,this.fire("divisions",this._divisions),this.__scheduleBuild()},get:function(){return this._divisions}}},__build:function(){var a=this._children.path;if(a){for(var b,c=a.getPoints(this._divisions),d=[],e=0,f=c.length;f>e;e++)b=c[e],d.push(b[0]),d.push(b[1]),d.push(b[2]);for(var g=[],e=0,f=c.length-1;f>e;e++)g.push(e),g.push(e+1);this.primitive="lines",this.positions=d,this.indices=g,this.normals=null,this.uv=null}},_getJSON:function(){var a={divisions:this._divisions};return this._children.path&&(a.path=this._children.path.id),a},_destroy:function(){this._children.path&&this._children.path.off(this._onPathCurves),this._super()}}),function(){"use strict";XEO.CylinderGeometry=XEO.Geometry.extend({type:"XEO.CylinderGeometry",_init:function(a){this._super(a),this.lod=a.lod,this.radiusTop=a.radiusTop,this.radiusBottom=a.radiusBottom,this.height=a.height,this.radialSegments=a.radialSegments,this.heightSegments=a.heightSegments,this.openEnded=a.openEnded},_cylinderDirty:function(){if(!this.__dirty){this.__dirty=!0;var a=this;this.scene.once("tick2",function(){a._buildCylinder(),a.__dirty=!1})}},_buildCylinder:function(){var a=this._radiusTop,b=this._radiusBottom,c=this._height,d=Math.floor(this._radialSegments*this._lod),e=Math.floor(this._heightSegments*this._lod);3>d&&(d=3),1>e&&(e=1);var f,g,h,i,j,k,l,m,n,o,p,q,r=this._openEnded,s=c/2,t=c/e,u=2*Math.PI/d,v=1/d,w=(this._radiusBottom,(a-b)/e),x=[],y=[],z=[],A=[],B=(90-180*Math.atan(c/(b-a))/Math.PI)/90;for(f=0;e>=f;f++)for(j=a-f*w,k=s-f*t,g=0;d>=g;g++)h=Math.sin(g*u),i=Math.cos(g*u),y.push(j*h),y.push(B),y.push(j*i),z.push(1-g*v),z.push(0+1*f/e),x.push(j*h),x.push(k),x.push(j*i);for(f=0;e>f;f++)for(g=0;d>=g;g++)m=f*(d+1)+g,n=m+d,A.push(m),A.push(n),A.push(n+1),A.push(m),A.push(n+1),A.push(m+1);if(!r&&a>0){for(o=x.length/3,y.push(0),y.push(1),y.push(0),z.push(.5),z.push(.5),x.push(0),x.push(s),x.push(0),g=0;d>=g;g++)h=Math.sin(g*u),i=Math.cos(g*u),p=.5*Math.sin(g*u)+.5,q=.5*Math.cos(g*u)+.5,y.push(a*h),y.push(1),y.push(a*i),z.push(p),z.push(q),x.push(a*h),x.push(s),x.push(a*i);for(g=0;d>g;g++)l=o,m=o+1+g,A.push(m),A.push(m+1),A.push(l)}if(!r&&b>0){for(o=x.length/3,y.push(0),y.push(-1),y.push(0),z.push(.5),z.push(.5),x.push(0),x.push(0-s),x.push(0),g=0;d>=g;g++)h=Math.sin(g*u),i=Math.cos(g*u),p=.5*Math.sin(g*u)+.5,q=.5*Math.cos(g*u)+.5,y.push(b*h),y.push(-1),y.push(b*i),z.push(p),z.push(q),x.push(b*h),x.push(0-s),x.push(b*i);for(g=0;d>g;g++)l=o,m=o+1+g,A.push(l),A.push(m+1),A.push(m)}this.positions=x,this.normals=y,this.uv=z,this.indices=A},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this.fire("lod",this._lod),this._cylinderDirty())},get:function(){return this._lod}},radiusTop:{set:function(a){a=void 0!==a?a:1,this._radiusTop!==a&&(0>a&&(this.warn("negative radiusTop not allowed - will invert"),a=-1*a),this._radiusTop=a,this.fire("radiusTop",this._radiusTop),this._cylinderDirty())},get:function(){return this._radiusTop}},radiusBottom:{set:function(a){a=void 0!==a?a:1,this._radiusBottom!==a&&(0>a&&(this.warn("negative radiusBottom not allowed - will invert"),a=-1*a),this._radiusBottom=a,this.fire("radiusBottom",this._radiusBottom),this._cylinderDirty())},get:function(){return this._radiusBottom}},height:{set:function(a){a=a||1,this._height!==a&&(0>a&&(this.warn("negative height not allowed - will invert"),a=-1*a),this._height=a,this.fire("height",this._height),this._cylinderDirty())},get:function(){return this._height}},radialSegments:{set:function(a){a=a||60,this._radialSegments!==a&&(0>a&&(this.warn("negative radialSegments not allowed - will invert"),a=-1*a),this._radialSegments=a,this.fire("radialSegments",this._radialSegments),this._cylinderDirty())},get:function(){return this._radialSegments}},heightSegments:{set:function(a){a=a||1,this._heightSegments!==a&&(0>a&&(this.warn("negative heightSegments not allowed - will invert"),a=-1*a),this._heightSegments=a,this.fire("heightSegments",this._heightSegments),this._cylinderDirty())},get:function(){return this._heightSegments}},openEnded:{set:function(a){a=void 0===a?!1:a,this._openEnded!==a&&(this._openEnded=a,this.fire("openEnded",this._openEnded),this._cylinderDirty())},get:function(){return this._openEnded}}},_getJSON:function(){return{radiusTop:this._radiusTop,radiusBottom:this._radiusBottom,height:this._height,radialSegments:this._radialSegments,heightSegments:this._heightSegments,openEnded:this._openEnded}}})}(),function(){"use strict";XEO.PlaneGeometry=XEO.Geometry.extend({type:"XEO.PlaneGeometry",_init:function(a){this._super(a),this.xSize=a.xSize,this.ySize=a.ySize,this.xSegments=a.xSegments,this.ySegments=a.ySegments,this.lod=a.lod,this.autoNormals=a.autoNormals!==!1},_setPlaneDirty:function(){if(!this._planeDirty){this._planeDirty=!0;var a=this;this.scene.once("tick2",function(){a._buildPlane(),a._planeDirty=!1})}},_buildPlane:function(){var a=this._xSize,b=this._ySize,c=Math.floor(this._lod*this._xSegments),d=Math.floor(this._lod*this._ySegments);4>d&&(d=4),4>d&&(d=4);for(var e=a/2,f=b/2,g=Math.floor(c)||1,h=Math.floor(d)||1,i=g+1,j=h+1,k=a/g,l=b/h,m=new Float32Array(i*j*3),n=new Float32Array(i*j*3),o=new Float32Array(i*j*2),p=0,q=0,r=0;j>r;r++)for(var s=r*l-f,t=0;i>t;t++){var u=t*k-e;m[p]=u,m[p+1]=-s,n[p+2]=-1,o[q]=(g-t)/g,o[q+1]=1-(h-r)/h,p+=3,q+=2}p=0;for(var v=new(m.length/3>65535?Uint32Array:Uint16Array)(g*h*6),r=0;h>r;r++)for(var t=0;g>t;t++){var w=t+i*r,x=t+i*(r+1),y=t+1+i*(r+1),z=t+1+i*r;v[p]=z,v[p+1]=x,v[p+2]=w,v[p+3]=z,v[p+4]=y,v[p+5]=x,p+=6}this.positions=m,this.normals=n,this.uv=o,this.indices=v},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this._setPlaneDirty(),this.fire("lod",this._lod))},get:function(){return this._lod}},xSize:{set:function(a){a=a||1,this._xSize!==a&&(0>a&&(this.warn("negative xSize not allowed - will invert"),a=-1*a),this._xSize=a,this._setPlaneDirty(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},ySize:{set:function(a){a=a||1,this._ySize!==a&&(0>a&&(this.warn("negative ySize not allowed - will invert"),a=-1*a),this._ySize=a,this._setPlaneDirty(),this.fire("ySize",this._ySize))},get:function(){return this._ySize}},xSegments:{set:function(a){a=a||4,this._xSegments!==a&&(0>a&&(this.warn("negative xSegments not allowed - will invert"),a=-1*a),this._xSegments=a,this._setPlaneDirty(),this.fire("xSegments",this._xSegments))},get:function(){return this._xSegments}},ySegments:{set:function(a){a=a||4,this._ySegments!==a&&(0>a&&(this.warn("negative ySegments not allowed - will invert"),a=-1*a),this._ySegments=a,this._setPlaneDirty(),this.fire("ySegments",this._ySegments))},get:function(){return this._ySegments}}},_getJSON:function(){return{xSize:this._xSize,ySize:this._ySize,xSegments:this._xSegments,ySegments:this._ySegments}}})}(),function(){"use strict";XEO.HeightmapGeometry=XEO.Geometry.extend({type:"XEO.HeightmapGeometry",_init:function(a){this._super(a),this._image=null,this._imageData=null,this._srcDirty=!1,this._imageDirty=!1,this._geometryDirty=!1,a.src?this.src=a.src:a.image&&(this.image=a.image),this.xSize=a.xSize,this.ySize=a.ySize,this.zSize=a.zSize,this.xSegments=a.xSegments,this.ySegments=a.ySegments,this.lod=a.lod,this.autoNormals=a.autoNormals!==!1},_setHeightmapDirty:function(){if(!this._heightmapDirty){this._heightmapDirty=!0;var a=this;this.scene.once("tick2",function(){a._buildHeightmap(),a._heightmapDirty=!1})}},_buildHeightmap:function(){if(this._srcDirty&&this._src)return this._loadSrc(this._src),this._srcDirty=!1,void(this._imageDirty=!0);if(this._imageDirty){if(!this._image)return;var a=window.document.createElement("canvas");a.width=this._image.width,a.height=this._image.height;var b=a.getContext("2d");b.drawImage(this._image,0,0),this._imageData=b.getImageData(0,0,this._image.width,this._image.height).data,this._imageDirty=!1,this._geometryDirty=!0}if(this._geometryDirty){if(!this._image||!this._imageData)return;var c=this._image.width,d=this._image.height,e=Math.floor(this._lod*this._xSegments),f=Math.floor(this._lod*this._ySegments);4>e&&(e=4),4>f&&(f=4);for(var g,h,i,j,k,l=this._xSize,m=this._ySize,n=this._zSize,o=l/2,p=m/2,q=Math.floor(e)||1,r=Math.floor(f)||1,s=q+1,t=r+1,u=l/q,v=m/r,w=new Float32Array(s*t*3),x=new Float32Array(s*t*3),y=new Float32Array(s*t*2),z=0,A=0,B=0;t>B;B++){j=B*v-p;for(var C=0;s>C;C++){i=C*u-o;var D=C*u,E=B*v;g=Math.round(D/l*(c-1)),h=Math.round(E/m*(d-1)),k=this._imageData[4*(c*h+g)]/255*n,(void 0==k||isNaN(k))&&(k=0),w[z]=i,w[z+1]=-j,w[z+2]=-k,x[z+2]=-1,y[A]=(q-C)/q,y[A+1]=1-B/r,z+=3,A+=2}}z=0;for(var F=new(w.length/3>65535?Uint32Array:Uint16Array)(q*r*6),B=0;r>B;B++)for(var C=0;q>C;C++){var G=C+s*B,H=C+s*(B+1),I=C+1+s*(B+1),J=C+1+s*B;F[z]=J,F[z+1]=H,F[z+2]=G,F[z+3]=J,F[z+4]=I,F[z+5]=H,z+=6}this.positions=w,this.normals=w,this.uv=y,this.indices=F,this._geometryDirty=!1,this.fire("updated",this)}},_loadSrc:function(a){var b=this,c=new Image;c.onload=function(){b._src===a&&(b._image=XEO.renderer.webgl.ensureImageSizePowerOfTwo(c),b._srcDirty=!1,b._imageDirty=!0,b._geometryDirty=!0,b._setHeightmapDirty(),b.fire("image",b._image))},c.onerror=function(){},0===a.indexOf("data")?c.src=a:(c.crossOrigin="Anonymous",c.src=a)},_props:{lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this._geometryDirty=!0,this._setHeightmapDirty(),this.fire("lod",this._lod))},get:function(){return this._lod}},image:{set:function(a){this._image=a?XEO.renderer.webgl.ensureImageSizePowerOfTwo(a):a,this._src=null,this._srcDirty=!1,this._imageDirty=!0,this._geometryDirty=!0,this._setHeightmapDirty(),this.fire("image",this._image)},get:function(){return this._state.image}},src:{set:function(a){this._image=null,this._src=a,this._srcDirty=!0,this._imageDirty=!0,this._geometryDirty=!0,this._setHeightmapDirty(),this.fire("src",this._src)},get:function(){return this._src}},xSize:{set:function(a){a=a||1,this._xSize!==a&&(0>a&&(this.warn("negative xSize not allowed - will invert"),a=-1*a),this._xSize=a,this._geometryDirty=!0,this._setHeightmapDirty(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},ySize:{set:function(a){a=a||1,this._ySize!==a&&(0>a&&(this.warn("negative ySize not allowed - will invert"),a=-1*a),this._ySize=a,this._geometryDirty=!0,this._setHeightmapDirty(),this.fire("ySize",this._ySize))},get:function(){return this._ySize}},zSize:{set:function(a){a=a||.25,this._zSize!==a&&(0>a&&(this.warn("negative zSize not allowed - will invert"),a=-1*a),this._zSize=a,this._geometryDirty=!0,this._setHeightmapDirty(),this.fire("zSize",this._zSize))},get:function(){return this._zSize}},xSegments:{set:function(a){a=a||100,this._xSegments!==a&&(0>a&&(this.warn("negative xSegments not allowed - will invert"),a=-1*a),this._xSegments=a,this._geometryDirty=!0,this._setHeightmapDirty(),this.fire("xSegments",this._xSegments))},get:function(){return this._xSegments}},ySegments:{set:function(a){a=a||100,this._ySegments!==a&&(0>a&&(this.warn("negative ySegments not allowed - will invert"),a=-1*a),this._ySegments=a,this._geometryDirty=!0,this._setHeightmapDirty(),this.fire("ySegments",this._ySegments))},get:function(){return this._ySegments}}},_getJSON:function(){var a={xSize:this._xSize,ySize:this._ySize,zSize:this._zSize,xSegments:this._xSegments,ySegments:this._ySegments};return this._src?a.src=this._src:this._image,a}})}(),function(){"use strict";XEO.LatheGeometry=XEO.Geometry.extend({type:"XEO.LatheGeometry",_init:function(a){this._super(a),this.points=a.points,this.segments=a.segments,this.phiStart=a.phiStart,this.phiLength=a.phiLength,this.lod=a.lod,this.autoNormals=a.autoNormals!==!1},_latheDirty:function(){if(!this.__dirty){this.__dirty=!0;var a=this;this.scene.once("tick2",function(){a._buildLathe(),a.__dirty=!1})}},_buildLathe:function(){var a=[],b=[],c=Math.floor(this._lod*this._segments);4>c&&(c=4);for(var d=this._phiStart*XEO.math.DEGTORAD,e=this._phiLength*XEO.math.DEGTORAD,f=this._points,g=(1/(f.length-1),1/c),h=0,i=c;i>=h;h++)for(var j=d+h*g*e,k=Math.cos(j),l=Math.sin(j),m=0,n=f.length;n>m;m++){var o=f[m];a.push(k*o[0]-l*o[1]),a.push(l*o[0]+k*o[1]),a.push(o[2])}for(var p=f.length,h=0,i=c;i>h;h++)for(var m=0,n=f.length-1;n>m;m++){var q=m+p*h,r=q,s=q+p,k=q+1+p,t=q+1;b.push(t),b.push(s),b.push(r),b.push(t),b.push(k),b.push(s)}this.positions=a,this.indices=b},_props:{points:{set:function(a){this._points=a||[],this._latheDirty(),this.fire("points",this._points)},get:function(){return this._points}},lod:{set:function(a){a=void 0!==a?a:1,this._lod!==a&&((0>a||a>1)&&(this.warn("clamping lod to [0..1]"),a=0>a?0:1),this._lod=a,this._latheDirty(),this.fire("lod",this._lod))},get:function(){return this._lod}},phiStart:{set:function(a){a=a||0,this._phiStart!==a&&(0>a&&(this.warn("negative phiStart not allowed - will invert"),a=-1*a),this._phiStart=a,this._latheDirty(),this.fire("phiStart",this._phiStart))},get:function(){return this._phiStart}},phiLength:{set:function(a){a=a||1,this._phiLength!==a&&(0>a&&(this.warn("negative phiLength not allowed - will invert"),a=-1*a),this._phiLength=a,this._latheDirty(),this.fire("phiLength",this._phiLength))},get:function(){return this._phiLength}},segments:{set:function(a){a=Math.floor(a||4),this._segments!==a&&(0>a&&(this.warn("negative segments not allowed - will invert"),a=-1*a),this._segments=a,this._latheDirty(),this.fire("segments",this._segments))},get:function(){return this._segments}}},_getJSON:function(){return{points:this._points,phiStart:this._phiStart,phiLength:this._phiLength,segments:this._segments}}})}(),function(){"use strict";function a(){return{" ":{width:16,points:[]},"!":{width:10,points:[[5,21],[5,7],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},'"':{width:16,points:[[4,21],[4,14],[-1,-1],[12,21],[12,14]]},"#":{width:21,points:[[11,25],[4,-7],[-1,-1],[17,25],[10,-7],[-1,-1],[4,12],[18,12],[-1,-1],[3,6],[17,6]]},$:{width:20,points:[[8,25],[8,-4],[-1,-1],[12,25],[12,-4],[-1,-1],[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},"%":{width:24,points:[[21,21],[3,0],[-1,-1],[8,21],[10,19],[10,17],[9,15],[7,14],[5,14],[3,16],[3,18],[4,20],[6,21],[8,21],[10,20],[13,19],[16,19],[19,20],[21,21],[-1,-1],[17,7],[15,6],[14,4],[14,2],[16,0],[18,0],[20,1],[21,3],[21,5],[19,7],[17,7]]},"&":{width:26,points:[[23,12],[23,13],[22,14],[21,14],[20,13],[19,11],[17,6],[15,3],[13,1],[11,0],[7,0],[5,1],[4,2],[3,4],[3,6],[4,8],[5,9],[12,13],[13,14],[14,16],[14,18],[13,20],[11,21],[9,20],[8,18],[8,16],[9,13],[11,10],[16,3],[18,1],[20,0],[22,0],[23,1],[23,2]]},"'":{width:10,points:[[5,19],[4,20],[5,21],[6,20],[6,18],[5,16],[4,15]]},"(":{width:14,points:[[11,25],[9,23],[7,20],[5,16],[4,11],[4,7],[5,2],[7,-2],[9,-5],[11,-7]]},")":{width:14,points:[[3,25],[5,23],[7,20],[9,16],[10,11],[10,7],[9,2],[7,-2],[5,-5],[3,-7]]},"*":{width:16,points:[[8,21],[8,9],[-1,-1],[3,18],[13,12],[-1,-1],[13,18],[3,12]]},"+":{width:26,points:[[13,18],[13,0],[-1,-1],[4,9],[22,9]]},",":{width:10,points:[[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"-":{width:26,points:[[4,9],[22,9]]},".":{width:10,points:[[5,2],[4,1],[5,0],[6,1],[5,2]]},"/":{width:22,points:[[20,25],[2,-7]]},0:{width:20,points:[[9,21],[6,20],[4,17],[3,12],[3,9],[4,4],[6,1],[9,0],[11,0],[14,1],[16,4],[17,9],[17,12],[16,17],[14,20],[11,21],[9,21]]},1:{width:20,points:[[6,17],[8,18],[11,21],[11,0]]},2:{width:20,points:[[4,16],[4,17],[5,19],[6,20],[8,21],[12,21],[14,20],[15,19],[16,17],[16,15],[15,13],[13,10],[3,0],[17,0]]},3:{width:20,points:[[5,21],[16,21],[10,13],[13,13],[15,12],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},4:{width:20,points:[[13,21],[3,7],[18,7],[-1,-1],[13,21],[13,0]]},5:{width:20,points:[[15,21],[5,21],[4,12],[5,13],[8,14],[11,14],[14,13],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},6:{width:20,points:[[16,18],[15,20],[12,21],[10,21],[7,20],[5,17],[4,12],[4,7],[5,3],[7,1],[10,0],[11,0],[14,1],[16,3],[17,6],[17,7],[16,10],[14,12],[11,13],[10,13],[7,12],[5,10],[4,7]]},7:{width:20,points:[[17,21],[7,0],[-1,-1],[3,21],[17,21]]},8:{width:20,points:[[8,21],[5,20],[4,18],[4,16],[5,14],[7,13],[11,12],[14,11],[16,9],[17,7],[17,4],[16,2],[15,1],[12,0],[8,0],[5,1],[4,2],[3,4],[3,7],[4,9],[6,11],[9,12],[13,13],[15,14],[16,16],[16,18],[15,20],[12,21],[8,21]]},9:{width:20,points:[[16,14],[15,11],[13,9],[10,8],[9,8],[6,9],[4,11],[3,14],[3,15],[4,18],[6,20],[9,21],[10,21],[13,20],[15,18],[16,14],[16,9],[15,4],[13,1],[10,0],[8,0],[5,1],[4,3]]},":":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},";":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"<":{width:24,points:[[20,18],[4,9],[20,0]]},"=":{width:26,points:[[4,12],[22,12],[-1,-1],[4,6],[22,6]]},">":{width:24,points:[[4,18],[20,9],[4,0]]},"?":{width:18,points:[[3,16],[3,17],[4,19],[5,20],[7,21],[11,21],[13,20],[14,19],[15,17],[15,15],[14,13],[13,12],[9,10],[9,7],[-1,-1],[9,2],[8,1],[9,0],[10,1],[9,2]]},"@":{width:27,points:[[18,13],[17,15],[15,16],[12,16],[10,15],[9,14],[8,11],[8,8],[9,6],[11,5],[14,5],[16,6],[17,8],[-1,-1],[12,16],[10,14],[9,11],[9,8],[10,6],[11,5],[-1,-1],[18,16],[17,8],[17,6],[19,5],[21,5],[23,7],[24,10],[24,12],[23,15],[22,17],[20,19],[18,20],[15,21],[12,21],[9,20],[7,19],[5,17],[4,15],[3,12],[3,9],[4,6],[5,4],[7,2],[9,1],[12,0],[15,0],[18,1],[20,2],[21,3],[-1,-1],[19,16],[18,8],[18,6],[19,5]]},A:{width:18,points:[[9,21],[1,0],[-1,-1],[9,21],[17,0],[-1,-1],[4,7],[14,7]]},B:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[-1,-1],[4,11],[13,11],[16,10],[17,9],[18,7],[18,4],[17,2],[16,1],[13,0],[4,0]]},C:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5]]},D:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[11,21],[14,20],[16,18],[17,16],[18,13],[18,8],[17,5],[16,3],[14,1],[11,0],[4,0]]},E:{width:19,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11],[-1,-1],[4,0],[17,0]]},F:{width:18,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11]]},G:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[18,8],[-1,-1],[13,8],[18,8]]},H:{width:22,points:[[4,21],[4,0],[-1,-1],[18,21],[18,0],[-1,-1],[4,11],[18,11]]},I:{width:8,points:[[4,21],[4,0]]},J:{width:16,points:[[12,21],[12,5],[11,2],[10,1],[8,0],[6,0],[4,1],[3,2],[2,5],[2,7]]},K:{width:21,points:[[4,21],[4,0],[-1,-1],[18,21],[4,7],[-1,-1],[9,12],[18,0]]},L:{width:17,points:[[4,21],[4,0],[-1,-1],[4,0],[16,0]]},M:{width:24,points:[[4,21],[4,0],[-1,-1],[4,21],[12,0],[-1,-1],[20,21],[12,0],[-1,-1],[20,21],[20,0]]},N:{width:22,points:[[4,21],[4,0],[-1,-1],[4,21],[18,0],[-1,-1],[18,21],[18,0]]},O:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21]]},P:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,14],[17,12],[16,11],[13,10],[4,10]]},Q:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21],[-1,-1],[12,4],[18,-2]]},R:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[4,11],[-1,-1],[11,11],[18,0]]},S:{width:20,points:[[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},T:{width:16,points:[[8,21],[8,0],[-1,-1],[1,21],[15,21]]},U:{width:22,points:[[4,21],[4,6],[5,3],[7,1],[10,0],[12,0],[15,1],[17,3],[18,6],[18,21]]},V:{width:18,points:[[1,21],[9,0],[-1,-1],[17,21],[9,0]]},W:{width:24,points:[[2,21],[7,0],[-1,-1],[12,21],[7,0],[-1,-1],[12,21],[17,0],[-1,-1],[22,21],[17,0]]},X:{width:20,points:[[3,21],[17,0],[-1,-1],[17,21],[3,0]]},Y:{width:18,points:[[1,21],[9,11],[9,0],[-1,-1],[17,21],[9,11]]},Z:{width:20,points:[[17,21],[3,0],[-1,-1],[3,21],[17,21],[-1,-1],[3,0],[17,0]]},"[":{width:14,points:[[4,25],[4,-7],[-1,-1],[5,25],[5,-7],[-1,-1],[4,25],[11,25],[-1,-1],[4,-7],[11,-7]]},"\\":{width:14,points:[[0,21],[14,-3]]},"]":{width:14,points:[[9,25],[9,-7],[-1,-1],[10,25],[10,-7],[-1,-1],[3,25],[10,25],[-1,-1],[3,-7],[10,-7]]},"^":{width:16,points:[[6,15],[8,18],[10,15],[-1,-1],[3,12],[8,17],[13,12],[-1,-1],[8,17],[8,0]]},_:{width:16,points:[[0,-2],[16,-2]]},"`":{width:10,points:[[6,21],[5,20],[4,18],[4,16],[5,15],[6,16],[5,17]]},a:{width:19,points:[[15,14],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},b:{width:19,points:[[4,21],[4,0],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},c:{width:18,points:[[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},d:{width:19,points:[[15,21],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},e:{width:18,points:[[3,8],[15,8],[15,10],[14,12],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},f:{width:12,points:[[10,21],[8,21],[6,20],[5,17],[5,0],[-1,-1],[2,14],[9,14]]},g:{width:19,points:[[15,14],[15,-2],[14,-5],[13,-6],[11,-7],[8,-7],[6,-6],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},h:{width:19,points:[[4,21],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},i:{width:8,points:[[3,21],[4,20],[5,21],[4,22],[3,21],[-1,-1],[4,14],[4,0]]},j:{width:10,points:[[5,21],[6,20],[7,21],[6,22],[5,21],[-1,-1],[6,14],[6,-3],[5,-6],[3,-7],[1,-7]]},k:{width:17,points:[[4,21],[4,0],[-1,-1],[14,14],[4,4],[-1,-1],[8,8],[15,0]]},l:{width:8,points:[[4,21],[4,0]]},m:{width:30,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0],[-1,-1],[15,10],[18,13],[20,14],[23,14],[25,13],[26,10],[26,0]]},n:{width:19,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},o:{width:19,points:[[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3],[16,6],[16,8],[15,11],[13,13],[11,14],[8,14]]},p:{width:19,points:[[4,14],[4,-7],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},q:{width:19,points:[[15,14],[15,-7],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},r:{width:13,points:[[4,14],[4,0],[-1,-1],[4,8],[5,11],[7,13],[9,14],[12,14]]},s:{width:17,points:[[14,11],[13,13],[10,14],[7,14],[4,13],[3,11],[4,9],[6,8],[11,7],[13,6],[14,4],[14,3],[13,1],[10,0],[7,0],[4,1],[3,3]]},t:{width:12,points:[[5,21],[5,4],[6,1],[8,0],[10,0],[-1,-1],[2,14],[9,14]]},u:{width:19,points:[[4,14],[4,4],[5,1],[7,0],[10,0],[12,1],[15,4],[-1,-1],[15,14],[15,0]]},v:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0]]},w:{width:22,points:[[3,14],[7,0],[-1,-1],[11,14],[7,0],[-1,-1],[11,14],[15,0],[-1,-1],[19,14],[15,0]]},x:{width:17,points:[[3,14],[14,0],[-1,-1],[14,14],[3,0]]},y:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0],[6,-4],[4,-6],[2,-7],[1,-7]]},z:{width:17,points:[[14,14],[3,0],[-1,-1],[3,14],[14,14],[-1,-1],[3,0],[14,0]]},"{":{width:14,points:[[9,25],[7,24],[6,23],[5,21],[5,19],[6,17],[7,16],[8,14],[8,12],[6,10],[-1,-1],[7,24],[6,22],[6,20],[7,18],[8,17],[9,15],[9,13],[8,11],[4,9],[8,7],[9,5],[9,3],[8,1],[7,0],[6,-2],[6,-4],[7,-6],[-1,-1],[6,8],[8,6],[8,4],[7,2],[6,1],[5,-1],[5,-3],[6,-5],[7,-6],[9,-7]]},"|":{width:8,points:[[4,25],[4,-7]]},"}":{width:14,points:[[5,25],[7,24],[8,23],[9,21],[9,19],[8,17],[7,16],[6,14],[6,12],[8,10],[-1,-1],[7,24],[8,22],[8,20],[7,18],[6,17],[5,15],[5,13],[6,11],[10,9],[6,7],[5,5],[5,3],[6,1],[7,0],[8,-2],[8,-4],[7,-6],[-1,-1],[8,8],[6,6],[6,4],[7,2],[8,1],[9,-1],[9,-3],[8,-5],[7,-6],[5,-7]]},"~":{width:24,points:[[3,6],[3,8],[4,11],[6,12],[8,12],[10,11],[14,8],[16,7],[18,7],[20,8],[21,10],[-1,-1],[3,8],[4,10],[6,11],[8,11],[10,10],[14,7],[16,6],[18,6],[20,7],[21,10],[21,12]]}}}var b;XEO.VectorTextGeometry=XEO.Geometry.extend({type:"XEO.VectorTextGeometry",_init:function(a){this._super(a),this.text=a.text,this.xSize=a.xSize,this.ySize=a.ySize},_textDirty:function(){if(!this.__dirty){this.__dirty=!0;var a=this;this.scene.once("tick2",function(){a._buildText(),a.__dirty=!1})}},_buildText:function(){b||(b=a());for(var c,d,e,f,g,h,i,j,k,l,m=[],n=[],o=this._text.split("\n"),p=0,q=0,r=.04,s=0;s<o.length;s++){
c=0,d=o[s],e=d.length;for(var t=0;e>t;t++)if(f=b[d.charAt(t)]){g=1,h=-1,i=-1,j=!1,k=f.points.length;for(var u=0;k>u;u++)l=f.points[u],-1!=l[0]||-1!=l[1]?(m.push(c-l[0]*this._xSize*r),m.push(q+l[1]*this._ySize*r),m.push(0),-1==h?h=p:-1==i?i=p:(h=i,i=p),p++,g?g=!1:(n.push(h),n.push(i)),j=!0):(g=1,j=!1);c-=f.width*r*this._xSize}q-=35*r*this._ySize}this.primitive="lines",this.positions=m,this.normals=null,this.uv=null,this.indices=n},_props:{text:{set:function(a){a=a||"",this._text!==a&&(this._text=a,this.fire("text",this._text),this._textDirty())},get:function(){return this._text}},xSize:{set:function(a){a=a||1,this._xSize!==a&&(0>a&&(this.warn("negative xSize not allowed - will invert"),a=-1*a),this._xSize=a,this._textDirty(),this.fire("xSize",this._xSize))},get:function(){return this._xSize}},ySize:{set:function(a){a=a||1,this._ySize!==a&&(0>a&&(this.warn("negative ySize not allowed - will invert"),a=-1*a),this._ySize=a,this._textDirty(),this.fire("ySize",this._ySize))},get:function(){return this._ySize}},_getJSON:function(){return{text:this._text}}}})}(),function(){"use strict";XEO.Group=XEO.Component.extend({type:"XEO.Group",_init:function(a){this.components={},this.numComponents=0,this.types={},this._destroyedSubs={},a.components&&this.add(a.components)},add:function(a){a=XEO._isArray(a)?a:[a];for(var b=0,c=a.length;c>b;b++)this._addComponent(a[b])},_addComponent:function(a){var b,c,d,e;if(a.type)c=a;else{if(!XEO._isNumeric(a)&&!XEO._isString(a))return;if(this.scene.types[a]){if(d=a,e=this.scene.types[d],!e)return void this.warn("Component type not found: '"+d+"'");for(b in e)e.hasOwnProperty(b)&&this._addComponent(e[b]);return}if(c=this.scene.components[a],!c)return void this.warn("Component not found: "+XEO._inQuotes(a))}if(c.scene!=this.scene)return void this.warn("Attempted to add component from different XEO.Scene: "+XEO._inQuotes(c.id));this.components[c.id]=c,e=this.types[c.type],e||(e=this.types[d]={}),e[c.id]=c,this.numComponents++;var f=this;this._destroyedSubs[c.id]=c.on("destroyed",function(a){f._removeComponent(a)}),this.fire("added",c)},clear:function(){this.iterate(function(a){this._removeComponent(a)})},destroyAll:function(){this.iterate(function(a){a.destroy()})},remove:function(a){a=XEO._isArray(a)?a:[a];for(var b=0,c=a.length;c>b;b++)this._removeComponent(a[b])},_removeComponent:function(a){var b=a.id;if(a.scene!=this.scene)return void this.warn("Attempted to remove component that's not in same XEO.Scene: '"+b+"'");delete this.components[b],a.off(this._destroyedSubs[b]),delete this._destroyedSubs[b];var c=this.types[a.type];c&&delete c[a.id],this.numComponents--,this.fire("removed",a)},iterate:function(a){for(var b in this.components)this.components.hasOwnProperty(b)&&a.call(this,this.components[b])},_getJSON:function(){var a=[];for(var b in this.components)this.components.hasOwnProperty(b)&&a.push(this.components[b].id);return{components:a}},_destroy:function(){this.clear()}})}(),function(){"use strict";XEO.CameraControl=XEO.Component.extend({type:"XEO.CameraControl",exclusive:!0,_init:function(a){var b=this,c=this.scene;this._boundaryObject=new XEO.GameObject(c,{geometry:new XEO.BoundaryGeometry(c),material:new XEO.PhongMaterial(c,{diffuse:[.5,1,.5],emissive:[.5,1,.5],lineWidth:2}),visibility:new XEO.Visibility(c,{visible:!1})}),this.keyboardAxis=new XEO.KeyboardAxisCamera(c,{camera:a.camera}),this.keyboardOrbit=new XEO.KeyboardOrbitCamera(c,{camera:a.camera}),this.mouseOrbit=new XEO.MouseOrbitCamera(c,{camera:a.camera}),this.keyboardPan=new XEO.KeyboardPanCamera(c,{camera:a.camera}),this.mousePan=new XEO.MousePanCamera(c,{camera:a.camera}),this.keyboardZoom=new XEO.KeyboardZoomCamera(c,{camera:a.camera}),this.mouseZoom=new XEO.MouseZoomCamera(c,{camera:a.camera}),this.mousePickObject=new XEO.MousePickObject(c,{rayPick:!0}),this.mousePickObject.on("pick",function(a){var c,d=b.cameraFly.camera.view;if(a.worldPos?c=a.worldPos:a.object&&(c=a.object.worldBoundary.center),c){var e=XEO.math.subVec3(d.eye,d.look,[]),f=b.scene.input;if(f.keyDown[f.KEY_SHIFT]&&a.object){b._boundaryObject.geometry.obb=a.object.worldBoundary.obb,b._boundaryObject.visibility.visible=!0;var g=a.object.worldBoundary.center;b.cameraFly.flyTo({aabb:a.object.worldBoundary.aabb,offset:[c[0]-g[0],c[1]-g[1],c[2]-g[2]]},function(){b._boundaryObject.visibility.visible=!1})}else b.cameraFly.flyTo({look:c,eye:[c[0]+e[0],c[1]+e[1],c[2]+e[2]]},function(){b._boundaryObject.visibility.visible=!1})}}),this.mousePickObject.on("nopick",function(a){}),this.cameraFly=new XEO.CameraFlight(c,{camera:a.camera,duration:.5}),this.firstPerson=a.firstPerson,this.camera=a.camera,this.active=a.active!==!1},_props:{firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.keyboardOrbit.firstPerson=a,this.mouseOrbit.firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},camera:{set:function(a){this._setChild("camera",a);var b=this._children.camera;this.keyboardAxis.camera=b,this.keyboardOrbit.camera=b,this.mouseOrbit.camera=b,this.keyboardPan.camera=b,this.mousePan.camera=b,this.keyboardZoom.camera=b,this.mouseZoom.camera=b,this.cameraFly.camera=b},get:function(){return this._children.camera}},active:{set:function(a){a=!!a,this._active!==a&&(this.keyboardAxis.active=a,this.keyboardOrbit.active=a,this.mouseOrbit.active=a,this.keyboardPan.active=a,this.mousePan.active=a,this.keyboardZoom.active=a,this.mouseZoom.active=a,this.mousePickObject.active=a,this.cameraFly.active=a,this.fire("active",this._active=a))},get:function(){return this._active}}},_getJSON:function(){var a={firstPerson:this._firstPerson,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1,this._boundaryObject.destroy(),this.keyboardAxis.destroy(),this.keyboardOrbit.destroy(),this.mouseOrbit.destroy(),this.keyboardPan.destroy(),this.mousePan.destroy(),this.keyboardZoom.destroy(),this.mouseZoom.destroy(),this.mousePickObject.destroy(),this.cameraFly.destroy()}})}(),function(){"use strict";XEO.KeyboardAxisCamera=XEO.Component.extend({type:"XEO.KeyboardAxisCamera",_init:function(a){this._onKeyDown=null,this._cameraFly=new XEO.CameraFlight(this.scene,{duration:1}),this.camera=a.camera,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a),this._cameraFly.camera=this._children.camera},get:function(){return this._children.camera}},active:{set:function(a){if(a=!!a,this._active!==a){this._cameraFly.active=a;var b=this,c=this.scene.input;a?this._onKeyDown=c.on("keydown",function(a){if(b._children.camera){var d=b.scene.worldBoundary,e=d.aabb,f=d.center,g=XEO.math.getAABBDiag(e);this._stopFOV=55;var h=Math.abs(g/Math.tan(this._stopFOV/2));switch(a){case c.KEY_NUM_1:b._cameraFly.flyTo({look:f,eye:[f[0]-h,f[1],f[2]],up:[0,1,0]});break;case c.KEY_NUM_2:b._cameraFly.flyTo({look:f,eye:[f[0],f[1],f[2]+h],up:[0,1,0]});break;case c.KEY_NUM_3:b._cameraFly.flyTo({look:f,eye:[f[0]+h,f[1],f[2]],up:[0,1,0]});break;case c.KEY_NUM_4:b._cameraFly.flyTo({look:f,eye:[f[0],f[1],f[2]-h],up:[0,1,0]});break;case c.KEY_NUM_5:b._cameraFly.flyTo({look:f,eye:[f[0],f[1]-h,f[2]],up:[0,0,-1]});break;case c.KEY_NUM_6:b._cameraFly.flyTo({look:f,eye:[f[0],f[1]+h,f[2]],up:[0,0,1]})}}}):this.scene.off(this._onKeyDown),this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1,this._cameraFly.destroy()}})}(),function(){"use strict";XEO.KeyboardOrbitCamera=XEO.Component.extend({type:"XEO.KeyboardOrbitCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.active=a.active!==!1,this.sensitivity=a.sensitivity},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a||1,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._children.camera;if(d){var e=a.deltaTime,f=.3*c._sensitivity,g=.3*c._sensitivity;if(!b.ctrlDown&&!b.altDown){var h=b.keyDown[b.KEY_LEFT_ARROW],i=b.keyDown[b.KEY_RIGHT_ARROW],j=b.keyDown[b.KEY_UP_ARROW],k=b.keyDown[b.KEY_DOWN_ARROW];if(h||i||j||k){var l=0,m=0;i?l=-e*f:h&&(l=e*f),k?m=e*g:j&&(m=-e*g),Math.abs(l)>Math.abs(m)?m=0:l=0,0!=l&&d.view.rotateEyeY(l),0!=m&&d.view.rotateEyeX(m)}}}})}else this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.KeyboardPanCamera=XEO.Component.extend({type:"XEO.KeyboardPanCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._children.camera;if(d){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_W],g=b.keyDown[b.KEY_S],h=b.keyDown[b.KEY_A],i=b.keyDown[b.KEY_D],j=b.keyDown[b.KEY_Z],k=b.keyDown[b.KEY_X];if(f||g||h||i||k||j){var l=0,m=0,n=0,o=.01*c._sensitivity;g?m=e*o:f&&(m=-e*o),i?l=e*o:h&&(l=-e*o),k?n=e*o:j&&(n=-e*o),d.view.pan([l,m,n])}}}})}else this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.KeyboardZoomCamera=XEO.Component.extend({type:"XEO.KeyboardZoomCamera",_init:function(a){this._onTick=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c=this;this._onTick=this.scene.on("tick",function(a){var d=c._children.camera;if(d){var e=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=b.keyDown[b.KEY_ADD],g=b.keyDown[b.KEY_SUBTRACT];if(f||g){var h=0,i=.01*c.sensitivity;g?h=e*i:f&&(h=-e*i),d.view.zoom(h)}}}})}else null!==this._onTick&&this.scene.off(this._onTick);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MouseOrbitCamera=XEO.Component.extend({type:"XEO.MouseOrbitCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=0,f=0,g=!1,h=this;this._onTick=this.scene.on("tick",function(a){var b=h._children.camera;b&&(0!=e&&(b.view.rotateEyeY(-e*h._sensitivity),e=0),0!=f&&(b.view.rotateEyeX(f*h._sensitivity),f=0))}),this._onMouseDown=b.on("mousedown",function(a){!b.mouseDownLeft||b.mouseDownRight||b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?g=!1:(g=!0,c=a[0],d=a[1])}),this._onMouseUp=b.on("mouseup",function(a){g=!1}),this._onMouseMove=b.on("mousemove",function(a){g&&(e+=(a[0]-c)*h._sensitivity,f+=(a[1]-d)*h._sensitivity,c=a[0],d=a[1])})}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MousePanCamera=XEO.Component.extend({type:"XEO.MousePanCamera",_init:function(a){this._onTick=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a?.03*a:.03,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=0,f=0,g=!1,h=this;this._onTick=this.scene.on("tick",function(){var a=h._children.camera;a&&(0!=e||0!=f)&&(a.view.pan([e,f,0]),e=0,f=0)}),this._onMouseDown=b.on("mousedown",function(a){b.mouseDownLeft&&b.mouseDownRight||b.mouseDownLeft&&b.keyDown[b.KEY_SHIFT]||b.mouseDownMiddle?(c=a[0],d=a[1],g=!0):g=!1}),this._onMouseUp=b.on("mouseup",function(){g=!1}),this._onMouseMove=b.on("mousemove",function(a){g&&(e+=(a[0]-c)*h._sensitivity,f+=(a[1]-d)*h._sensitivity,c=a[0],d=a[1])})}else b.off(this._onTick),b.off(this._onMouseDown),b.off(this._onMouseUp),b.off(this._onMouseMove);this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MousePickObject=XEO.Component.extend({type:"XEO.MousePickObject",_init:function(a){this.rayPick=a.rayPick,this.active=a.active!==!1},_props:{active:{set:function(a){if(this._active!==a){var b=this.scene.input;if(a){var c,d,e=this,f=2,g=!1;this._onMouseDown=b.on("mousedown",function(a){g=!0,c=a[0],d=a[1]}),this._onMouseUp=b.on("mouseup",function(a){if(g){if(c>=a[0]-f&&c<=a[0]+f&&d>=a[1]-f&&d<=a[1]+f){var b=e.scene.pick(a,{rayPick:e._rayPick});b?e.fire("pick",b):e.fire("nopick",{canvasPos:a})}g=!1}})}else b.off(this._onMouseDown),b.off(this._onMouseUp);this.fire("active",this._active=a)}},get:function(){return this._active}},rayPick:{set:function(a){a=!!a,this._rayPick!==a&&(this._dirty=!1,this.fire("rayPick",this._rayPick=a))},get:function(){return this._rayPick}}},_getJSON:function(){var a={rayPick:this._rayPick,active:this._active};return a},_destroy:function(){this.active=!1}})}(),function(){"use strict";XEO.MouseZoomCamera=XEO.Component.extend({type:"XEO.MouseZoomCamera",_init:function(a){this._onTick=null,this._onMouseWheel=null,this.camera=a.camera,this.sensitivity=a.sensitivity,this.active=a.active!==!1},_props:{camera:{set:function(a){this._setChild("camera",a)},get:function(){return this._children.camera}},sensitivity:{set:function(a){this._sensitivity=a||.5,this.fire("sensitivity",this._sensitivity)},get:function(){return this._sensitivity}},active:{set:function(a){if(this._active!==a){if(a){var b=0,c=0,d=!1,e=!1,f=0,g=XEO.math.vec3(),h=XEO.math.vec3(),i=XEO.math.vec3(),j=this;this._onMouseWheel=this.scene.input.on("mousewheel",function(a){b=a,0===b?(e=!1,d=!1):d=!0}),this._onTick=this.scene.on("tick",function(){var a=j._children.camera;if(a){var k=a.view.eye,l=a.view.look;g[0]=k[0],g[1]=k[1],g[2]=k[2],h[0]=l[0],h[1]=l[1],h[2]=l[2],XEO.math.subVec3(g,h,i);var m=Math.abs(XEO.math.lenVec3(i)),n=1e3,o=j._sensitivity*(2+m/n);d&&(c=b*o,f=0,d=!1,e=!0),e&&(b>0?(f+=.2*o,f>c&&(e=!1)):0>b&&(f-=.2*o,c>f&&(e=!1)),e&&a.view.zoom(f))}})}else null!==this._onTick&&(this.scene.off(this._onTick),this.scene.input.off(this._onMouseWheel));this.fire("active",this._active=a)}},get:function(){return this._active}}},_getJSON:function(){var a={sensitivity:this._sensitivity,active:this._active};return this._children.camera&&(a.camera=this._children.camera.id),a},_destroy:function(){this.active=!1}})}(),XEO.version="0.1.0";