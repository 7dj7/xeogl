/*
 * xeoEngine V0.0.1
 *
 * A WebGL-based 3D engine from xeoLabs
 * http://xeoengine.org/
 *
 * Built on 2015-03-01
 *
 * MIT License
 * Copyright 2015, Lindsay Kay
 * http://xeolabs.com/
 *
 */

"use strict";!function(){var a=function(){this._scene=null,this.scenes={},this._dirtyScenes={};var a=this,b=function(){var c,d={};for(var e in a.scenes)a.scenes.hasOwnProperty(e)&&(c=a.scenes[e],c.fire("tick",d),a._dirtyScenes[e]&&(c._compile(),a._dirtyScenes[e]=!1));window.requestAnimationFrame(b)};window.requestAnimationFrame(b)};a.prototype={constructor:a,get scene(){return this._scene||(this._scene=new a.Scene)},_addScene:function(a){this.scenes[a.id]=a;var b=this;a.on("destroyed",function(){delete b.scenes[a.id],delete b._dirtyScenes[a.id]}),a.on("dirty",function(){b._dirtyScenes[a.id]=!0})},clear:function(){for(var a in this.scenes)this.scenes.hasOwnProperty(a)&&this.scenes[a].destroy();this.scenes={},this._dirtyScenes={}},_isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},_isString:function(a){return"string"==typeof a||a instanceof String},_copy:function(a){return this._apply(a,{})},_apply:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_applyIf:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0==b[c]||null==b[c])&&(b[c]=a[c]);return b},_createType:function(b){var c=a.Component;for(var d in b)c.prototype[d]=d;return c}},window.XEO=new a}(),XEO.Component=function(){var a={},b=arguments[0],c=arguments[1];switch(arguments.length){case 0:this.scene=XEO.scene,this._renderer=this.scene._renderer;break;case 1:"scene"==b.type?(this.scene=b,this._renderer=this.scene._renderer):(this.scene=XEO.scene,this._renderer=this.scene._renderer,a=b);break;case 2:this.scene=b,a=c}this.metadata=a.metadata||{},this.className=a.className,this.type=a.type||"component",this.id=a.id,this.destroyed=!1,this._children={},this._childDestroySubs={},this._childDirtySubs={},this._handleMap=new XEO.utils.Map,this._locSubs={},this._handleLocs={},this.props={};var d=XEO.Component._stateIDMap.addItem({});this._core={type:this.type,stateId:d,hash:""+d},this._init&&this._init(a),this.scene&&this.scene._addComponent(this)},XEO.Component._stateIDMap=new XEO.utils.Map({}),XEO.Component.prototype._init=function(){},XEO.Component.prototype.fire=function(a,b,c){c!==!0&&(this.props[a]=b);var d=this._locSubs[a];if(d)for(var e in d)d.hasOwnProperty(e)&&d[e].call(this,b)},XEO.Component.prototype.on=function(a,b){var c=this._locSubs[a];c||(c={},this._locSubs[a]=c);var d=this._handleMap.addItem();c[d]=b,this._handleLocs[d]=a;var e=this.props[a];return e&&b.call(this,e),d},XEO.Component.prototype.off=function(a){var b=this._handleLocs[a];if(b){delete this._handleLocs[a];var c=this._locSubs[b];c&&delete c[a],this._handleMap.removeItem(a)}},XEO.Component.prototype.once=function(a,b){var c=this,d=this.on(a,function(a){c.off(d),b(a)})},XEO.Component.prototype.log=function(a){console.log("[LOG] "+this.id+": "+a),this.scene.fire("log",a)},XEO.Component.prototype.error=function(a){console.error("[ERROR] "+this.id+": "+a),this.scene.fire("error",a)},XEO.Component.prototype.warn=function(a){console.warn("[WARN] "+this.id+": "+a),this.scene.fire("warn",a)},XEO.Component.prototype._setChild=function(a,b){if(b){if(XEO._isString(b)){var c=b;if(b=this.scene.components[c],!b)return void this.error("component not found for ID: '"+c+"'")}if(!b.type||b.type!=a)return void this.error("Failed to add component '"+b.id+"' to object - component expected to be a '"+a+"' type")}else if(b=this.scene[a],!b)return void this.error("Default component not found for type '"+a+"'");var d=this._children[a];if(d){if(d.id==b.id)return;d.off(this._childDestroySubs[a]),d.off(this._childDirtySubs[a])}this._children[a]=b;var e=this;this._childDestroySubs[a]=b.on("destroyed",function(){delete e._children[a];var c=e.scene[a];return b.id==c.id?void e.set(a,null):void e._setChild(a,c)}),this._childDirtySubs[a]=b.on("dirty",function(){e.fire("dirty",!0)}),this.fire("dirty",!0),this.set(a,b)},XEO.Component.prototype._compile=function(){},GameObject.defineProperty(XEO.Component.prototype,"json",{get:function(){var a={id:this.id,className:this.className,type:this.type,metadata:this.metadata};return this._getJSON?XEO._apply(a,this._getJSON()):a}}),XEO.Component.prototype.destroy=function(){var a;for(var b in this._children)this._children.hasOwnProperty(b)&&(a=this._children[b],a.off(this._childDestroySubs[b]),a.off(this._childDirtySubs[b]));XEO.Component._stateIDMap.removeItem(this._core.stateId),this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)},XEO.Component.prototype._destroy=function(){},function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;XEO.Component.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),XEO.AmbientLight=XEO.Component.extend({className:"XEO.AmbientLight",type:"light",_init:function(a){this.mode="ambient",this.ambient=a.ambient},set ambient(a){a=a||[.7,.7,.8],this._core.ambient=a,this._renderer.imageDirty=!0,this.fire("ambient",a)},get ambient(){return this._core.ambient},_getJSON:function(){return{color:this.color}}}),XEO.Camera=XEO.Component.extend({className:"XEO.Camera",type:"camera",_init:function(a){this.project=a.project,this.view=a.view},set project(a){this._setChild("project",a)},get project(){return this._children.project},set view(a){this._setChild("view",a)},get view(){return this._children.view},_compile:function(){this._children.project._compile(),this._children.view._compile()},_getJSON:function(){return{project:this.project.id,view:this.view.id}}}),XEO.Scene.prototype.newCamera=function(a){return new XEO.Camera(this,a)},XEO.Canvas=XEO.Component.extend({className:"XEO.Canvas",type:"canvas",_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(a){if(this.canvas=null,this.gl=null,this.contextAttr=a.contextAttr||{},a.canvas?XEO._isString(a.canvas)?(this.canvas=document.getElementById(a.canvas),this.canvas||(this.error("Canvas element not found: '"+a.canvas+"' - creating one automatically."),this._createCanvas())):this.error("Config 'canvasId' should be a string."):this._createCanvas(),this.canvas){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this._initWebGL();var b=this;this.canvas.addEventListener("webglcontextlost",function(){b.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){b._initWebGL(),b.gl&&b.fire("webglContextRestored",b.gl)},!1);var c=this.canvas.width,d=this.canvas.height;this._tick=this.scene.on("tick",function(){var a=b.canvas;(a.width!=c||a.height!=d)&&(c=a.width,d=a.height,b.fire("resized",{width:a.width,height:a.height,aspect:a.height/a.width}))})}},pick:function(){},_createCanvas:function(){var a="canvas-"+this.id,b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height="100%",d.width="100%",d.padding="0",d.margin="0",d.left="0",d.top="0",d.position="absolute",c.innerHTML+='<canvas id="'+a+'" style="width: 100%; height: 100%; margin: 0; padding: 0;"></canvas>',b.appendChild(c),this.canvas=document.getElementById(a)},_initWebGL:function(){for(var a=0;!this.gl&&a<this._WEBGL_CONTEXT_NAMES.length;a++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[a],this.contextAttr)}catch(b){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0))},_destroy:function(){this.scene.off(this._tick)}}),XEO.Clip=XEO.Component.extend({className:"XEO.Clip",type:"clip",_init:function(a){this.mode=a.mode,this.dir=a.dir,this.dist=a.dist},set mode(a){a=a||"disabled",this._core.mode=a,this._renderer.imageDirty=!0,this.fire("mode",a)},get mode(){return this._core.mode},set dir(a){a=a||[1,0,0],this._core.dir=a,this._renderer.imageDirty=!0,this.fire("dir",a)},get dir(){return this._core.dir},set dist(a){a=void 0!=a?a:1,this._core.dist=a,this._renderer.imageDirty=!0,this.fire("dist",a)},get dist(){return this._core.dist},_getJSON:function(){return{mode:this.mode,dir:this.dir,dist:this.dist}}}),XEO.Clips=XEO.Component.extend({className:"XEO.Clips",type:"clips",_init:function(a){this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=a.clips},set clips(a){for(var b,c=0,d=this._clips.length;d>c;c++)b=this._clips[c],b.off(this._dirtySubs[c]),b.off(this._destroyedSubs[c]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];for(var e=[],f=this,c=0,d=a.length;d>c;c++){if(b=a[c],XEO._isString(b)){var g=b;if(b=this.components[g],!b){this.error("Clip not found for ID: '"+g+"'");continue}}"clip"==b.type?(this._clips.push(b),this._dirtySubs.push(b.on("dirty",function(){f.fire("dirty",!0)})),this._destroyedSubs.push(b.on("destroyed",function(){for(var a=this.id,b=0,c=f._clips.length;c>b;b++)if(f._clips[b].id==a)return f._clips=f._clips.slice(b,b+1),f._dirtySubs=f._dirtySubs.slice(b,b+1),f._destroyedSubs=f._destroyedSubs.slice(b,b+1),f.fire("dirty",!0),void f.fire("clips",f._clips)})),e.push(b)):this.error("Component is not a clip: '"+b.id+"'")}this.fire("dirty",!0),this.fire("clips",this._clips)},get clips(){return this._clips.slice(0,this._clips.length)},_compile:function(){for(var a=[],b=0,c=this._clips.length;c>b;b++)a.push(this._clips[b]._core);var d={type:"clips",clips:a,hash:this._makeHash(a)};this._renderer.clips=d},_makeHash:function(a){if(0==a.length)return"";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b.mode),b.specular&&c.push("s"),b.diffuse&&c.push("d"),c.push("world"==b.space?"w":"v");return c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._clips.length;c>b;b++)a.push(this._clips[b].id);return{clips:a}}}),XEO.ColorBuf=XEO.Component.extend({className:"XEO.ColorBuf",type:"colorbuf",_init:function(a){this.blendEnabled=a.blendEnabled,this.colorMask=a.colorMask},set blendEnabled(a){a=a!==!1,this._core.blendEnabled=a,this._renderer.imageDirty=!0,this.fire("blendEnabled",a)},get blendEnabled(){return this._core.blendEnabled},set colorMask(a){a=a||[!0,!0,!0,!0],this._core.colorMask=a,this._renderer.imageDirty=!0,this.fire("colorMask",a)},get colorMask(){return this._core.colorMask},_compile:function(){this._renderer.colorBuf=this._core},_getJSON:function(){return{blendEnabled:this.blendEnabled,colorMask:this.colorMask}}}),XEO.ColorTarget=XEO.Component.extend({className:"XEO.ColorTarget",type:"renderBuf",_componentCoreMap:{},_init:function(){this._core.bufType="color",this._componentCoreMap[this._core.id]=this._core,this._core.renderBuf=new XEO.webgl.RenderBuffer({canvas:this.scene.canvas})},_compile:function(){this._renderer.colorTarget=this._core},_destroy:function(){this._core&&(this._core.renderBuf&&this._core.renderBuf.destroy(),delete this._componentCoreMap[this._core.id])}}),XEO.Configs=XEO.Component.extend({className:"XEO.Configs",type:"configs",_init:function(a){for(var b in a)a.hasOwnProperty(b)&&this.fire(b,a[b])},_toJSON:function(){return XEO._copy(this.props)}}),XEO.DepthBuf=XEO.Component.extend({className:"XEO.DepthBuf",type:"DepthBuf",_init:function(a){this.clearDepth=a.clearDepth,this.depthFunc=a.depthFunc},set clearDepth(a){a=void 0!=a?a:1,this._core.clearDepth=a,this._renderer.imageDirty=!0,this.fire("clearDepth",a)},get clearDepth(){return this._core.clearDepth},set depthFunc(a){a=a||"less";var b=this._depthFuncNames[a];return void 0==b?void this.error("unsupported value for 'clearFunc' attribute on depthBuf component: '"+a+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal'"):(this._core.depthFunc=this.scene.canvas.gl[b],this._core.depthFuncName=a,this._renderer.imageDirty=!0,void this.fire("depthFunc",a))},_depthFuncNames:{less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},get depthFunc(){return this._core.depthFuncName},_compile:function(){this._renderer.depthBuf=this._core},_getJSON:function(){return{clearDepth:this.clearDepth,depthFunc:this.depthFunc}}}),XEO.DepthTarget=XEO.Component.extend({className:"XEO.DepthTarget",type:"renderBuf",_componentCoreMap:{},_init:function(){this._core.bufType="depth",this._componentCoreMap[this._core.coreId]=this._core,this._core.renderBuf=new XEO.webgl.RenderBuffer({canvas:this.scene.canvas})},_compile:function(){this._renderer.depthTarget=this._core},_destroy:function(){this._core&&(this._core.renderBuf&&this._core.renderBuf.destroy(),delete this._componentCoreMap[this._core.coreId])}}),XEO.DirLight=XEO.Component.extend({className:"XEO.DirLight",type:"light",_init:function(a){this.mode="dir",this._core.mode=this.mode,this.dir=a.dir,this.diffuse=a.diffuse,this.specular=a.specular,this.space=a.space},set dir(a){a=a||[1,1,1],this._core.dir=a,this._renderer.imageDirty=!0,this.fire("dir",a)},get dir(){return this._core.dir},set diffuse(a){a=a||[.7,.7,.8],this._core.diffuse=a,this._renderer.imageDirty=!0,this.fire("diffuse",a)},get diffuse(){return this._core.diffuse},set specular(a){a=a||[1,1,1],this._core.specular=a,this._renderer.imageDirty=!0,this.fire("specular",a)},get specular(){return this._core.specular},set space(a){a=a||"view",a!=this._core.space&&(this._core.space=a,this.fire("dirty",!0),this.fire("space",a))},get space(){return this._core.space},_getJSON:function(){return{mode:this.mode,dir:this.dir,color:this.color,diffuse:this.diffuse,specular:this.specular,space:this.space}}}),XEO.Visibility=XEO.Component.extend({className:"XEO.Visibility",type:"enable",_init:function(a){this.visible=a.visible},set visible(a){a=a!==!1,this._core.visible=a,this._renderer.imageDirty=!0,this.fire("visible",a)},get visible(){return this._core.visible},_compile:function(){this._renderer.enable=this._core},_getJSON:function(){return{visible:this.visible}}}),XEO.Modes=XEO.Component.extend({className:"XEO.Modes",type:"modes",_init:function(a){this.picking=a.picking,this.clipping=a.clipping,this.transparent=a.transparent,this.backfaces=a.backfaces,this.frontface=a.frontface,this.backfaceLighting=a.backfaceLighting,this.backfaceTexturing=a.backfaceTexturing,this.diffuse=a.diffuse,this.specular=a.specular,this.ambient=a.ambient,this.reflection=a.reflection},set picking(a){a=a!==!1,this._core.picking=a,this._renderer.drawListDirty=!0,this.fire("picking",a)},get picking(){return this._core.picking},set clipping(a){a=a!==!1,this._core.clipping=a,this._renderer.imageDirty=!0,this.fire("clipping",a)},get clipping(){return this._core.clipping},set transparent(a){a=!!a,this._core.transparent=a,this._renderer.stateOrderDirty=!0,this.fire("transparent",a)},get transparent(){return this._core.transparent},set backfaces(a){a=a!==!1,this._core.backfaces=a,this._renderer.imageDirty=!0,this.fire("backfaces",a)},get backfaces(){return this._core.backfaces},set frontface(a){a=a||"ccw",this._core.frontface=a,this._renderer.imageDirty=!0,this.fire("frontface",a)},get frontface(){return this._core.frontface},set backfaceLighting(a){a=a!==!1,this._core.backfaceLighting=a,this._renderer.imageDirty=!0,this.fire("backfaceLighting",a)},get backfaceLighting(){return this._core.backfaceLighting},set backfaceTexturing(a){a=a!==!1,this._core.backfaceTexturing=a,this._renderer.imageDirty=!0,this.fire("backfaceTexturing",a)},get backfaceTexturing(){return this._core.backfaceTexturing},set diffuse(a){a=a!==!1,this._core.diffuse=a,this._renderer.imageDirty=!0,this.fire("diffuse",a)},get diffuse(){return this._core.diffuse},set specular(a){a=a!==!1,this._core.specular=a,this._renderer.imageDirty=!0,this.fire("specular",a)},get specular(){return this._core.specular},set ambient(a){a=a!==!1,this._core.ambient=a,this._renderer.imageDirty=!0,this.fire("ambient",a)},get ambient(){return this._core.ambient},set reflection(a){a=a!==!1,this._core.reflection=a,this._renderer.imageDirty=!0,this.fire("reflection",a)},get reflection(){return this._core.reflection},_compile:function(){this._renderer.flags=this._core},_getJSON:function(){return{picking:this.picking,clipping:this.clipping,transparent:this.transparent,backfaces:this.backfaces,frontface:this.frontface,backfaceLighting:this.backfaceLighting,backfaceTexturing:this.backfaceTexturing,diffuse:this.diffuse,specular:this.specular,ambient:this.ambient,reflection:this.reflection}}}),XEO.Frustum=XEO.Component.extend({className:"XEO.Frustum",type:"project",_init:function(a){this.mode="frustum",this.left=a.left,this.right=a.right,this.top=a.top,this.bottom=a.bottom,this.near=a.near,this.far=a.far;var b=this;this._onTick=this.scene.on("tick",function(){b._dirty&&b._rebuild()})},_rebuild:function(){var a=this._core;a.matrix=XEO.math.frustumMat4c(a.left,a.right,a.bottom,a.top,a.near,a.far,[]),a.mat?a.mat.set(a.matrix):a.mat=new Float32Array(a.matrix),this.fire("matrix",a.matrix),this._dirty=!1},set left(a){a=a||-1,this._core.left=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("left",a)},get left(){return this._core.left},set right(a){a=a||1,this._core.right=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("right",a)},get right(){return this._core.right},set top(a){a=a||1,this._core.top=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("top",a)},get top(){return this._core.top},set bottom(a){a=a||-1,this._core.bottom=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("bottom",a)},get bottom(){return this._core.bottom},set near(a){a=a||.1,this._core.near=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("near",a)},get near(){return this._core.near},set far(a){a=a||1e4,this._core.far=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("far",a)},get far(){return this._core.far},get matrix(){return this._dirty&&this._core.rebuild(),this._core.matrix.slice(0)},_compile:function(){this._renderer.cameraMat=this._core},_getJSON:function(){return{left:this.left,right:this.right,top:this.top,bottom:this.bottom,near:this.near,far:this.far}},_destroy:function(){this.scene.off(this._onTick)}}),XEO.Geometry=XEO.Component.extend({className:"XEO.Geometry",type:"geometry",_init:function(a){a.positions||a.normals||a.uv||!a.uv2||a.indices||(a.primitive="triangles",a.positions=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],a.colors=[1,1,1,1,1,0,0,1,0,1,0,1,0,0,1,1,1,1,0,1,1,0,1,1],a.normals=[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],a.uv=[1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],a.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),this.primitive=a.primitive,this.positions=a.positions,this.normals=a.normals,this.uv=a.uv,this.uv2=a.uv2,this.colors=a.colors,this.indices=a.indices,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",function(){}),this.scene.stats.inc("geometries")},set primitive(a){a=a||"triangles";var b,c=this.scene.canvas.gl;switch(a){case"points":b=c.POINTS;break;case"lines":b=c.LINES;break;case"line-loop":b=c.LINE_LOOP;break;case"line-strip":b=c.LINE_STRIP;break;case"triangles":b=c.TRIANGLES;break;case"triangle-strip":b=c.TRIANGLE_STRIP;break;case"triangle-fan":b=c.TRIANGLE_FAN;break;default:this.error("XEO.Geometry 'primitive' value is unsupported - should be either 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan' (defaulting to 'triangles')"),a="triangles",b=c.TRIANGLES}this._core.primitive=a,this._core.primitiveEnum=b,this.fire("dirty",!0),this.fire("primitive",b)},get primitive(){return this._core.primitive},set positions(a){this.fire("positions",a)},get positions(){},set normals(a){},get normals(){},set uv(a){},get uv(){},set uv2(a){},get uv2(){},set colors(a){},get colors(){},set indices(a){},get indices(){},get boundingBox(){},get boundingSphere(){},get center(){},_compile:function(){},_buildNormals:function(a){for(var b,c,d,e,f,g,h=a.positions,i=a.indices,j=new Array(h.length/3),k=0,l=i.length-3;l>k;k+=3){b=i[k+0],c=i[k+1],d=i[k+2],e=[h[3*b+0],h[3*b+1],h[3*b+2]],f=[h[3*c+0],h[3*c+1],h[3*c+2]],g=[h[3*d+0],h[3*d+1],h[3*d+2]],f=SceneJS_math_subVec4(f,e,[0,0,0,0]),g=SceneJS_math_subVec4(g,e,[0,0,0,0]);var m=SceneJS_math_normalizeVec4(SceneJS_math_cross3Vec4(f,g,[0,0,0,0]),[0,0,0,0]);j[b]||(j[b]=[]),j[c]||(j[c]=[]),j[d]||(j[d]=[]),j[b].push(m),j[c].push(m),j[d].push(m)}for(var n=new Array(h.length),k=0,l=j.length;l>k;k++){for(var o=j[k].length,p=0,q=0,r=0,s=0;o>s;s++)p+=j[k][s][0],q+=j[k][s][1],r+=j[k][s][2];n[3*k+0]=p/o,n[3*k+1]=q/o,n[3*k+2]=r/o}a.normals=n},_buildTangents:function(a){for(var b=a.positions,c=a.indices,d=a.uv,e=[],f=0;f<c.length;f+=3){var g=c[f],h=[b[3*g],b[3*g+1],b[3*g+2]],i=[d[2*g],d[2*g+1]];g=c[f+1];var j=[b[3*g],b[3*g+1],b[3*g+2]],k=[d[2*g],d[2*g+1]];g=c[f+2];for(var l=[b[3*g],b[3*g+1],b[3*g+2]],m=[d[2*g],d[2*g+1]],n=SceneJS_math_subVec3(j,h,[]),o=SceneJS_math_subVec3(l,h,[]),p=SceneJS_math_subVec2(k,i,[]),q=SceneJS_math_subVec2(m,i,[]),r=1/(p[0]*q[1]-p[1]*q[0]),s=SceneJS_math_mulVec3Scalar(SceneJS_math_subVec3(SceneJS_math_mulVec3Scalar(n,q[1],[]),SceneJS_math_mulVec3Scalar(o,p[1],[]),[]),r,[]),t=0;3>t;t++){var u=c[f+t];e[u]="undefined"!=typeof e[u]?SceneJS_math_addVec3(e[u],s,[]):s}}for(var v=[],w=0;w<e.length;w++)v=v.concat(e[w]);return v},_getJSON:function(){var a={primitive:this.primitive};return this._core.positions&&(a.positions=this.positions),this._core.normals&&(a.normals=this.normals),this._core.uv&&(a.uv=this.uv),this._core.uv2&&(a.uv2=this.uv2),this._core.colors&&(a.colors=this.colors),this._core.indices&&(a.indices=this.indices),a},_destroy:function(){this.scene.stats.dec("geometries"),this.scene.canvas.off(this._webglContextRestored)}}),XEO.Input=XEO.Component.extend({className:"XEO.Input",type:"input",_init:function(a){var b=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,document.addEventListener("keydown",this._keyDownListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!0:a.altKey?b.altDown=!0:(b.keyDown[a.keyCode]=!0,b.fire("keydown",a.keyCode,!0)))},!0),document.addEventListener("keyup",this._keyUpListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!1:a.altKey?b.altDown=!1:(b.keyDown[a.keyCode]=!1,b.fire("keyup",a.keyCode,!0)))}),a.canvas.mousedown(this._mouseDownListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!0;break;case 2:b.mouseDownMiddle=!0;break;case 3:b.mouseDownRight=!0}var c=b._getClickCoordsWithinElement(a);b.fire("mousedown",c,!0)}}),a.canvas.mouseup(this._mouseUpListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("mouseup",c,!0)}}),a.canvas.dblclick(this._dblClickListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1,b.mouseDownRight=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownLeft=!1,b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("dblclick",c,!0)}}),a.canvas.mousemove(this._mouseMoveListener=function(a){if(b.enabled){var c=b._getClickCoordsWithinElement(a);b.fire("mousedown",c,!0)}}),a.canvas.bind("mousewheel",this._mouseWheelListener=function(a,c){b.enabled&&b.fire("mousewheel",{event:a,d:c},!0)}),function(){var a,c;b.on("mousedown",function(b){a=b.x,c=b.y}),b.on("mouseup",function(d){a==d.x&&c==d.y&&b.fire("mouseclicked",d,!0)})}()},_getClickCoordsWithinElement:function(a){var b={x:0,y:0};if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b.x=a.pageX-d,b.y=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b},setEnabled:function(a){this.enabled!=a&&this.fire("enabled",this.enabled=a)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}}),XEO.Layer=XEO.Component.extend({className:"XEO.Layer",type:"layer",_init:function(a){this.priority=a.priority},set priority(a){a=a||0,this._core.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",a)},get priority(){return this._core.priority},_compile:function(){this._renderer.layer=this._core},_getJSON:function(){return{priority:this.priority}}}),XEO.Lights=XEO.Component.extend({className:"XEO.Lights",type:"lights",_init:function(a){this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],this.lights=a.lights},set lights(a){for(var b,c=0,d=this._lights.length;d>c;c++)b=this._lights[c],b.off(this._dirtySubs[c]),b.off(this._destroyedSubs[c]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];for(var e=[],f=this,c=0,d=a.length;d>c;c++){if(b=a[c],XEO._isString(b)){var g=b;if(b=this.components[g],!b){this.error("Light not found for ID: '"+g+"'");continue}}"light"==b.type?(this._lights.push(b),this._dirtySubs.push(b.on("dirty",function(){f.fire("dirty",!0)})),this._destroyedSubs.push(b.on("destroyed",function(){for(var a=this.id,b=0,c=f._lights.length;c>b;b++)if(f._lights[b].id==a)return f._lights=f._lights.slice(b,b+1),f._dirtySubs=f._dirtySubs.slice(b,b+1),f._destroyedSubs=f._destroyedSubs.slice(b,b+1),f.fire("dirty",!0),void f.fire("lights",f._lights)})),e.push(b)):this.error("Component is not a light: '"+b.id+"'")}this.fire("dirty",!0),this.fire("lights",this._lights)},get lights(){return this._lights.slice(0,this._lights.length)},_compile:function(){for(var a=[],b=0,c=this._lights.length;c>b;b++)a.push(this._lights[b]._core);var d={type:"lights",lights:a,hash:this._makeHash(a)};this._renderer.lights=d},_makeHash:function(a){if(0==a.length)return"";for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],c.push(b.mode),b.specular&&c.push("s"),b.diffuse&&c.push("d"),c.push("world"==b.space?"w":"v");return c.join("")},_getJSON:function(){for(var a=[],b=0,c=this._lights.length;c>b;b++)a.push(this._lights[b].id);return{lights:a}}}),XEO.Lookat=XEO.Component.extend({className:"XEO.Lookat",type:"lookat",_init:function(a){this.eye=a.eye,this.look=a.look,this.up=a.up;var b=this._core,c=this;b.rebuild=function(){b.matrix=XEO.math.lookAtMat4c(b.eye[0],b.eye[1],b.eye[2],b.look[0],b.look[1],b.look[2],b.up[0],b.up[1],b.up[2]),b.lookAt={eye:b.eye,look:b.look,up:b.up},b.mat?(b.mat.set(b.matrix),b.normalMat.set(XEO.math.transposeMat4(XEO.math.inverseMat4(b.matrix,XEO.math.mat4())))):(b.mat=new Float32Array(b.matrix),b.normalMat=new Float32Array(XEO.math.transposeMat4(XEO.math.inverseMat4(b.matrix,XEO.math.mat4())))),c.fire("matrix",b.matrix),b.dirty=!1},this._core.dirty=!0},set eye(a){a=a||[0,0,-10],this._core.eye=a,this._core.dirty=!0,this._renderer.imageDirty=!0,this.fire("eye",a)},get eye(){return this._core.eye},set look(a){a=a||[0,0,0],this._core.look=a,this._core.dirty=!0,this._renderer.imageDirty=!0,this.fire("look",a)},get look(){return this._core.look},set up(a){a=a||[0,1,0],this._core.up=a,this._core.dirty=!0,this._renderer.imageDirty=!0,this.fire("up",a)},get up(){return this._core.up},get matrix(){return this._core.dirty&&this._core.rebuild(),this._core.matrix.slice(0)},_compile:function(){this._renderer.viewTransform=this._core},_getJSON:function(){return{eye:this.eye,look:this.look,up:this.up}}}),XEO.Scene.prototype.newLookat=function(a){return new XEO.Lookat(this,a)},XEO.Matrix=XEO.Component.extend({className:"XEO.Matrix",type:"transform",_init:function(a){this.elements=a.elements},set elements(a){a=a||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this._core.elements=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("elements",a)},get elements(){return this._core.elements},_compile:function(){},_getJSON:function(){return{elements:this._core.elements}}}),XEO.Material=XEO.Component.extend({className:"XEO.Material",type:"material",_init:function(a){this._textures=[],this._dirtyTextureSubs=[],this._destroyedTextureSubs=[],this.ambient=a.ambient,this.diffuse=a.diffuse,this.specular=a.specular,this.emissive=a.emissive,this.opacity=a.opacity,this.shininess=a.shininess,this.reflectivity=a.reflectivity,this.bumpMap=a.bumpMap,this.diffuseMap=a.diffuseMap,this.specularMap=a.specularMap,this.emissiveMap=a.emissiveMap,this.opacityMap=a.opacityMap,this.reflectivityMap=a.reflectivityMap},set ambient(a){a=a||[1,1,1],this._core.ambient=a,this._renderer.imageDirty=!0,this.fire("ambient",a)},get ambient(){return this._core.ambient},set diffuse(a){a=a||[1,1,1],this._core.diffuse=a,this._renderer.imageDirty=!0,this.fire("diffuse",a)},get diffuse(){return this._core.diffuse},set specular(a){a=a||[.3,.3,.3],this._core.specular=a,this._renderer.imageDirty=!0,this.fire("specular",a)},get specular(){return this._core.specular},set emissive(a){a=a||[1,1,1],this._core.emissive=a,this._renderer.imageDirty=!0,this.fire("emissive",a)},get emissive(){return this._core.emissive},set opacity(a){a=void 0!=a?a:1,this._core.opacity=a,this._renderer.imageDirty=!0,this.fire("opacity",a)},get opacity(){return this._core.opacity},set shininess(a){a=void 0!=a?a:30,this._core.shininess=a,this._renderer.imageDirty=!0,this.fire("shininess",a)},get shininess(){return this._core.shininess},set reflectivity(a){a=void 0!=a?a:1,this._core.reflectivity=a,this._renderer.imageDirty=!0,this.fire("reflectivity",a)},get reflectivity(){return this._core.reflectivity},set diffuseMap(a){this._attachTexture("diffuseMap",a)},get diffuseMap(){return this._textures.diffuseMap},set specularMap(a){this._attachTexture("specularMap",a)},get specularMap(){return this._textures.specularMap},set emissiveMap(a){this._attachTexture("emissiveMap",a)},get emissiveMap(){return this._textures.emissiveMap},set opacityMap(a){this._attachTexture("opacityMap",a)},get opacityMap(){return this._textures.opacityMap},set reflectivityMap(a){this._attachTexture("reflectivityMap",a)},get reflectivityMap(){return this._textures.reflectivityMap},_attachTexture:function(a,b){if(XEO._isString(b)){var c=b;if(b=this.scene.components[c],!b)return void this.error("Texture not found for ID: '"+c+"'")}if("texture"!=b.type)return void this.error("Component is not a texture: '"+c+"'");var d=this._textures[a];d&&(d.off(this._dirtyTextureSubs[a]),d.off(this._destroyedTextureSubs[a]));var e=this;this._dirtyTextureSubs[a]=b.on("dirty",function(){e.fire("dirty",!0)}),this._dirtyTextureSubs[a]=b.on("destroyed",function(){delete e._dirtyTextureSubs[a],delete e._destroyedTextureSubs[a],e.fire("dirty",!0),e.fire(a,null)
}),this._textures[a]=b,this.fire(a,b)},_compile:function(){this._renderer.material=this._core;for(var a=[],b=0,c=this._textures.length;c>b;b++)a.push(this._textures[b]._core);var d={type:"texture",bumpMap:this.bumpMap?this.bumpMap._core:null,diffuseMap:this.diffuseMap?this.diffuseMap._core:null,specularMap:this.specularMap?this.specularMap._core:null,emissiveMap:this.emissiveMap?this.emissiveMap._core:null,opacityMap:this.opacityMap?this.opacityMap._core:null,reflectivityMap:this.reflectivityMap?this.reflectivityMap._core:null,hash:this._makeTexturesHash()};this._renderer.texture=d},_makeTexturesHash:function(){var a=[];return this.bumpMap&&(a.push("/b"),this.bumpMap.matrix&&a.push("/anim")),this.diffuseMap&&(a.push("/d"),this.bumpMap.matrix&&a.push("/anim")),this.specularMap&&(a.push("/s"),this.bumpMap.matrix&&a.push("/anim")),this.emissiveMap&&(a.push("/e"),this.bumpMap.matrix&&a.push("/anim")),this.opacityMap&&(a.push("/o"),this.bumpMap.matrix&&a.push("/anim")),this.reflectivityMap&&(a.push("/r"),this.bumpMap.matrix&&a.push("/anim")),a.join("")},_getJSON:function(){var a={ambient:this.ambient,diffuse:this.diffuse,specular:this.specular,emissive:this.emissive,opacity:this.opacity,shininess:this.shininess,reflectivity:this.reflectivity};return this.bumpMap&&(a.bumpMap=this.bumpMap.id),this.diffuseMap&&(a.diffuseMap=this.diffuseMap.id),this.specularMap&&(a.specularMap=this.specularMap.id),this.emissiveMap&&(a.emissiveMap=this.emissiveMap.id),this.opacityMap&&(a.opacityMap=this.opacityMap.id),this.reflectivityMap&&(a.reflectivityMap=this.reflectivityMap.id),a}}),XEO.GameObject=XEO.Component.extend({className:"XEO.GameObject",type:"object",_init:function(a){this.camera=a.camera,this.clips=a.clips,this.colorTarget=a.colorTarget,this.colorBuf=a.colorBuf,this.depthTarget=a.depthTarget,this.depthBuf=a.depthBuf,this.visibility=a.visibility,this.modes=a.modes,this.geometry=a.geometry,this.layer=a.layer,this.lights=a.lights,this.material=a.material,this.morphTargets=a.morphTargets,this.reflect=a.reflect,this.shader=a.shader,this.shaderParams=a.shaderParams,this.stage=a.stage,this.transform=a.transform},set camera(a){this._setChild("camera",a)},get camera(){return this._children.camera},set clips(a){this._setChild("clips",a)},get clips(){return this._children.clips},set colorTarget(a){this._setChild("colorTarget",a)},get colorTarget(){return this._children.colorTarget},set colorBuf(a){this._setChild("colorBuf",a)},get colorBuf(){return this._children.colorBuf},set depthTarget(a){this._setChild("depthTarget",a)},get depthTarget(){return this._children.depthTarget},set depthBuf(a){this._setChild("depthBuf",a)},get depthBuf(){return this._children.depthBuf},set visibility(a){this._setChild("visibility",a)},get visibility(){return this._children.visibility},set modes(a){this._setChild("modes",a)},get modes(){return this._children.modes},set geometry(a){this._setChild("geometry",a)},get geometry(){return this._children.geometry},set layer(a){this._setChild("layer",a)},get layer(){return this._children.layer},set lights(a){this._setChild("lights",a)},get lights(){return this._children.lights},set material(a){this._setChild("material",a)},get material(){return this._children.material},set morphTargets(a){this._setChild("morphTargets",a)},get morphTargets(){return this._children.morphTargets},set reflect(a){this._setChild("reflect",a)},get reflect(){return this._children.reflect},set shader(a){this._setChild("shader",a)},get shader(){return this._children.shader},set shaderParams(a){this._setChild("shaderParams",a)},get shaderParams(){return this._children.shaderParams},set stage(a){this._setChild("stage",a)},get stage(){return this._children.stage},set transform(a){this._setChild("transform",a)},get transform(){return this._children.transform},_compile:function(){var a=this._children;a.camera._compile(),a.clips._compile(),a.colorTarget._compile(),a.colorBuf._compile(),a.depthTarget._compile(),a.depthBuf._compile(),a.visibility._compile(),a.modes._compile(),a.geometry._compile(),a.layer._compile(),a.lights._compile(),a.material._compile(),a.morphTargets._compile(),a.reflect._compile(),a.shader._compile(),a.shaderParams._compile(),a.stage._compile(),a.transform._compile(),this._renderer.buildGameObject(this.id)},_getJSON:function(){return{camera:this.camera.id,clips:this.clips.id,colorTarget:this.colorTarget.id,colorBuf:this.colorBuf.id,depthTarget:this.depthTarget.id,depthBuf:this.depthBuf.id,visibility:this.visibility.id,modes:this.modes.id,geometry:this.geometry.id,layer:this.layer.id,lights:this.lights.id,material:this.material.id,morphTargets:this.morphTargets.id,reflect:this.reflect.id,shader:this.shader.id,shaderParams:this.shaderParams.id,stage:this.stage.id,transform:this.transform.id}},_destroy:function(){this._renderer.removeGameObject(this.id)}}),XEO.Ortho=XEO.Component.extend({className:"XEO.Ortho",type:"project",_init:function(a){this.mode="ortho",this.left=a.left,this.right=a.right,this.top=a.top,this.bottom=a.bottom,this.near=a.near,this.far=a.far;var b=this;this._onTick=this.scene.on("tick",function(){b._dirty&&b._rebuild()})},_rebuild:function(){var a=this._core;a.matrix=XEO.math.orthoMat4c(a.left,a.right,a.bottom,a.top,a.near,a.far,[]),a.mat?a.mat.set(a.matrix):a.mat=new Float32Array(a.matrix),this.fire("matrix",a.matrix),this._dirty=!1},set left(a){a=a||-1,this._core.left=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("left",a)},get left(){return this._core.left},set right(a){a=a||1,this._core.right=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("right",a)},get right(){return this._core.right},set top(a){a=a||1,this._core.top=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("top",a)},get top(){return this._core.top},set bottom(a){a=a||-1,this._core.bottom=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("bottom",a)},get bottom(){return this._core.bottom},set near(a){a=a||.1,this._core.near=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("near",a)},get near(){return this._core.near},set far(a){a=a||1e4,this._core.far=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("far",a)},get far(){return this._core.far},get matrix(){return this._dirty&&this._core.rebuild(),this._core.matrix.slice(0)},_compile:function(){this._renderer.cameraMat=this._core},_getJSON:function(){return{left:this.left,right:this.right,top:this.top,bottom:this.bottom,near:this.near,far:this.far}},_destroy:function(){this.scene.off(this._onTick)}}),XEO.Perspective=XEO.Component.extend({className:"XEO.Perspective",type:"project",_init:function(a){this.mode="perspective";var b=this.scene.canvas;this.fovy=a.fovy,this.aspect=b.width/b.height,this.near=a.near,this.far=a.far;var c=this;this._canvasResized=this.scene.canvas.on("resized",function(){c.aspect=b.width/b.height}),this._tick=this.scene.on("tick",function(){c._dirty&&c._rebuild()})},_rebuild:function(){var a=this._core;a.matrix=XEO.math.perspectiveMatrix4(a.fovy*Math.PI/180,a.aspect,a.near,a.far),a.mat?a.mat.set(a.matrix):a.mat=new Float32Array(a.matrix),this.fire("matrix",a.matrix),this._dirty=!1},set fovy(a){a=a||60,this._core.fovy=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("fovy",a)},get fovy(){return this._core.fovy},set aspect(a){a=a||1,this._core.aspect=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("aspect",a)},get aspect(){return this._core.aspect},set near(a){a=a||.1,this._core.near=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("near",a)},get near(){return this._core.near},set far(a){a=a||1e4,this._core.far=a,this._dirty=!0,this._renderer.imageDirty=!0,this.fire("far",a)},get far(){return this._core.far},get matrix(){return this._dirty&&this._core.rebuild(),this._core.matrix.slice(0)},_compile:function(){this._renderer.cameraMat=this._core},_getJSON:function(){return{fovy:this.fovy,aspect:this.aspect,near:this.near,far:this.far}},_destroy:function(){this.scene.canvas.off(this._canvasResized),this.scene.off(this._tick)}}),XEO.Scene.prototype.newPerspective=function(a){return new XEO.Perspective(this,a)},XEO.PointLight=XEO.Component.extend({className:"XEO.PointLight",type:"light",_init:function(a){this.mode="point",this._core.mode=this.mode,this.pos=a.pos,this.diffuse=a.diffuse,this.specular=a.specular,this.constantAttenuation=a.constantAttenuation,this.linearAttenuation=a.linearAttenuation,this.quadraticAttenuation=a.quadraticAttenuation,this.space=a.space},set pos(a){a=a||[1,1,1],this._core.pos=a,this._renderer.imageDirty=!0,this.fire("pos",a)},get pos(){return this._core.pos},set diffuse(a){a=a||[.7,.7,.8],this._core.diffuse=a,this._renderer.imageDirty=!0,this.fire("diffuse",a)},get diffuse(){return this._core.diffuse},set specular(a){a=a||[.7,.7,.8],this._core.specular=a,this._renderer.imageDirty=!0,this.fire("specular",a)},get specular(){return this._core.specular},set constantAttenuation(a){a=a||0,this._core.constantAttenuation=a,this._renderer.imageDirty=!0,this.fire("constantAttenuation",a)},get constantAttenuation(){return this._core.constantAttenuation},set linearAttenuation(a){a=a||0,this._core.linearAttenuation=a,this._renderer.imageDirty=!0,this.fire("linearAttenuation",a)},get linearAttenuation(){return this._core.linearAttenuation},set quadraticAttenuation(a){a=a||0,this._core.quadraticAttenuation=a,this._renderer.imageDirty=!0,this.fire("quadraticAttenuation",a)},get quadraticAttenuation(){return this._core.quadraticAttenuation},set space(a){a=a||"view",a!=this._core.space&&(this._core.space=a,this.fire("dirty",!0),this.fire("space",a))},get space(){return this._core.space},_getJSON:function(){return{mode:this.mode,pos:this.pos,diffuse:this.diffuse,specular:this.specular,constantAttenuation:this.constantAttenuation,linearAttenuation:this.linearAttenuation,quadraticAttenuation:this.quadraticAttenuation,space:this.space}}}),XEO.Scene=XEO.Component.extend({className:"XEO.Scene",type:"scene",_init:function(a){var b=this;this._componentIDMap=new XEO.utils.Map,this.components={},this._dirtyGameObjects={},this.configs=new XEO.Configs(this,a.configs),this.canvas=new XEO.Canvas(this,{canvas:a.canvas,contextAttr:a.contextAttr||{}}),this.canvas.on("webglContextFailed",function(){alert("XeoEngine failed to find WebGL")}),this._renderer=new XEO.Renderer({canvas:this.canvas,transparent:a.transparent}),this.input=new XEO.Input(this,this.canvas.canvas),this.tasks=new XEO.Tasks(this),this.stats=new XEO.Stats(this,{objects:0,geometries:0,textures:0}),this.engine._addScene(this);var c=a.components;if(c)for(var d,e,f,g=0,h=c.length;h>g;g++)d=c[g],e=d.className,e&&(f=window[e],f&&new f(this,d));this.camera,this.clips,this.colorTarget,this.colorBuf,this.depthTarget,this.depthBuf,this.visibility,this.modes,this.geometry,this.layer,this.lights,this.material,this.morphTargets,this.reflect,this.shader,this.shaderParams,this.stage,this.transform,this.engine.on("tick",function(a){b.fire("tick",a)})},_addComponent:function(a){if(a.id){if(this.components[a.id])return void this.error("A component with this ID already exists in this Scene: "+a.id)}else a.id=this._componentIDMap.addItem({});this.components[a.id]=a;var b="object"==a.type,c=this;a.on("destroyed",function(){c._componentIDMap.removeItem(a.id),delete c.components[a.id],b&&(c.stats.dec("objects"),delete c._dirtyGameObjects[a.id],c.fire("dirty",!0)),c.fire("componentDestroyed",a,!0)}),b&&(this.stats.inc("objects"),a.on("dirty",function(){c._dirtyGameObjects[a.id]||(c._dirtyGameObjects[a.id]=object),c.fire("dirty",!0)})),this.fire("componentCreated",a,!0)},get project(){return this.components["default.project"]||new XEO.Perspective(this,{id:"default.project"})},get view(){return this.components["default.view"]||new XEO.Lookat(this,{id:"default.view"})},get camera(){return this.components["default.camera"]||new XEO.Camera(this,{id:"default.camera",project:"default.view",view:"default.lookat"})},get transform(){return this.components["default.transform"]||new XEO.Matrix(this,{id:"default.transform"})},get clips(){return this.components["default.clips"]||new XEO.Clips(this,{id:"default.clips"})},get colorBuf(){return this.components["default.colorBuf"]||new XEO.ColorBuf(this,{id:"default.colorBuf"})},get colorTarget(){return this.components["default.colorTarget"]||new XEO.ColorTarget(this,{id:"default.colorTarget"})},get depthBuf(){return this.components["default.depthBuf"]||new XEO.DepthBuf(this,{id:"default.depthBuf"})},get depthTarget(){return this.components["default.depthTarget"]||new XEO.DepthTarget(this,{id:"default.colorTarget"})},get visibility(){return this.components["default.visibility"]||new XEO.Visibility(this,{id:"default.visibility",enabled:!0})},get modes(){return this.components["default.modes"]||new XEO.Modes(this,{id:"default.modes"})},get geometry(){return this.components["default.geometry"]||new XEO.Geometry(this,{id:"default.geometry"})},get layer(){return this.components["default.layer"]||new XEO.Layer(this,{id:"default.layer",priority:0})},get lights(){return this.components["default.lights"]||new XEO.Lights(this,{id:"default.lights",lights:[new XEO.AmbientLight(this,{id:"default.light0",color:[.7,.7,.7]}),new XEO.DirLight(this,{id:"default.light1",dir:[-.5,-.5,-1],color:[1,1,1],specular:!0,diffuse:!0,space:"view"}),new XEO.DirLight(this,{id:"default.light2",dir:[1,-.9,-.7],color:[1,1,1],specular:!0,diffuse:!0,space:"view"})]})},get material(){return this.components["default.material"]||new XEO.Material(this,{id:"default.material"})},get morphTargets(){return this.components["default.morphTargets"]||new XEO.MorphTargets(this,{id:"default.morphTargets"})},get reflect(){return this.components["default.reflect"]||new XEO.Reflect(this,{id:"default.reflect"})},get shader(){return this.components["default.shader"]||this.components["default.shader"]||new XEO.Shader(this,{id:"default.shader"})},get shaderParams(){return this.components["default.shaderParams"]||new XEO.ShaderParams(this,{id:"default.shaderParams"})},get stage(){return this.components["default.stage"]||new XEO.Stage(this,{id:"default.stage",priority:0})},clear:function(){var a;for(var b in this.components)this.components.hasOwnProperty(b)&&(a=this.components[b],!a.id!=this.id&&a.destroy());this._dirtyGameObjects={}},_compile:function(){for(var a in this._dirtyGameObjects)this._dirtyGameObjects.hasOwnProperty(a)&&this._dirtyGameObjects[i]._compile();this._dirtyGameObjects={},this._renderer.render({clear:0==i})},_getJSON:function(){var a=[];for(var b in this.components)this.components.hasOwnProperty(b)&&a.push(this.components[b]);a.sort(function(a,b){return a._componentOrder-b._componentOrder});for(var c=[],d=0,e=a.length;e>d;d++)c.push(a[d].json);return{components:c}},_destroy:function(){this.clear()}}),XEO.Engine.prototype.newScene=function(a){return new XEO.Scene(this,a)},XEO.Shader=XEO.Component.extend({className:"XEO.Shader",type:"shader",_init:function(a){this._core.shaders={},this.vertex=a.vertex,this.fragment=a.fragment,this.setParams(a.params)},set vertex(a){this._core.shaders.vertex=a,this.fire("dirty",!0),this.fire("vertex",a)},get vertex(){return this._core.shaders.vertex},set fragment(a){this._core.shaders.fragment=a,this.fire("dirty",!0),this.fire("fragment",a)},get fragment(){return this._core.shaders.fragment},setParams:function(a){this._core.params=this._core.params||{};for(var b in a)a.hasOwnProperty(b)&&(this._core.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._core.params)},get params(){return this._core.params},_compile:function(){this._renderer.shader=this._core},_getJSON:function(){return{vertex:this.vertex,fragment:this.fragment,params:this.params}}}),XEO.ShaderParams=XEO.Component.extend({className:"XEO.ShaderParams",type:"shaderParams",_init:function(a){this.setParams(a.params)},setParams:function(a){this._core.params=this._core.params||{};for(var b in a)a.hasOwnProperty(b)&&(this._core.params[b]=a[b]);this._renderer.imageDirty=!0,this.fire("params",this._core.params)},get params(){return this._core.params},_compile:function(){this._renderer.shader=this._core},_getJSON:function(){return{params:this.params}}}),XEO.Stage=XEO.Component.extend({className:"XEO.Stage",type:"stage",_init:function(a){this.priority=a.priority,this.pickable=a.pickable},set priority(a){a=a||0,this._core.priority=a,this._renderer.stateOrderDirty=!0,this.fire("priority",a)},get priority(){return this._core.priority},set pickable(a){a=a!==!1,this._core.pickable=a,this._renderer.drawListDirty=!0,this.fire("pickable",a)},get pickable(){return this._core.pickable},_compile:function(){this._renderer.stage=this._core},_getJSON:function(){return{priority:this.priority,pickable:this.pickable}}}),XEO.Stats=XEO.Component.extend({className:"XEO.Stats",type:"stats",_init:function(a){for(var b in a)a.hasOwnProperty(b)&&this.fire(b,a[b])},clear:function(){},inc:function(a){this.fire(a,(this.props[a]||0)+1)},dec:function(a){this.fir(a,(this.props[a]||0)-1)},zero:function(a){this.fire(a,0)},_toJSON:function(){return XEO._copy(this.props)}}),XEO.Task=function(a,b){this._init(a.engine,"task['"+b.id+"']"),this.tasks=a,this.id=b.id,this.description=b.description||"",this.failed=!1,this.completed=!1},XEO._extend(XEO.Task,XEO.Component),XEO.Task.prototype.setCompleted=function(){this.fire("completed",this.completed=!0)},XEO.Task.prototype.setFailed=function(){this.fire("failed",this.failed=!0)},XEO.Task._destroy=function(){!this.completed&&this.destroyed&&this.setCompleted()},XEO.Tasks=function(a){this._init(a,"tasks"),this._idMap=new XEO.utils.Map,this.tasks={}},XEO._extend(XEO.Tasks,XEO.Component),XEO.Tasks.prototype.create=function(a){if(a=a||{},a.id){if(this.tasks[a.id])return this.error("A task with this ID already exists: "+a.id),null}else a.id=this._idMap.addItem({});var b=this.tasks[a.id]=new XEO.Tasks.Task(this,a),c=this;return b.on("completed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("completed",b,!0)}),b.on("failed",function(){delete c.tasks[b.id],c._idMap.removeItem(b.id),c.fire("failed",b,!0)}),c.fire("started",b,!0),b},XEO.Tasks.prototype.setCompleted=function(a){var b=this.tasks[a];return b?void b.fire("completed",b,!0):void this.error("Task not found:"+a)},XEO.Tasks.prototype.setFailed=function(a){var b=this.tasks[a];return b?void b.fire("failed",b,!0):void this.error("Task not found:"+a)},XEO.Tasks.prototype.clear=function(){for(var a in this.tasks)this.tasks.hasOwnProperty(a)&&this.tasks[a].setCompleted()},XEO.Texture=XEO.Component.extend({className:"XEO.Texture",type:"texture",_init:function(a){this._srcDirty=!1,this._textureDirty=!1,this.minFilter=a.minFilter,this.magFilter=a.magFilter,this.wrapS=a.wrapS,this.wrapT=a.wrapT,this.isDepth=a.isDepth,this.depthMode=a.depthMode,this.depthCompareMode=a.depthCompareMode,this.depthCompareFunc=a.depthCompareFunc,this.flipY=a.flipY,this.width=a.width,this.height=a.height,this.internalFormat=a.internalFormat,this.sourceFormat=a.sourceFormat,this.sourceType=a.sourceType,this.translate=a.translate,this.scale=a.scale,this.rotate=a.rotate,a.src?this.src=a.src:a.target&&(this.target=a.target);var b=this._core;b.waitForLoad=a.waitForLoad!==!1,b.texture=null,b.matrix=null,b._matrixDirty=!0,b._textureDirty=!0,b.buildMatrix=function(){self._buildMatrix(b)},b.buildMatrix.call(this._core),a.src?(this._core.src=a.src,this._loadTexture(a.src)):a.image?(this._core.image=a.image,this._initTexture(a.image)):a.target&&this.scene.getComponent(a.target,function(a){self.setTarget(a)}),this._webglContextRestored=this.scene.canvas.on("webglContextRestored",function(){self._core.src?self._loadTexture(self._core.src):self._core.image?self._initTexture(self._core.image):self._core.target}),this.scene.stats.inc("textures")},set src(a){this._core.image=null,this._core.src=a,this._core.target=null;var b=this;this.scene.once("tick",function(){b._loadTexture(b._core.src)}),this._srcDirty=!0,this.fire("src",a)},get src(){return this._core.src},set target(a){this._setChild("renderBuf",a),this._core.image=null,this._core.src=null,this._core.target=null,this._targetDirty=!0,this._setDirty(),this.fire("target",a)},get target(){return this._children.renderBuf},set translate(a){a=a||[0,0,0],this._core.translate=a,this._core._matrixDirty=!0,this.fire("translate",a)},get translate(){return this._core.translate},set scale(a){a=a||[1,1,1],this._core.scale=a,this._core._matrixDirty=!0,this.fire("scale",a)},get scale(){return this._core.scale},set rotate(a){a=a||0,this._core.rotate=a,this._core._matrixDirty=!0,this.fire("rotate",a)},get rotate(){return this._core.rotate},set minFilter(a){a=a||"linearMipMapNearest",this._core.minFilter=a,this.fire("minFilter",a)},get minFilter(){return this._core.minFilter},set magFilter(a){a=a||"linear",this._core.magFilter=a,this.fire("magFilter",a)},get magFilter(){return this._core.magFilter},set wrapS(a){a=a||"repeat",this._core.wrapS=a,this.fire("wrapS",a)},get wrapS(){return this._core.wrapS},set wrapT(a){a=a||"repeat",this._core.wrapT=a,this.fire("wrapT",a)},get wrapT(){return this._core.wrapT},set isDepth(a){a=a===!0,this._core.isDepth=a,this.fire("isDepth",a)},get isDepth(){return this._core.isDepth},set depthMode(a){a=a||"luminance",this._core.depthMode=a,this.fire("depthMode",a)},get depthMode(){return this._core.depthMode},set depthCompareMode(a){a=a||"compareRToTexture",this._core.depthCompareMode=a,this.fire("depthCompareMode",a)},get depthCompareMode(){return this._core.depthCompareMode},set depthCompareFunc(a){a=a||"lequal",this._core.depthCompareFunc=a,this.fire("depthCompareFunc",a)},get depthCompareFunc(){return this._core.depthCompareFunc},set flipY(a){a=a!==!1,this._core.flipY=a,this.fire("flipY",a)},get flipY(){return this._core.flipY},set width(a){a=void 0!=a?a:1,this._core.width=a,this.fire("width",a)},get width(){return this._core.width},set height(a){a=void 0!=a?a:1,this._core.height=a,this.fire("height",a)},get height(){return this._core.height},set internalFormat(a){a=a||"alpha",this._core.internalFormat=a,this.fire("internalFormat",a)},get internalFormat(){return this._core.internalFormat},set sourceFormat(a){a=a||"alpha",this._core.sourceFormat=a,this.fire("sourceFormat",a)},get sourceFormat(){return this._core.sourceFormat},set sourceType(a){a=a||"unsignedByte",this._core.sourceType=a,this.fire("sourceType",a)},get sourceType(){return this._core.sourceType},set image(a){this.fire("image",a)},get image(){},_buildMatrix:function(){var a,b;(0!=this.translate.x||0!=this.translate.y)&&(a=XEO.math.translationMat4v([this.translate.x||0,this.translate.y||0,0])),(1!=this.scale.x||1!=this.scale.y)&&(b=XEO.math.scalingMat4v([this.scale.x||1,this.scale.y||1,1]),a=a?XEO.math.mulMat4(a,b):b),0!=this.rotate&&(b=XEO.math.rotationMat4v(.0174532925*this.rotate,[0,0,1]),a=a?XEO.math.mulMat4(a,b):b),a&&(this.matrix=a,this.matrixAsArray?this.matrixAsArray.set(this.matrix):this.matrixAsArray=new Float32Array(this.matrix)),this._matrixDirty=!1},_loadTexture:function(a){var b=this,c=this.scene.tasks.create({description:"Loading texture"}),d=new Image;d.onload=function(){b._initTexture(d),c.setCompleted()},d.onerror=function(){c.setFailed()},0==a.indexOf("data")?d.src=a:(d.crossOrigin="Anonymous",d.src=a)},_initTexture:function(a){var b=!!this._core.texture,c=this.scene.canvas.gl,d=b?this._core.texture.texture:c.createTexture();c.bindTexture(c.TEXTURE_2D,d),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,this._ensureImageSizePowerOfTwo(a)),b||(this._core.texture=new XEO.webgl.Texture2D(c,{texture:d,minFilter:this._getGLOption("minFilter",c.LINEAR_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",c.LINEAR),wrapS:this._getGLOption("wrapS",c.REPEAT),wrapT:this._getGLOption("wrapT",c.REPEAT),isDepth:this._getOption(this._core.isDepth,!1),depthMode:this._getGLOption("depthMode",c.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",c.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",c.LEQUAL),flipY:this._getOption(this._core.flipY,!0),width:this._getOption(this._core.width,1),height:this._getOption(this._core.height,1),internalFormat:this._getGLOption("internalFormat",c.LEQUAL),sourceFormat:this._getGLOption("sourceType",c.ALPHA),sourceType:this._getGLOption("sourceType",c.UNSIGNED_BYTE),update:null}),this.destroyed&&this._core.texture.destroy()),this._renderer.imageDirty=!0},_ensureImageSizePowerOfTwo:function(a){if(!this._isPowerOfTwo(a.width)||!this._isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=this._nextHighestPowerOfTwo(a.width),b.height=this._nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b,a.crossOrigin=""}return a},_isPowerOfTwo:function(a){return 0==(a&a-1)},_nextHighestPowerOfTwo:function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},_getGLOption:function(a,b){var c=this.scene.canvas.gl,d=this._core[a];if(void 0==d)return b;var e=XEO.webgl.enums[d];if(void 0==e)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_COMPONENT_CONFIG,"Unrecognised value for texture component property '"+a+"' value: '"+d+"'");return c[e]},_getOption:function(a,b){return void 0==a?b:a},_getJSON:function(){var a={translate:this.translate,scale:this.scale,rotate:this.rotate,minFilter:this.minFilter,magFilter:this.magFilter,wrapS:this.wrapS,wrapT:this.wrapT,isDepth:this.isDepth,depthMode:this.depthMode,depthCompareMode:this.depthCompareMode,depthCompareFunc:this.depthCompareFunc,flipY:this.flipY,width:this.width,height:this.height,internalFormat:this.internalFormat,sourceFormat:this.sourceFormat,sourceType:this.sourceType};return this.src?a.src=this.src:this.target&&(a.target=this.target.id),a},_destroy:function(){this.scene.off(this._tick),this.scene.canvas.off(this._webglContextRestored),this.scene.stats.dec("textures")}}),XEO.utils=XEO.utils||{},XEO.utils.Map=function(a,b){this.items=a||[],b=_baseId||0;var c=b+1;this.addItem=function(){var a;if(2==arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(;;){a=arguments[0];var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}},XEO.math={createUUID:function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;36>e;e++)8==e||13==e||18==e||23==e?c[e]="-":14==e?c[e]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19==e?3&a|8:a]);return c.join("")}}(),fmod:function(a,b){if(b>a)return console.error("XEO.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;a>=b;)a-=b;return a},negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return XEO.math.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(XEO.math.sqLenVec4(a))},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return XEO.math.dotVec3(a,a)},sqLenVec2:function(a){return XEO.math.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(XEO.math.sqLenVec3(a))},lenVec2:function(a){return Math.sqrt(XEO.math.sqLenVec2(a))},rcpVec3:function(a,b){return XEO.math.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/XEO.math.lenVec4(a);return XEO.math.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/XEO.math.lenVec3(a);return XEO.math.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/XEO.math.lenVec2(a);return XEO.math.mulVec2Scalar(a,c,b)},mat4:function(){return new Array(16)},dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return XEO.math.m4s(0)},setMat4ToOnes:function(){return XEO.math.m4s(1)},diagonalMat4v:function(a){return[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]]},diagonalMat4c:function(a,b,c,d){return XEO.math.diagonalMat4v([a,b,c,d])},diagonalMat4s:function(a){return XEO.math.diagonalMat4c(a,a,a,a)},identityMat4:function(){return XEO.math.diagonalMat4v([1,1,1,1])},isIdentityMat4:function(a){return 1!==a[0]||0!==a[1]||0!==a[2]||0!==a[3]||0!==a[4]||1!==a[5]||0!==a[6]||0!==a[7]||0!==a[8]||0!==a[9]||1!==a[10]||0!==a[11]||0!==a[12]||0!==a[13]||0!==a[14]||1!==a[15]?!1:!0},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return XEO.math.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c
},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a==b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a){var b=XEO.math.identityMat4();return b[12]=a[0],b[13]=a[1],b[14]=a[2],b},translationMat4c:function(a,b,c){return XEO.math.translationMat4v([a,b,c])},translationMat4s:function(a){return XEO.math.translationMat4c(a,a,a)},rotationMat4v:function(a,b){var c,d,e,f,g,h,i=XEO.math.normalizeVec4([b[0],b[1],b[2],0],[]),j=Math.sin(a),k=Math.cos(a),l=1-k,m=i[0],n=i[1],o=i[2];c=m*n,d=n*o,e=o*m,f=m*j,g=n*j,h=o*j;var p=XEO.math.mat4();return p[0]=l*m*m+k,p[1]=l*c+h,p[2]=l*e-g,p[3]=0,p[4]=l*c-h,p[5]=l*n*n+k,p[6]=l*d+f,p[7]=0,p[8]=l*e+g,p[9]=l*d-f,p[10]=l*o*o+k,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},rotationMat4c:function(a,b,c,d){return XEO.math.rotationMat4v(a,[b,c,d])},scalingMat4v:function(a){var b=XEO.math.identityMat4();return b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat4c:function(a,b,c){return XEO.math.scalingMat4v([a,b,c])},scalingMat4s:function(a){return XEO.math.scalingMat4c(a,a,a)},lookAtMat4v:function(a,b,c,d){d||(d=XEO.math.mat4());var e=a[0],f=a[1],g=a[2],h=c[0],i=c[1],j=c[2],k=b[0],l=b[1],m=b[2];if(e==k&&f==l&&g==m)return XEO.math.identityMat4();var n,o,p,q,r,s,t,u,v,w;return n=e-k,o=f-l,p=g-m,w=1/Math.sqrt(n*n+o*o+p*p),n*=w,o*=w,p*=w,q=i*p-j*o,r=j*n-h*p,s=h*o-i*n,w=Math.sqrt(q*q+r*r+s*s),w?(w=1/w,q*=w,r*=w,s*=w):(q=0,r=0,s=0),t=o*s-p*r,u=p*q-n*s,v=n*r-o*q,w=Math.sqrt(t*t+u*u+v*v),w?(w=1/w,t*=w,u*=w,v*=w):(t=0,u=0,v=0),d[0]=q,d[1]=t,d[2]=n,d[3]=0,d[4]=r,d[5]=u,d[6]=o,d[7]=0,d[8]=s,d[9]=v,d[10]=p,d[11]=0,d[12]=-(q*e+r*f+s*g),d[13]=-(t*e+u*f+v*g),d[14]=-(n*e+o*f+p*g),d[15]=1,d},lookAtMat4c:function(a,b,c,d,e,f,g,h,i){return XEO.math.lookAtMat4v([a,b,c],[d,e,f],[g,h,i],[])},orthoMat4c:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2/i,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=-2/j,g[11]=0,g[12]=-(a+b)/h,g[13]=-(d+c)/i,g[14]=-(f+e)/j,g[15]=1,g},frustumMat4v:function(a,b){var c=[a[0],a[1],a[2],0],d=[b[0],b[1],b[2],0],e=XEO.math.mat4();XEO.math.addVec4(d,c,e);var f=XEO.math.mat4();XEO.math.subVec4(d,c,f);var g=2*c[2],h=XEO.math.mat4(),i=f[0],j=f[1],k=f[2];return h[0]=g/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=g/j,h[6]=0,h[7]=0,h[8]=e[0]/i,h[9]=e[1]/j,h[10]=-e[2]/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-g*d[2]/k,h[15]=0,h},frustumMatrix4:function(a,b,c,d,e,f,g){g||(g=XEO.math.mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2*e/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2*e/i,g[6]=0,g[7]=0,g[8]=(b+a)/h,g[9]=(d+c)/i,g[10]=-(f+e)/j,g[11]=-1,g[12]=0,g[13]=0,g[14]=-(f*e*2)/j,g[15]=0,g},perspectiveMatrix4:function(a,b,c,d){var e=[],f=[];return e[2]=c,f[2]=d,f[1]=e[2]*Math.tan(a/2),e[1]=-f[1],f[0]=f[1]*b,e[0]=-f[0],XEO.math.frustumMat4v(e,f)},transformPoint3:function(a,b){var c=b[0],d=b[1],e=b[2];return[a[0]*c+a[4]*d+a[8]*e+a[12],a[1]*c+a[5]*d+a[9]*e+a[13],a[2]*c+a[6]*d+a[10]*e+a[14],a[3]*c+a[7]*d+a[11]*e+a[15]]},transformPoints3:function(a,b){for(var c,d,e,f,g=new Array(b.length),h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15],y=0;h>y;++y)f=b[y],c=f[0],d=f[1],e=f[2],g[y]=[i*c+m*d+q*e+u,j*c+n*d+r*e+v,k*c+o*d+s*e+w,l*c+p*d+t*e+x];return g},transformVec3:function(a,b){var c=b[0],d=b[1],e=b[2];return[a[0]*c+a[4]*d+a[8]*e,a[1]*c+a[5]*d+a[9]*e,a[2]*c+a[6]*d+a[10]*e]},transformVec4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},projectVec4:function(a){var b=1/a[3];return[a[0]*b,a[1]*b,a[2]*b,1]}},XEO.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipMapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipMapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipMapLinear:"NEAREST_MIPMAP_LINEAR",linearMipMapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}},XEO.webgl.ArrayBuffer=function(a,b,c,d,e,f){this.allocated=!1,this.gl=a,this.type=b,this.numItems=d,this.itemSize=e,this.usage=f,this._allocate(c,d)},XEO.webgl.ArrayBuffer.prototype._allocate=function(a,b){if(this.allocated=!1,this.handle=this.gl.createBuffer(),!this.handle)throw"Failed to allocate WebGL ArrayBuffer";this.handle&&(this.gl.bindBuffer(this.type,this.handle),this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null),this.numItems=b,this.length=a.length,this.allocated=!0)},XEO.webgl.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):b||0===b?this.gl.bufferSubData(this.type,b,a):this.gl.bufferData(this.type,a))},XEO.webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},XEO.webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this.handle),this.handle=null,this.allocated=!1)},XEO.webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this.handle)},XEO.webgl.Attribute=function(a,b,c,d,e,f){this.gl=a,this.location=f,this.bindFloatArrayBuffer=function(b){b&&(b.bind(),a.enableVertexAttribArray(f),a.vertexAttribPointer(f,b.itemSize,a.FLOAT,!1,0,0))}},XEO.webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(a,b,c){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a,this.gl.FLOAT,!1,b,c)},XEO.webgl.Program=function(a,b,c){this.allocated=!1,this.gl=a,this._uniforms={},this._samplers={},this._attributes={},this.uniformValues=[],this.materialSettings={specularColor:[0,0,0],specular:0,shininess:0,emit:0,alpha:0},this._vertexShader=new XEO.webgl.Shader(a,a.VERTEX_SHADER,b),this._fragmentShader=new XEO.webgl.Shader(a,a.FRAGMENT_SHADER,c);var d,e,f,g,h;if(this.handle=a.createProgram(),this.handle){this._vertexShader.valid&&a.attachShader(this.handle,this._vertexShader.handle),this._fragmentShader.valid&&a.attachShader(this.handle,this._fragmentShader.handle),a.linkProgram(this.handle);var i=a.getProgramParameter(this.handle,a.ACTIVE_UNIFORMS),j=0;for(e=0;i>e;++e)f=a.getActiveUniform(this.handle,e),f&&(g=f.name,"\x00"==g[g.length-1]&&(g=g.substr(0,g.length-1)),h=a.getUniformLocation(this.handle,g),f.type==a.SAMPLER_2D||f.type==a.SAMPLER_CUBE||35682==f.type?this._samplers[g]=new XEO.webgl.Sampler(a,this.handle,g,f.type,f.size,h):(this._uniforms[g]=new XEO.webgl.Uniform(a,this.handle,g,f.type,f.size,h,j),this.uniformValues[j]=null,++j));var k=a.getProgramParameter(this.handle,a.ACTIVE_ATTRIBUTES);for(e=0;k>e;e++)d=a.getActiveAttrib(this.handle,e),d&&(h=a.getAttribLocation(this.handle,d.name),this._attributes[d.name]=new XEO.webgl.Attribute(a,this.handle,d.name,d.type,d.size,h));this.allocated=!0}},XEO.webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},XEO.webgl.Program.prototype.getUniformLocation=function(a){if(this.allocated){var b=this._uniforms[a];return b?b.getLocation():void 0}},XEO.webgl.Program.prototype.getUniform=function(a){if(this.allocated){var b=this._uniforms[a];return b?b:void 0}},XEO.webgl.Program.prototype.getAttribute=function(a){if(this.allocated){var b=this._attributes[a];return b?b:void 0}},XEO.webgl.Program.prototype.bindFloatArrayBuffer=function(a,b){if(this.allocated){var c=this._attributes[a];c&&c.bindFloatArrayBuffer(b)}},XEO.webgl.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this._samplers[a];return d?d.bindTexture(b,c):!1},XEO.webgl.Program.prototype.destroy=function(){this.allocated&&(this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this._attributes=null,this._uniforms=null,this._samplers=null,this.allocated=!1)},XEO.webgl.Program.prototype.setUniform=function(a,b){if(this.allocated){var c=this._uniforms[a];c&&(this.uniformValues[c.index]===b&&c.numberValue||(c.setValue(b),this.uniformValues[c.index]=b))}},XEO.webgl.RenderBuffer=function(a){this.allocated=!1,this.canvas=a.canvas,this.gl=a.canvas.gl,this.buf=null,this.bound=!1},XEO.webgl.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buf=null,this.allocated=!1,this.bound=!1},XEO.webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.bound=!0)},XEO.webgl.RenderBuffer.prototype._touch=function(){var a=this.canvas.canvas.width,b=this.canvas.canvas.height;if(this.buf){if(this.buf.width==a&&this.buf.height==b)return;this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf)}this.buf={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:a,height:b},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buf.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(c){var d=new WebGLUnsignedByteArray(a*b*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,d)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buf.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),!this.gl.isFramebuffer(this.buf.framebuf))throw XEO_error.fatalError(XEO.errors.INVALID_FRAMEBUFFER,"Invalid framebuffer");var e=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(e){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case this.gl.FRAMEBUFFER_UNSUPPORTED:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw XEO_error.fatalError(XEO.errors.ERROR,"Incomplete framebuffer: "+e)}this.bound=!1},XEO.webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},XEO.webgl.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.canvas.height-b,e=new Uint8Array(4);return this.gl.readPixels(c,d,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),e},XEO.webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},XEO.webgl.RenderBuffer.prototype.getTexture=function(){var a=this;return{bind:function(b){return a.buf&&a.buf.texture?(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buf.texture),!0):!1},unbind:function(b){a.buf&&a.buf.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},XEO.webgl.RenderBuffer.prototype.destroy=function(){this.buf&&(this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf),this.buf=null,this.bound=!1)},XEO.webgl.Sampler=function(a,b,c,d,e,f){this.bindTexture=function(b,c){return b.bind(c)?(a.uniform1i(f,c),!0):!1}},XEO.webgl.Texture2D=function(a,b){this.allocated=!1,this.target=b.target||a.TEXTURE_2D,this.minFilter=b.minFilter,this.magFilter=b.magFilter,this.wrapS=b.wrapS,this.wrapT=b.wrapT,this.update=b.update,this.texture=b.texture,this.format=a.RGBA,this.isDepth=!1,this.depthMode=0,this.depthCompareMode=0,this.depthCompareFunc=0;try{a.bindTexture(this.target,this.texture),b.minFilter&&a.texParameteri(this.target,a.TEXTURE_MIN_FILTER,b.minFilter),b.magFilter&&a.texParameteri(this.target,a.TEXTURE_MAG_FILTER,b.magFilter),b.wrapS&&a.texParameteri(this.target,a.TEXTURE_WRAP_S,b.wrapS),b.wrapT&&a.texParameteri(this.target,a.TEXTURE_WRAP_T,b.wrapT),(b.minFilter==a.NEAREST_MIPMAP_NEAREST||b.minFilter==a.LINEAR_MIPMAP_NEAREST||b.minFilter==a.NEAREST_MIPMAP_LINEAR||b.minFilter==a.LINEAR_MIPMAP_LINEAR)&&a.generateMipmap(this.target),a.bindTexture(this.target,null),this.allocated=!0}catch(c){throw XEO_error.fatalError(XEO.errors.OUT_OF_VRAM,"Failed to create texture: "+c.message||c)}this.bind=function(b){return this.allocated?this.texture?(a.activeTexture(a["TEXTURE"+b]),a.bindTexture(this.target,this.texture),this.update&&this.update(a),!0):!1:void 0},this.unbind=function(b){this.allocated&&this.texture&&(a.activeTexture(a["TEXTURE"+b]),a.bindTexture(this.target,null))},this.destroy=function(){this.allocated&&this.texture&&(a.deleteTexture(this.texture),this.texture=null)}},XEO.webgl.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=XEO.webgl.nextHighestPowerOfTwo(e),g.height=XEO.webgl.nextHighestPowerOfTwo(f);var h=g.getContext("2d");h.drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},XEO.webgl.ensureImageSizePowerOfTwo=function(a){if(!XEO.webgl.isPowerOfTwo(a.width)||!XEO.webgl.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=XEO.webgl.nextHighestPowerOfTwo(a.width),b.height=XEO.webgl.nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},XEO.webgl.isPowerOfTwo=function(a){return 0==(a&a-1)},XEO.webgl.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},XEO.webgl.Uniform=function(a,b,c,d,e,f,g){var h=null;if(this.numberValue=!1,d==a.BOOL)this.numberValue=!0,h=function(b){a.uniform1i(f,b)};else if(d==a.BOOL_VEC2)h=function(b){a.uniform2iv(f,b)};else if(d==a.BOOL_VEC3)h=function(b){a.uniform3iv(f,b)};else if(d==a.BOOL_VEC4)h=function(b){a.uniform4iv(f,b)};else if(d==a.INT)this.numberValue=!0,h=function(b){a.uniform1iv(f,b)};else if(d==a.INT_VEC2)h=function(b){a.uniform2iv(f,b)};else if(d==a.INT_VEC3)h=function(b){a.uniform3iv(f,b)};else if(d==a.INT_VEC4)h=function(b){a.uniform4iv(f,b)};else if(d==a.FLOAT)this.numberValue=!0,h=function(b){a.uniform1f(f,b)};else if(d==a.FLOAT_VEC2)h=function(b){a.uniform2fv(f,b)};else if(d==a.FLOAT_VEC3)h=function(b){a.uniform3fv(f,b)};else if(d==a.FLOAT_VEC4)h=function(b){a.uniform4fv(f,b)};else if(d==a.FLOAT_MAT2)h=function(b){a.uniformMatrix2fv(f,a.FALSE,b)};else if(d==a.FLOAT_MAT3)h=function(b){a.uniformMatrix3fv(f,a.FALSE,b)};else{if(d!=a.FLOAT_MAT4)throw"Unsupported shader uniform type: "+d;h=function(b){a.uniformMatrix4fv(f,a.FALSE,b)}}this.setValue=h,this.getValue=function(){return a.getUniform(b,f)},this.getLocation=function(){return f},this.index=g},XEO.renderer=XEO.renderer||{},XEO.renderer.Renderer=function(a){this._canvas=a.canvas,this._programFactory=new XEO.renderer.ProgramFactory({canvas:a.canvas}),this._chunkFactory=new XEO.ChunkFactory,this.transparent=a.transparent===!0,this.enable=null,this.flags=null,this.layer=null,this.stage=null,this.renderer=null,this.depthBuf=null,this.colorBuf=null,this.view=null,this.lights=null,this.material=null,this.texture=null,this.cubemap=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.renderTarget=null,this.clips=null,this.MorphTargets=null,this.name=null,this.tag=null,this.shader=null,this.uniforms=null,this.style=null,this.geometry=null,this._objectFactory=new XEO.renderer.GameObjectFactory,this._objects={},this._ambientColor=[0,0,0,1],this._objectList=[],this._objectListLen=0,this._drawList=[],this._drawListLen=0,this._pickDrawList=[],this._pickDrawListLen=0,this._targetList=[],this._targetListLen=0,this._frameCtx={pickNames:[],canvas:this._canvas,VAO:null},this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.drawListDirty=!0,this.imageDirty=!0,this.pickBufDirty=!0,this.rayPickBufDirty=!0},XEO.Renderer.prototype.webglRestored=function(){this._programFactory.webglRestored(),this._chunkFactory.webglRestored();var a=this._canvas.gl;this.pickBuf&&this.pickBuf.webglRestored(a),this.rayPickBuf&&this.rayPickBuf.webglRestored(a),this.imageDirty=!0},XEO.Renderer.prototype.buildGameObject=function(a){var b=this._objects[a];b||(b=this._objects[a]=this._objectFactory.getGameObject(a),this.objectListDirty=!0),b.stage=this.stage,b.layer=this.layer,b.renderTarget=this.renderTarget,b.texture=this.texture,b.cubemap=this.cubemap,b.geometry=this.geometry,b.enable=this.enable,b.flags=this.flags,b.tag=this.tag;var c=[this.geometry.hash,this.shader.hash,this.clips.hash,this.MorphTargets.hash,this.texture.hash,this.cubemap.hash,this.lights.hash].join(";");b.program&&c==b.hash||(b.program&&this._programFactory.putProgram(b.program),b.program=this._programFactory.getProgram(c,this),b.hash=c),this._setChunk(b,0,"program"),this._setChunk(b,1,"xform",this.modelTransform),this._setChunk(b,2,"lookAt",this.viewTransform),this._setChunk(b,3,"camera",this.projTransform),this._setChunk(b,4,"flags",this.flags),this._setChunk(b,5,"shader",this.shader),this._setChunk(b,6,"uniforms",this.uniforms),this._setChunk(b,7,"style",this.style),this._setChunk(b,8,"depthBuf",this.depthBuf),this._setChunk(b,9,"colorBuf",this.colorBuf),this._setChunk(b,10,"view",this.view),this._setChunk(b,11,"name",this.name),this._setChunk(b,12,"lights",this.lights),this._setChunk(b,13,"material",this.material),this._setChunk(b,14,"texture",this.texture),this._setChunk(b,15,"cubemap",this.cubemap),this._setChunk(b,16,"clips",this.clips),this._setChunk(b,17,"renderer",this.renderer),this._setChunk(b,18,"geometry",this.MorphTargets,this.geometry),this._setChunk(b,19,"draw",this.geometry)},XEO.Renderer.prototype._setChunk=function(a,b,c,d,e){var f,g=this._chunkFactory.chunkTypes[c];if(d){if(d.empty){var h=a.chunks[b];return h&&this._chunkFactory.putChunk(h),void(a.chunks[b]=null)}f=g.prototype.programGlobal?"_"+d.stateId:"p"+a.program.id+"_"+d.stateId,e&&(f+="__"+e.stateId)}else f="p"+a.program.id;f=b+"__"+f;var h=a.chunks[b];if(h){if(h.id==f)return;this._chunkFactory.putChunk(h)}a.chunks[b]=this._chunkFactory.getChunk(f,c,a.program,d,e),"lights"==c&&this._setAmbient(d)},XEO.Renderer.prototype._setAmbient=function(a){for(var b,c=a.lights,d=0,e=c.length;e>d;d++)b=c[d],"ambient"==b.mode&&(this._ambientColor[0]=b.color[0],this._ambientColor[1]=b.color[1],this._ambientColor[2]=b.color[2])},XEO.Renderer.prototype.removeGameObject=function(a){var b=this._objects[a];b&&(this._programFactory.putProgram(b.program),b.program=null,b.hash=null,this._objectFactory.putGameObject(b),delete this._objects[a],this.objectListDirty=!0)},XEO.Renderer.prototype.selectTags=function(a){this._tagSelector=a,this.drawListDirty=!0},XEO.Renderer.prototype.render=function(a){a=a||{},this.objectListDirty&&(this._buildGameObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.drawListDirty=!0),this.drawListDirty&&(this._buildDrawList(),this.imageDirty=!0),(this.imageDirty||a.force)&&(this._doDrawList({clear:a.clear!==!1}),this.imageDirty=!1,this.pickBufDirty=!0)},XEO.Renderer.prototype._buildGameObjectList=function(){this._objectListLen=0;for(var a in this._objects)this._objects.hasOwnProperty(a)&&(this._objectList[this._objectListLen++]=this._objects[a])},XEO.Renderer.prototype._makeStateSortKeys=function(){for(var a,b=0,c=this._objectListLen;c>b;b++)a=this._objectList[b],a.sortKey=a.program?1e12*(a.stage.priority+1)+1e9*(a.flags.transparent?2:1)+1e6*(a.layer.priority+1)+1e3*(a.program.id+1)+a.texture.stateId:-1},XEO.Renderer.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(this._stateSortGameObjects)},XEO.Renderer.prototype._stateSortGameObjects=function(a,b){return a.sortKey-b.sortKey},XEO.Renderer.prototype._logGameObjectList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._objectListLen+" objects");for(var a=0,b=this._objectListLen;b>a;a++){var c=this._objectList[a];console.log("XEO.Renderer : object["+a+"] sortKey = "+c.sortKey)}console.log("--------------------------------------------------------------------------------------------------")},XEO.Renderer.prototype._buildDrawList=function(){this._lastStateId=this._lastStateId||[],this._lastPickStateId=this._lastPickStateId||[];for(var a=0;23>a;a++)this._lastStateId[a]=null,this._lastPickStateId[a]=null;this._drawListLen=0,this._pickDrawListLen=0;var b,c,d,e,f,g={},h=[],i=[];this._tagSelector&&(c=this._tagSelector.mask,d=this._tagSelector.regex),this._objectDrawList=this._objectDrawList||[],this._objectDrawListLen=0;for(var a=0,j=this._objectListLen;j>a;a++)if(b=this._objectList[a],b.enable.enabled!==!1&&(f=b.flags,f.enabled!==!1&&b.layer.enabled&&(!c||(e=b.tag,!e.tag||(e.mask!=c&&(e.mask=c,e.matches=d.test(e.tag)),e.matches)))))if(b.renderTarget.targets)for(var k,l,m,n=b.renderTarget.targets,o=0,p=n.length;p>o;o++)k=n[o],l=k.coreId,m=g[l],m||(m=[],g[l]=m,h.push(m),i.push(this._chunkFactory.getChunk(k.stateId,"renderTarget",b.program,k))),m.push(b);else this._objectDrawList[this._objectDrawListLen++]=b;for(var m,k,b,q,a=0,j=h.length;j>a;a++){m=h[a],k=i[a],this._appendRenderTargetChunk(k);for(var o=0,p=m.length;p>o;o++)b=m[o],q=b.stage&&b.stage.pickable,this._appendGameObjectToDrawLists(b,q)}b&&this._appendRenderTargetChunk(this._chunkFactory.getChunk(-1,"renderTarget",b.program,{}));for(var a=0,j=this._objectDrawListLen;j>a;a++)b=this._objectDrawList[a],q=!b.stage||b.stage&&b.stage.pickable,this._appendGameObjectToDrawLists(b,q);this.drawListDirty=!1},XEO.Renderer.prototype._appendRenderTargetChunk=function(a){this._drawList[this._drawListLen++]=a},XEO.Renderer.prototype._appendGameObjectToDrawLists=function(a,b){for(var c,d=a.chunks,e=a.flags.picking,f=0,g=d.length;g>f;f++)c=d[f],c&&(c.draw&&(c.unique||this._lastStateId[f]!=c.id)&&(this._drawList[this._drawListLen++]=c,this._lastStateId[f]=c.id),c.pick&&b!==!1&&e&&(c.unique||this._lastPickStateId[f]!=c.id)&&(this._pickDrawList[this._pickDrawListLen++]=c,this._lastPickStateId[f]=c.id))},XEO.Renderer.prototype._logDrawList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._drawListLen+" draw list chunks");for(var a=0,b=this._drawListLen;b>a;a++){var c=this._drawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+c.core.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},XEO.Renderer.prototype._logPickList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._pickDrawListLen+" pick list chunks");for(var a=0,b=this._pickDrawListLen;b>a;a++){var c=this._pickDrawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+c.core.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},XEO.Renderer.prototype.pick=function(a){var b=this._canvas.canvas,c=null,d=a.canvasX,e=a.canvasY,f=this.pickBuf;f||(f=this.pickBuf=new XEO.webgl.RenderBuffer({canvas:this._canvas}),this.pickBufDirty=!0),this.render(),f.bind(),this.pickBufDirty&&(f.clear(),this._doDrawList({pick:!0,clear:!0}),this._canvas.gl.finish(),this.pickBufDirty=!1,this.rayPickBufDirty=!0);var g=f.read(d,e),h=g[0]+256*g[1]+65536*g[2],i=h>=1?h-1:-1;f.unbind();var j=this._frameCtx.pickNames[i];if(j&&(c={name:j.name,path:j.path,componentId:j.componentId,canvasPos:[d,e]},a.rayPick)){var k=this.rayPickBuf;k||(k=this.rayPickBuf=new XEO.webgl.RenderBuffer({canvas:this._canvas}),this.rayPickBufDirty=!0),k.bind(),this.rayPickBufDirty&&(k.clear(),this._doDrawList({pick:!0,rayPick:!0,clear:!0}),this.rayPickBufDirty=!1),g=k.read(d,e),k.unbind();var l=this._unpackDepth(g),m=b.width,n=b.height,o=(d-m/2)/(m/2),p=-(e-n/2)/(n/2),q=this._frameCtx.cameraMat,r=this._frameCtx.viewMat,s=SceneJS_math_mulMat4(q,r,[]),t=SceneJS_math_inverseMat4(s,[]),u=SceneJS_math_transformVec4(t,[o,p,-1,1]);u=SceneJS_math_mulVec4Scalar(u,1/u[3]);var v=SceneJS_math_transformVec4(t,[o,p,1,1]);v=SceneJS_math_mulVec4Scalar(v,1/v[3]);var w=SceneJS_math_subVec3(v,u,[]),x=SceneJS_math_addVec3(u,SceneJS_math_mulVec4Scalar(w,l,[]),[]);c.worldPos=x}return c},XEO.Renderer.prototype._unpackDepth=function(a){var b=[a[0]/256,a[1]/256,a[2]/256,a[3]/256],c=[1/16777216,1/65536,1/256,1];return SceneJS_math_dotVector4(b,c)},XEO.Renderer.prototype._doDrawList=function(a){var b=this._canvas.gl,c=this._frameCtx;c.renderTarget=null,c.targetIndex=0,c.renderBuf=null,c.viewMat=null,c.modelMat=null,c.cameraMat=null,c.renderer=null,c.depthbufEnabled=null,c.clearDepth=null,c.depthFunc=b.LESS,c.scissorTestEnabled=!1,c.blendEnabled=!1,c.backfaces=!0,c.frontface="ccw",c.pick=!!a.pick,c.rayPick=!!a.rayPick,c.pickIndex=0,c.textureUnit=0,c.lineWidth=1,c.transparent=!1,c.ambientColor=this._ambientColor,c.aspect=this._canvas.canvas.width/this._canvas.canvas.height;var d=b.getExtension("OES_vertex_array_object");if(c.VAO=d?d:null,c.VAO=null,b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),this.transparent?b.clearColor(0,0,0,0):b.clearColor(this._ambientColor[0],this._ambientColor[1],this._ambientColor[2],1),a.clear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT),b.frontFace(b.CCW),b.disable(b.CULL_FACE),b.disable(b.BLEND),a.pick)for(var e=0,f=this._pickDrawListLen;f>e;e++)this._pickDrawList[e].pick(c);else for(var e=0,f=this._drawListLen;f>e;e++)this._drawList[e].draw(c);if(b.flush(),c.renderBuf&&c.renderBuf.unbind(),c.VAO){c.VAO.bindVertexArrayOES(null);for(var e=0;10>e;e++)b.disableVertexAttribArray(e)}},XEO.Renderer.prototype.destroy=function(){this._programFactory.destroy()};